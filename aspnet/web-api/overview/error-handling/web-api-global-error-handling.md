---
uid: web-api/overview/error-handling/web-api-global-error-handling
title: Gestione degli errori globale in API Web ASP.NET 2-ASP.NET 4. x
author: davidmatson
description: Panoramica della gestione degli errori globale in API Web ASP.NET 2 per ASP.NET 4. x.
ms.author: riande
ms.date: 02/03/2014
ms.custom: seoapril2019
ms.assetid: bffd7863-f63b-4b23-a13c-372b5492e9fb
msc.legacyurl: /web-api/overview/error-handling/web-api-global-error-handling
msc.type: authoredcontent
ms.openlocfilehash: 94f2d6d31d0b37f9bb0077e6258c70a2dfb1918d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/06/2020
ms.locfileid: "78557281"
---
# <a name="global-error-handling-in-aspnet-web-api-2"></a><span data-ttu-id="116d9-103">Gestione degli errori globale in API Web ASP.NET 2</span><span class="sxs-lookup"><span data-stu-id="116d9-103">Global Error Handling in ASP.NET Web API 2</span></span>

<span data-ttu-id="116d9-104">di [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="116d9-104">by [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="116d9-105">Questo argomento fornisce una panoramica della gestione degli errori globale in API Web ASP.NET 2 per ASP.NET 4. x.</span><span class="sxs-lookup"><span data-stu-id="116d9-105">This topic provides an overview of global error handling in ASP.NET Web API 2 for ASP.NET 4.x.</span></span> <span data-ttu-id="116d9-106">Attualmente non esiste alcun modo semplice nell'API Web per registrare o gestire gli errori a livello globale.</span><span class="sxs-lookup"><span data-stu-id="116d9-106">Today there's no easy way in Web API to log or handle errors globally.</span></span> <span data-ttu-id="116d9-107">Alcune eccezioni non gestite possono essere elaborate tramite [filtri eccezioni](exception-handling.md), ma in alcuni casi non è possibile gestire i filtri eccezioni.</span><span class="sxs-lookup"><span data-stu-id="116d9-107">Some unhandled exceptions can be processed via [exception filters](exception-handling.md), but there are a number of cases that exception filters can't handle.</span></span> <span data-ttu-id="116d9-108">Esempio:</span><span class="sxs-lookup"><span data-stu-id="116d9-108">For example:</span></span>

1. <span data-ttu-id="116d9-109">Eccezioni generate dai costruttori dei controller.</span><span class="sxs-lookup"><span data-stu-id="116d9-109">Exceptions thrown from controller constructors.</span></span>
2. <span data-ttu-id="116d9-110">Eccezioni generate dai gestori di messaggi.</span><span class="sxs-lookup"><span data-stu-id="116d9-110">Exceptions thrown from message handlers.</span></span>
3. <span data-ttu-id="116d9-111">Eccezioni generate durante il routing.</span><span class="sxs-lookup"><span data-stu-id="116d9-111">Exceptions thrown during routing.</span></span>
4. <span data-ttu-id="116d9-112">Eccezioni generate durante la serializzazione del contenuto della risposta.</span><span class="sxs-lookup"><span data-stu-id="116d9-112">Exceptions thrown during response content serialization .</span></span>

<span data-ttu-id="116d9-113">Si vuole fornire un modo semplice e coerente per la registrazione e la gestione (laddove possibile) di queste eccezioni.</span><span class="sxs-lookup"><span data-stu-id="116d9-113">We want to provide a simple, consistent way to log and handle (where possible) these exceptions.</span></span> 

<span data-ttu-id="116d9-114">Esistono due casi principali per la gestione delle eccezioni, nel caso in cui siamo in grado di inviare una risposta di errore e nel caso in cui sia possibile registrare l'eccezione.</span><span class="sxs-lookup"><span data-stu-id="116d9-114">There are two major cases for handling exceptions, the case where we are able to send an error response and the case where all we can do is log the exception.</span></span> <span data-ttu-id="116d9-115">Un esempio per il secondo caso è quando viene generata un'eccezione durante la trasmissione del contenuto della risposta. in tal caso è troppo tardi per inviare un nuovo messaggio di risposta dal momento che il codice di stato, le intestazioni e il contenuto parziale sono già passati attraverso la rete, quindi è sufficiente interrompere la connessione.</span><span class="sxs-lookup"><span data-stu-id="116d9-115">An example for the latter case is when an exception is thrown in the middle of streaming response content; in that case it is too late to send a new response message since the status code, headers, and partial content have already gone across the wire, so we simply abort the connection.</span></span> <span data-ttu-id="116d9-116">Anche se non è possibile gestire l'eccezione per produrre un nuovo messaggio di risposta, è ancora supportata la registrazione dell'eccezione.</span><span class="sxs-lookup"><span data-stu-id="116d9-116">Even though the exception can't be handled to produce a new response message, we still support logging the exception.</span></span> <span data-ttu-id="116d9-117">Nei casi in cui è possibile rilevare un errore, è possibile restituire una risposta di errore appropriata, come illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="116d9-117">In cases where we can detect an error, we can return an appropriate error response as shown in the following:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample1.cs?highlight=6)]

### <a name="existing-options"></a><span data-ttu-id="116d9-118">Opzioni esistenti</span><span class="sxs-lookup"><span data-stu-id="116d9-118">Existing Options</span></span>

<span data-ttu-id="116d9-119">Oltre ai [filtri eccezioni](exception-handling.md), i [gestori di messaggi](../advanced/http-message-handlers.md) possono essere usati oggi per osservare tutte le risposte a livello di 500, ma l'azione su tali risposte è difficile, in quanto manca il contesto dell'errore originale.</span><span class="sxs-lookup"><span data-stu-id="116d9-119">In addition to [exception filters](exception-handling.md), [message handlers](../advanced/http-message-handlers.md) can be used today to observe all 500-level responses, but acting on those responses is difficult, as they lack context about the original error.</span></span> <span data-ttu-id="116d9-120">I gestori di messaggi presentano anche alcune delle stesse limitazioni dei filtri eccezioni relativi ai casi che è possibile gestire. Sebbene l'API Web disponga di un'infrastruttura di traccia che acquisisce le condizioni di errore, l'infrastruttura di traccia è a scopo di diagnostica e non è progettata o adatta per l'esecuzione in ambienti di produzione.</span><span class="sxs-lookup"><span data-stu-id="116d9-120">Message handlers also have some of the same limitations as exception filters regarding the cases they can handle.While Web API does have tracing infrastructure that captures error conditions the tracing infrastructure is for diagnostics purposes and is not designed or suited for running in production environments.</span></span> <span data-ttu-id="116d9-121">La gestione e la registrazione delle eccezioni globali devono essere servizi che possono essere eseguiti durante la produzione e collegati a soluzioni di monitoraggio esistenti (ad esempio, [ELMAH](https://code.google.com/p/elmah/) ).</span><span class="sxs-lookup"><span data-stu-id="116d9-121">Global exception handling and logging should be services that can run during production and be plugged into existing monitoring solutions (for example, [ELMAH](https://code.google.com/p/elmah/) ).</span></span>

### <a name="solution-overview"></a><span data-ttu-id="116d9-122">Panoramica della soluzione</span><span class="sxs-lookup"><span data-stu-id="116d9-122">Solution Overview</span></span>

 <span data-ttu-id="116d9-123">Sono disponibili due nuovi servizi sostituibili dall'utente, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) e IExceptionHandler, per registrare e gestire le eccezioni non gestite.</span><span class="sxs-lookup"><span data-stu-id="116d9-123">We provide two new user-replaceable services, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) and IExceptionHandler, to log and handle unhandled exceptions.</span></span> <span data-ttu-id="116d9-124">I servizi sono molto simili, con due differenze principali:</span><span class="sxs-lookup"><span data-stu-id="116d9-124">The services are very similar, with two main differences:</span></span>

1. <span data-ttu-id="116d9-125">È supportata la registrazione di più logger di eccezione, ma solo un singolo gestore di eccezioni.</span><span class="sxs-lookup"><span data-stu-id="116d9-125">We support registering multiple exception loggers but only a single exception handler.</span></span>
2. <span data-ttu-id="116d9-126">I logger di eccezione vengono sempre chiamati, anche se si sta per interrompere la connessione.</span><span class="sxs-lookup"><span data-stu-id="116d9-126">Exception loggers always get called, even if we're about to abort the connection.</span></span> <span data-ttu-id="116d9-127">I gestori di eccezioni vengono chiamati solo quando è ancora possibile scegliere il messaggio di risposta da inviare.</span><span class="sxs-lookup"><span data-stu-id="116d9-127">Exception handlers only get called when we're still able to choose which response message to send.</span></span>

<span data-ttu-id="116d9-128">Entrambi i servizi forniscono l'accesso a un contesto di eccezione contenente le informazioni rilevanti dal punto in cui è stata rilevata l'eccezione, in particolare [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), l'eccezione generata e l'origine dell'eccezione (dettagli di seguito).</span><span class="sxs-lookup"><span data-stu-id="116d9-128">Both services provide access to an exception context containing relevant information from the point where the exception was detected, particularly the [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), the [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), the thrown exception and the exception source (details below).</span></span>

### <a name="design-principles"></a><span data-ttu-id="116d9-129">Principi di progettazione</span><span class="sxs-lookup"><span data-stu-id="116d9-129">Design Principles</span></span>

1. <span data-ttu-id="116d9-130">**Nessuna modifica di rilievo** Poiché questa funzionalità viene aggiunta in una versione secondaria, un vincolo importante che influisca sulla soluzione è che non ci sono modifiche di rilievo, per digitare i contratti o il comportamento.</span><span class="sxs-lookup"><span data-stu-id="116d9-130">**No breaking changes** Because this functionality is being added in a minor release, one important constraint impacting the solution is that there be no breaking changes, either to type contracts or to behavior.</span></span> <span data-ttu-id="116d9-131">Questo vincolo ha eliminato alcune operazioni di pulizia che si desidera eseguire in termini di blocchi catch esistenti che trasformano le eccezioni in risposte 500.</span><span class="sxs-lookup"><span data-stu-id="116d9-131">This constraint ruled out some cleanup we would like to have done in terms of existing catch blocks turning exceptions into 500 responses.</span></span> <span data-ttu-id="116d9-132">Questa pulizia aggiuntiva è un elemento che è opportuno considerare per una versione principale successiva.</span><span class="sxs-lookup"><span data-stu-id="116d9-132">This additional cleanup is something we might consider for a subsequent major release.</span></span> <span data-ttu-id="116d9-133">Se questa operazione è importante per l'utente, è necessario votarla all' [API Web ASP.NET voce dell'utente](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span><span class="sxs-lookup"><span data-stu-id="116d9-133">If this is important to you please vote on it at [ASP.NET Web API user voice](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span></span>
2. <span data-ttu-id="116d9-134">**Mantenimento della coerenza con i costrutti dell'API Web** La pipeline di filtri dell'API Web è un ottimo modo per gestire le problematiche trasversali con la flessibilità di applicare la logica a un ambito specifico dell'azione, specifico del controller o globale.</span><span class="sxs-lookup"><span data-stu-id="116d9-134">**Maintaining consistency with Web API constructs** Web API's filter pipeline is a great way to handle cross-cutting concerns with the flexibility of applying the logic at an action-specific, controller-specific or global scope.</span></span> <span data-ttu-id="116d9-135">I filtri, inclusi i filtri eccezioni, presentano sempre contesti di azione e controller, anche se registrati nell'ambito globale.</span><span class="sxs-lookup"><span data-stu-id="116d9-135">Filters, including exception filters, always have action and controller contexts, even when registered at the global scope.</span></span> <span data-ttu-id="116d9-136">Questo contratto è utile per i filtri, ma significa che i filtri delle eccezioni, anche quelli a ambito globale, non sono adatti per alcuni casi di gestione delle eccezioni, ad esempio eccezioni dei gestori di messaggi, in cui non esiste alcun contesto di azione o di controller.</span><span class="sxs-lookup"><span data-stu-id="116d9-136">That contract makes sense for filters, but it means that exception filters, even globally scoped ones, aren't a good fit for some exception handling cases, such as exceptions from message handlers, where no action or controller context exists.</span></span> <span data-ttu-id="116d9-137">Se si vuole usare l'ambito flessibile concesso da filtri per la gestione delle eccezioni, sono ancora necessari filtri eccezioni.</span><span class="sxs-lookup"><span data-stu-id="116d9-137">If we want to use the flexible scoping afforded by filters for exception handling, we still need exception filters.</span></span> <span data-ttu-id="116d9-138">Tuttavia, se è necessario gestire un'eccezione all'esterno di un contesto del controller, è necessario anche un costrutto separato per la gestione completa degli errori globale (qualcosa senza i vincoli del contesto del controller e del contesto dell'azione).</span><span class="sxs-lookup"><span data-stu-id="116d9-138">But if we need to handle exception outside of a controller context, we also need a separate construct for full global error handling (something without the controller context and action context constraints).</span></span>

### <a name="when-to-use"></a><span data-ttu-id="116d9-139">Utilizzo</span><span class="sxs-lookup"><span data-stu-id="116d9-139">When to Use</span></span>

- <span data-ttu-id="116d9-140">I logger delle eccezioni sono la soluzione per visualizzare tutte le eccezioni non gestite rilevate dall'API Web.</span><span class="sxs-lookup"><span data-stu-id="116d9-140">Exception loggers are the solution to seeing all unhandled exception caught by Web API.</span></span>
- <span data-ttu-id="116d9-141">I gestori di eccezioni sono la soluzione per la personalizzazione di tutte le possibili risposte a eccezioni non gestite rilevate dall'API Web.</span><span class="sxs-lookup"><span data-stu-id="116d9-141">Exception handlers are the solution for customizing all possible responses to unhandled exceptions caught by Web API.</span></span>
- <span data-ttu-id="116d9-142">I filtri eccezioni rappresentano la soluzione più semplice per elaborare le eccezioni non gestite del subset correlate a un'azione o a un controller specifico.</span><span class="sxs-lookup"><span data-stu-id="116d9-142">Exception filters are the easiest solution for processing the subset unhandled exceptions related to a specific action or controller.</span></span>

### <a name="service-details"></a><span data-ttu-id="116d9-143">Dettagli servizio</span><span class="sxs-lookup"><span data-stu-id="116d9-143">Service Details</span></span>

 <span data-ttu-id="116d9-144">Le interfacce del servizio del gestore e del logger delle eccezioni sono semplici metodi asincroni che accettano i rispettivi contesti:</span><span class="sxs-lookup"><span data-stu-id="116d9-144">The exception logger and handler service interfaces are simple async methods taking the respective contexts:</span></span> 

[!code-csharp[Main](web-api-global-error-handling/samples/sample2.cs)]

 <span data-ttu-id="116d9-145">Sono inoltre disponibili classi di base per entrambe le interfacce.</span><span class="sxs-lookup"><span data-stu-id="116d9-145">We also provide base classes for both of these interfaces.</span></span> <span data-ttu-id="116d9-146">L'override dei metodi Core (Sync o Async) è tutto ciò che è necessario per la registrazione o la gestione alle ore consigliate.</span><span class="sxs-lookup"><span data-stu-id="116d9-146">Overriding the core (sync or async) methods is all that is required to log or handle at the recommended times.</span></span> <span data-ttu-id="116d9-147">Per la registrazione, la classe di base `ExceptionLogger` garantisce che il metodo di registrazione principale venga chiamato una sola volta per ogni eccezione (anche se in un secondo momento viene propagata ulteriormente lo stack di chiamate e viene rilevata).</span><span class="sxs-lookup"><span data-stu-id="116d9-147">For logging, the `ExceptionLogger` base class will ensure that the core logging method is only called once for each exception (even if it later propagates further up the call stack and is caught again).</span></span> <span data-ttu-id="116d9-148">La classe di base `ExceptionHandler` chiamerà il metodo di gestione principale solo per le eccezioni all'inizio dello stack di chiamate, ignorando i blocchi catch annidati legacy.</span><span class="sxs-lookup"><span data-stu-id="116d9-148">The `ExceptionHandler` base class will call the core handling method only for exceptions at the top of the call stack, ignoring legacy nested catch blocks.</span></span> <span data-ttu-id="116d9-149">(Le versioni semplificate di queste classi di base sono riportate nell'appendice riportata di seguito). Sia `IExceptionLogger` che `IExceptionHandler` ricevono informazioni sull'eccezione tramite un `ExceptionContext`.</span><span class="sxs-lookup"><span data-stu-id="116d9-149">(Simplified versions of these base classes are in the appendix below.) Both `IExceptionLogger` and `IExceptionHandler` receive information about the exception via an `ExceptionContext`.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample3.cs)]

<span data-ttu-id="116d9-150">Quando il Framework chiama un logger di eccezioni o un gestore di eccezioni, fornisce sempre un `Exception` e una `Request`.</span><span class="sxs-lookup"><span data-stu-id="116d9-150">When the framework calls an exception logger or an exception handler, it will always provide an `Exception` and a `Request`.</span></span> <span data-ttu-id="116d9-151">Ad eccezione degli unit test, fornisce sempre un `RequestContext`.</span><span class="sxs-lookup"><span data-stu-id="116d9-151">Except for unit testing, it will also always provide a `RequestContext`.</span></span> <span data-ttu-id="116d9-152">Fornisce raramente un `ControllerContext` e `ActionContext` (solo quando viene chiamato dal blocco catch per i filtri eccezioni).</span><span class="sxs-lookup"><span data-stu-id="116d9-152">It will rarely provide a `ControllerContext` and `ActionContext` (only when calling from the catch block for exception filters).</span></span> <span data-ttu-id="116d9-153">Fornisce raramente un `Response`(solo in alcuni casi IIS durante il tentativo di scrittura della risposta).</span><span class="sxs-lookup"><span data-stu-id="116d9-153">It will very rarely provide a `Response`(only in certain IIS cases when in the middle of trying to write the response).</span></span> <span data-ttu-id="116d9-154">Si noti che poiché alcune di queste proprietà possono essere `null` spetta al consumer verificare la presenza di `null` prima di accedere ai membri della classe Exception.`CatchBlock`</span><span class="sxs-lookup"><span data-stu-id="116d9-154">Note that because some of these properties may be `null` it is up to the consumer to check for `null` before accessing members of the exception class.`CatchBlock`</span></span> <span data-ttu-id="116d9-155">stringa che indica il blocco catch che ha rilevato l'eccezione.</span><span class="sxs-lookup"><span data-stu-id="116d9-155">is a string indicating which catch block saw the exception.</span></span> <span data-ttu-id="116d9-156">Le stringhe del blocco catch sono le seguenti:</span><span class="sxs-lookup"><span data-stu-id="116d9-156">The catch block strings are as follows:</span></span>

- <span data-ttu-id="116d9-157">HttpServer (metodo SendAsync)</span><span class="sxs-lookup"><span data-stu-id="116d9-157">HttpServer (SendAsync method)</span></span>
- <span data-ttu-id="116d9-158">HttpControllerDispatcher (metodo SendAsync)</span><span class="sxs-lookup"><span data-stu-id="116d9-158">HttpControllerDispatcher (SendAsync method)</span></span>
- <span data-ttu-id="116d9-159">HttpBatchHandler (metodo SendAsync)</span><span class="sxs-lookup"><span data-stu-id="116d9-159">HttpBatchHandler (SendAsync method)</span></span>
- <span data-ttu-id="116d9-160">IExceptionFilter (elaborazione di ApiController della pipeline del filtro eccezioni in ExecuteAsync)</span><span class="sxs-lookup"><span data-stu-id="116d9-160">IExceptionFilter (ApiController's processing of the exception filter pipeline in ExecuteAsync)</span></span>
- <span data-ttu-id="116d9-161">Host OWIN:</span><span class="sxs-lookup"><span data-stu-id="116d9-161">OWIN host:</span></span>

    - <span data-ttu-id="116d9-162">HttpMessageHandlerAdapter. BufferResponseContentAsync (per il buffering dell'output)</span><span class="sxs-lookup"><span data-stu-id="116d9-162">HttpMessageHandlerAdapter.BufferResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="116d9-163">HttpMessageHandlerAdapter. CopyResponseContentAsync (per il flusso di output)</span><span class="sxs-lookup"><span data-stu-id="116d9-163">HttpMessageHandlerAdapter.CopyResponseContentAsync (for streaming output)</span></span>
- <span data-ttu-id="116d9-164">Host Web:</span><span class="sxs-lookup"><span data-stu-id="116d9-164">Web host:</span></span>

    - <span data-ttu-id="116d9-165">HttpControllerHandler. WriteBufferedResponseContentAsync (per il buffering dell'output)</span><span class="sxs-lookup"><span data-stu-id="116d9-165">HttpControllerHandler.WriteBufferedResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="116d9-166">HttpControllerHandler. WriteStreamedResponseContentAsync (per il flusso di output)</span><span class="sxs-lookup"><span data-stu-id="116d9-166">HttpControllerHandler.WriteStreamedResponseContentAsync (for streaming output)</span></span>
    - <span data-ttu-id="116d9-167">HttpControllerHandler. WriteErrorResponseContentAsync (per errori nel ripristino degli errori in modalità di output memorizzato nel buffer)</span><span class="sxs-lookup"><span data-stu-id="116d9-167">HttpControllerHandler.WriteErrorResponseContentAsync (for failures in error recovery under buffered output mode)</span></span>

<span data-ttu-id="116d9-168">L'elenco di stringhe di blocco catch è disponibile anche tramite le proprietà di sola lettura statiche.</span><span class="sxs-lookup"><span data-stu-id="116d9-168">The list of catch block strings is also available via static readonly properties.</span></span> <span data-ttu-id="116d9-169">(La stringa del blocco catch principale si trova sul ExceptionCatchBlocks statico; il resto viene visualizzato in una classe statica ogni per OWIN e host Web).`IsTopLevelCatchBlock`</span><span class="sxs-lookup"><span data-stu-id="116d9-169">(The core catch block string are on the static ExceptionCatchBlocks; the remainder appear on one static class each for OWIN and web host).`IsTopLevelCatchBlock`</span></span> <span data-ttu-id="116d9-170">è utile per seguire il modello consigliato di gestione delle eccezioni solo nella parte superiore dello stack di chiamate.</span><span class="sxs-lookup"><span data-stu-id="116d9-170">is helpful for following the recommended pattern of handling exceptions only at the top of the call stack.</span></span> <span data-ttu-id="116d9-171">Anziché trasformare le eccezioni in risposte 500 ovunque si verifichi un blocco catch annidato, un gestore di eccezioni può consentire la propagazione delle eccezioni fino a quando non vengono visualizzate dall'host.</span><span class="sxs-lookup"><span data-stu-id="116d9-171">Rather than turning exceptions into 500 responses anywhere a nested catch block occurs, an exception handler can let exceptions propagate until they are about to be seen by the host.</span></span>

<span data-ttu-id="116d9-172">Oltre alla `ExceptionContext`, un logger riceve un'ulteriore informazione tramite la `ExceptionLoggerContext`completa:</span><span class="sxs-lookup"><span data-stu-id="116d9-172">In addition to the `ExceptionContext`, a logger gets one more piece of information via the full `ExceptionLoggerContext`:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample4.cs)]

<span data-ttu-id="116d9-173">La seconda proprietà, `CanBeHandled`, consente a un logger di identificare un'eccezione che non può essere gestita.</span><span class="sxs-lookup"><span data-stu-id="116d9-173">The second property, `CanBeHandled`, allows a logger to identify an exception that cannot be handled.</span></span> <span data-ttu-id="116d9-174">Quando la connessione sta per essere interrotta e non è possibile inviare un nuovo messaggio di risposta, i logger verranno chiamati, ma il gestore ***non*** verrà chiamato e i logger potranno identificare questo scenario da questa proprietà.</span><span class="sxs-lookup"><span data-stu-id="116d9-174">When the connection is about to be aborted and no new response message can be sent, the loggers will be called but the handler will ***not*** be called, and the loggers can identify this scenario from this property.</span></span>

<span data-ttu-id="116d9-175">In aggiunta alla `ExceptionContext`, un gestore ottiene un'altra proprietà che può impostare sulla `ExceptionHandlerContext` completa per gestire l'eccezione:</span><span class="sxs-lookup"><span data-stu-id="116d9-175">In additional to the `ExceptionContext`, a handler gets one more property it can set on the full `ExceptionHandlerContext` to handle the exception:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample5.cs)]

<span data-ttu-id="116d9-176">Un gestore di eccezioni indica che ha gestito un'eccezione impostando la proprietà `Result` su un risultato dell'azione, ad esempio [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx)o un risultato personalizzato.</span><span class="sxs-lookup"><span data-stu-id="116d9-176">An exception handler indicates that it has handled an exception by setting the `Result` property to an action result (for example, an [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx), or a custom result).</span></span> <span data-ttu-id="116d9-177">Se la proprietà `Result` è null, l'eccezione non viene gestita e l'eccezione originale verrà generata nuovamente.</span><span class="sxs-lookup"><span data-stu-id="116d9-177">If the `Result` property is null, the exception is unhandled and the original exception will be re-thrown.</span></span>

<span data-ttu-id="116d9-178">Per le eccezioni all'inizio dello stack di chiamate, è stato adottato un passaggio aggiuntivo per garantire che la risposta sia appropriata per i chiamanti API.</span><span class="sxs-lookup"><span data-stu-id="116d9-178">For exceptions at the top of the call stack, we took an extra step to ensure the response is appropriate for API callers.</span></span> <span data-ttu-id="116d9-179">Se l'eccezione viene propagata all'host, il chiamante visualizzerà lo schermo giallo di morte o un altro host fornirà una risposta che in genere è HTML e non è in genere una risposta di errore API appropriata.</span><span class="sxs-lookup"><span data-stu-id="116d9-179">If the exception propagates up to the host, the caller would see the yellow screen of death or some other host provided response which is typically HTML and not usually an appropriate API error response.</span></span> <span data-ttu-id="116d9-180">In questi casi, il risultato inizia con un valore non null e solo se un gestore di eccezioni personalizzato lo imposta in modo esplicito su `null` (non gestito) l'eccezione viene propagata all'host.</span><span class="sxs-lookup"><span data-stu-id="116d9-180">In these cases, the Result starts out non-null, and only if a custom exception handler explicitly sets it back to `null` (unhandled) will the exception propagate to the host.</span></span> <span data-ttu-id="116d9-181">L'impostazione di `Result` su `null` in questi casi può essere utile per due scenari:</span><span class="sxs-lookup"><span data-stu-id="116d9-181">Setting `Result` to `null` in such cases can be useful for two scenarios:</span></span>

1. <span data-ttu-id="116d9-182">API Web ospitata in OWIN con middleware di gestione delle eccezioni personalizzato registrato prima/fuori dall'API Web.</span><span class="sxs-lookup"><span data-stu-id="116d9-182">OWIN hosted Web API with custom exception handling middleware registered before/outside Web API.</span></span>
2. <span data-ttu-id="116d9-183">Debug locale tramite un browser, in cui la schermata gialla della morte è effettivamente una risposta utile per un'eccezione non gestita.</span><span class="sxs-lookup"><span data-stu-id="116d9-183">Local debugging via a browser, where the yellow screen of death is actually a helpful response for an unhandled exception.</span></span>

<span data-ttu-id="116d9-184">Per i logger di eccezione e i gestori di eccezioni, non viene eseguita alcuna operazione per ripristinare se il logger o il gestore stesso genera un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="116d9-184">For both exception loggers and exception handlers, we don't do anything to recover if the logger or handler itself throws an exception.</span></span> <span data-ttu-id="116d9-185">(Oltre a consentire la propagazione dell'eccezione, lasciare commenti e suggerimenti nella parte inferiore della pagina se si ha un approccio migliore). Il contratto per i logger e i gestori di eccezioni è che non devono consentire la propagazione delle eccezioni ai chiamanti; in caso contrario, l'eccezione viene propagata, spesso fino all'host, ottenendo un errore HTML, ad esempio ASP. Lo schermo giallo di NET) viene restituito al client (che in genere non è l'opzione preferita per i chiamanti API che prevedono JSON o XML).</span><span class="sxs-lookup"><span data-stu-id="116d9-185">(Other than letting the exception propagate, leave feedback at the bottom of this page if you have a better approach.) The contract for exception loggers and handlers is that they should not let exceptions propagate up to their callers; otherwise, the exception will just propagate, often all the way to the host resulting in an HTML error (like the ASP.NET's yellow screen) being sent back to the client (which usually isn't the preferred option for API callers that expect JSON or XML).</span></span>

## <a name="examples"></a><span data-ttu-id="116d9-186">Esempi</span><span class="sxs-lookup"><span data-stu-id="116d9-186">Examples</span></span>

### <a name="tracing-exception-logger"></a><span data-ttu-id="116d9-187">Traccia del logger delle eccezioni</span><span class="sxs-lookup"><span data-stu-id="116d9-187">Tracing Exception Logger</span></span>

<span data-ttu-id="116d9-188">Il logger di eccezioni seguente invia i dati dell'eccezione alle origini di traccia configurate (inclusa la finestra di output di debug in Visual Studio).</span><span class="sxs-lookup"><span data-stu-id="116d9-188">The exception logger below send exception data to configured Trace sources (including the Debug output window in Visual Studio).</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample6.cs)]

### <a name="custom-error-message-exception-handler"></a><span data-ttu-id="116d9-189">Gestore di eccezioni del messaggio di errore personalizzato</span><span class="sxs-lookup"><span data-stu-id="116d9-189">Custom Error Message Exception Handler</span></span>

<span data-ttu-id="116d9-190">Di seguito viene prodotta una risposta di errore personalizzata ai client, incluso un indirizzo di posta elettronica per contattare il supporto tecnico.</span><span class="sxs-lookup"><span data-stu-id="116d9-190">The following below produces a custom error response to clients, including an email address for contacting support.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample7.cs)]

## <a name="registering-exception-filters"></a><span data-ttu-id="116d9-191">Registrazione dei filtri eccezioni</span><span class="sxs-lookup"><span data-stu-id="116d9-191">Registering Exception Filters</span></span>

<span data-ttu-id="116d9-192">Se si usa il modello di progetto "applicazione Web MVC 4 ASP.NET" per creare il progetto, inserire il codice di configurazione dell'API Web all'interno della classe `WebApiConfig` nella cartella *app/_Start* :</span><span class="sxs-lookup"><span data-stu-id="116d9-192">If you use the "ASP.NET MVC 4 Web Application" project template to create your project, put your Web API configuration code inside the `WebApiConfig` class, in the *App/_Start* folder:</span></span>

[!code-csharp[Main](exception-handling/samples/sample7.cs?highlight=5)]

## <a name="appendix-base-class-details"></a><span data-ttu-id="116d9-193">Appendice: dettagli della classe di base</span><span class="sxs-lookup"><span data-stu-id="116d9-193">Appendix: Base Class Details</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample8.cs)]
