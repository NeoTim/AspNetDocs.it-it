---
uid: web-api/overview/error-handling/web-api-global-error-handling
title: Gestione degli errori globali in ASP.NET API Web 2 - ASP.NET 4.x
author: davidmatson
description: Panoramica della gestione degli errori globale in ASP.NET API Web 2 per ASP.NET 4.x.
ms.author: riande
ms.date: 02/03/2014
ms.custom: seoapril2019
ms.assetid: bffd7863-f63b-4b23-a13c-372b5492e9fb
msc.legacyurl: /web-api/overview/error-handling/web-api-global-error-handling
msc.type: authoredcontent
ms.openlocfilehash: 5ff54d2e4ed881ce927d0a401fb79d9b8bc5b8a1
ms.sourcegitcommit: ce28244209db8615bc9bdd576a2e2c88174d318d
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/06/2020
ms.locfileid: "80675423"
---
# <a name="global-error-handling-in-aspnet-web-api-2"></a><span data-ttu-id="bdda6-103">Gestione degli errori globali in ASP.NET API Web 2</span><span class="sxs-lookup"><span data-stu-id="bdda6-103">Global Error Handling in ASP.NET Web API 2</span></span>

<span data-ttu-id="bdda6-104">di [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="bdda6-104">by [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="bdda6-105">In questo argomento viene fornita una panoramica della gestione degli errori globale in ASP.NET API Web 2 per ASP.NET 4.x.</span><span class="sxs-lookup"><span data-stu-id="bdda6-105">This topic provides an overview of global error handling in ASP.NET Web API 2 for ASP.NET 4.x.</span></span> <span data-ttu-id="bdda6-106">Oggi non c'è un modo semplice nell'API Web per registrare o gestire gli errori a livello globale.</span><span class="sxs-lookup"><span data-stu-id="bdda6-106">Today there's no easy way in Web API to log or handle errors globally.</span></span> <span data-ttu-id="bdda6-107">Alcune eccezioni non gestite possono essere elaborate tramite [filtri eccezioni](exception-handling.md), ma esistono diversi casi che i filtri eccezioni non sono in grado di gestire.</span><span class="sxs-lookup"><span data-stu-id="bdda6-107">Some unhandled exceptions can be processed via [exception filters](exception-handling.md), but there are a number of cases that exception filters can't handle.</span></span> <span data-ttu-id="bdda6-108">Ad esempio:</span><span class="sxs-lookup"><span data-stu-id="bdda6-108">For example:</span></span>

1. <span data-ttu-id="bdda6-109">Eccezioni generate dai costruttori dei controller.</span><span class="sxs-lookup"><span data-stu-id="bdda6-109">Exceptions thrown from controller constructors.</span></span>
2. <span data-ttu-id="bdda6-110">Eccezioni generate dai gestori di messaggi.</span><span class="sxs-lookup"><span data-stu-id="bdda6-110">Exceptions thrown from message handlers.</span></span>
3. <span data-ttu-id="bdda6-111">Eccezioni generate durante il routing.</span><span class="sxs-lookup"><span data-stu-id="bdda6-111">Exceptions thrown during routing.</span></span>
4. <span data-ttu-id="bdda6-112">Eccezioni generate durante la serializzazione del contenuto della risposta.</span><span class="sxs-lookup"><span data-stu-id="bdda6-112">Exceptions thrown during response content serialization.</span></span>

<span data-ttu-id="bdda6-113">Vogliamo fornire un modo semplice e coerente per registrare e gestire (ove possibile) queste eccezioni.</span><span class="sxs-lookup"><span data-stu-id="bdda6-113">We want to provide a simple, consistent way to log and handle (where possible) these exceptions.</span></span> 

<span data-ttu-id="bdda6-114">Ci sono due casi principali per la gestione delle eccezioni, il caso in cui siamo in grado di inviare una risposta di errore e il caso in cui tutto quello che possiamo fare è registrare l'eccezione.</span><span class="sxs-lookup"><span data-stu-id="bdda6-114">There are two major cases for handling exceptions, the case where we are able to send an error response and the case where all we can do is log the exception.</span></span> <span data-ttu-id="bdda6-115">Un esempio per quest'ultimo caso è quando viene generata un'eccezione nel mezzo del contenuto della risposta di streaming; in questo caso è troppo tardi per inviare un nuovo messaggio di risposta poiché il codice di stato, le intestazioni e il contenuto parziale sono già passati attraverso la rete, quindi interrompiamo semplicemente la connessione.</span><span class="sxs-lookup"><span data-stu-id="bdda6-115">An example for the latter case is when an exception is thrown in the middle of streaming response content; in that case it is too late to send a new response message since the status code, headers, and partial content have already gone across the wire, so we simply abort the connection.</span></span> <span data-ttu-id="bdda6-116">Anche se l'eccezione non può essere gestita per produrre un nuovo messaggio di risposta, è comunque supportata la registrazione dell'eccezione.</span><span class="sxs-lookup"><span data-stu-id="bdda6-116">Even though the exception can't be handled to produce a new response message, we still support logging the exception.</span></span> <span data-ttu-id="bdda6-117">Nei casi in cui è possibile rilevare un errore, è possibile restituire una risposta di errore appropriata, come illustrato di seguito:In cases where we can detect an error, we can return an appropriate error response as shown in the following:</span><span class="sxs-lookup"><span data-stu-id="bdda6-117">In cases where we can detect an error, we can return an appropriate error response as shown in the following:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample1.cs?highlight=6)]

### <a name="existing-options"></a><span data-ttu-id="bdda6-118">Opzioni esistenti</span><span class="sxs-lookup"><span data-stu-id="bdda6-118">Existing Options</span></span>

<span data-ttu-id="bdda6-119">Oltre ai [filtri](exception-handling.md) [eccezioni, i gestori di messaggi](../advanced/http-message-handlers.md) possono essere utilizzati oggi per osservare tutte le risposte di livello 500, ma agire su tali risposte è difficile, in quanto mancano di contesto sull'errore originale.</span><span class="sxs-lookup"><span data-stu-id="bdda6-119">In addition to [exception filters](exception-handling.md), [message handlers](../advanced/http-message-handlers.md) can be used today to observe all 500-level responses, but acting on those responses is difficult, as they lack context about the original error.</span></span> <span data-ttu-id="bdda6-120">I gestori di messaggi hanno anche alcune delle stesse limitazioni dei filtri eccezioni per quanto riguarda i casi che possono gestire.</span><span class="sxs-lookup"><span data-stu-id="bdda6-120">Message handlers also have some of the same limitations as exception filters regarding the cases they can handle.</span></span> <span data-ttu-id="bdda6-121">Mentre l'API Web dispone di un'infrastruttura di traccia che acquisisce le condizioni di errore l'infrastruttura di traccia è a scopo diagnostico e non è progettata o adatta per l'esecuzione in ambienti di produzione.</span><span class="sxs-lookup"><span data-stu-id="bdda6-121">While Web API does have tracing infrastructure that captures error conditions the tracing infrastructure is for diagnostics purposes and is not designed or suited for running in production environments.</span></span> <span data-ttu-id="bdda6-122">La gestione e la registrazione delle eccezioni globali devono essere servizi che possono essere eseguiti durante l'ambiente di produzione ed essere collegati a soluzioni di monitoraggio esistenti , ad esempio [ELMAH](https://code.google.com/p/elmah/).</span><span class="sxs-lookup"><span data-stu-id="bdda6-122">Global exception handling and logging should be services that can run during production and be plugged into existing monitoring solutions (for example, [ELMAH](https://code.google.com/p/elmah/)).</span></span>

### <a name="solution-overview"></a><span data-ttu-id="bdda6-123">Panoramica della soluzione</span><span class="sxs-lookup"><span data-stu-id="bdda6-123">Solution Overview</span></span>

 <span data-ttu-id="bdda6-124">Forniamo due nuovi servizi sostituibili dall'utente, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) e IExceptionHandler, per registrare e gestire le eccezioni non gestite.</span><span class="sxs-lookup"><span data-stu-id="bdda6-124">We provide two new user-replaceable services, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) and IExceptionHandler, to log and handle unhandled exceptions.</span></span> <span data-ttu-id="bdda6-125">I servizi sono molto simili, con due differenze principali:</span><span class="sxs-lookup"><span data-stu-id="bdda6-125">The services are very similar, with two main differences:</span></span>

1. <span data-ttu-id="bdda6-126">Supportiamo la registrazione di più logger di eccezioni, ma solo un singolo gestore di eccezioni.</span><span class="sxs-lookup"><span data-stu-id="bdda6-126">We support registering multiple exception loggers but only a single exception handler.</span></span>
2. <span data-ttu-id="bdda6-127">I logger di eccezioni vengono sempre chiamati, anche se stiamo per interrompere la connessione.</span><span class="sxs-lookup"><span data-stu-id="bdda6-127">Exception loggers always get called, even if we're about to abort the connection.</span></span> <span data-ttu-id="bdda6-128">I gestori di eccezioni vengono chiamati solo quando siamo ancora in grado di scegliere quale messaggio di risposta inviare.</span><span class="sxs-lookup"><span data-stu-id="bdda6-128">Exception handlers only get called when we're still able to choose which response message to send.</span></span>

<span data-ttu-id="bdda6-129">Entrambi i servizi forniscono l'accesso a un contesto di eccezione contenente informazioni rilevanti dal punto in cui è stata rilevata l'eccezione, in particolare [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), l'eccezione generata e l'origine dell'eccezione (dettagli di seguito).</span><span class="sxs-lookup"><span data-stu-id="bdda6-129">Both services provide access to an exception context containing relevant information from the point where the exception was detected, particularly the [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), the [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), the thrown exception and the exception source (details below).</span></span>

### <a name="design-principles"></a><span data-ttu-id="bdda6-130">Principi di progettazione</span><span class="sxs-lookup"><span data-stu-id="bdda6-130">Design Principles</span></span>

1. <span data-ttu-id="bdda6-131">**Nessuna modifica di rilievo** Poiché questa funzionalità viene aggiunta in una versione secondaria, un vincolo importante che influisce sulla soluzione è che non vengono apportate modifiche di rilievo, ai contratti di tipo o al comportamento.</span><span class="sxs-lookup"><span data-stu-id="bdda6-131">**No breaking changes** Because this functionality is being added in a minor release, one important constraint impacting the solution is that there be no breaking changes, either to type contracts or to behavior.</span></span> <span data-ttu-id="bdda6-132">Questo vincolo escludeva alcune operazioni di pulizia che avremmo voluto eseguire in termini di blocchi catch esistenti che trasformano le eccezioni in 500 risposte.</span><span class="sxs-lookup"><span data-stu-id="bdda6-132">This constraint ruled out some cleanup we would like to have done in terms of existing catch blocks turning exceptions into 500 responses.</span></span> <span data-ttu-id="bdda6-133">Questa pulizia aggiuntiva è qualcosa che potremmo prendere in considerazione per una successiva versione principale.</span><span class="sxs-lookup"><span data-stu-id="bdda6-133">This additional cleanup is something we might consider for a subsequent major release.</span></span> <span data-ttu-id="bdda6-134">Se questo è importante per voi si prega di votare su di esso a [ASP.NET voce utente WEB API](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span><span class="sxs-lookup"><span data-stu-id="bdda6-134">If this is important to you please vote on it at [ASP.NET Web API user voice](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span></span>
2. <span data-ttu-id="bdda6-135">**Mantenere la coerenza con i costrutti API Web** La pipeline di filtro dell'API Web è un ottimo modo per gestire i problemi trasversali con la flessibilità di applicare la logica in un ambito globale specifico dell'azione, specifico del controller o.</span><span class="sxs-lookup"><span data-stu-id="bdda6-135">**Maintaining consistency with Web API constructs** Web API's filter pipeline is a great way to handle cross-cutting concerns with the flexibility of applying the logic at an action-specific, controller-specific or global scope.</span></span> <span data-ttu-id="bdda6-136">I filtri, inclusi i filtri eccezioni, hanno sempre contesti di azione e controller, anche se registrati nell'ambito globale.</span><span class="sxs-lookup"><span data-stu-id="bdda6-136">Filters, including exception filters, always have action and controller contexts, even when registered at the global scope.</span></span> <span data-ttu-id="bdda6-137">Tale contratto ha senso per i filtri, ma significa che i filtri di eccezione, anche quelli con ambito globale, non sono adatti per alcuni casi di gestione delle eccezioni, ad esempio le eccezioni dai gestori di messaggi, in cui non esiste alcun contesto di azione o controller.</span><span class="sxs-lookup"><span data-stu-id="bdda6-137">That contract makes sense for filters, but it means that exception filters, even globally scoped ones, aren't a good fit for some exception handling cases, such as exceptions from message handlers, where no action or controller context exists.</span></span> <span data-ttu-id="bdda6-138">Se vogliamo usare l'ambito flessibile offerto dai filtri per la gestione delle eccezioni, abbiamo ancora bisogno di filtri eccezioni.</span><span class="sxs-lookup"><span data-stu-id="bdda6-138">If we want to use the flexible scoping afforded by filters for exception handling, we still need exception filters.</span></span> <span data-ttu-id="bdda6-139">Ma se abbiamo bisogno di gestire le eccezioni all'esterno di un contesto del controller, abbiamo anche bisogno di un costrutto separato per la gestione completa degli errori globali (qualcosa senza i vincoli di contesto del controller e del contesto dell'azione).</span><span class="sxs-lookup"><span data-stu-id="bdda6-139">But if we need to handle exception outside of a controller context, we also need a separate construct for full global error handling (something without the controller context and action context constraints).</span></span>

### <a name="when-to-use"></a><span data-ttu-id="bdda6-140">Utilizzo</span><span class="sxs-lookup"><span data-stu-id="bdda6-140">When to Use</span></span>

- <span data-ttu-id="bdda6-141">I logger di eccezione sono la soluzione per visualizzare tutte le eccezioni non gestite rilevate dall'API Web.</span><span class="sxs-lookup"><span data-stu-id="bdda6-141">Exception loggers are the solution to seeing all unhandled exception caught by Web API.</span></span>
- <span data-ttu-id="bdda6-142">I gestori di eccezioni sono la soluzione per personalizzare tutte le possibili risposte alle eccezioni non gestite rilevate dall'API Web.</span><span class="sxs-lookup"><span data-stu-id="bdda6-142">Exception handlers are the solution for customizing all possible responses to unhandled exceptions caught by Web API.</span></span>
- <span data-ttu-id="bdda6-143">I filtri eccezioni sono la soluzione più semplice per l'elaborazione del sottoinsieme di eccezioni non gestite correlate a un'azione o a un controller specifico.</span><span class="sxs-lookup"><span data-stu-id="bdda6-143">Exception filters are the easiest solution for processing the subset unhandled exceptions related to a specific action or controller.</span></span>

### <a name="service-details"></a><span data-ttu-id="bdda6-144">Dettagli del servizio</span><span class="sxs-lookup"><span data-stu-id="bdda6-144">Service Details</span></span>

 <span data-ttu-id="bdda6-145">Il logger di eccezione e le interfacce del servizio del gestore delle eccezioni sono semplici metodi asincroni che utilizzano i rispettivi contesti:The exception logger and handler service interfaces are simple async methods taking the respective contexts:</span><span class="sxs-lookup"><span data-stu-id="bdda6-145">The exception logger and handler service interfaces are simple async methods taking the respective contexts:</span></span> 

[!code-csharp[Main](web-api-global-error-handling/samples/sample2.cs)]

 <span data-ttu-id="bdda6-146">Forniamo anche le classi di base per entrambe queste interfacce.</span><span class="sxs-lookup"><span data-stu-id="bdda6-146">We also provide base classes for both of these interfaces.</span></span> <span data-ttu-id="bdda6-147">L'override dei metodi principali (sync o async) è tutto ciò che è necessario per registrare o gestire gli orari consigliati.</span><span class="sxs-lookup"><span data-stu-id="bdda6-147">Overriding the core (sync or async) methods is all that is required to log or handle at the recommended times.</span></span> <span data-ttu-id="bdda6-148">Per la `ExceptionLogger` registrazione, la classe di base garantirà che il metodo di registrazione di base viene chiamato solo una volta per ogni eccezione (anche se in seguito si propaga più in alto nello stack di chiamate e viene intercettato nuovamente).</span><span class="sxs-lookup"><span data-stu-id="bdda6-148">For logging, the `ExceptionLogger` base class will ensure that the core logging method is only called once for each exception (even if it later propagates further up the call stack and is caught again).</span></span> <span data-ttu-id="bdda6-149">La `ExceptionHandler` classe base chiamerà il metodo di gestione principale solo per le eccezioni all'inizio dello stack di chiamate, ignorando i blocchi catch annidati legacy.</span><span class="sxs-lookup"><span data-stu-id="bdda6-149">The `ExceptionHandler` base class will call the core handling method only for exceptions at the top of the call stack, ignoring legacy nested catch blocks.</span></span> <span data-ttu-id="bdda6-150">(Le versioni semplificate di queste classi di base sono nell'appendice sottostante.) Entrambi `IExceptionLogger` `IExceptionHandler` e ricevere informazioni sull'eccezione tramite un `ExceptionContext`file .</span><span class="sxs-lookup"><span data-stu-id="bdda6-150">(Simplified versions of these base classes are in the appendix below.) Both `IExceptionLogger` and `IExceptionHandler` receive information about the exception via an `ExceptionContext`.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample3.cs)]

<span data-ttu-id="bdda6-151">Quando il framework chiama un logger di eccezione `Exception` o `Request`un gestore di eccezioni, fornirà sempre un e un oggetto .</span><span class="sxs-lookup"><span data-stu-id="bdda6-151">When the framework calls an exception logger or an exception handler, it will always provide an `Exception` and a `Request`.</span></span> <span data-ttu-id="bdda6-152">Fatta eccezione per gli unit `RequestContext`test, fornirà sempre un .</span><span class="sxs-lookup"><span data-stu-id="bdda6-152">Except for unit testing, it will also always provide a `RequestContext`.</span></span> <span data-ttu-id="bdda6-153">Raramente fornirà `ControllerContext` `ActionContext` a (solo quando si chiama dal blocco catch per i filtri eccezioni).</span><span class="sxs-lookup"><span data-stu-id="bdda6-153">It will rarely provide a `ControllerContext` and `ActionContext` (only when calling from the catch block for exception filters).</span></span> <span data-ttu-id="bdda6-154">Esso fornirà molto `Response`raramente un (solo in alcuni casi di IIS quando nel bel mezzo del tentativo di scrivere la risposta).</span><span class="sxs-lookup"><span data-stu-id="bdda6-154">It will very rarely provide a `Response`(only in certain IIS cases when in the middle of trying to write the response).</span></span> <span data-ttu-id="bdda6-155">Si noti che, poiché alcune di queste proprietà possono essere `null` spetta al consumer controllare prima `null` di accedere ai membri della classe di eccezione.`CatchBlock`</span><span class="sxs-lookup"><span data-stu-id="bdda6-155">Note that because some of these properties may be `null` it is up to the consumer to check for `null` before accessing members of the exception class.`CatchBlock`</span></span> <span data-ttu-id="bdda6-156">è una stringa che indica quale blocco catch ha visto l'eccezione.</span><span class="sxs-lookup"><span data-stu-id="bdda6-156">is a string indicating which catch block saw the exception.</span></span> <span data-ttu-id="bdda6-157">Le stringhe di blocco catch sono le seguenti:The catch block strings are as follows:</span><span class="sxs-lookup"><span data-stu-id="bdda6-157">The catch block strings are as follows:</span></span>

- <span data-ttu-id="bdda6-158">HttpServer (metodo SendAsync)</span><span class="sxs-lookup"><span data-stu-id="bdda6-158">HttpServer (SendAsync method)</span></span>
- <span data-ttu-id="bdda6-159">HttpControllerDispatcher (metodo SendAsync)</span><span class="sxs-lookup"><span data-stu-id="bdda6-159">HttpControllerDispatcher (SendAsync method)</span></span>
- <span data-ttu-id="bdda6-160">HttpBatchHandler (metodo SendAsync)</span><span class="sxs-lookup"><span data-stu-id="bdda6-160">HttpBatchHandler (SendAsync method)</span></span>
- <span data-ttu-id="bdda6-161">IExceptionFilter (elaborazione di ApiController della pipeline del filtro eccezioni in ExecuteAsync)</span><span class="sxs-lookup"><span data-stu-id="bdda6-161">IExceptionFilter (ApiController's processing of the exception filter pipeline in ExecuteAsync)</span></span>
- <span data-ttu-id="bdda6-162">Host OWIN:</span><span class="sxs-lookup"><span data-stu-id="bdda6-162">OWIN host:</span></span>

    - <span data-ttu-id="bdda6-163">HttpMessageHandlerAdapter.BufferResponseContentAsync (per l'output di buffer)</span><span class="sxs-lookup"><span data-stu-id="bdda6-163">HttpMessageHandlerAdapter.BufferResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="bdda6-164">HttpMessageHandlerAdapter.CopyResponseContentAsync (per l'output di flusso)</span><span class="sxs-lookup"><span data-stu-id="bdda6-164">HttpMessageHandlerAdapter.CopyResponseContentAsync (for streaming output)</span></span>
- <span data-ttu-id="bdda6-165">Host Web:</span><span class="sxs-lookup"><span data-stu-id="bdda6-165">Web host:</span></span>

    - <span data-ttu-id="bdda6-166">HttpControllerHandler.WriteBufferedResponseContentAsync (per l'output di buffer)</span><span class="sxs-lookup"><span data-stu-id="bdda6-166">HttpControllerHandler.WriteBufferedResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="bdda6-167">HttpControllerHandler.WriteStreamedResponseContentAsync (per l'output di flusso)HttpControllerHandler.WriteStreamedResponseContentAsync (for streaming output)</span><span class="sxs-lookup"><span data-stu-id="bdda6-167">HttpControllerHandler.WriteStreamedResponseContentAsync (for streaming output)</span></span>
    - <span data-ttu-id="bdda6-168">HttpControllerHandler.WriteErrorResponseContentAsync (per errori nel recupero degli errori in modalità di output memorizzato nel buffer)</span><span class="sxs-lookup"><span data-stu-id="bdda6-168">HttpControllerHandler.WriteErrorResponseContentAsync (for failures in error recovery under buffered output mode)</span></span>

<span data-ttu-id="bdda6-169">L'elenco delle stringhe di blocco catch è disponibile anche tramite proprietà readonly statiche.</span><span class="sxs-lookup"><span data-stu-id="bdda6-169">The list of catch block strings is also available via static readonly properties.</span></span> <span data-ttu-id="bdda6-170">(La stringa di blocco catch di base si trova sul static ExceptionCatchBlocks; il resto viene visualizzato in una classe statica ogni per OWIN e host web).`IsTopLevelCatchBlock`</span><span class="sxs-lookup"><span data-stu-id="bdda6-170">(The core catch block string are on the static ExceptionCatchBlocks; the remainder appear on one static class each for OWIN and web host).`IsTopLevelCatchBlock`</span></span> <span data-ttu-id="bdda6-171">è utile per seguire il modello consigliato di gestione delle eccezioni solo all'inizio dello stack di chiamate.</span><span class="sxs-lookup"><span data-stu-id="bdda6-171">is helpful for following the recommended pattern of handling exceptions only at the top of the call stack.</span></span> <span data-ttu-id="bdda6-172">Anziché trasformare le eccezioni in 500 risposte ovunque si verifichi un blocco catch annidato, un gestore di eccezioni può consentire la propagazione delle eccezioni fino a quando non stanno per essere visualizzate dall'host.</span><span class="sxs-lookup"><span data-stu-id="bdda6-172">Rather than turning exceptions into 500 responses anywhere a nested catch block occurs, an exception handler can let exceptions propagate until they are about to be seen by the host.</span></span>

<span data-ttu-id="bdda6-173">Oltre al `ExceptionContext`, un logger ottiene un'altra `ExceptionLoggerContext`informazione tramite il pieno :</span><span class="sxs-lookup"><span data-stu-id="bdda6-173">In addition to the `ExceptionContext`, a logger gets one more piece of information via the full `ExceptionLoggerContext`:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample4.cs)]

<span data-ttu-id="bdda6-174">La seconda `CanBeHandled`proprietà, , consente a un logger di identificare un'eccezione che non può essere gestita.</span><span class="sxs-lookup"><span data-stu-id="bdda6-174">The second property, `CanBeHandled`, allows a logger to identify an exception that cannot be handled.</span></span> <span data-ttu-id="bdda6-175">Quando la connessione sta per essere interrotta e non è possibile inviare alcun nuovo messaggio di risposta, verranno chiamati i logger ma il gestore ***non*** verrà chiamato e i logger possono identificare questo scenario da questa proprietà.</span><span class="sxs-lookup"><span data-stu-id="bdda6-175">When the connection is about to be aborted and no new response message can be sent, the loggers will be called but the handler will ***not*** be called, and the loggers can identify this scenario from this property.</span></span>

<span data-ttu-id="bdda6-176">Oltre a `ExceptionContext`, un gestore ottiene un'altra `ExceptionHandlerContext` proprietà che può impostare sul full per gestire l'eccezione:</span><span class="sxs-lookup"><span data-stu-id="bdda6-176">In additional to the `ExceptionContext`, a handler gets one more property it can set on the full `ExceptionHandlerContext` to handle the exception:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample5.cs)]

<span data-ttu-id="bdda6-177">Un gestore di eccezioni indica che ha `Result` gestito un'eccezione impostando la proprietà su un risultato dell'azione, ad esempio [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx)o un risultato personalizzato.</span><span class="sxs-lookup"><span data-stu-id="bdda6-177">An exception handler indicates that it has handled an exception by setting the `Result` property to an action result (for example, an [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx), or a custom result).</span></span> <span data-ttu-id="bdda6-178">Se `Result` la proprietà è null, l'eccezione non è gestita e l'eccezione originale verrà generata nuovamente.</span><span class="sxs-lookup"><span data-stu-id="bdda6-178">If the `Result` property is null, the exception is unhandled and the original exception will be re-thrown.</span></span>

<span data-ttu-id="bdda6-179">Per le eccezioni all'inizio dello stack di chiamate, è stato eseguito un passaggio aggiuntivo per garantire che la risposta sia appropriata per i chiamanti dell'API.</span><span class="sxs-lookup"><span data-stu-id="bdda6-179">For exceptions at the top of the call stack, we took an extra step to ensure the response is appropriate for API callers.</span></span> <span data-ttu-id="bdda6-180">Se l'eccezione si propaga fino all'host, il chiamante vedrà la schermata gialla di morte o qualche altra risposta fornita dall'host che è in genere HTML e non in genere una risposta di errore API appropriata.</span><span class="sxs-lookup"><span data-stu-id="bdda6-180">If the exception propagates up to the host, the caller would see the yellow screen of death or some other host provided response which is typically HTML and not usually an appropriate API error response.</span></span> <span data-ttu-id="bdda6-181">In questi casi, il Result inizia non null e solo se un `null` gestore di eccezioni personalizzato imposta in modo esplicito su (non gestito) l'eccezione si propagherà all'host.</span><span class="sxs-lookup"><span data-stu-id="bdda6-181">In these cases, the Result starts out non-null, and only if a custom exception handler explicitly sets it back to `null` (unhandled) will the exception propagate to the host.</span></span> <span data-ttu-id="bdda6-182">L'impostazione di in questi casi può essere utile per due scenari:Setting `Result` to `null` in such cases can be useful for two scenarios:</span><span class="sxs-lookup"><span data-stu-id="bdda6-182">Setting `Result` to `null` in such cases can be useful for two scenarios:</span></span>

1. <span data-ttu-id="bdda6-183">API Web ospitata da OWIN con middleware personalizzato di gestione delle eccezioni registrato prima/esterno all'API Web.</span><span class="sxs-lookup"><span data-stu-id="bdda6-183">OWIN hosted Web API with custom exception handling middleware registered before/outside Web API.</span></span>
2. <span data-ttu-id="bdda6-184">Debug locale tramite un browser, dove la schermata gialla di morte è in realtà una risposta utile per un'eccezione non gestita.</span><span class="sxs-lookup"><span data-stu-id="bdda6-184">Local debugging via a browser, where the yellow screen of death is actually a helpful response for an unhandled exception.</span></span>

<span data-ttu-id="bdda6-185">Sia per i logger di eccezioni che per i gestori di eccezioni, non viene eseguito alcuna operazione di ripristino se il logger o il gestore stesso genera un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="bdda6-185">For both exception loggers and exception handlers, we don't do anything to recover if the logger or handler itself throws an exception.</span></span> <span data-ttu-id="bdda6-186">(Oltre a lasciare che l'eccezione si propaghi, lasciare un feedback nella parte inferiore di questa pagina se si dispone di un approccio migliore.) Il contratto per i logger e i gestori di eccezioni è che non devono consentire che le eccezioni si propaghino ai relativi chiamanti; in caso contrario, l'eccezione si propagherà, spesso fino all'host generando un errore HTML (ad esempio ASP. Schermata gialla di NET) viene inviata al client (che in genere non è l'opzione preferita per i chiamanti API che si aspettano JSON o XML).</span><span class="sxs-lookup"><span data-stu-id="bdda6-186">(Other than letting the exception propagate, leave feedback at the bottom of this page if you have a better approach.) The contract for exception loggers and handlers is that they should not let exceptions propagate up to their callers; otherwise, the exception will just propagate, often all the way to the host resulting in an HTML error (like ASP.NET's yellow screen) being sent back to the client (which usually isn't the preferred option for API callers that expect JSON or XML).</span></span>

## <a name="examples"></a><span data-ttu-id="bdda6-187">Esempi</span><span class="sxs-lookup"><span data-stu-id="bdda6-187">Examples</span></span>

### <a name="tracing-exception-logger"></a><span data-ttu-id="bdda6-188">Logger di eccezioni di tracciaTracing Exception Logger</span><span class="sxs-lookup"><span data-stu-id="bdda6-188">Tracing Exception Logger</span></span>

<span data-ttu-id="bdda6-189">Il logger di eccezione riportato di seguito invia i dati delle eccezioni alle origini di traccia configurate (inclusa la finestra di output di Debug in Visual Studio).</span><span class="sxs-lookup"><span data-stu-id="bdda6-189">The exception logger below sends exception data to configured Trace sources (including the Debug output window in Visual Studio).</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample6.cs)]

### <a name="custom-error-message-exception-handler"></a><span data-ttu-id="bdda6-190">Gestore eccezioni messaggio di errore personalizzatoCustom Error Message Exception Handler</span><span class="sxs-lookup"><span data-stu-id="bdda6-190">Custom Error Message Exception Handler</span></span>

<span data-ttu-id="bdda6-191">Il gestore di eccezioni seguente produce una risposta di errore personalizzata ai client, incluso un indirizzo di posta elettronica per contattare il supporto.</span><span class="sxs-lookup"><span data-stu-id="bdda6-191">The exception handler below produces a custom error response to clients, including an email address for contacting support.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample7.cs)]

## <a name="registering-exception-filters"></a><span data-ttu-id="bdda6-192">Registrazione dei filtri eccezioni</span><span class="sxs-lookup"><span data-stu-id="bdda6-192">Registering Exception Filters</span></span>

<span data-ttu-id="bdda6-193">Se si utilizza il modello di progetto "ASP.NET applicazione Web MVC 4" `WebApiConfig` per creare il progetto, inserire il codice di configurazione dell'API Web all'interno della classe, nella cartella *App_Start:*</span><span class="sxs-lookup"><span data-stu-id="bdda6-193">If you use the "ASP.NET MVC 4 Web Application" project template to create your project, put your Web API configuration code inside the `WebApiConfig` class, in the *App_Start* folder:</span></span>

[!code-csharp[Main](exception-handling/samples/sample7.cs?highlight=5)]

## <a name="appendix-base-class-details"></a><span data-ttu-id="bdda6-194">Appendice: Dettagli della classe baseAppendix: Base Class Details</span><span class="sxs-lookup"><span data-stu-id="bdda6-194">Appendix: Base Class Details</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample8.cs)]
