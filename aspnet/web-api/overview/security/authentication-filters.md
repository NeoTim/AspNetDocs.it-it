---
uid: web-api/overview/security/authentication-filters
title: Filtri di autenticazione nell'API Web ASP.NET 2 | Microsoft Docs
author: MikeWasson
description: Un filtro di autenticazione è un componente che consente di autenticare una richiesta HTTP. Web API 2 e MVC 5 supportano entrambi i filtri di autenticazione, ma differiscono leggermente...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: a14facad4cbd0f9be1ff7bde2667f61ec8cc2a14
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/01/2019
ms.locfileid: "57030008"
---
<a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="7ec4a-104">Filtri di autenticazione nell'API Web ASP.NET 2</span><span class="sxs-lookup"><span data-stu-id="7ec4a-104">Authentication Filters in ASP.NET Web API 2</span></span>
====================
<span data-ttu-id="7ec4a-105">da [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="7ec4a-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="7ec4a-106">Un filtro di autenticazione è un componente che consente di autenticare una richiesta HTTP.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="7ec4a-107">Web API 2 e MVC 5 supportano entrambi i filtri di autenticazione, ma differiscono leggermente, soprattutto per le convenzioni di denominazione per l'interfaccia di filtro.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="7ec4a-108">In questo argomento vengono descritti i filtri di autenticazione di API Web.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-108">This topic describes Web API authentication filters.</span></span>


<span data-ttu-id="7ec4a-109">I filtri di autenticazione consentono di impostare uno schema di autenticazione per singoli controller o azioni.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="7ec4a-110">In questo modo, l'app può supportare i meccanismi di autenticazione diversi per diverse risorse HTTP.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="7ec4a-111">In questo articolo verrà illustrato dal codice il [l'autenticazione di base](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) esempio sul [ http://aspnet.codeplex.com ](http://aspnet.codeplex.com).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-111">In this article, I'll show code from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample on [http://aspnet.codeplex.com](http://aspnet.codeplex.com).</span></span> <span data-ttu-id="7ec4a-112">L'esempio illustra un filtro di autenticazione che implementa lo schema di autenticazione HTTP di base accesso (RFC 2617).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-112">The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="7ec4a-113">Il filtro viene implementato in una classe denominata `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-113">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="7ec4a-114">Non mostrano tutto il codice dell'esempio solo le parti che illustrano come scrivere un filtro di autenticazione.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-114">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="7ec4a-115">Impostazione di un filtro di autenticazione</span><span class="sxs-lookup"><span data-stu-id="7ec4a-115">Setting an Authentication Filter</span></span>

<span data-ttu-id="7ec4a-116">Come altri filtri, filtri di autenticazione possono essere applicato per ogni controller, per ogni azione o a livello globale su tutti i controller API Web.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-116">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="7ec4a-117">Per applicare un filtro di autenticazione a un controller, decorare la classe controller con l'attributo di filtro.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-117">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="7ec4a-118">Il codice seguente imposta la `[IdentityBasicAuthentication]` filtro in una classe controller, che consente l'autenticazione di base per tutte le azioni del controller.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-118">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="7ec4a-119">Per applicare il filtro a un'azione, decorare l'azione con il filtro.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-119">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="7ec4a-120">Il codice seguente imposta la `[IdentityBasicAuthentication]` filtrare il controller `Post` (metodo).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-120">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="7ec4a-121">Per applicare il filtro per tutti i controller API Web, aggiungerlo alla **GlobalConfiguration.Filters**.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-121">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="7ec4a-122">Implementazione di un filtro di autenticazione di API Web</span><span class="sxs-lookup"><span data-stu-id="7ec4a-122">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="7ec4a-123">Nell'API Web, implementano filtri di autenticazione di [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interfaccia.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-123">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="7ec4a-124">Deve anche ereditare **System. Attribute**, in modo da essere applicati come attributi.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-124">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="7ec4a-125">Il **IAuthenticationFilter** interfaccia dispone di due metodi:</span><span class="sxs-lookup"><span data-stu-id="7ec4a-125">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="7ec4a-126">**AuthenticateAsync** autentica la richiesta per la convalida delle credenziali nella richiesta, se presente.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-126">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="7ec4a-127">**ChallengeAsync** aggiunge una richiesta di autenticazione nella risposta HTTP, se necessario.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-127">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="7ec4a-128">Questi metodi corrispondano per il flusso di autenticazione definito in [RFC 2612](http://tools.ietf.org/html/rfc2616) e [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="7ec4a-128">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="7ec4a-129">Il client invia le credenziali nell'intestazione dell'autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-129">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="7ec4a-130">Ciò accade solitamente dopo che il client riceve una risposta 401 (non autorizzato) dal server.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-130">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="7ec4a-131">Tuttavia, un client può inviare le credenziali in tutte le richieste, non solo dopo aver ottenuto un codice 401.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-131">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="7ec4a-132">Se il server non accetta le credenziali, restituisce una risposta 401 (non autorizzato).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-132">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="7ec4a-133">La risposta include un'intestazione Www-Authenticate contenente uno o più problemi.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-133">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="7ec4a-134">Ogni richiesta di verifica specifica uno schema di autenticazione riconosciuto dal server.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-134">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="7ec4a-135">Il server può inoltre restituire 401 da una richiesta anonima.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-135">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="7ec4a-136">In effetti, che è in genere come viene avviato il processo di autenticazione:</span><span class="sxs-lookup"><span data-stu-id="7ec4a-136">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="7ec4a-137">Il client invia una richiesta anonima.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-137">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="7ec4a-138">Il server restituisce 401.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-138">The server returns 401.</span></span>
3. <span data-ttu-id="7ec4a-139">Il client invia nuovamente la richiesta con le credenziali.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-139">The clients resends the request with credentials.</span></span>

<span data-ttu-id="7ec4a-140">Questo flusso include sia *authentication* e *autorizzazione* passaggi.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-140">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="7ec4a-141">L'autenticazione di dimostrare l'identità del client.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-141">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="7ec4a-142">Autorizzazione determina se il client può accedere a una determinata risorsa.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-142">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="7ec4a-143">Nell'API Web, i filtri di autenticazione gestiscono l'autenticazione, ma non di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-143">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="7ec4a-144">Autorizzazione deve essere eseguita da un filtro di autorizzazione o all'interno di azione del controller.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-144">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="7ec4a-145">Ecco il flusso nella pipeline di Web API 2:</span><span class="sxs-lookup"><span data-stu-id="7ec4a-145">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="7ec4a-146">Prima di richiamare un'azione, API Web crea un elenco dei filtri di autenticazione per l'azione.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-146">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="7ec4a-147">Sono inclusi i filtri con ambito globale, ambito del controller e ambito dell'azione.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-147">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="7ec4a-148">Le chiamate API Web **AuthenticateAsync** su ogni filtro nell'elenco.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-148">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="7ec4a-149">Ogni filtro è possibile convalidare le credenziali nella richiesta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-149">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="7ec4a-150">Se qualsiasi filtro convalida correttamente le credenziali, il filtro consente di creare un **IPrincipal** e lo collega alla richiesta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-150">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="7ec4a-151">Un filtro può inoltre generare un errore a questo punto.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-151">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="7ec4a-152">In questo caso, il resto della pipeline non viene eseguito.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-152">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="7ec4a-153">Supponendo che non si è verificato alcun errore, la richiesta viene trasmessa attraverso il resto della pipeline.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-153">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="7ec4a-154">Infine, API Web chiama ogni filtro di autenticazione **ChallengeAsync** (metodo).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-154">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="7ec4a-155">Filtri di usano questo metodo per aggiungere una sfida per la risposta, se necessario.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-155">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="7ec4a-156">In genere, ma non sempre, in questo caso vengono eseguiti in risposta a un errore 401.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-156">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="7ec4a-157">I diagrammi seguenti mostrano due i casi possibili.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-157">The following diagrams show two possible cases.</span></span> <span data-ttu-id="7ec4a-158">Nel primo, il filtro di autenticazione la richiesta viene autenticato correttamente, un filtro di autorizzazione autorizza la richiesta e l'azione del controller restituisce 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-158">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="7ec4a-159">Nel secondo esempio, il filtro di autenticazione autentica la richiesta, ma il filtro di autorizzazione restituisce 401 (non autorizzato).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-159">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="7ec4a-160">In questo caso, non viene richiamata l'azione del controller.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-160">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="7ec4a-161">Il filtro di autenticazione aggiunge un'intestazione Www-Authenticate nella risposta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-161">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="7ec4a-162">Sono possibili altre combinazioni&mdash;, ad esempio, se l'azione del controller consente le richieste anonime, potrebbe essere un filtro di autenticazione, ma nessuna autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-162">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="7ec4a-163">L'implementazione del metodo AuthenticateAsync</span><span class="sxs-lookup"><span data-stu-id="7ec4a-163">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="7ec4a-164">Il **AuthenticateAsync** metodo tenta di autenticare la richiesta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-164">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="7ec4a-165">Ecco la firma del metodo:</span><span class="sxs-lookup"><span data-stu-id="7ec4a-165">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="7ec4a-166">Il **AuthenticateAsync** metodo deve eseguire una delle operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="7ec4a-166">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="7ec4a-167">Nothing (no-op).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-167">Nothing (no-op).</span></span>
2. <span data-ttu-id="7ec4a-168">Creare un **IPrincipal** e impostarla sulla richiesta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-168">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="7ec4a-169">Impostare un risultato di errore.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-169">Set an error result.</span></span>

<span data-ttu-id="7ec4a-170">Opzione (1) indica che la richiesta non aveva le credenziali che comprende il filtro.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-170">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="7ec4a-171">Opzione (2) significa che il filtro viene autenticato correttamente la richiesta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-171">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="7ec4a-172">Opzione (3) significa che la richiesta era credenziali non valide (ad esempio, la password errata), che attiva una risposta di errore.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-172">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="7ec4a-173">Ecco una descrizione generale per l'implementazione **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-173">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="7ec4a-174">Cercare le credenziali nella richiesta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-174">Look for credentials in the request.</span></span>
2. <span data-ttu-id="7ec4a-175">Se non sono disponibili credenziali, non eseguire alcuna operazione e restituire (no-op).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-175">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="7ec4a-176">Se sono presenti credenziali, ma il filtro non riconosce lo schema di autenticazione, non eseguire alcuna operazione e restituire (no-op).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-176">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="7ec4a-177">Un altro filtro nella pipeline può comprendere lo schema.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-177">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="7ec4a-178">Se sono presenti credenziali che comprende il filtro, provare a eseguire l'autenticazione.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-178">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="7ec4a-179">Se le credenziali sono danneggiate, restituito 401 impostando `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-179">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="7ec4a-180">Se le credenziali sono valide, creare un **IPrincipal** e impostare `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-180">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="7ec4a-181">Nel codice seguente viene illustrato il **AuthenticateAsync** metodo le [l'autenticazione di base](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) esempio.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-181">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample.</span></span> <span data-ttu-id="7ec4a-182">I commenti indicano ogni passaggio.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-182">The comments indicate each step.</span></span> <span data-ttu-id="7ec4a-183">Il codice illustra diversi tipi di errore: Un'intestazione di autorizzazione senza credenziali, le credenziali in formato non corretto e nome utente/password non valida.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-183">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="7ec4a-184">L'impostazione di un risultato di errore</span><span class="sxs-lookup"><span data-stu-id="7ec4a-184">Setting an Error Result</span></span>

<span data-ttu-id="7ec4a-185">Se le credenziali sono valide, è necessario impostare il filtro `context.ErrorResult` a un **IHttpActionResult** che crea una risposta di errore.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-185">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="7ec4a-186">Per altre informazioni sulle **IHttpActionResult**, vedere [i risultati dell'azione nell'API Web 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-186">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="7ec4a-187">L'esempio di autenticazione di base include un `AuthenticationFailureResult` classe adatta a questo scopo.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-187">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="7ec4a-188">Implementazione ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="7ec4a-188">Implementing ChallengeAsync</span></span>

<span data-ttu-id="7ec4a-189">Lo scopo del **ChallengeAsync** metodo consiste nell'aggiungere problemi di autenticazione nella risposta, se necessario.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-189">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="7ec4a-190">Ecco la firma del metodo:</span><span class="sxs-lookup"><span data-stu-id="7ec4a-190">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="7ec4a-191">Il metodo viene chiamato su ogni filtro di autenticazione nella pipeline delle richieste.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-191">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="7ec4a-192">È importante comprendere che **ChallengeAsync** viene chiamato *prima* la risposta HTTP è stata creata ed eventualmente anche prima dell'esecuzione di azione del controller.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-192">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="7ec4a-193">Quando **ChallengeAsync** viene chiamato `context.Result` contiene un' **IHttpActionResult**, che viene usato in un secondo momento per creare la risposta HTTP.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-193">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="7ec4a-194">Quando **ChallengeAsync** viene chiamato, non si conosce nulla sulla risposta HTTP ancora.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-194">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="7ec4a-195">Il **ChallengeAsync** metodo deve sostituire il valore originale della `context.Result` con un nuovo **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-195">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="7ec4a-196">Ciò **IHttpActionResult** necessario eseguire il wrapping dell'originale `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-196">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="7ec4a-197">Che denominerò originale **IHttpActionResult** le *risultati interno*e il nuovo **IHttpActionResult** il *risultato outer*.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-197">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="7ec4a-198">Il risultato esterno deve eseguire le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="7ec4a-198">The outer result must do the following:</span></span>

1. <span data-ttu-id="7ec4a-199">Richiamare il risultato interno per creare la risposta HTTP.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-199">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="7ec4a-200">Esaminare la risposta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-200">Examine the response.</span></span>
3. <span data-ttu-id="7ec4a-201">Aggiungere una richiesta di autenticazione per la risposta, se necessario.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-201">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="7ec4a-202">Nell'esempio seguente è tratto dall'esempio autenticazione di base.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-202">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="7ec4a-203">Definisce un **IHttpActionResult** per il risultato esterno.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-203">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="7ec4a-204">Il `InnerResult` proprietà contiene interna **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-204">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="7ec4a-205">Il `Challenge` proprietà rappresenta un'intestazione Www-Authenticate.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-205">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="7ec4a-206">Si noti che **ExecuteAsync** chiama innanzitutto `InnerResult.ExecuteAsync` per creare la risposta HTTP e quindi aggiunge la richiesta di verifica se necessario.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-206">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="7ec4a-207">Controllare il codice di risposta prima di aggiungere la richiesta di verifica.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-207">Check the response code before adding the challenge.</span></span> <span data-ttu-id="7ec4a-208">La maggior parte degli schemi di autenticazione aggiungere solo una richiesta di verifica se la risposta 401, come illustrato di seguito.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-208">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="7ec4a-209">Tuttavia, alcuni schemi di autenticazione si aggiunge una sfida per una risposta di esito positivo.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-209">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="7ec4a-210">Ad esempio, vedere [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="7ec4a-210">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="7ec4a-211">Dato il `AddChallengeOnUnauthorizedResult` classe, il codice effettivamente presente **ChallengeAsync** è semplice.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-211">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="7ec4a-212">È solo creare il risultato e collegarlo a `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-212">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="7ec4a-213">Nota: L'esempio di autenticazione di base consente di astrarre questa logica un po', inserendolo in un metodo di estensione.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-213">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="7ec4a-214">La combinazione di filtri di autenticazione con l'autenticazione a livello di Host</span><span class="sxs-lookup"><span data-stu-id="7ec4a-214">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="7ec4a-215">"L'autenticazione a livello di host" è l'autenticazione eseguita dall'host (ad esempio IIS), prima di framework raggiunge l'API Web di richiesta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-215">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="7ec4a-216">Spesso, è possibile abilitare l'autenticazione a livello di host per il resto dell'applicazione, ma disabilitare la funzionalità di controller API Web.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-216">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="7ec4a-217">Uno scenario tipico è ad esempio, per abilitare l'autenticazione basata su form a livello di host, ma usano l'autenticazione basata su token per l'API Web.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-217">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="7ec4a-218">Per disabilitare l'autenticazione a livello di host all'interno della pipeline di Web API, chiamare `config.SuppressHostPrincipal()` nella configurazione.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-218">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="7ec4a-219">In questo modo, API Web rimuovere il **IPrincipal** da qualsiasi richiesta in entrata della pipeline API Web.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-219">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="7ec4a-220">In effetti, si &quot;ONU-autentica&quot; la richiesta.</span><span class="sxs-lookup"><span data-stu-id="7ec4a-220">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="7ec4a-221">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="7ec4a-221">Additional Resources</span></span>

<span data-ttu-id="7ec4a-222">[Filtri di protezione dell'API Web ASP.NET](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="7ec4a-222">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
