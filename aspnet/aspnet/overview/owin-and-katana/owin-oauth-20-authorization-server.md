---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Server di autorizzazione OAuth 2.0 OWIN | Microsoft Docs
author: hongyes
description: Questa esercitazione illustra come implementare un Server di autorizzazione OAuth 2.0 usa il middleware OWIN OAuth. Questa è un'esercitazione avanzata tale raggruppamento solo...
ms.author: riande
ms.date: 01/28/2019
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: b8451d2d9e346bd5e2f51ba45e48030a5221b549
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/01/2019
ms.locfileid: "57059748"
---
# <a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="395c3-104">Server di autorizzazione OAuth 2.0 OWIN</span><span class="sxs-lookup"><span data-stu-id="395c3-104">OWIN OAuth 2.0 Authorization Server</span></span>

> <span data-ttu-id="395c3-105">Questa esercitazione illustra come implementare un Server di autorizzazione OAuth 2.0 usa il middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="395c3-105">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="395c3-106">Si tratta di un'esercitazione avanzata che illustra solo i passaggi per creare un Server di autorizzazione di OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="395c3-106">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="395c3-107">Questo non è un'esercitazione dettagliata.</span><span class="sxs-lookup"><span data-stu-id="395c3-107">This is not a step by step tutorial.</span></span> <span data-ttu-id="395c3-108">[Scaricare il codice di esempio](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="395c3-108">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="395c3-109">In questa struttura dovrebbe non essere voluta da utilizzare per la creazione di un'app di produzione sicuro.</span><span class="sxs-lookup"><span data-stu-id="395c3-109">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="395c3-110">Questa esercitazione intende fornire solo una struttura su come implementare un Server di autorizzazione OAuth 2.0 usa il middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="395c3-110">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="395c3-111">Versioni del software</span><span class="sxs-lookup"><span data-stu-id="395c3-111">Software versions</span></span>
>
> | <span data-ttu-id="395c3-112">**Illustrato nell'esercitazione**</span><span class="sxs-lookup"><span data-stu-id="395c3-112">**Shown in the tutorial**</span></span> | <span data-ttu-id="395c3-113">**Si integra inoltre con**</span><span class="sxs-lookup"><span data-stu-id="395c3-113">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="395c3-114">Windows 8,1</span><span class="sxs-lookup"><span data-stu-id="395c3-114">Windows 8.1</span></span> | <span data-ttu-id="395c3-115">Windows 10, Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="395c3-115">Windows 10, Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="395c3-116">Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="395c3-116">Visual Studio 2017</span></span>](https://visualstudio.microsoft.com/downloads/)
> | <span data-ttu-id="395c3-117">.NET 4.7.2</span><span class="sxs-lookup"><span data-stu-id="395c3-117">.NET 4.7.2</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="395c3-118">Domande e commenti</span><span class="sxs-lookup"><span data-stu-id="395c3-118">Questions and comments</span></span>
>
> <span data-ttu-id="395c3-119">Se hai domande che non sono direttamente correlate con l'esercitazione, è possibile pubblicarle in [Katana Project su GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="395c3-119">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="395c3-120">Per domande e commenti relativi all'esercitazione, vedere la sezione dei commenti nella parte inferiore della pagina.</span><span class="sxs-lookup"><span data-stu-id="395c3-120">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="395c3-121">Il [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) consente a un'app di terze parti ottenere l'accesso limitato a un servizio HTTP.</span><span class="sxs-lookup"><span data-stu-id="395c3-121">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="395c3-122">Anziché utilizzare le credenziali del proprietario della risorsa per accedere a una risorsa protetta, il client ottenga un token di accesso (ovvero una stringa che denota un ambito specifico, durata e altri attributi di accesso).</span><span class="sxs-lookup"><span data-stu-id="395c3-122">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="395c3-123">I token di accesso vengono rilasciati ai client di terze parti da un server di autorizzazione con l'approvazione del proprietario della risorsa.</span><span class="sxs-lookup"><span data-stu-id="395c3-123">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="395c3-124">Questa esercitazione illustrerà quanto segue:</span><span class="sxs-lookup"><span data-stu-id="395c3-124">This tutorial will cover:</span></span>

- <span data-ttu-id="395c3-125">Come creare un server di autorizzazione per supportare l'autorizzazione quattro tipi di concessione di token di aggiornamento:</span><span class="sxs-lookup"><span data-stu-id="395c3-125">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="395c3-126">Concessione del codice di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="395c3-126">Authorization code grant</span></span>
    - <span data-ttu-id="395c3-127">Concessione implicita</span><span class="sxs-lookup"><span data-stu-id="395c3-127">Implicit Grant</span></span>
    - <span data-ttu-id="395c3-128">Concessione delle credenziali Password proprietario risorsa</span><span class="sxs-lookup"><span data-stu-id="395c3-128">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="395c3-129">Concessione delle credenziali client</span><span class="sxs-lookup"><span data-stu-id="395c3-129">Client Credentials Grant</span></span>
- <span data-ttu-id="395c3-130">Creazione di un server di risorse che è protetta da un token di accesso.</span><span class="sxs-lookup"><span data-stu-id="395c3-130">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="395c3-131">Creazione di client di OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="395c3-131">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="395c3-132">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="395c3-132">Prerequisites</span></span>

- <span data-ttu-id="395c3-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) come indicato nella **le versioni del Software** nella parte superiore della pagina.</span><span class="sxs-lookup"><span data-stu-id="395c3-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="395c3-134">Familiarità con OWIN.</span><span class="sxs-lookup"><span data-stu-id="395c3-134">Familiarity with OWIN.</span></span> <span data-ttu-id="395c3-135">Visualizzare [Introduzione al Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) e [novità OWIN e Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="395c3-135">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="395c3-136">Conoscenza [OAuth](http://tools.ietf.org/html/rfc6749) terminologia, tra cui [ruoli](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), e [concessione di autorizzazione](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="395c3-136">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="395c3-137">[Introduzione a OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) offre una buona introduzione.</span><span class="sxs-lookup"><span data-stu-id="395c3-137">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="395c3-138">Creare un Server di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="395c3-138">Create an Authorization Server</span></span>

<span data-ttu-id="395c3-139">In questa esercitazione, saranno all'incirca sketch su come usare [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) e ASP.NET MVC per creare un server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="395c3-139">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="395c3-140">Ci auguriamo di presto forniscono un download per l'esempio completato, in questa esercitazione include ogni passaggio.</span><span class="sxs-lookup"><span data-stu-id="395c3-140">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="395c3-141">Innanzitutto, creare un'app web vuota denominata *AuthorizationServer* e installare i pacchetti seguenti:</span><span class="sxs-lookup"><span data-stu-id="395c3-141">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="395c3-142">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="395c3-142">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="395c3-143">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="395c3-143">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="395c3-144">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="395c3-144">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="395c3-145">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="395c3-145">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="395c3-146">Microsoft.Owin.Security.Google (o qualsiasi altro account di accesso basati su social network del pacchetto, ad esempio owin)</span><span class="sxs-lookup"><span data-stu-id="395c3-146">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="395c3-147">Aggiungere un [OWIN Startup class](owin-startup-class-detection.md) nella cartella radice del progetto denominata *avvio*.</span><span class="sxs-lookup"><span data-stu-id="395c3-147">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="395c3-148">Creare un *App\_avviare* cartella.</span><span class="sxs-lookup"><span data-stu-id="395c3-148">Create an *App\_Start* folder.</span></span> <span data-ttu-id="395c3-149">Selezionare il *App\_avviare* cartella e utilizzare Maiusc + Alt + A per aggiungere la versione scaricata del *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span><span class="sxs-lookup"><span data-stu-id="395c3-149">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="395c3-150">Il codice riportato sopra consente i cookie e l'autenticazione di Google, che vengono utilizzati dal server di autorizzazione per gestire gli account di accesso dell'applicazione ed esterni.</span><span class="sxs-lookup"><span data-stu-id="395c3-150">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="395c3-151">Il `UseOAuthAuthorizationServer` metodo di estensione è quella di configurare il server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="395c3-151">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="395c3-152">Le opzioni di installazione sono:</span><span class="sxs-lookup"><span data-stu-id="395c3-152">The setup options are:</span></span>

- <span data-ttu-id="395c3-153">`AuthorizeEndpointPath`: Il percorso della richiesta in cui le applicazioni client reindirizzeranno l'agente utente per ottenere gli utenti di fornire il consenso per emettere un token o codice.</span><span class="sxs-lookup"><span data-stu-id="395c3-153">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="395c3-154">Deve iniziare con una barra iniziale, ad esempio, "`/Authorize`".</span><span class="sxs-lookup"><span data-stu-id="395c3-154">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="395c3-155">`TokenEndpointPath`: Le applicazioni client del percorso richiesta comunicano direttamente per ottenere il token di accesso.</span><span class="sxs-lookup"><span data-stu-id="395c3-155">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="395c3-156">Deve iniziare con una barra iniziale, come "/token".</span><span class="sxs-lookup"><span data-stu-id="395c3-156">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="395c3-157">Se il client viene emesso un [client\_segreto](http://tools.ietf.org/html/rfc6749#appendix-A.2), ma deve essere fornita a questo endpoint.</span><span class="sxs-lookup"><span data-stu-id="395c3-157">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="395c3-158">`ApplicationCanDisplayErrors`: Impostare su `true` se l'applicazione web desidera generare una pagina di errore personalizzato per gli errori di convalida client su `/Authorize` endpoint.</span><span class="sxs-lookup"><span data-stu-id="395c3-158">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="395c3-159">È necessario solo per casi in cui non viene reindirizzato il browser all'applicazione client, ad esempio, quando la `client_id` o `redirect_uri` non sono corrette.</span><span class="sxs-lookup"><span data-stu-id="395c3-159">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="395c3-160">Il `/Authorize` endpoint prevede che il "oauth. Errore","oauth. ErrorDescription"e"oauth. Proprietà ErrorUri"vengono aggiunte all'ambiente OWIN.</span><span class="sxs-lookup"><span data-stu-id="395c3-160">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="395c3-161">In caso contrario true, il server di autorizzazione restituirà una pagina di errore predefinita con i dettagli dell'errore.</span><span class="sxs-lookup"><span data-stu-id="395c3-161">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="395c3-162">`AllowInsecureHttp`: True per consentire l'autorizzazione e le richieste di token in arrivo sugli indirizzi URI HTTP e di consentire l'ingresso `redirect_uri` autorizzare indirizzi URI HTTP per i parametri di richiesta.</span><span class="sxs-lookup"><span data-stu-id="395c3-162">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="395c3-163">Security - si tratta solo per lo sviluppo.</span><span class="sxs-lookup"><span data-stu-id="395c3-163">Security - This is for development only.</span></span>
- <span data-ttu-id="395c3-164">`Provider`: Oggetto fornito dall'applicazione per elaborare gli eventi generati dal middleware del Server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="395c3-164">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="395c3-165">L'applicazione deve implementare l'interfaccia completamente o è possibile creare un'istanza di `OAuthAuthorizationServerProvider` e assegnare delegati necessari per questo server supporta i flussi di OAuth.</span><span class="sxs-lookup"><span data-stu-id="395c3-165">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="395c3-166">`AuthorizationCodeProvider`: Produce un codice di autorizzazione monouso da restituire all'applicazione client.</span><span class="sxs-lookup"><span data-stu-id="395c3-166">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="395c3-167">Proteggere l'applicazione per il server OAuth **devono** fornire un'istanza di `AuthorizationCodeProvider` in cui il token prodotto dal `OnCreate/OnCreateAsync` evento viene considerato valido solo per una chiamata a `OnReceive/OnReceiveAsync`.</span><span class="sxs-lookup"><span data-stu-id="395c3-167">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="395c3-168">`RefreshTokenProvider`: Produce un token di aggiornamento che può essere utilizzato per produrre un nuovo token di accesso quando necessario.</span><span class="sxs-lookup"><span data-stu-id="395c3-168">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="395c3-169">Se non specificato il server di autorizzazione non restituirà i token di aggiornamento dal `/Token` endpoint.</span><span class="sxs-lookup"><span data-stu-id="395c3-169">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="395c3-170">Gestione degli account</span><span class="sxs-lookup"><span data-stu-id="395c3-170">Account Management</span></span>

<span data-ttu-id="395c3-171">OAuth non è rilevante dove o come è gestire le informazioni sull'account utente.</span><span class="sxs-lookup"><span data-stu-id="395c3-171">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="395c3-172">Dispone [ASP.NET Identity](../../../identity/index.md) che è responsabile.</span><span class="sxs-lookup"><span data-stu-id="395c3-172">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="395c3-173">In questa esercitazione, si verrà semplificano il codice di gestione di account e assicurarsi che l'utente può eseguire l'accesso tramite middleware OWIN cookie.</span><span class="sxs-lookup"><span data-stu-id="395c3-173">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="395c3-174">Ecco il codice di esempio semplificato per la `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="395c3-174">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="395c3-175">`ValidateClientRedirectUri` viene usato per convalidare il client con il relativo URL di reindirizzamento registrato.</span><span class="sxs-lookup"><span data-stu-id="395c3-175">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="395c3-176">`ValidateClientAuthentication` Controlla l'intestazione di base dello schema e il corpo del form per ottenere le credenziali del client.</span><span class="sxs-lookup"><span data-stu-id="395c3-176">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="395c3-177">La pagina di accesso è la seguente:</span><span class="sxs-lookup"><span data-stu-id="395c3-177">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="395c3-178">Esaminare la IETF OAuth 2 [concessione del codice di autorizzazione](http://tools.ietf.org/html/rfc6749#section-4.1) sezione ora.</span><span class="sxs-lookup"><span data-stu-id="395c3-178">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="395c3-179">**Provider** (nella tabella seguente) viene [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Provider, che è di tipo `OAuthAuthorizationServerProvider`, che contiene tutti gli eventi server OAuth.</span><span class="sxs-lookup"><span data-stu-id="395c3-179">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="395c3-180">Passaggi del flusso dalla sezione di concessione del codice di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="395c3-180">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="395c3-181">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="395c3-181">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="395c3-182">(A) il client avvia il flusso indirizzando l'agente utente del proprietario della risorsa per l'endpoint di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="395c3-182">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="395c3-183">Il client include il relativo identificatore client, ambito richiesto, lo stato locale e un URI di reindirizzamento a cui il server di autorizzazione Invia l'agente utente dopo l'accesso viene concesso (o negato).</span><span class="sxs-lookup"><span data-stu-id="395c3-183">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="395c3-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="395c3-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="395c3-185">(B) il server di autorizzazione autentica il proprietario della risorsa (tramite l'agente utente) e stabilisce se il proprietario della risorsa concede o Nega la richiesta di accesso del client.</span><span class="sxs-lookup"><span data-stu-id="395c3-185">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="395c3-186">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="395c3-186">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="395c3-187">(C) supponendo che il proprietario della risorsa concede l'accesso, il server di autorizzazione reindirizza l'agente utente al client usando l'URI fornito il reindirizzamento delle versioni precedenti (nella richiesta o durante la registrazione del client).</span><span class="sxs-lookup"><span data-stu-id="395c3-187">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="395c3-188">...</span><span class="sxs-lookup"><span data-stu-id="395c3-188">...</span></span> |  |
|  |  |
| <span data-ttu-id="395c3-189">(D) il client richiede un token di accesso dall'endpoint di token del server di autorizzazione, includendo il codice di autorizzazione ricevuto nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="395c3-189">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="395c3-190">Quando si effettua la richiesta, con il server di autorizzazione autentica il client.</span><span class="sxs-lookup"><span data-stu-id="395c3-190">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="395c3-191">Il client include il reindirizzamento che URI usato per ottenere il codice di autorizzazione per la verifica.</span><span class="sxs-lookup"><span data-stu-id="395c3-191">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="395c3-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="395c3-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="395c3-193">Per un esempio di implementazione `AuthorizationCodeProvider.CreateAsync` e `ReceiveAsync` per controllare la creazione e la convalida del codice di autorizzazione è illustrato di seguito.</span><span class="sxs-lookup"><span data-stu-id="395c3-193">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="395c3-194">Il codice precedente Usa un dizionario simultaneo in memoria per memorizzare il ticket di codice e l'identità e il ripristino dell'identità dopo la ricezione del codice.</span><span class="sxs-lookup"><span data-stu-id="395c3-194">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="395c3-195">In un'applicazione reale, questo verrà sostituito da un archivio dati permanente.</span><span class="sxs-lookup"><span data-stu-id="395c3-195">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="395c3-196">L'endpoint di autorizzazione è proprietario della risorsa concedere l'accesso al client.</span><span class="sxs-lookup"><span data-stu-id="395c3-196">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="395c3-197">In genere, è necessario un'interfaccia utente per consentire all'utente di fare clic su un pulsante e confermare la concessione.</span><span class="sxs-lookup"><span data-stu-id="395c3-197">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="395c3-198">Middleware OWIN OAuth consente al codice dell'applicazione gestire l'endpoint di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="395c3-198">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="395c3-199">Nel nostro app di esempio, utilizziamo un controller MVC chiamato `OAuthController` gestirlo.</span><span class="sxs-lookup"><span data-stu-id="395c3-199">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="395c3-200">Ecco l'implementazione di esempio:</span><span class="sxs-lookup"><span data-stu-id="395c3-200">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="395c3-201">Il `Authorize` azione controlla prima se l'utente ha effettuato l'accesso al server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="395c3-201">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="395c3-202">In caso contrario, il middleware di autenticazione al chiamante di eseguire l'autenticazione usando il cookie "Applicazione" sono le problematiche e reindirizza alla pagina di accesso.</span><span class="sxs-lookup"><span data-stu-id="395c3-202">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="395c3-203">(Vedere il codice evidenziato sopra). Se l'utente ha effettuato l'accesso, eseguirà il rendering della visualizzazione Authorize, come illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="395c3-203">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="395c3-204">Se il **concessione** pulsante è selezionato, il `Authorize` azione consente di creare una nuova identità "Bearer" e accedere con lo.</span><span class="sxs-lookup"><span data-stu-id="395c3-204">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="395c3-205">Attiva il server di autorizzazione per generare un token di connessione e restituirlo al client con payload JSON.</span><span class="sxs-lookup"><span data-stu-id="395c3-205">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="395c3-206">Concessione implicita</span><span class="sxs-lookup"><span data-stu-id="395c3-206">Implicit Grant</span></span>

<span data-ttu-id="395c3-207">Fare riferimento OAuth 2 di IETF [concessione implicita](http://tools.ietf.org/html/rfc6749#section-4.2) sezione ora.</span><span class="sxs-lookup"><span data-stu-id="395c3-207">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="395c3-208">Il [concessione implicita](http://tools.ietf.org/html/rfc6749#section-4.2) flusso illustrato nella figura 4 viene illustrato il flusso e di mapping che OAuth OWIN segue middleware.</span><span class="sxs-lookup"><span data-stu-id="395c3-208">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="395c3-209">Passaggi del flusso dalla sezione di concessione implicita</span><span class="sxs-lookup"><span data-stu-id="395c3-209">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="395c3-210">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="395c3-210">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="395c3-211">(A) il client avvia il flusso indirizzando l'agente utente del proprietario della risorsa per l'endpoint di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="395c3-211">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="395c3-212">Il client include il relativo identificatore client, ambito richiesto, lo stato locale e un URI di reindirizzamento a cui il server di autorizzazione Invia l'agente utente dopo l'accesso viene concesso (o negato).</span><span class="sxs-lookup"><span data-stu-id="395c3-212">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="395c3-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="395c3-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="395c3-214">(B) il server di autorizzazione autentica il proprietario della risorsa (tramite l'agente utente) e stabilisce se il proprietario della risorsa concede o Nega la richiesta di accesso del client.</span><span class="sxs-lookup"><span data-stu-id="395c3-214">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="395c3-215">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="395c3-215">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="395c3-216">(C) supponendo che il proprietario della risorsa concede l'accesso, il server di autorizzazione reindirizza l'agente utente al client usando l'URI fornito il reindirizzamento delle versioni precedenti (nella richiesta o durante la registrazione del client).</span><span class="sxs-lookup"><span data-stu-id="395c3-216">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="395c3-217">...</span><span class="sxs-lookup"><span data-stu-id="395c3-217">...</span></span> |  |
|  |  |
| <span data-ttu-id="395c3-218">(D) il client richiede un token di accesso dall'endpoint di token del server di autorizzazione, includendo il codice di autorizzazione ricevuto nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="395c3-218">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="395c3-219">Quando si effettua la richiesta, con il server di autorizzazione autentica il client.</span><span class="sxs-lookup"><span data-stu-id="395c3-219">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="395c3-220">Il client include il reindirizzamento che URI usato per ottenere il codice di autorizzazione per la verifica.</span><span class="sxs-lookup"><span data-stu-id="395c3-220">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="395c3-221">Poiché è già implementato l'endpoint di autorizzazione (`OAuthController.Authorize` azione) per la concessione del codice di autorizzazione, abilita automaticamente anche il flusso implicito.</span><span class="sxs-lookup"><span data-stu-id="395c3-221">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="395c3-222">Nota: `Provider.ValidateClientRedirectUri` viene usato per convalidare l'ID client con l'URL di reindirizzamento, che protegge il flusso di concessione implicita di inviare l'accesso token da malintenzionati client ([attacco Man-in-the-middle](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="395c3-222">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="395c3-223">Concessione delle credenziali Password proprietario risorsa</span><span class="sxs-lookup"><span data-stu-id="395c3-223">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="395c3-224">Fare riferimento OAuth 2 di IETF [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) sezione ora.</span><span class="sxs-lookup"><span data-stu-id="395c3-224">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="395c3-225">Il [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flusso illustrato nella figura 5 viene illustrato il flusso e di mapping che OAuth OWIN segue middleware.</span><span class="sxs-lookup"><span data-stu-id="395c3-225">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="395c3-226">Passaggi del flusso dalla sezione Resource Owner Password Credentials Grant</span><span class="sxs-lookup"><span data-stu-id="395c3-226">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="395c3-227">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="395c3-227">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="395c3-228">(A) il proprietario della risorsa fornisce al client con il nome utente e la password.</span><span class="sxs-lookup"><span data-stu-id="395c3-228">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="395c3-229">(B) il client richiede un token di accesso dall'endpoint di token del server di autorizzazione includendo le credenziali ricevute dal proprietario della risorsa.</span><span class="sxs-lookup"><span data-stu-id="395c3-229">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="395c3-230">Quando si effettua la richiesta, con il server di autorizzazione autentica il client.</span><span class="sxs-lookup"><span data-stu-id="395c3-230">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="395c3-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="395c3-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="395c3-232">(C) il server di autorizzazione autentica il client e convalida le credenziali del proprietario risorsa e se valido, rilascia un token di accesso.</span><span class="sxs-lookup"><span data-stu-id="395c3-232">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="395c3-233">Ecco l'implementazione di esempio per `Provider.GrantResourceOwnerCredentials`:</span><span class="sxs-lookup"><span data-stu-id="395c3-233">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="395c3-234">Il codice riportato sopra è destinato per spiegare in questa sezione dell'esercitazione e non deve essere utilizzato in sicura o le app di produzione.</span><span class="sxs-lookup"><span data-stu-id="395c3-234">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="395c3-235">Non controlla le credenziali di proprietari di risorse.</span><span class="sxs-lookup"><span data-stu-id="395c3-235">It does not check the resource owners credentials.</span></span> <span data-ttu-id="395c3-236">Si presuppone ogni credenziale è valida e crea una nuova identità per tale.</span><span class="sxs-lookup"><span data-stu-id="395c3-236">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="395c3-237">La nuova identità verrà usata per generare il token di accesso e token di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="395c3-237">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="395c3-238">Sostituire il codice con il proprio codice di gestione di account sicuro.</span><span class="sxs-lookup"><span data-stu-id="395c3-238">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="395c3-239">Concessione delle credenziali client</span><span class="sxs-lookup"><span data-stu-id="395c3-239">Client Credentials Grant</span></span>

<span data-ttu-id="395c3-240">Fare riferimento OAuth 2 di IETF [concessione delle credenziali Client](http://tools.ietf.org/html/rfc6749#section-4.4) sezione ora.</span><span class="sxs-lookup"><span data-stu-id="395c3-240">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="395c3-241">Il [concessione delle credenziali Client](http://tools.ietf.org/html/rfc6749#section-4.4) flusso illustrato nella figura 6 viene illustrato il flusso e di mapping che OAuth OWIN segue middleware.</span><span class="sxs-lookup"><span data-stu-id="395c3-241">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="395c3-242">Passaggi del flusso dalla sezione di concessione delle credenziali Client</span><span class="sxs-lookup"><span data-stu-id="395c3-242">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="395c3-243">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="395c3-243">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="395c3-244">(A) il client esegue l'autenticazione con il server di autorizzazione e richiede un token di accesso dall'endpoint di token.</span><span class="sxs-lookup"><span data-stu-id="395c3-244">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="395c3-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="395c3-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="395c3-246">(B) il server di autorizzazione autentica il client e, se valido, rilascia un token di accesso.</span><span class="sxs-lookup"><span data-stu-id="395c3-246">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="395c3-247">Ecco l'implementazione di esempio per `Provider.GrantClientCredentials`:</span><span class="sxs-lookup"><span data-stu-id="395c3-247">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="395c3-248">Il codice riportato sopra è destinato per spiegare in questa sezione dell'esercitazione e non deve essere utilizzato in sicura o le app di produzione.</span><span class="sxs-lookup"><span data-stu-id="395c3-248">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="395c3-249">Sostituire il codice con il proprio codice di gestione client protette.</span><span class="sxs-lookup"><span data-stu-id="395c3-249">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="395c3-250">Token di aggiornamento</span><span class="sxs-lookup"><span data-stu-id="395c3-250">Refresh Token</span></span>

<span data-ttu-id="395c3-251">Fare riferimento OAuth 2 di IETF [Token di aggiornamento](http://tools.ietf.org/html/rfc6749#section-1.5) sezione ora.</span><span class="sxs-lookup"><span data-stu-id="395c3-251">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="395c3-252">Il [Token di aggiornamento](http://tools.ietf.org/html/rfc6749#section-1.5) flusso illustrato nella figura 2 viene illustrato il flusso e di mapping che OAuth OWIN segue middleware.</span><span class="sxs-lookup"><span data-stu-id="395c3-252">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="395c3-253">Passaggi del flusso dalla sezione di concessione delle credenziali Client</span><span class="sxs-lookup"><span data-stu-id="395c3-253">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="395c3-254">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="395c3-254">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="395c3-255">(G) il client richiede un nuovo token di accesso per l'autenticazione con il server di autorizzazione e presentare il token di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="395c3-255">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="395c3-256">I requisiti di autenticazione client sono basati sul tipo di client e in criteri del server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="395c3-256">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="395c3-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="395c3-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="395c3-258">(H) il server di autorizzazione autentica il client e convalida il token di aggiornamento e se valido, genera un nuovo token di accesso (e, facoltativamente, un nuovo token di aggiornamento).</span><span class="sxs-lookup"><span data-stu-id="395c3-258">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="395c3-259">Ecco l'implementazione di esempio per `Provider.GrantRefreshToken`:</span><span class="sxs-lookup"><span data-stu-id="395c3-259">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="395c3-260">Creare un Server di risorse che è protetta dal Token di accesso</span><span class="sxs-lookup"><span data-stu-id="395c3-260">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="395c3-261">Creare un progetto di app web vuota e installare i pacchetti nel progetto in seguito:</span><span class="sxs-lookup"><span data-stu-id="395c3-261">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="395c3-262">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="395c3-262">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="395c3-263">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="395c3-263">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="395c3-264">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="395c3-264">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="395c3-265">Creare una classe startup e configurare l'autenticazione e l'API Web.</span><span class="sxs-lookup"><span data-stu-id="395c3-265">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="395c3-266">Visualizzare *AuthorizationServer\ResourceServer\Startup.cs* nel download di esempio.</span><span class="sxs-lookup"><span data-stu-id="395c3-266">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="395c3-267">Visualizzare *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* nel download di esempio.</span><span class="sxs-lookup"><span data-stu-id="395c3-267">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="395c3-268">Visualizzare *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* nel download di esempio.</span><span class="sxs-lookup"><span data-stu-id="395c3-268">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="395c3-269">`UseCors` metodo consente a CORS per tutti i domini.</span><span class="sxs-lookup"><span data-stu-id="395c3-269">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="395c3-270">`UseOAuthBearerAuthentication` metodo consente di middleware di autenticazione basata su token di connessione OAuth che consente di ricevere e convalidare i token di connessione dall'intestazione di autorizzazione nella richiesta.</span><span class="sxs-lookup"><span data-stu-id="395c3-270">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="395c3-271">`Config.SuppressDefaultHostAuthenticaiton` evita la visualizzazione predefinita ospitare entità autenticata dall'app, pertanto saranno tutte le richieste anonime dopo questa chiamata.</span><span class="sxs-lookup"><span data-stu-id="395c3-271">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="395c3-272">`HostAuthenticationFilter` Abilita l'autenticazione solo per il tipo di autenticazione specificato.</span><span class="sxs-lookup"><span data-stu-id="395c3-272">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="395c3-273">In questo caso, è il tipo di autenticazione bearer.</span><span class="sxs-lookup"><span data-stu-id="395c3-273">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="395c3-274">Per dimostrare l'identità autenticata, creiamo un ApiController per ottenere l'output di attestazioni dell'utente corrente.</span><span class="sxs-lookup"><span data-stu-id="395c3-274">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="395c3-275">Se il server di autorizzazione e il server di risorse non sono nello stesso computer, il middleware di OAuth utilizzerà le chiavi del computer diverso per crittografare e decrittografare i token di accesso di connessione.</span><span class="sxs-lookup"><span data-stu-id="395c3-275">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="395c3-276">Per condividere la stessa chiave privata tra entrambi i progetti, si aggiunge la stessa `machinekey` impostazione in entrambe *Web. config* file.</span><span class="sxs-lookup"><span data-stu-id="395c3-276">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="395c3-277">Creare i client di OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="395c3-277">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="395c3-278">Usiamo il [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) pacchetto NuGet per semplificare il codice client.</span><span class="sxs-lookup"><span data-stu-id="395c3-278">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="395c3-279">Authorization Code Grant Client</span><span class="sxs-lookup"><span data-stu-id="395c3-279">Authorization Code Grant Client</span></span>

 <span data-ttu-id="395c3-280">Questo client è un'applicazione MVC.</span><span class="sxs-lookup"><span data-stu-id="395c3-280">This client is an MVC application.</span></span> <span data-ttu-id="395c3-281">Attiva un flusso di concessione di codice di autorizzazione per ottenere il token di accesso dal back-end.</span><span class="sxs-lookup"><span data-stu-id="395c3-281">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="395c3-282">Dispone di una pagina singola come illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="395c3-282">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="395c3-283">Il **Authorize** pulsante reindirizzerà browser al server di autorizzazione per notificare il proprietario della risorsa per concedere l'accesso a questo client.</span><span class="sxs-lookup"><span data-stu-id="395c3-283">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="395c3-284">Il **Aggiorna** pulsante verrà visualizzato un nuovo token di accesso e un token di aggiornamento tramite l'aggiornamento corrente token.</span><span class="sxs-lookup"><span data-stu-id="395c3-284">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="395c3-285">Il **API di risorsa protetta da accesso** pulsante chiamerà il server di risorse per ottenere i dati delle attestazioni dell'utente corrente e visualizzarli nella pagina.</span><span class="sxs-lookup"><span data-stu-id="395c3-285">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="395c3-286">Ecco il codice di esempio del `HomeController` del client.</span><span class="sxs-lookup"><span data-stu-id="395c3-286">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="395c3-287">`DotNetOpenAuth` richiede SSL per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="395c3-287">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="395c3-288">Poiché la demo Usa HTTP, è necessario aggiungere seguente impostazione nel file di configurazione:</span><span class="sxs-lookup"><span data-stu-id="395c3-288">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="395c3-289">Security - mai disabilitare SSL in un'app di produzione.</span><span class="sxs-lookup"><span data-stu-id="395c3-289">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="395c3-290">Le credenziali di accesso vengono ora inviate via cavo in testo non crittografato.</span><span class="sxs-lookup"><span data-stu-id="395c3-290">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="395c3-291">Il codice sopra riportato è solo per l'esplorazione e il debug di esempio locali.</span><span class="sxs-lookup"><span data-stu-id="395c3-291">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="395c3-292">Client di concessione implicita</span><span class="sxs-lookup"><span data-stu-id="395c3-292">Implicit Grant Client</span></span>

<span data-ttu-id="395c3-293">Questo client utilizza JavaScript per:</span><span class="sxs-lookup"><span data-stu-id="395c3-293">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="395c3-294">Aprire una nuova finestra e il reindirizzamento all'endpoint di autorizzazione del Server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="395c3-294">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="395c3-295">Ottenere il token di accesso da frammenti di URL quando viene reindirizzato nuovamente.</span><span class="sxs-lookup"><span data-stu-id="395c3-295">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="395c3-296">L'immagine seguente illustra questo processo:</span><span class="sxs-lookup"><span data-stu-id="395c3-296">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="395c3-297">Il client deve disporre di due pagine: uno per la home page e l'altra per i callback. Ecco l'esempio di codice trovato in JavaScript la *index. cshtml* file:</span><span class="sxs-lookup"><span data-stu-id="395c3-297">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="395c3-298">Ecco il callback nel codice di gestione *SignIn.cshtml* file:</span><span class="sxs-lookup"><span data-stu-id="395c3-298">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="395c3-299">Una procedura consigliata è spostare il codice JavaScript in un file esterno e non incorporala con il markup Razor.</span><span class="sxs-lookup"><span data-stu-id="395c3-299">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="395c3-300">Per semplificare questo esempio, sono stati combinati.</span><span class="sxs-lookup"><span data-stu-id="395c3-300">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="395c3-301">Client concessione delle credenziali Password proprietario risorsa</span><span class="sxs-lookup"><span data-stu-id="395c3-301">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="395c3-302">Si usa un'app console per questo client della demo.</span><span class="sxs-lookup"><span data-stu-id="395c3-302">We uses a console app to demo this client.</span></span> <span data-ttu-id="395c3-303">Ecco il codice:</span><span class="sxs-lookup"><span data-stu-id="395c3-303">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="395c3-304">Client di concessione di credenziali client</span><span class="sxs-lookup"><span data-stu-id="395c3-304">Client Credentials Grant Client</span></span>

<span data-ttu-id="395c3-305">Analogamente a Resource Owner Password Credentials Grant, ecco il codice di app console:</span><span class="sxs-lookup"><span data-stu-id="395c3-305">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
