---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Server di autorizzazione OWin OAuth 2.0 Documenti Microsoft
author: hongyes
description: Questo tutorial ti guiderà su come implementare un server di autorizzazione OAuth 2.0 usando il middleware OAuth OWIN. Questo è un tutorial avanzato che solo outlin...
ms.author: riande
ms.date: 03/20/2014
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: d758fa2639d10e1b7be8d87c5d1f7adb7e292ac7
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/17/2020
ms.locfileid: "81540404"
---
<a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="78b27-104">Server di autorizzazione OAuth 2.0 OWIN</span><span class="sxs-lookup"><span data-stu-id="78b27-104">OWIN OAuth 2.0 Authorization Server</span></span>
====================
<span data-ttu-id="78b27-105">di [Hongye Sun](https://github.com/hongyes) e [Praburaj Thiagarajan](https://github.com/Praburaj)</span><span class="sxs-lookup"><span data-stu-id="78b27-105">by [Hongye Sun](https://github.com/hongyes) and [Praburaj Thiagarajan](https://github.com/Praburaj)</span></span>

> <span data-ttu-id="78b27-106">Questo tutorial ti guiderà su come implementare un server di autorizzazione OAuth 2.0 usando il middleware OAuth OWIN.</span><span class="sxs-lookup"><span data-stu-id="78b27-106">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="78b27-107">Si tratta di un'esercitazione avanzata che descrive solo i passaggi per creare un server di autorizzazione OAuth 2.0 OWIN.</span><span class="sxs-lookup"><span data-stu-id="78b27-107">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="78b27-108">Questo non è un tutorial passo dopo passo.</span><span class="sxs-lookup"><span data-stu-id="78b27-108">This is not a step by step tutorial.</span></span> <span data-ttu-id="78b27-109">[Scaricare il codice di esempio](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="78b27-109">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="78b27-110">Questa struttura non deve essere utilizzata per la creazione di un'app di produzione sicura.</span><span class="sxs-lookup"><span data-stu-id="78b27-110">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="78b27-111">Questa esercitazione ha lo scopo di fornire solo una struttura su come implementare un server di autorizzazione OAuth 2.0 utilizzando il middleware OAuth OAuth OWIN.</span><span class="sxs-lookup"><span data-stu-id="78b27-111">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="78b27-112">Versioni software</span><span class="sxs-lookup"><span data-stu-id="78b27-112">Software versions</span></span>
>
> | <span data-ttu-id="78b27-113">**Mostrato nell'esercitazione**</span><span class="sxs-lookup"><span data-stu-id="78b27-113">**Shown in the tutorial**</span></span> | <span data-ttu-id="78b27-114">**Funziona anche con**</span><span class="sxs-lookup"><span data-stu-id="78b27-114">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="78b27-115">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="78b27-115">Windows 8.1</span></span> | <span data-ttu-id="78b27-116">Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="78b27-116">Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="78b27-117">Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="78b27-117">Visual Studio 2013</span></span>](https://my.visualstudio.com/Downloads?q=visual%20studio%202013) | <span data-ttu-id="78b27-118">[Visual Studio 2013 Express per desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span><span class="sxs-lookup"><span data-stu-id="78b27-118">[Visual Studio 2013 Express for Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span></span> <span data-ttu-id="78b27-119">Visual Studio 2012 con l'aggiornamento più recente dovrebbe funzionare, ma l'esercitazione non è stata testata con esso e alcune selezioni di menu e finestre di dialogo sono diverse.</span><span class="sxs-lookup"><span data-stu-id="78b27-119">Visual Studio 2012 with the latest update should work, but the tutorial has not been tested with it, and some menu selections and dialog boxes are different.</span></span> |
> | <span data-ttu-id="78b27-120">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="78b27-120">.NET 4.5</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="78b27-121">Domande e commenti</span><span class="sxs-lookup"><span data-stu-id="78b27-121">Questions and Comments</span></span>
>
> <span data-ttu-id="78b27-122">Se hai domande che non sono direttamente correlate al tutorial, puoi pubblicarle su [Katana Project su GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="78b27-122">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="78b27-123">Per domande e commenti relativi al tutorial stesso, vedere la sezione commenti nella parte inferiore della pagina.</span><span class="sxs-lookup"><span data-stu-id="78b27-123">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="78b27-124">Il [framework OAuth 2.0](http://tools.ietf.org/html/rfc6749) consente a un'app di terze parti di ottenere un accesso limitato a un servizio HTTP.</span><span class="sxs-lookup"><span data-stu-id="78b27-124">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="78b27-125">Anziché utilizzare le credenziali del proprietario della risorsa per accedere a una risorsa protetta, il client ottiene un token di accesso, ovvero una stringa che indica un ambito, una durata e altri attributi di accesso specifici.</span><span class="sxs-lookup"><span data-stu-id="78b27-125">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="78b27-126">I token di accesso vengono rilasciati ai client di terze parti da un server di autorizzazione con l'approvazione del proprietario della risorsa.</span><span class="sxs-lookup"><span data-stu-id="78b27-126">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="78b27-127">Questo tutorial tratterà:</span><span class="sxs-lookup"><span data-stu-id="78b27-127">This tutorial will cover:</span></span>

- <span data-ttu-id="78b27-128">Come creare un server di autorizzazione per supportare quattro tipi di concessione di autorizzazione e token di aggiornamento:How to create an authorization server to support four authorization grant types and refresh tokens:</span><span class="sxs-lookup"><span data-stu-id="78b27-128">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="78b27-129">Concessione del codice di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="78b27-129">Authorization code grant</span></span>
    - <span data-ttu-id="78b27-130">Concessione implicita</span><span class="sxs-lookup"><span data-stu-id="78b27-130">Implicit Grant</span></span>
    - <span data-ttu-id="78b27-131">Concessione credenziali password proprietario risorsa</span><span class="sxs-lookup"><span data-stu-id="78b27-131">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="78b27-132">Concessione credenziali client</span><span class="sxs-lookup"><span data-stu-id="78b27-132">Client Credentials Grant</span></span>
- <span data-ttu-id="78b27-133">Creazione di un server di risorse protetto da un token di accesso.</span><span class="sxs-lookup"><span data-stu-id="78b27-133">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="78b27-134">Creazione di client OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="78b27-134">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="78b27-135">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="78b27-135">Prerequisites</span></span>

- <span data-ttu-id="78b27-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) o [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express)gratuito, come indicato in **Versioni software** nella parte superiore della pagina.</span><span class="sxs-lookup"><span data-stu-id="78b27-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) or the free [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="78b27-137">Familiarità con OWIN.</span><span class="sxs-lookup"><span data-stu-id="78b27-137">Familiarity with OWIN.</span></span> <span data-ttu-id="78b27-138">Vedere [Introduzione al progetto Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) e Novità di [OWIN e Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="78b27-138">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="78b27-139">Familiarità con la terminologia [OAuth,](http://tools.ietf.org/html/rfc6749) inclusi [Ruoli,](http://tools.ietf.org/html/rfc6749#section-1.1) [Flusso di protocollo](http://tools.ietf.org/html/rfc6749#section-1.2)e [Concessione autorizzazione](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="78b27-139">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="78b27-140">[L'introduzione a OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) fornisce una buona introduzione.</span><span class="sxs-lookup"><span data-stu-id="78b27-140">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="78b27-141">Creare un server di autorizzazioneCreate an Authorization Server</span><span class="sxs-lookup"><span data-stu-id="78b27-141">Create an Authorization Server</span></span>

<span data-ttu-id="78b27-142">In questa esercitazione verrà illustrato come utilizzare [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) e MVC ASP.NET per creare un server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-142">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="78b27-143">Speriamo di fornire presto un download per l'esempio completato, come questa esercitazione non include ogni passaggio.</span><span class="sxs-lookup"><span data-stu-id="78b27-143">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="78b27-144">Creare innanzitutto un'app Web vuota denominata *AuthorizationServer* e installare i pacchetti seguenti:</span><span class="sxs-lookup"><span data-stu-id="78b27-144">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="78b27-145">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="78b27-145">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="78b27-146">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="78b27-146">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="78b27-147">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="78b27-147">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="78b27-148">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="78b27-148">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="78b27-149">Microsoft.Owin.Security.Google (O qualsiasi altro pacchetto di login sociale come Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="78b27-149">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="78b27-150">Aggiungere una [classe OWIN Startup](owin-startup-class-detection.md) nella cartella radice del progetto denominata *Startup*.</span><span class="sxs-lookup"><span data-stu-id="78b27-150">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="78b27-151">Creare una cartella *di avvio\_dell'app.*</span><span class="sxs-lookup"><span data-stu-id="78b27-151">Create an *App\_Start* folder.</span></span> <span data-ttu-id="78b27-152">Selezionare la cartella *Di avvio\_dell'app* e utilizzare Maiusc-ALT-A per aggiungere la versione scaricata del file *AuthorizationServer,App\_Start,Startup.Auth.cs.*</span><span class="sxs-lookup"><span data-stu-id="78b27-152">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="78b27-153">Il codice precedente abilita i cookie di accesso dell'applicazione/esterno e l'autenticazione di Google, che vengono utilizzati dal server di autorizzazione stesso per gestire gli account.</span><span class="sxs-lookup"><span data-stu-id="78b27-153">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="78b27-154">Il `UseOAuthAuthorizationServer` metodo di estensione consiste nell'impostare il server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-154">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="78b27-155">Le opzioni di configurazione sono:</span><span class="sxs-lookup"><span data-stu-id="78b27-155">The setup options are:</span></span>

- <span data-ttu-id="78b27-156">`AuthorizeEndpointPath`: il percorso della richiesta in cui le applicazioni client reindirizzeranno l'agente utente per ottenere il consenso degli utenti per l'emissione di un token o di un codice.</span><span class="sxs-lookup"><span data-stu-id="78b27-156">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="78b27-157">Deve iniziare con una barra iniziale, ad esempio , "`/Authorize`".</span><span class="sxs-lookup"><span data-stu-id="78b27-157">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="78b27-158">`TokenEndpointPath`: le applicazioni client del percorso della richiesta comunicano direttamente per ottenere il token di accesso.</span><span class="sxs-lookup"><span data-stu-id="78b27-158">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="78b27-159">Deve iniziare con una barra iniziale, ad esempio "/Token".</span><span class="sxs-lookup"><span data-stu-id="78b27-159">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="78b27-160">Se al client viene rilasciato un [segreto client,\_](http://tools.ietf.org/html/rfc6749#appendix-A.2)è necessario fornirlo a questo endpoint.</span><span class="sxs-lookup"><span data-stu-id="78b27-160">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="78b27-161">`ApplicationCanDisplayErrors`: impostare su `true` se l'applicazione Web desidera generare `/Authorize` una pagina di errore personalizzata per gli errori di convalida client nell'endpoint.</span><span class="sxs-lookup"><span data-stu-id="78b27-161">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="78b27-162">Questa operazione è necessaria solo per i casi in cui il browser `client_id` non `redirect_uri` viene reindirizzato all'applicazione client, ad esempio quando il o non sono corretti.</span><span class="sxs-lookup"><span data-stu-id="78b27-162">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="78b27-163">L'endpoint `/Authorize` dovrebbe aspettarsi di vedere l'"oauth. Errore", "oauth. ErrorDescription" e "oauth. ErrorUri" vengono aggiunte all'ambiente OWIN.</span><span class="sxs-lookup"><span data-stu-id="78b27-163">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="78b27-164">Se non true, il server di autorizzazione restituirà una pagina di errore predefinita con i dettagli dell'errore.</span><span class="sxs-lookup"><span data-stu-id="78b27-164">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="78b27-165">`AllowInsecureHttp`: True per consentire l'accesso alle richieste di autorizzazione `redirect_uri` e token sugli indirizzi URI HTTP e per consentire ai parametri di richiesta di autorizzazione in ingresso di avere indirizzi URI HTTP.</span><span class="sxs-lookup"><span data-stu-id="78b27-165">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="78b27-166">Sicurezza - Questo è solo per lo sviluppo.</span><span class="sxs-lookup"><span data-stu-id="78b27-166">Security - This is for development only.</span></span>
- <span data-ttu-id="78b27-167">`Provider`: oggetto fornito dall'applicazione per elaborare gli eventi generati dal middleware del server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-167">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="78b27-168">L'applicazione può implementare completamente l'interfaccia `OAuthAuthorizationServerProvider` o può creare un'istanza di e assegnare i delegati necessari per i flussi OAuth supportati da questo server.</span><span class="sxs-lookup"><span data-stu-id="78b27-168">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="78b27-169">`AuthorizationCodeProvider`: produce un codice di autorizzazione monouso da restituire all'applicazione client.</span><span class="sxs-lookup"><span data-stu-id="78b27-169">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="78b27-170">Affinché il server OAuth **MUST** sia protetto, `AuthorizationCodeProvider` l'applicazione DEVE `OnCreate/OnCreateAsync` fornire un'istanza in cui `OnReceive/OnReceiveAsync`il token prodotto dall'evento è considerato valido per una sola chiamata a .</span><span class="sxs-lookup"><span data-stu-id="78b27-170">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="78b27-171">`RefreshTokenProvider`: produce un token di aggiornamento che può essere utilizzato per produrre un nuovo token di accesso quando necessario.</span><span class="sxs-lookup"><span data-stu-id="78b27-171">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="78b27-172">Se non viene specificato, il server di `/Token` autorizzazione non restituirà i token di aggiornamento dall'endpoint.</span><span class="sxs-lookup"><span data-stu-id="78b27-172">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="78b27-173">Gestione degli account</span><span class="sxs-lookup"><span data-stu-id="78b27-173">Account Management</span></span>

<span data-ttu-id="78b27-174">OAuth non si preoccupa di dove o come gestire le informazioni dell'account utente.</span><span class="sxs-lookup"><span data-stu-id="78b27-174">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="78b27-175">È [ASP.NET'identità](../../../identity/index.md) che ne è responsabile.</span><span class="sxs-lookup"><span data-stu-id="78b27-175">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="78b27-176">In questo tutorial, semplificheremo il codice di gestione dell'account e ci assicureremo che l'utente possa effettuare l'accesso utilizzando il middleware dei cookie OWIN.</span><span class="sxs-lookup"><span data-stu-id="78b27-176">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="78b27-177">Di seguito è riportato `AccountController`il codice di esempio semplificato per il :</span><span class="sxs-lookup"><span data-stu-id="78b27-177">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="78b27-178">`ValidateClientRedirectUri`viene utilizzato per convalidare il client con il relativo URL di reindirizzamento registrato.</span><span class="sxs-lookup"><span data-stu-id="78b27-178">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="78b27-179">`ValidateClientAuthentication`controlla l'intestazione dello schema di base e il corpo del modulo per ottenere le credenziali del client.</span><span class="sxs-lookup"><span data-stu-id="78b27-179">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="78b27-180">La pagina di login è mostrata di seguito:</span><span class="sxs-lookup"><span data-stu-id="78b27-180">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="78b27-181">Esamina ora la sezione OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) di IETF.</span><span class="sxs-lookup"><span data-stu-id="78b27-181">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="78b27-182">**Il provider** (nella tabella seguente) è [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Provider, che è `OAuthAuthorizationServerProvider`di tipo , che contiene tutti gli eventi del server OAuth.</span><span class="sxs-lookup"><span data-stu-id="78b27-182">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="78b27-183">Passaggi del flusso dalla sezione Concessione codice di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="78b27-183">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="78b27-184">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="78b27-184">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="78b27-185">(A) Il client avvia il flusso indirizzando l'agente utente del proprietario della risorsa all'endpoint di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-185">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="78b27-186">Il client include l'identificatore client, l'ambito richiesto, lo stato locale e un URI di reindirizzamento a cui il server di autorizzazione invierà l'agente utente una volta concesso (o negato l'accesso).</span><span class="sxs-lookup"><span data-stu-id="78b27-186">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="78b27-187">Provider Provider Provider.Match-Endpoint.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="78b27-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="78b27-188">(B) Il server di autorizzazione autentica il proprietario della risorsa (tramite l'agente utente) e stabilisce se il proprietario della risorsa concede o nega la richiesta di accesso del client.</span><span class="sxs-lookup"><span data-stu-id="78b27-188">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="78b27-189">**Se l'utente concede l'accesso&gt; &lt;** Provider Provider.MatchEndpoint.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="78b27-189">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="78b27-190">(C) Supponendo che il proprietario della risorsa conceda l'accesso, il server di autorizzazione reindirizza l'agente utente al client utilizzando l'URI di reindirizzamento fornito in precedenza (nella richiesta o durante la registrazione del client).</span><span class="sxs-lookup"><span data-stu-id="78b27-190">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="78b27-191">...</span><span class="sxs-lookup"><span data-stu-id="78b27-191">...</span></span> |  |
|  |  |
| <span data-ttu-id="78b27-192">(D) Il client richiede un token di accesso dall'endpoint del token del server di autorizzazione includendo il codice di autorizzazione ricevuto nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="78b27-192">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="78b27-193">Quando si effettua la richiesta, il client esegue l'autenticazione con il server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-193">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="78b27-194">Il client include l'URI di reindirizzamento utilizzato per ottenere il codice di autorizzazione per la verifica.</span><span class="sxs-lookup"><span data-stu-id="78b27-194">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="78b27-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="78b27-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="78b27-196">Di seguito `AuthorizationCodeProvider.CreateAsync` è `ReceiveAsync` illustrata un'implementazione di esempio per e per controllare la creazione e la convalida del codice di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-196">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="78b27-197">Il codice precedente usa un dizionario simultaneo in memoria per archiviare il codice e il ticket di identità e ripristinare l'identità dopo aver ricevuto il codice.</span><span class="sxs-lookup"><span data-stu-id="78b27-197">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="78b27-198">In un'applicazione reale, verrebbe sostituito da un archivio dati persistente.</span><span class="sxs-lookup"><span data-stu-id="78b27-198">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="78b27-199">L'endpoint di autorizzazione consente al proprietario della risorsa di concedere l'accesso al client.</span><span class="sxs-lookup"><span data-stu-id="78b27-199">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="78b27-200">In genere, è necessaria un'interfaccia utente per consentire all'utente di fare clic su un pulsante e confermare la concessione.</span><span class="sxs-lookup"><span data-stu-id="78b27-200">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="78b27-201">Il middleware OAuth OWIN consente al codice dell'applicazione di gestire l'endpoint di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-201">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="78b27-202">Nell'app di esempio viene usato `OAuthController` un controller MVC chiamato per gestirlo.</span><span class="sxs-lookup"><span data-stu-id="78b27-202">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="78b27-203">Di seguito è riportata l'implementazione di esempio:Here is the sample implementation:</span><span class="sxs-lookup"><span data-stu-id="78b27-203">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="78b27-204">L'azione `Authorize` controllerà innanzitutto se l'utente ha effettuato l'accesso al server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-204">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="78b27-205">In caso contrario, il middleware di autenticazione sfida il chiamante per l'autenticazione utilizzando il cookie "Applicazione" e reindirizza alla pagina di accesso.</span><span class="sxs-lookup"><span data-stu-id="78b27-205">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="78b27-206">(Vedere il codice evidenziato sopra.) Se l'utente ha effettuato l'accesso, eseguirà il rendering della visualizzazione Autorizza, come illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="78b27-206">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="78b27-207">Se il pulsante **Concedi** è selezionato, l'azione `Authorize` creerà una nuova identità "Bearer" e accederà con esso.</span><span class="sxs-lookup"><span data-stu-id="78b27-207">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="78b27-208">Verrà attivato il server di autorizzazione per generare un token di connessione e inviarlo al client con payload JSON.</span><span class="sxs-lookup"><span data-stu-id="78b27-208">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="78b27-209">Concessione implicita</span><span class="sxs-lookup"><span data-stu-id="78b27-209">Implicit Grant</span></span>

<span data-ttu-id="78b27-210">Fare riferimento alla sezione Concessione [implicita](http://tools.ietf.org/html/rfc6749#section-4.2) OAuth 2 di IETF.</span><span class="sxs-lookup"><span data-stu-id="78b27-210">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="78b27-211">Il flusso [di concessione implicita](http://tools.ietf.org/html/rfc6749#section-4.2) illustrato nella Figura 4 è il flusso e il mapping che segue il middleware OAuth OWIN.</span><span class="sxs-lookup"><span data-stu-id="78b27-211">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="78b27-212">Passaggi del flusso dalla sezione Concessione implicita</span><span class="sxs-lookup"><span data-stu-id="78b27-212">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="78b27-213">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="78b27-213">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="78b27-214">(A) Il client avvia il flusso indirizzando l'agente utente del proprietario della risorsa all'endpoint di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-214">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="78b27-215">Il client include l'identificatore client, l'ambito richiesto, lo stato locale e un URI di reindirizzamento a cui il server di autorizzazione invierà l'agente utente una volta concesso (o negato l'accesso).</span><span class="sxs-lookup"><span data-stu-id="78b27-215">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="78b27-216">Provider Provider Provider.Match-Endpoint.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="78b27-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="78b27-217">(B) Il server di autorizzazione autentica il proprietario della risorsa (tramite l'agente utente) e stabilisce se il proprietario della risorsa concede o nega la richiesta di accesso del client.</span><span class="sxs-lookup"><span data-stu-id="78b27-217">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="78b27-218">**Se l'utente concede l'accesso&gt; &lt;** Provider Provider.MatchEndpoint.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="78b27-218">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="78b27-219">(C) Supponendo che il proprietario della risorsa conceda l'accesso, il server di autorizzazione reindirizza l'agente utente al client utilizzando l'URI di reindirizzamento fornito in precedenza (nella richiesta o durante la registrazione del client).</span><span class="sxs-lookup"><span data-stu-id="78b27-219">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="78b27-220">...</span><span class="sxs-lookup"><span data-stu-id="78b27-220">...</span></span> |  |
|  |  |
| <span data-ttu-id="78b27-221">(D) Il client richiede un token di accesso dall'endpoint del token del server di autorizzazione includendo il codice di autorizzazione ricevuto nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="78b27-221">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="78b27-222">Quando si effettua la richiesta, il client esegue l'autenticazione con il server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-222">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="78b27-223">Il client include l'URI di reindirizzamento utilizzato per ottenere il codice di autorizzazione per la verifica.</span><span class="sxs-lookup"><span data-stu-id="78b27-223">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="78b27-224">Poiché abbiamo già implementato`OAuthController.Authorize` l'endpoint di autorizzazione (azione) per la concessione del codice di autorizzazione, abilita automaticamente anche il flusso implicito.</span><span class="sxs-lookup"><span data-stu-id="78b27-224">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="78b27-225">Nota: `Provider.ValidateClientRedirectUri` viene utilizzato per convalidare l'ID client con il relativo URL di reindirizzamento, che protegge il flusso di concessione implicita dall'invio del token di accesso a client dannosi[(Attacco man-in-the-middle](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="78b27-225">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="78b27-226">Concessione credenziali password proprietario risorsa</span><span class="sxs-lookup"><span data-stu-id="78b27-226">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="78b27-227">Fare riferimento alla sezione OAuth 2 [Resource Owner Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) di IETF.</span><span class="sxs-lookup"><span data-stu-id="78b27-227">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="78b27-228">Il flusso [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) mostrato nella Figura 5 è il flusso e il mapping che segue il middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="78b27-228">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="78b27-229">Passaggi del flusso dalla sezione Credenziali password proprietario risorsa</span><span class="sxs-lookup"><span data-stu-id="78b27-229">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="78b27-230">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="78b27-230">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="78b27-231">(A) Il proprietario della risorsa fornisce al client il nome utente e la password.</span><span class="sxs-lookup"><span data-stu-id="78b27-231">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="78b27-232">(B) Il client richiede un token di accesso dall'endpoint del token del server di autorizzazione includendo le credenziali ricevute dal proprietario della risorsa.</span><span class="sxs-lookup"><span data-stu-id="78b27-232">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="78b27-233">Quando si effettua la richiesta, il client esegue l'autenticazione con il server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-233">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="78b27-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="78b27-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="78b27-235">(C) Il server di autorizzazione autentica il client e convalida le credenziali del proprietario della risorsa e, se valido, emette un token di accesso.</span><span class="sxs-lookup"><span data-stu-id="78b27-235">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="78b27-236">Di seguito è `Provider.GrantResourceOwnerCredentials`riportata l'implementazione di esempio per :</span><span class="sxs-lookup"><span data-stu-id="78b27-236">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="78b27-237">Il codice precedente ha lo scopo di spiegare questa sezione dell'esercitazione e non deve essere usato nelle app sicure o di produzione.</span><span class="sxs-lookup"><span data-stu-id="78b27-237">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="78b27-238">Non controlla le credenziali dei proprietari delle risorse.</span><span class="sxs-lookup"><span data-stu-id="78b27-238">It does not check the resource owners credentials.</span></span> <span data-ttu-id="78b27-239">Si presuppone che ogni credenziale sia valida e crea una nuova identità per esso.</span><span class="sxs-lookup"><span data-stu-id="78b27-239">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="78b27-240">La nuova identità verrà utilizzata per generare il token di accesso e il token di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="78b27-240">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="78b27-241">Si prega di sostituire il codice con il proprio codice di gestione dell'account sicuro.</span><span class="sxs-lookup"><span data-stu-id="78b27-241">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="78b27-242">Concessione credenziali client</span><span class="sxs-lookup"><span data-stu-id="78b27-242">Client Credentials Grant</span></span>

<span data-ttu-id="78b27-243">Fare riferimento alla sezione OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) di IETF.</span><span class="sxs-lookup"><span data-stu-id="78b27-243">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="78b27-244">Il flusso [di concessione delle credenziali client](http://tools.ietf.org/html/rfc6749#section-4.4) illustrato nella Figura 6 è il flusso e il mapping che segue il middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="78b27-244">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="78b27-245">Passaggi del flusso dalla sezione Concessione credenziali client</span><span class="sxs-lookup"><span data-stu-id="78b27-245">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="78b27-246">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="78b27-246">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="78b27-247">(A) Il client esegue l'autenticazione con il server di autorizzazione e richiede un token di accesso dall'endpoint del token.</span><span class="sxs-lookup"><span data-stu-id="78b27-247">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="78b27-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="78b27-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="78b27-249">(B) Il server di autorizzazione autentica il client e, se valido, emette un token di accesso.</span><span class="sxs-lookup"><span data-stu-id="78b27-249">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="78b27-250">Di seguito è `Provider.GrantClientCredentials`riportata l'implementazione di esempio per :</span><span class="sxs-lookup"><span data-stu-id="78b27-250">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="78b27-251">Il codice precedente ha lo scopo di spiegare questa sezione dell'esercitazione e non deve essere usato nelle app sicure o di produzione.</span><span class="sxs-lookup"><span data-stu-id="78b27-251">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="78b27-252">Sostituire il codice con il proprio codice di gestione client sicuro.</span><span class="sxs-lookup"><span data-stu-id="78b27-252">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="78b27-253">Aggiornare un token</span><span class="sxs-lookup"><span data-stu-id="78b27-253">Refresh Token</span></span>

<span data-ttu-id="78b27-254">Fare riferimento alla sezione [Del token](http://tools.ietf.org/html/rfc6749#section-1.5) di aggiornamento OAuth 2 di IETF.</span><span class="sxs-lookup"><span data-stu-id="78b27-254">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="78b27-255">Il flusso [di token](http://tools.ietf.org/html/rfc6749#section-1.5) di aggiornamento illustrato nella Figura 2 è il flusso e il mapping che segue il middleware OAuth OWIN.</span><span class="sxs-lookup"><span data-stu-id="78b27-255">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="78b27-256">Passaggi del flusso dalla sezione Concessione credenziali client</span><span class="sxs-lookup"><span data-stu-id="78b27-256">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="78b27-257">Download di esempio esegue questi passaggi con:</span><span class="sxs-lookup"><span data-stu-id="78b27-257">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="78b27-258">(G) Il client richiede un nuovo token di accesso eseguendo l'autenticazione con il server di autorizzazione e presentando il token di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="78b27-258">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="78b27-259">I requisiti di autenticazione client si basano sul tipo di client e sui criteri del server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-259">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="78b27-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="78b27-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="78b27-261">(H) Il server di autorizzazione autentica il client e convalida il token di aggiornamento e, se valido, emette un nuovo token di accesso (e, facoltativamente, un nuovo token di aggiornamento).</span><span class="sxs-lookup"><span data-stu-id="78b27-261">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="78b27-262">Di seguito è `Provider.GrantRefreshToken`riportata l'implementazione di esempio per :</span><span class="sxs-lookup"><span data-stu-id="78b27-262">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="78b27-263">Creare un server di risorse protetto dal token di accessoCreate a Resource Server which is protected by Access Token</span><span class="sxs-lookup"><span data-stu-id="78b27-263">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="78b27-264">Creare un progetto di app Web vuoto e installare i pacchetti seguenti nel progetto:</span><span class="sxs-lookup"><span data-stu-id="78b27-264">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="78b27-265">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="78b27-265">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="78b27-266">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="78b27-266">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="78b27-267">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="78b27-267">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="78b27-268">Creare una classe di avvio e configurare l'autenticazione e l'API Web.Create a startup class and configure authentication and Web API.</span><span class="sxs-lookup"><span data-stu-id="78b27-268">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="78b27-269">Nell'esempio di download, vedere *AuthorizationServer/ResourceServer/Startup.cs.*</span><span class="sxs-lookup"><span data-stu-id="78b27-269">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="78b27-270">Nell'esempio di download, vedere *AuthorizationServer.\_*</span><span class="sxs-lookup"><span data-stu-id="78b27-270">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="78b27-271">Nell'esempio di download, vedere Il server di autorizzazione del server delle *risorse, l'avvio dell'app.\_*</span><span class="sxs-lookup"><span data-stu-id="78b27-271">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="78b27-272">`UseCors`metodo consente CORS per tutti i domini.</span><span class="sxs-lookup"><span data-stu-id="78b27-272">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="78b27-273">`UseOAuthBearerAuthentication`metodo abilita il middleware di autenticazione del token di connessione OAuth che riceverà e convaliderà il token di connessione dall'intestazione di autorizzazione nella richiesta.</span><span class="sxs-lookup"><span data-stu-id="78b27-273">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="78b27-274">`Config.SuppressDefaultHostAuthenticaiton`elimina l'entità autenticata dell'host predefinita dall'app, pertanto tutte le richieste saranno anonime dopo questa chiamata.</span><span class="sxs-lookup"><span data-stu-id="78b27-274">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="78b27-275">`HostAuthenticationFilter`abilita l'autenticazione solo per il tipo di autenticazione specificato.</span><span class="sxs-lookup"><span data-stu-id="78b27-275">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="78b27-276">In questo caso, è il tipo di autenticazione al portatore.</span><span class="sxs-lookup"><span data-stu-id="78b27-276">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="78b27-277">Per dimostrare l'identità autenticata, viene creato un ApiController per restituire le attestazioni dell'utente corrente.</span><span class="sxs-lookup"><span data-stu-id="78b27-277">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="78b27-278">Se il server di autorizzazione e il server delle risorse non si trovano nello stesso computer, il middleware OAuth utilizzerà le diverse chiavi del computer per crittografare e decrittografare il token di accesso al portatore.</span><span class="sxs-lookup"><span data-stu-id="78b27-278">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="78b27-279">Per condividere la stessa chiave privata tra entrambi `machinekey` i progetti, aggiungiamo la stessa impostazione in entrambi i file *web.config.*</span><span class="sxs-lookup"><span data-stu-id="78b27-279">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="78b27-280">Creazione di client OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="78b27-280">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="78b27-281">Usiamo il pacchetto [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet per semplificare il codice client.</span><span class="sxs-lookup"><span data-stu-id="78b27-281">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="78b27-282">Codice di autorizzazione Concedere il cliente</span><span class="sxs-lookup"><span data-stu-id="78b27-282">Authorization Code Grant Client</span></span>

 <span data-ttu-id="78b27-283">Questo client è un'applicazione MVC.</span><span class="sxs-lookup"><span data-stu-id="78b27-283">This client is an MVC application.</span></span> <span data-ttu-id="78b27-284">Verrà attivato un flusso di concessione del codice di autorizzazione per ottenere il token di accesso dal back-end.</span><span class="sxs-lookup"><span data-stu-id="78b27-284">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="78b27-285">Ha una singola pagina come mostrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="78b27-285">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="78b27-286">Il pulsante **Autorizza** reindirizzerà il browser al server di autorizzazione per notificare al proprietario della risorsa di concedere l'accesso a questo client.</span><span class="sxs-lookup"><span data-stu-id="78b27-286">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="78b27-287">Il pulsante **Aggiorna** otterrà un nuovo token di accesso e un token di aggiornamento usando il token di aggiornamento corrente.</span><span class="sxs-lookup"><span data-stu-id="78b27-287">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="78b27-288">Il pulsante **Access Protected Resource API** chiamerà il server delle risorse per ottenere i dati sulle attestazioni dell'utente corrente e visualizzarli nella pagina.</span><span class="sxs-lookup"><span data-stu-id="78b27-288">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="78b27-289">Di seguito è riportato il codice di esempio `HomeController` del client.</span><span class="sxs-lookup"><span data-stu-id="78b27-289">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="78b27-290">`DotNetOpenAuth`richiede SSL per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="78b27-290">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="78b27-291">Poiché la demo utilizza HTTP, è necessario aggiungere le seguenti impostazioni nel file di configurazione:</span><span class="sxs-lookup"><span data-stu-id="78b27-291">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="78b27-292">Sicurezza: non disabilitare mai SSL in un'app di produzione.</span><span class="sxs-lookup"><span data-stu-id="78b27-292">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="78b27-293">Le credenziali di accesso vengono ora inviate in testo non crittografato attraverso la rete.</span><span class="sxs-lookup"><span data-stu-id="78b27-293">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="78b27-294">Il codice precedente è solo per il debug di esempio locale e l'esplorazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-294">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="78b27-295">Cliente grant implicito</span><span class="sxs-lookup"><span data-stu-id="78b27-295">Implicit Grant Client</span></span>

<span data-ttu-id="78b27-296">Questo client utilizza JavaScript per:</span><span class="sxs-lookup"><span data-stu-id="78b27-296">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="78b27-297">Aprire una nuova finestra e reindirizzare all'endpoint di autorizzazione del server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="78b27-297">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="78b27-298">Ottenere il token di accesso dai frammenti di URL quando viene reindirizzato.</span><span class="sxs-lookup"><span data-stu-id="78b27-298">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="78b27-299">L'immagine seguente mostra questo processo:The following image shows this process:</span><span class="sxs-lookup"><span data-stu-id="78b27-299">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="78b27-300">Il client deve avere due pagine: una per la home page e l'altra per la richiamata. Di seguito è riportato il codice JavaScript di esempio trovato nel file *Index.cshtml:Here* is the sample JavaScript code found in the Index.cshtml file:</span><span class="sxs-lookup"><span data-stu-id="78b27-300">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="78b27-301">Di seguito è riportato il codice di gestione dei callback nel file *SignIn.cshtml:Here* is the callback handling code in SignIn.cshtml file:</span><span class="sxs-lookup"><span data-stu-id="78b27-301">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="78b27-302">Una procedura consigliata consiste nello spostare il codice JavaScript in un file esterno e non incorporarlo con il markup Razor.</span><span class="sxs-lookup"><span data-stu-id="78b27-302">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="78b27-303">Per mantenere questo esempio semplice, sono stati combinati.</span><span class="sxs-lookup"><span data-stu-id="78b27-303">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="78b27-304">Credenziali password proprietario risorsa Concedere conferma client</span><span class="sxs-lookup"><span data-stu-id="78b27-304">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="78b27-305">Usiamo un'app console per disfare questo client.</span><span class="sxs-lookup"><span data-stu-id="78b27-305">We uses a console app to demo this client.</span></span> <span data-ttu-id="78b27-306">Il codice è il seguente:</span><span class="sxs-lookup"><span data-stu-id="78b27-306">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="78b27-307">Credenziali client Concedi client</span><span class="sxs-lookup"><span data-stu-id="78b27-307">Client Credentials Grant Client</span></span>

<span data-ttu-id="78b27-308">Analogamente alla concessione delle credenziali della password del proprietario della risorsa, ecco il codice dell'app console:Similar to the Resource Owner Password Credentials Grant, here is console app code:</span><span class="sxs-lookup"><span data-stu-id="78b27-308">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
