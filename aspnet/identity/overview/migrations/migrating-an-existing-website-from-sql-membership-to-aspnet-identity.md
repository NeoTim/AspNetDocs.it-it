---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: La migrazione di un sito Web esistente dall'appartenenza SQL ad ASP.NET Identity | Microsoft Docs
author: Rick-Anderson
description: Questa esercitazione illustra i passaggi per eseguire la migrazione di un'applicazione web esistente con l'utente e i dati del ruolo creati mediante l'appartenenza di SQL per la nuova identità di ASP.NET s...
ms.author: riande
ms.date: 12/19/2014
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: b80f2f5cc4702c3e406d8989905c56508711e788
ms.sourcegitcommit: 289e051cc8a90e8f7127e239fda73047bde4de12
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/25/2019
ms.locfileid: "58426081"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="67c1d-103">Migrazione di un sito Web esistente dall'appartenenza SQL ad ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="67c1d-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>

<span data-ttu-id="67c1d-104">dal [Rick Anderson]((https://twitter.com/RickAndMSFT)), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="67c1d-104">by [Rick Anderson]((https://twitter.com/RickAndMSFT)), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="67c1d-105">Questa esercitazione illustra i passaggi per eseguire la migrazione di un'applicazione web esistente con l'utente e i dati del ruolo creati mediante l'appartenenza di SQL nel nuovo sistema di identità di ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="67c1d-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="67c1d-106">Questo approccio comporta la modifica lo schema del database esistente a quella necessaria per l'identità di ASP.NET e hook nelle classi vecchi/nuovi a esso.</span><span class="sxs-lookup"><span data-stu-id="67c1d-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="67c1d-107">Dopo che si adotta questo approccio, dopo la migrazione del database, gli aggiornamenti futuri all'identità verranno gestiti senza fatica.</span><span class="sxs-lookup"><span data-stu-id="67c1d-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>

<span data-ttu-id="67c1d-108">Per questa esercitazione verrà usato un modello di applicazione web (Web Form) creato utilizzando Visual Studio 2010 per creare dati utente e il ruolo.</span><span class="sxs-lookup"><span data-stu-id="67c1d-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="67c1d-109">Si userà quindi gli script SQL per eseguire la migrazione del database esistente per le tabelle necessite per il sistema di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="67c1d-110">Verranno quindi installare i pacchetti NuGet necessari e aggiungere nuove pagine di gestione di account che usano il sistema di identità per gestione delle appartenenze.</span><span class="sxs-lookup"><span data-stu-id="67c1d-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="67c1d-111">Come un test della migrazione, gli utenti creati tramite l'appartenenza SQL devono essere in grado di accedere e devono essere in grado di registrare i nuovi utenti.</span><span class="sxs-lookup"><span data-stu-id="67c1d-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="67c1d-112">È possibile trovare l'esempio completo [qui](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/).</span><span class="sxs-lookup"><span data-stu-id="67c1d-112">You can find the complete sample [here](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="67c1d-113">Vedere anche [eseguire la migrazione dall'appartenenza ASP.NET ad ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span><span class="sxs-lookup"><span data-stu-id="67c1d-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span></span>

## <a name="getting-started"></a><span data-ttu-id="67c1d-114">Per iniziare</span><span class="sxs-lookup"><span data-stu-id="67c1d-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="67c1d-115">Creazione di un'applicazione con l'appartenenza di SQL</span><span class="sxs-lookup"><span data-stu-id="67c1d-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="67c1d-116">È necessario iniziare con un'applicazione esistente che usa l'appartenenza SQL e include dati utente e il ruolo.</span><span class="sxs-lookup"><span data-stu-id="67c1d-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="67c1d-117">Ai fini di questo articolo, è possibile creare un'applicazione web in Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="67c1d-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="67c1d-118">Utilizzare lo strumento di configurazione di ASP.NET, creare 2 utenti: **oldAdminUser** e **oldUser.**</span><span class="sxs-lookup"><span data-stu-id="67c1d-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="67c1d-119">Creare un ruolo denominato amministratore e aggiungere 'oldAdminUser' come utente nel ruolo in questione.</span><span class="sxs-lookup"><span data-stu-id="67c1d-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="67c1d-120">Creare una sezione di amministrazione del sito con un default. aspx.</span><span class="sxs-lookup"><span data-stu-id="67c1d-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="67c1d-121">Impostare il tag di autorizzazione nel file Web. config per abilitare l'accesso solo agli utenti nei ruoli di amministratore.</span><span class="sxs-lookup"><span data-stu-id="67c1d-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="67c1d-122">Altre informazioni sono disponibili qui [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="67c1d-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="67c1d-123">Visualizzare il database in Esplora Server per comprendere le tabelle create dal sistema di appartenenze SQL.</span><span class="sxs-lookup"><span data-stu-id="67c1d-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="67c1d-124">I dati dell'account di accesso utente viene archiviati in aspnet\_utenti e aspnet\_tabelle delle appartenenze, mentre i dati del ruolo viene archiviati nella aspnet\_tabella ruoli.</span><span class="sxs-lookup"><span data-stu-id="67c1d-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="67c1d-125">Informazioni su quali utenti sono in ruoli che sono archiviati in aspnet\_UsersInRoles tabella.</span><span class="sxs-lookup"><span data-stu-id="67c1d-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="67c1d-126">Per la gestione di appartenenza base è sufficiente trasferire le informazioni nelle tabelle precedenti per il sistema di identità di ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="67c1d-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="67c1d-127">Eseguire la migrazione a Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="67c1d-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="67c1d-128">Installare Visual Studio Express 2013 per Web o di Visual Studio 2013 con il [gli aggiornamenti più recenti](https://www.microsoft.com/download/details.aspx?id=44921).</span><span class="sxs-lookup"><span data-stu-id="67c1d-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="67c1d-129">Nella versione installata di Visual Studio, aprire il progetto precedente.</span><span class="sxs-lookup"><span data-stu-id="67c1d-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="67c1d-130">Se SQL Server Express non è installato nel computer, viene visualizzato un prompt dei comandi quando si apre il progetto, dato che la stringa di connessione Usa SQL Express.</span><span class="sxs-lookup"><span data-stu-id="67c1d-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="67c1d-131">È possibile scegliere di installare SQL Express o come soluzione alternativa modifica la stringa di connessione a LocalDb.</span><span class="sxs-lookup"><span data-stu-id="67c1d-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="67c1d-132">Per questo articolo, verranno modificate in LocalDb.</span><span class="sxs-lookup"><span data-stu-id="67c1d-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="67c1d-133">Aprire Web. config e modificare la stringa di connessione. SQLExpress per v11.0 (LocalDb).</span><span class="sxs-lookup"><span data-stu-id="67c1d-133">Open web.config and change the connection string from .SQLExpress to (LocalDb)v11.0.</span></span> <span data-ttu-id="67c1d-134">Rimuovere ' User Instance = true' dalla stringa di connessione.</span><span class="sxs-lookup"><span data-stu-id="67c1d-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="67c1d-135">Aprire Esplora Server e verificare che i dati e lo schema di tabella possono essere osservati.</span><span class="sxs-lookup"><span data-stu-id="67c1d-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="67c1d-136">Il sistema di identità ASP.NET funziona con la versione 4.5 o versione successiva del framework.</span><span class="sxs-lookup"><span data-stu-id="67c1d-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="67c1d-137">Ridestinare l'applicazione alla versione 4.5 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="67c1d-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="67c1d-138">Compilare il progetto per verificare che non siano presenti errori.</span><span class="sxs-lookup"><span data-stu-id="67c1d-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="67c1d-139">Installazione dei pacchetti Nuget</span><span class="sxs-lookup"><span data-stu-id="67c1d-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="67c1d-140">In Esplora soluzioni fare clic sul progetto &gt; **Gestisci pacchetti NuGet**.</span><span class="sxs-lookup"><span data-stu-id="67c1d-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="67c1d-141">Nella casella di ricerca immettere "Asp.net Identity".</span><span class="sxs-lookup"><span data-stu-id="67c1d-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="67c1d-142">Selezionare il pacchetto nell'elenco dei risultati e fare clic su Installa.</span><span class="sxs-lookup"><span data-stu-id="67c1d-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="67c1d-143">Accettare il contratto di licenza facendo clic sul pulsante "Accetto".</span><span class="sxs-lookup"><span data-stu-id="67c1d-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="67c1d-144">Si noti che questo pacchetto installerà i pacchetti di dipendenza: Entity Framework e Microsoft ASP.NET Identity Core.</span><span class="sxs-lookup"><span data-stu-id="67c1d-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="67c1d-145">Analogamente, installare i pacchetti seguenti (se non si vuole abilitare log aggiuntivo OAuth, ignorare le ultime 4 pacchetti OWIN):</span><span class="sxs-lookup"><span data-stu-id="67c1d-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

   - <span data-ttu-id="67c1d-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="67c1d-146">Microsoft.AspNet.Identity.Owin</span></span>
   - <span data-ttu-id="67c1d-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="67c1d-147">Microsoft.Owin.Host.SystemWeb</span></span>
   - <span data-ttu-id="67c1d-148">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="67c1d-148">Microsoft.Owin.Security.Facebook</span></span>
   - <span data-ttu-id="67c1d-149">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="67c1d-149">Microsoft.Owin.Security.Google</span></span>
   - <span data-ttu-id="67c1d-150">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="67c1d-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
   - <span data-ttu-id="67c1d-151">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="67c1d-151">Microsoft.Owin.Security.Twitter</span></span>

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="67c1d-152">Eseguire la migrazione di database nel nuovo sistema di identità</span><span class="sxs-lookup"><span data-stu-id="67c1d-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="67c1d-153">Il passaggio successivo consiste nella migrazione del database esistente a uno schema richiesto dal sistema ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="67c1d-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="67c1d-154">Per ottenere questo eseguiamo un database SQL di script che ha un set di comandi per creare nuove tabelle e la migrazione delle informazioni utente esistenti nelle nuove tabelle.</span><span class="sxs-lookup"><span data-stu-id="67c1d-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="67c1d-155">Il file di script sono reperibili [qui](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span><span class="sxs-lookup"><span data-stu-id="67c1d-155">The script file can be found [here](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="67c1d-156">Questo file di script è specifico per questo esempio.</span><span class="sxs-lookup"><span data-stu-id="67c1d-156">This script file is specific to this sample.</span></span> <span data-ttu-id="67c1d-157">Se lo schema per le tabelle create tramite l'appartenenza SQL personalizzato o modificato la necessità di script per essere modificato di conseguenza.</span><span class="sxs-lookup"><span data-stu-id="67c1d-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="67c1d-158">Come generare lo script SQL per la migrazione dello schema</span><span class="sxs-lookup"><span data-stu-id="67c1d-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="67c1d-159">Per le classi di ASP.NET Identity a funziona automaticamente con i dati degli utenti esistenti, è necessario eseguire la migrazione dello schema del database a quello richiesto dall'identità di ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="67c1d-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="67c1d-160">È possibile farlo mediante l'aggiunta di nuove tabelle e copia le informazioni esistenti in tali tabelle.</span><span class="sxs-lookup"><span data-stu-id="67c1d-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="67c1d-161">Per impostazione predefinita ASP.NET Identity Usa EntityFramework per eseguire il mapping di classi del modello di identità nel database di archiviare/recuperare le informazioni.</span><span class="sxs-lookup"><span data-stu-id="67c1d-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="67c1d-162">Queste classi modello implementano le interfacce di identità core la definizione di utente e gli oggetti role.</span><span class="sxs-lookup"><span data-stu-id="67c1d-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="67c1d-163">Le tabelle e le colonne nel database si basano su queste classi di modello.</span><span class="sxs-lookup"><span data-stu-id="67c1d-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="67c1d-164">Le classi modello EntityFramework 2.1.0 in identità e le relative proprietà sono definite come segue</span><span class="sxs-lookup"><span data-stu-id="67c1d-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="67c1d-165">**IdentityUser**</span><span class="sxs-lookup"><span data-stu-id="67c1d-165">**IdentityUser**</span></span> | <span data-ttu-id="67c1d-166">**Type**</span><span class="sxs-lookup"><span data-stu-id="67c1d-166">**Type**</span></span> | <span data-ttu-id="67c1d-167">**IdentityRole**</span><span class="sxs-lookup"><span data-stu-id="67c1d-167">**IdentityRole**</span></span> | <span data-ttu-id="67c1d-168">**IdentityUserRole**</span><span class="sxs-lookup"><span data-stu-id="67c1d-168">**IdentityUserRole**</span></span> | <span data-ttu-id="67c1d-169">**IdentityUserLogin**</span><span class="sxs-lookup"><span data-stu-id="67c1d-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="67c1d-170">**IdentityUserClaim**</span><span class="sxs-lookup"><span data-stu-id="67c1d-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="67c1d-171">Id</span><span class="sxs-lookup"><span data-stu-id="67c1d-171">Id</span></span> | <span data-ttu-id="67c1d-172">string</span><span class="sxs-lookup"><span data-stu-id="67c1d-172">string</span></span> | <span data-ttu-id="67c1d-173">Id</span><span class="sxs-lookup"><span data-stu-id="67c1d-173">Id</span></span> | <span data-ttu-id="67c1d-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="67c1d-174">RoleId</span></span> | <span data-ttu-id="67c1d-175">ProviderKey</span><span class="sxs-lookup"><span data-stu-id="67c1d-175">ProviderKey</span></span> | <span data-ttu-id="67c1d-176">Id</span><span class="sxs-lookup"><span data-stu-id="67c1d-176">Id</span></span> |
| <span data-ttu-id="67c1d-177">Nome utente</span><span class="sxs-lookup"><span data-stu-id="67c1d-177">Username</span></span> | <span data-ttu-id="67c1d-178">string</span><span class="sxs-lookup"><span data-stu-id="67c1d-178">string</span></span> | <span data-ttu-id="67c1d-179">Nome</span><span class="sxs-lookup"><span data-stu-id="67c1d-179">Name</span></span> | <span data-ttu-id="67c1d-180">UserId</span><span class="sxs-lookup"><span data-stu-id="67c1d-180">UserId</span></span> | <span data-ttu-id="67c1d-181">UserId</span><span class="sxs-lookup"><span data-stu-id="67c1d-181">UserId</span></span> | <span data-ttu-id="67c1d-182">ClaimType</span><span class="sxs-lookup"><span data-stu-id="67c1d-182">ClaimType</span></span> |
| <span data-ttu-id="67c1d-183">PasswordHash</span><span class="sxs-lookup"><span data-stu-id="67c1d-183">PasswordHash</span></span> | <span data-ttu-id="67c1d-184">string</span><span class="sxs-lookup"><span data-stu-id="67c1d-184">string</span></span> |  |  | <span data-ttu-id="67c1d-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="67c1d-185">LoginProvider</span></span> | <span data-ttu-id="67c1d-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="67c1d-186">ClaimValue</span></span> |
| <span data-ttu-id="67c1d-187">SecurityStamp</span><span class="sxs-lookup"><span data-stu-id="67c1d-187">SecurityStamp</span></span> | <span data-ttu-id="67c1d-188">string</span><span class="sxs-lookup"><span data-stu-id="67c1d-188">string</span></span> |  |  |  | <span data-ttu-id="67c1d-189">Utente\_Id</span><span class="sxs-lookup"><span data-stu-id="67c1d-189">User\_Id</span></span> |
| <span data-ttu-id="67c1d-190">Email</span><span class="sxs-lookup"><span data-stu-id="67c1d-190">Email</span></span> | <span data-ttu-id="67c1d-191">string</span><span class="sxs-lookup"><span data-stu-id="67c1d-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="67c1d-192">EmailConfirmed</span><span class="sxs-lookup"><span data-stu-id="67c1d-192">EmailConfirmed</span></span> | <span data-ttu-id="67c1d-193">bool</span><span class="sxs-lookup"><span data-stu-id="67c1d-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="67c1d-194">Numero di telefono</span><span class="sxs-lookup"><span data-stu-id="67c1d-194">PhoneNumber</span></span> | <span data-ttu-id="67c1d-195">string</span><span class="sxs-lookup"><span data-stu-id="67c1d-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="67c1d-196">PhoneNumberConfirmed</span><span class="sxs-lookup"><span data-stu-id="67c1d-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="67c1d-197">bool</span><span class="sxs-lookup"><span data-stu-id="67c1d-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="67c1d-198">LockoutEnabled</span><span class="sxs-lookup"><span data-stu-id="67c1d-198">LockoutEnabled</span></span> | <span data-ttu-id="67c1d-199">bool</span><span class="sxs-lookup"><span data-stu-id="67c1d-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="67c1d-200">LockoutEndDate</span><span class="sxs-lookup"><span data-stu-id="67c1d-200">LockoutEndDate</span></span> | <span data-ttu-id="67c1d-201">DateTime</span><span class="sxs-lookup"><span data-stu-id="67c1d-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="67c1d-202">AccessFailedCount</span><span class="sxs-lookup"><span data-stu-id="67c1d-202">AccessFailedCount</span></span> | <span data-ttu-id="67c1d-203">int</span><span class="sxs-lookup"><span data-stu-id="67c1d-203">int</span></span> |  |  |  |  |

<span data-ttu-id="67c1d-204">È necessario disporre di tabelle per ognuno di questi modelli le cui colonne corrispondono alle proprietà.</span><span class="sxs-lookup"><span data-stu-id="67c1d-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="67c1d-205">Il mapping tra le classi e le tabelle viene definito nel `OnModelCreating` metodo del `IdentityDBContext`.</span><span class="sxs-lookup"><span data-stu-id="67c1d-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="67c1d-206">Ciò è noto come il metodo API fluent della configurazione e altre informazioni sono reperibili [qui](https://msdn.microsoft.com/data/jj591617.aspx).</span><span class="sxs-lookup"><span data-stu-id="67c1d-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/data/jj591617.aspx).</span></span> <span data-ttu-id="67c1d-207">La configurazione per le classi è come indicato di seguito</span><span class="sxs-lookup"><span data-stu-id="67c1d-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="67c1d-208">**Classe**</span><span class="sxs-lookup"><span data-stu-id="67c1d-208">**Class**</span></span> | <span data-ttu-id="67c1d-209">**Tabella**</span><span class="sxs-lookup"><span data-stu-id="67c1d-209">**Table**</span></span> | <span data-ttu-id="67c1d-210">**Chiave primaria**</span><span class="sxs-lookup"><span data-stu-id="67c1d-210">**Primary key**</span></span> | <span data-ttu-id="67c1d-211">**Chiave esterna**</span><span class="sxs-lookup"><span data-stu-id="67c1d-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="67c1d-212">IdentityUser</span><span class="sxs-lookup"><span data-stu-id="67c1d-212">IdentityUser</span></span> | <span data-ttu-id="67c1d-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="67c1d-213">AspnetUsers</span></span> | <span data-ttu-id="67c1d-214">Id</span><span class="sxs-lookup"><span data-stu-id="67c1d-214">Id</span></span> |  |
| <span data-ttu-id="67c1d-215">IdentityRole</span><span class="sxs-lookup"><span data-stu-id="67c1d-215">IdentityRole</span></span> | <span data-ttu-id="67c1d-216">AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="67c1d-216">AspnetRoles</span></span> | <span data-ttu-id="67c1d-217">Id</span><span class="sxs-lookup"><span data-stu-id="67c1d-217">Id</span></span> |  |
| <span data-ttu-id="67c1d-218">IdentityUserRole</span><span class="sxs-lookup"><span data-stu-id="67c1d-218">IdentityUserRole</span></span> | <span data-ttu-id="67c1d-219">AspnetUserRole</span><span class="sxs-lookup"><span data-stu-id="67c1d-219">AspnetUserRole</span></span> | <span data-ttu-id="67c1d-220">UserId + RoleId</span><span class="sxs-lookup"><span data-stu-id="67c1d-220">UserId + RoleId</span></span> | <span data-ttu-id="67c1d-221">Utente\_Id -&gt;AspnetUsers RoleId -&gt;AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="67c1d-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="67c1d-222">IdentityUserLogin</span><span class="sxs-lookup"><span data-stu-id="67c1d-222">IdentityUserLogin</span></span> | <span data-ttu-id="67c1d-223">AspnetUserLogins</span><span class="sxs-lookup"><span data-stu-id="67c1d-223">AspnetUserLogins</span></span> | <span data-ttu-id="67c1d-224">Provider + UserId + LoginProvider</span><span class="sxs-lookup"><span data-stu-id="67c1d-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="67c1d-225">UserId-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="67c1d-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="67c1d-226">IdentityUserClaim</span><span class="sxs-lookup"><span data-stu-id="67c1d-226">IdentityUserClaim</span></span> | <span data-ttu-id="67c1d-227">AspnetUserClaims</span><span class="sxs-lookup"><span data-stu-id="67c1d-227">AspnetUserClaims</span></span> | <span data-ttu-id="67c1d-228">Id</span><span class="sxs-lookup"><span data-stu-id="67c1d-228">Id</span></span> | <span data-ttu-id="67c1d-229">User\_Id-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="67c1d-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="67c1d-230">Con queste informazioni è possibile creare istruzioni SQL per creare nuove tabelle.</span><span class="sxs-lookup"><span data-stu-id="67c1d-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="67c1d-231">È possibile scrivere ogni istruzione individualmente o generare l'intero script tramite EntityFramework PowerShell comandi che è quindi possibile modificare in base alle esigenze.</span><span class="sxs-lookup"><span data-stu-id="67c1d-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="67c1d-232">A tale scopo, in Visual Studio aprire il **Console di gestione pacchetti** dal **View** o **strumenti** menu</span><span class="sxs-lookup"><span data-stu-id="67c1d-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="67c1d-233">Esegui comando "Enable-Migrations" per abilitare le migrazioni di Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="67c1d-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="67c1d-234">Eseguire il comando "Add-migration initial" che consente di creare il codice di configurazione iniziale per creare il database in c# o VB.</span><span class="sxs-lookup"><span data-stu-id="67c1d-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="67c1d-235">Il passaggio finale consiste nell'eseguire "Update-Database-Script" comando che genera lo script SQL basati sulle classi del modello.</span><span class="sxs-lookup"><span data-stu-id="67c1d-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

<span data-ttu-id="67c1d-236">Questo script di generazione di database può essere utilizzato come punto di partenza in cui è possibile apportare ulteriori modifiche per aggiungere nuove colonne e copiare i dati.</span><span class="sxs-lookup"><span data-stu-id="67c1d-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="67c1d-237">Il vantaggio consiste nel fatto che si generino la `_MigrationHistory` tabella cui viene usata da Entity Framework per modificare lo schema del database quando il modello di classi di modifica per le versioni future dei rilasci di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span>

<span data-ttu-id="67c1d-238">Le informazioni sull'utente di appartenenza SQL era altri proprietà oltre a quelli nella classe di modello di identità utente particolare messaggio di posta elettronica, tentativi di password, data dell'ultimo accesso, l'ultima data di blocco e così via. Si tratta di informazioni utili e ci piacerebbe che deve essere eseguita il sistema di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="67c1d-239">Questa operazione può essere eseguita aggiungendo le proprietà aggiuntive per il modello di utente e li esegue il mapping a colonne della tabella nel database.</span><span class="sxs-lookup"><span data-stu-id="67c1d-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="67c1d-240">È possibile farlo mediante l'aggiunta di una classe che rappresenti le sottoclassi di `IdentityUser` modello.</span><span class="sxs-lookup"><span data-stu-id="67c1d-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="67c1d-241">È possibile aggiungere le proprietà per questa classe personalizzata e modificare lo script SQL per aggiungere le colonne corrispondenti durante la creazione della tabella.</span><span class="sxs-lookup"><span data-stu-id="67c1d-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="67c1d-242">Il codice per questa classe è descritto più dettagliatamente nell'articolo.</span><span class="sxs-lookup"><span data-stu-id="67c1d-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="67c1d-243">Lo script SQL per la creazione di `AspnetUsers` tabella dopo l'aggiunta di nuove proprietà saranno</span><span class="sxs-lookup"><span data-stu-id="67c1d-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="67c1d-244">Successivamente è necessario copiare le informazioni esistenti dal database di appartenenze SQL alle tabelle appena aggiunte per l'identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="67c1d-245">Questa operazione può essere eseguita tramite SQL copiando i dati direttamente da una tabella a altra.</span><span class="sxs-lookup"><span data-stu-id="67c1d-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="67c1d-246">Per aggiungere i dati nelle righe della tabella, usiamo il `INSERT INTO [Table]` costruire.</span><span class="sxs-lookup"><span data-stu-id="67c1d-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="67c1d-247">Per copiare da un'altra tabella è possibile usare la `INSERT INTO` istruzione con il `SELECT` istruzione.</span><span class="sxs-lookup"><span data-stu-id="67c1d-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="67c1d-248">Per ottenere tutte le informazioni utente è necessario eseguire una query il *aspnet\_gli utenti* e *aspnet\_appartenenza* tabelle e copiare i dati di *AspNetUsers*nella tabella.</span><span class="sxs-lookup"><span data-stu-id="67c1d-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="67c1d-249">Usiamo il `INSERT INTO` e `SELECT` insieme a `JOIN` e `LEFT OUTER JOIN` istruzioni.</span><span class="sxs-lookup"><span data-stu-id="67c1d-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="67c1d-250">Per altre informazioni sull'esecuzione di query e la copia dei dati tra tabelle, fare riferimento a [ciò](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) collegamento.</span><span class="sxs-lookup"><span data-stu-id="67c1d-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="67c1d-251">Inoltre le tabelle AspnetUserLogins e AspnetUserClaims sono vuote per iniziare perché non sono disponibili informazioni di appartenenza SQL che esegue il mapping a questo per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="67c1d-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="67c1d-252">L'unica informazione copiato è per utenti e ruoli.</span><span class="sxs-lookup"><span data-stu-id="67c1d-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="67c1d-253">Per il progetto creato nei passaggi precedenti, sarà la query SQL per copiare le informazioni alla tabella users</span><span class="sxs-lookup"><span data-stu-id="67c1d-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="67c1d-254">Nell'istruzione SQL precedente, le informazioni relative a ciascun utente dal *aspnet\_gli utenti* e *aspnet\_appartenenza* tabelle viene copiato in colonne di  *AspnetUsers* tabella.</span><span class="sxs-lookup"><span data-stu-id="67c1d-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="67c1d-255">L'unica modifica eseguita in questo caso è quando si copia la password.</span><span class="sxs-lookup"><span data-stu-id="67c1d-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="67c1d-256">Poiché l'algoritmo di crittografia per le password nell'appartenenza SQL utilizzato 'PasswordSalt' e 'PasswordFormat', copiamo che troppo con password con hash in modo che può essere utilizzato per decrittografare la password dall'identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="67c1d-257">Ciò è illustrato più dettagliatamente nell'articolo quando agganciarmi hasher una password personalizzata.</span><span class="sxs-lookup"><span data-stu-id="67c1d-257">This is explained further in the article when hooking up a custom password hasher.</span></span>

<span data-ttu-id="67c1d-258">Questo file di script è specifico per questo esempio.</span><span class="sxs-lookup"><span data-stu-id="67c1d-258">This script file is specific to this sample.</span></span> <span data-ttu-id="67c1d-259">Per le applicazioni che hanno tabelle aggiuntive, gli sviluppatori possono seguire un approccio simile per aggiungere ulteriori proprietà sulla classe di modello utente ed eseguirne il mapping alle colonne nella tabella AspnetUsers.</span><span class="sxs-lookup"><span data-stu-id="67c1d-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="67c1d-260">Per eseguire lo script,</span><span class="sxs-lookup"><span data-stu-id="67c1d-260">To run the script,</span></span>

1. <span data-ttu-id="67c1d-261">Aprire Esplora Server.</span><span class="sxs-lookup"><span data-stu-id="67c1d-261">Open Server Explorer.</span></span> <span data-ttu-id="67c1d-262">Espandere la connessione 'ApplicationServices' per visualizzare le tabelle.</span><span class="sxs-lookup"><span data-stu-id="67c1d-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="67c1d-263">Fare clic con il pulsante destro sul nodo Tables e selezionare l'opzione 'Nuova Query'</span><span class="sxs-lookup"><span data-stu-id="67c1d-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="67c1d-264">Nella finestra di query, copiare e incollare l'intero script SQL dal file Migrations.sql.</span><span class="sxs-lookup"><span data-stu-id="67c1d-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="67c1d-265">Eseguire il file di script facendo clic sul pulsante freccia 'Execute'.</span><span class="sxs-lookup"><span data-stu-id="67c1d-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="67c1d-266">Aggiornare la finestra di Esplora Server.</span><span class="sxs-lookup"><span data-stu-id="67c1d-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="67c1d-267">Vengono create cinque nuove tabelle nel database.</span><span class="sxs-lookup"><span data-stu-id="67c1d-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="67c1d-268">Di seguito è la modalità di mapping le informazioni nelle tabelle di appartenenza SQL nel nuovo sistema di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="67c1d-269">ASPNET\_ruoli -&gt; AspNetRoles</span><span class="sxs-lookup"><span data-stu-id="67c1d-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="67c1d-270">ASP\_netUsers e asp\_netMembership -&gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="67c1d-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="67c1d-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span><span class="sxs-lookup"><span data-stu-id="67c1d-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="67c1d-272">Come spiegato nella sezione precedente, le tabelle AspNetUserClaims e AspNetUserLogins sono vuote.</span><span class="sxs-lookup"><span data-stu-id="67c1d-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="67c1d-273">Il campo 'Discriminatore' nella tabella AspNetUser deve corrispondere al nome di classe modello che è definito come un passaggio successivo.</span><span class="sxs-lookup"><span data-stu-id="67c1d-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="67c1d-274">Anche la colonna PasswordHash è nel formato ' password crittografata | valore salt della password | il formato della password'.</span><span class="sxs-lookup"><span data-stu-id="67c1d-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="67c1d-275">In questo modo è possibile usare per la logica crypto di appartenenze SQL speciale in modo da poterla riutilizzare password precedenti.</span><span class="sxs-lookup"><span data-stu-id="67c1d-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="67c1d-276">Che viene spiegato in seguito in questo articolo.</span><span class="sxs-lookup"><span data-stu-id="67c1d-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="67c1d-277">Creazione di modelli e le pagine di appartenenza</span><span class="sxs-lookup"><span data-stu-id="67c1d-277">Creating models and membership pages</span></span>

<span data-ttu-id="67c1d-278">Come accennato in precedenza, la funzionalità di identità Usa Entity Framework per comunicare con il database per archiviare le informazioni sull'account per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="67c1d-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="67c1d-279">Per lavorare con i dati esistenti nella tabella, è necessario creare le classi modello che eseguire il mapping a tabelle e agganciare il sistema di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="67c1d-280">Come parte del contratto dell'identità, le classi del modello devono implementare le interfacce definite nella dll Identity.Core o estendono l'implementazione esistente di queste interfacce disponibili in EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="67c1d-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="67c1d-281">Nel nostro esempio, le tabelle AspNetRoles, AspNetUserClaims, AspNetLogins e AspNetUserRole presentano colonne che sono simili per l'implementazione esistente del sistema di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="67c1d-282">Di conseguenza è possibile riutilizzare le classi esistenti per eseguire il mapping a queste tabelle.</span><span class="sxs-lookup"><span data-stu-id="67c1d-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="67c1d-283">La tabella AspNetUser include alcune colonne aggiuntive che vengono usati per archiviare informazioni aggiuntive dalle tabelle delle appartenenze di SQL.</span><span class="sxs-lookup"><span data-stu-id="67c1d-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="67c1d-284">Ciò può essere mappato mediante la creazione di una classe di modello che estendono l'implementazione esistente di 'IdentityUser' e aggiungere le proprietà aggiuntive.</span><span class="sxs-lookup"><span data-stu-id="67c1d-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="67c1d-285">Creare una cartella modelli del progetto e aggiungere una classe utente.</span><span class="sxs-lookup"><span data-stu-id="67c1d-285">Create a Models folder in the project and add a class User.</span></span> <span data-ttu-id="67c1d-286">Il nome della classe deve corrispondere i dati aggiunti nella colonna 'Discriminatore' della tabella 'AspnetUsers'.</span><span class="sxs-lookup"><span data-stu-id="67c1d-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="67c1d-287">La classe dell'utente deve estendere la classe IdentityUser trovata nel *EntityFramework* dll.</span><span class="sxs-lookup"><span data-stu-id="67c1d-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="67c1d-288">Dichiarare le proprietà nella classe che fanno riferimento al AspNetUser colonne.</span><span class="sxs-lookup"><span data-stu-id="67c1d-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="67c1d-289">Le proprietà ID, nome utente, PasswordHash e SecurityStamp definite nel IdentityUser e pertanto vengono omessi.</span><span class="sxs-lookup"><span data-stu-id="67c1d-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="67c1d-290">Di seguito è riportato il codice per la classe utente che dispone di tutte le proprietà</span><span class="sxs-lookup"><span data-stu-id="67c1d-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="67c1d-291">Una classe DbContext di Entity Framework è necessaria per rendere persistenti i dati nei modelli a tabelle e recuperare dati dalle tabelle per popolare i modelli.</span><span class="sxs-lookup"><span data-stu-id="67c1d-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="67c1d-292">*EntityFramework* dll definisce la classe di IdentityDbContext che interagisce con le tabelle di identità per recuperare e archiviare informazioni.</span><span class="sxs-lookup"><span data-stu-id="67c1d-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="67c1d-293">IdentityDbContext&lt;tuser&gt; accetta una classe 'TUser' che può essere qualsiasi classe che estende la classe IdentityUser.</span><span class="sxs-lookup"><span data-stu-id="67c1d-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="67c1d-294">Creare una nuova classe ApplicationDBContext che estende IdentityDbContext sotto la cartella 'Modelli', passando la classe 'User' creata nel passaggio 1</span><span class="sxs-lookup"><span data-stu-id="67c1d-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="67c1d-295">Gestione degli utenti nel nuovo sistema di identità viene eseguita usando la classe UserManager&lt;tuser&gt; definito nella classe la *EntityFramework* dll.</span><span class="sxs-lookup"><span data-stu-id="67c1d-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="67c1d-296">È necessario creare una classe personalizzata che estende UserManager, passando la classe 'User' creata nel passaggio 1.</span><span class="sxs-lookup"><span data-stu-id="67c1d-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="67c1d-297">Nella cartella Models creare una nuova classe UserManager che estende UserManager&lt;utente&gt;</span><span class="sxs-lookup"><span data-stu-id="67c1d-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="67c1d-298">Le password degli utenti dell'applicazione vengono crittografate e archiviate nel database.</span><span class="sxs-lookup"><span data-stu-id="67c1d-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="67c1d-299">L'algoritmo di crittografia usato nell'appartenenza SQL è diversa da quella nel nuovo sistema di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="67c1d-300">Per riutilizzare le password precedenti è necessario decrittografare in modo selettivo le password quando dei vecchi utenti accedono usando l'algoritmo di appartenenze SQL quando si usa l'algoritmo di crittografia nell'identità per i nuovi utenti.</span><span class="sxs-lookup"><span data-stu-id="67c1d-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="67c1d-301">La classe UserManager ha una proprietà 'PasswordHasher' che contiene un'istanza di una classe che implementa l'interfaccia 'IPasswordHasher'.</span><span class="sxs-lookup"><span data-stu-id="67c1d-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="67c1d-302">Viene utilizzato per crittografare/decrittografare le password durante operazioni di autenticazione utente.</span><span class="sxs-lookup"><span data-stu-id="67c1d-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="67c1d-303">La classe UserManager definita nel passaggio 3, creare una nuova classe SQLPasswordHasher e copiare il codice riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="67c1d-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="67c1d-304">Per risolvere gli errori di compilazione, l'importazione di spazi dei nomi System. Text e Cryptography.</span><span class="sxs-lookup"><span data-stu-id="67c1d-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="67c1d-305">Il metodo EncodePassword crittografa la password in base all'implementazione di operazioni di crittografia appartenenze SQL predefinita.</span><span class="sxs-lookup"><span data-stu-id="67c1d-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="67c1d-306">Questi dati vengono estratti dalla dll System. Web.</span><span class="sxs-lookup"><span data-stu-id="67c1d-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="67c1d-307">Se l'app precedente usato un'implementazione personalizzata deve riflettersi qui.</span><span class="sxs-lookup"><span data-stu-id="67c1d-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="67c1d-308">È necessario definire due altri metodi *HashPassword* e *VerifyHashedPassword* che utilizzano il *EncodePassword* metodo per l'hashing di una password o verificare un testo normale password con uno esistente nel database.</span><span class="sxs-lookup"><span data-stu-id="67c1d-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="67c1d-309">Il sistema di appartenenze SQL utilizzato PasswordHash, PasswordSalt e PasswordFormat per l'hash della password immesse dagli utenti quando si registra o si modificano la propria password.</span><span class="sxs-lookup"><span data-stu-id="67c1d-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="67c1d-310">Durante la migrazione dei tre campi vengono archiviati nella colonna PasswordHash nella tabella AspNetUser separata con il ' |' caratteri.</span><span class="sxs-lookup"><span data-stu-id="67c1d-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="67c1d-311">Quando un utente esegue l'accesso e la password contiene questi campi, di crittografia di appartenenze SQL viene usato per verificare la password; in caso contrario è usare la crittografia predefinita del sistema di identità per verificare la password.</span><span class="sxs-lookup"><span data-stu-id="67c1d-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="67c1d-312">In questo modo gli utenti precedenti non dovrà modificare la password una volta che viene eseguita la migrazione dell'app.</span><span class="sxs-lookup"><span data-stu-id="67c1d-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="67c1d-313">Dichiarare il costruttore per la classe UserManager e passarlo come il SQLPasswordHasher alla proprietà nel costruttore.</span><span class="sxs-lookup"><span data-stu-id="67c1d-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="67c1d-314">Crea nuovo account di pagine di gestione</span><span class="sxs-lookup"><span data-stu-id="67c1d-314">Create new account management pages</span></span>

<span data-ttu-id="67c1d-315">Il passaggio successivo nel processo di migrazione consiste nell'aggiungere le pagine di gestione di account che verranno consentono agli utenti di registrare ed eseguire l'accesso.</span><span class="sxs-lookup"><span data-stu-id="67c1d-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="67c1d-316">Le pagine di account precedente dall'appartenenza SQL usano i controlli che non funzionano con il nuovo sistema di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="67c1d-317">Per aggiungere il nuovo utente pagine di gestione di seguono l'esercitazione in questo collegamento [ https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project ](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) partendo dal passaggio 'Aggiunta di Web Form per la registrazione degli utenti all'applicazione' poiché abbiamo già creato il progetto e aggiunta di NuGet pacchetti.</span><span class="sxs-lookup"><span data-stu-id="67c1d-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="67c1d-318">È necessario apportare alcune modifiche per l'esempio di funzioni con il progetto che è disponibile qui.</span><span class="sxs-lookup"><span data-stu-id="67c1d-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="67c1d-319">Register.aspx.cs e Login.aspx.cs code-behind Usa le classi di `UserManager` dai pacchetti di identità per creare un utente.</span><span class="sxs-lookup"><span data-stu-id="67c1d-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="67c1d-320">Per questo esempio Usa la classe UserManager aggiunta nella cartella Models da seguendo la procedura descritta in precedenza.</span><span class="sxs-lookup"><span data-stu-id="67c1d-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="67c1d-321">Usare la classe utente creata anziché IdentityUser in Register.aspx.cs e Login.aspx.cs code-behind di classi.</span><span class="sxs-lookup"><span data-stu-id="67c1d-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="67c1d-322">Questo hook nella nostra classe utente personalizzata nel sistema di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="67c1d-323">La parte per creare il database può essere ignorata.</span><span class="sxs-lookup"><span data-stu-id="67c1d-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="67c1d-324">Lo sviluppatore deve impostare l'ID applicazione per il nuovo utente in base l'ID dell'applicazione corrente.</span><span class="sxs-lookup"><span data-stu-id="67c1d-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="67c1d-325">Questa operazione può essere eseguita l'esecuzione di query l'ID applicazione per l'applicazione prima della creazione di un oggetto utente nella classe Register.aspx.cs e impostandolo prima della creazione utente.</span><span class="sxs-lookup"><span data-stu-id="67c1d-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span>

    <span data-ttu-id="67c1d-326">Esempio:</span><span class="sxs-lookup"><span data-stu-id="67c1d-326">Example:</span></span>

    <span data-ttu-id="67c1d-327">Un metodo definito nella pagina Register.aspx.cs per eseguire una query aspnet\_applicazioni di tabella e ottenere l'Id applicazione in base al nome dell'applicazione</span><span class="sxs-lookup"><span data-stu-id="67c1d-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="67c1d-328">A questo punto recupero / impostazione questo nell'oggetto utente</span><span class="sxs-lookup"><span data-stu-id="67c1d-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="67c1d-329">Usare il nome utente precedente e la password per accedere un utente esistente.</span><span class="sxs-lookup"><span data-stu-id="67c1d-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="67c1d-330">Utilizzare la pagina di registrazione per creare un nuovo utente.</span><span class="sxs-lookup"><span data-stu-id="67c1d-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="67c1d-331">Verificare inoltre che gli utenti siano in ruoli come previsto.</span><span class="sxs-lookup"><span data-stu-id="67c1d-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="67c1d-332">Porting per il sistema di identità consente all'utente di aggiungere l'autenticazione aperta (OAuth) all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="67c1d-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="67c1d-333">Vedere l'esempio [qui](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/) con OAuth abilitato.</span><span class="sxs-lookup"><span data-stu-id="67c1d-333">Please refer to the sample [here](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="67c1d-334">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="67c1d-334">Next Steps</span></span>

<span data-ttu-id="67c1d-335">In questa esercitazione è stato illustrato come convertire gli utenti dall'appartenenza SQL ad ASP.NET Identity, ma è non trasferire i dati del profilo.</span><span class="sxs-lookup"><span data-stu-id="67c1d-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="67c1d-336">Nella prossima esercitazione verrà illustrato nel trasferimento dei dati di profilo dall'appartenenza SQL nel nuovo sistema di identità.</span><span class="sxs-lookup"><span data-stu-id="67c1d-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="67c1d-337">È possibile lasciare commenti e suggerimenti nella parte inferiore di questo articolo.</span><span class="sxs-lookup"><span data-stu-id="67c1d-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="67c1d-338">*Tom Dykstra e Rick Anderson grazie per aver letto l'articolo.*</span><span class="sxs-lookup"><span data-stu-id="67c1d-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
