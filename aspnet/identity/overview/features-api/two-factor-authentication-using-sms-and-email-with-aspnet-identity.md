---
uid: identity/overview/features-api/two-factor-authentication-using-sms-and-email-with-aspnet-identity
title: Autenticazione a due fattori tramite SMS e posta elettronica con ASP.NET Identity-ASP.NET 4. x
author: HaoK
description: In questa esercitazione verrà illustrato come configurare l'autenticazione a due fattori (2FA) tramite SMS e posta elettronica. Questo articolo è stato scritto da Rick Anderson (@RickAndMSFT), Pr...
ms.author: riande
ms.date: 09/15/2015
ms.assetid: 053e23c4-13c9-40fa-87cb-3e9b0823b31e
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/features-api/two-factor-authentication-using-sms-and-email-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 5f5218ca6c65ed3a2cd39d4e100349efa35d14cd
ms.sourcegitcommit: 6f0e10e4ca61a1e5534b09c655fd35cdc6886c8a
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 11/15/2019
ms.locfileid: "74115093"
---
# <a name="two-factorauthentication-using-sms-and-email-with-aspnet-identity"></a><span data-ttu-id="c89e1-104">Autenticazione a due fattori tramite SMS e posta elettronica con ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="c89e1-104">Two-factor authentication using SMS and email with ASP.NET Identity</span></span>

<span data-ttu-id="c89e1-105">di [Hao Kung](https://github.com/HaoK), Manuel [Rastogi](https://github.com/rustd), [Rick Anderson]((https://twitter.com/RickAndMSFT)), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="c89e1-105">by [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson]((https://twitter.com/RickAndMSFT)), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="c89e1-106">In questa esercitazione verrà illustrato come configurare l'autenticazione a due fattori (2FA) tramite SMS e posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="c89e1-106">This tutorial will show you how to set up Two-factor authentication (2FA) using SMS and email.</span></span>
> 
> <span data-ttu-id="c89e1-107">Questo articolo è stato scritto da Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung e Suhas Joshi.</span><span class="sxs-lookup"><span data-stu-id="c89e1-107">This article was written by Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung, and Suhas Joshi.</span></span> <span data-ttu-id="c89e1-108">L'esempio NuGet è stato scritto principalmente da Hao Kung.</span><span class="sxs-lookup"><span data-stu-id="c89e1-108">The NuGet sample was written primarily by Hao Kung.</span></span>

<span data-ttu-id="c89e1-109">In questo argomento vengono illustrate le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="c89e1-109">This topic covers the following:</span></span>

- [<span data-ttu-id="c89e1-110">Compilazione dell'esempio di identità</span><span class="sxs-lookup"><span data-stu-id="c89e1-110">Building the Identity sample</span></span>](#build)
- [<span data-ttu-id="c89e1-111">Configurare SMS per l'autenticazione a due fattori</span><span class="sxs-lookup"><span data-stu-id="c89e1-111">Set up SMS for Two-factor authentication</span></span>](#SMS)
- [<span data-ttu-id="c89e1-112">Abilitare l'autenticazione a due fattori</span><span class="sxs-lookup"><span data-stu-id="c89e1-112">Enable Two-factor authentication</span></span>](#enable2)
- [<span data-ttu-id="c89e1-113">Come registrare un provider di autenticazione a due fattori</span><span class="sxs-lookup"><span data-stu-id="c89e1-113">How to register a Two-factor authentication provider</span></span>](#reg)
- [<span data-ttu-id="c89e1-114">Combinare account di accesso di social networking e locali</span><span class="sxs-lookup"><span data-stu-id="c89e1-114">Combine social and local login accounts</span></span>](#combine)
- [<span data-ttu-id="c89e1-115">Blocco degli account da attacchi di forza bruta</span><span class="sxs-lookup"><span data-stu-id="c89e1-115">Account lockout from brute force attacks</span></span>](#lock)

<a id="build"></a>

## <a name="building-the-identity-sample"></a><span data-ttu-id="c89e1-116">Compilazione dell'esempio di identità</span><span class="sxs-lookup"><span data-stu-id="c89e1-116">Building the Identity sample</span></span>

<span data-ttu-id="c89e1-117">In questa sezione si userà NuGet per scaricare un esempio che verrà usato con.</span><span class="sxs-lookup"><span data-stu-id="c89e1-117">In this section, you'll use NuGet to download a sample we will work with.</span></span> <span data-ttu-id="c89e1-118">Per iniziare, installare ed eseguire [Visual Studio Express 2013 per il Web](https://go.microsoft.com/fwlink/?LinkId=299058) o [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span><span class="sxs-lookup"><span data-stu-id="c89e1-118">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="c89e1-119">Installare Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="c89e1-119">Install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) or higher.</span></span>

> [!NOTE]
> <span data-ttu-id="c89e1-120">Avviso: per completare questa esercitazione, è necessario installare Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) .</span><span class="sxs-lookup"><span data-stu-id="c89e1-120">Warning: You must install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) to complete this tutorial.</span></span>

1. <span data-ttu-id="c89e1-121">Creare un nuovo progetto Web ASP.NET ***vuoto*** .</span><span class="sxs-lookup"><span data-stu-id="c89e1-121">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="c89e1-122">Nella console di gestione pacchetti immettere i comandi seguenti:</span><span class="sxs-lookup"><span data-stu-id="c89e1-122">In the Package Manager Console, enter the following the following commands:</span></span>  
  
    `Install-Package SendGrid`  
    `Install-Package -Prerelease Microsoft.AspNet.Identity.Samples`  
  
   <span data-ttu-id="c89e1-123">In questa esercitazione si userà [SendGrid](http://sendgrid.com/) per inviare messaggi di posta elettronica e [Twilio](https://www.twilio.com/) o [ASPSMS](https://www.aspsms.com/asp.net/identity/testcredits/) per SMS.</span><span class="sxs-lookup"><span data-stu-id="c89e1-123">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email and [Twilio](https://www.twilio.com/) or [ASPSMS](https://www.aspsms.com/asp.net/identity/testcredits/) for sms texting.</span></span> <span data-ttu-id="c89e1-124">Il pacchetto di `Identity.Samples` installa il codice che verrà usato.</span><span class="sxs-lookup"><span data-stu-id="c89e1-124">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="c89e1-125">Impostare il [progetto per l'utilizzo di SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="c89e1-125">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="c89e1-126">*Facoltativo*: seguire le istruzioni riportate nell' [esercitazione di conferma tramite posta elettronica](account-confirmation-and-password-recovery-with-aspnet-identity.md) per associare SendGrid, quindi eseguire l'app e registrare un account di posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="c89e1-126">*Optional*: Follow the instructions in my [Email confirmation tutorial](account-confirmation-and-password-recovery-with-aspnet-identity.md) to hook up SendGrid and then run the app and register an email account.</span></span>
5. <span data-ttu-id="c89e1-127">*Facoltativo:* Rimuovere il codice di conferma del collegamento di posta elettronica demo dall'esempio (il codice `ViewBag.Link` nel controller account.</span><span class="sxs-lookup"><span data-stu-id="c89e1-127">*Optional:* Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="c89e1-128">Vedere i metodi di azione `DisplayEmail` e `ForgotPasswordConfirmation` e le visualizzazioni Razor).</span><span class="sxs-lookup"><span data-stu-id="c89e1-128">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>
6. <span data-ttu-id="c89e1-129">*Facoltativo:* Rimuovere il codice `ViewBag.Status` dai controller gestione e account e dalle visualizzazioni Razor *Views\Account\VerifyCode.cshtml* e *Views\Manage\VerifyPhoneNumber.cshtml* .</span><span class="sxs-lookup"><span data-stu-id="c89e1-129">*Optional:* Remove the `ViewBag.Status` code from the Manage and Account controllers and from the *Views\Account\VerifyCode.cshtml* and *Views\Manage\VerifyPhoneNumber.cshtml* razor views.</span></span> <span data-ttu-id="c89e1-130">In alternativa, è possibile usare la visualizzazione `ViewBag.Status` per verificare il funzionamento di questa app localmente senza dover associare e inviare messaggi di posta elettronica e SMS.</span><span class="sxs-lookup"><span data-stu-id="c89e1-130">Alternatively, you can keep the `ViewBag.Status` display to test how this app works locally without having to hook up and send email and SMS messages.</span></span>

> [!NOTE]
> <span data-ttu-id="c89e1-131">Avviso: se si modifica una delle impostazioni di sicurezza in questo esempio, le app Productions dovranno sottoporsi a un controllo di sicurezza che richiama in modo esplicito le modifiche apportate.</span><span class="sxs-lookup"><span data-stu-id="c89e1-131">Warning: If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls out the changes made.</span></span>

<a id="SMS"></a>

## <a name="set-up-sms-for-two-factor-authentication"></a><span data-ttu-id="c89e1-132">Configurare SMS per l'autenticazione a due fattori</span><span class="sxs-lookup"><span data-stu-id="c89e1-132">Set up SMS for Two-factor authentication</span></span>

<span data-ttu-id="c89e1-133">Questa esercitazione fornisce istruzioni per l'uso di Twilio o ASPSMS, ma è possibile usare qualsiasi altro provider SMS.</span><span class="sxs-lookup"><span data-stu-id="c89e1-133">This tutorial provides instructions for using either Twilio or ASPSMS but you can use any other SMS provider.</span></span>

1. <span data-ttu-id="c89e1-134">**Creazione di un account utente con un provider SMS**</span><span class="sxs-lookup"><span data-stu-id="c89e1-134">**Creating a User Account with an SMS provider**</span></span>  
  
   <span data-ttu-id="c89e1-135">Creare un account [Twilio](https://www.twilio.com/try-twilio) o [ASPSMS](https://www.aspsms.com/asp.net/identity/testcredits/) .</span><span class="sxs-lookup"><span data-stu-id="c89e1-135">Create a [Twilio](https://www.twilio.com/try-twilio) or an [ASPSMS](https://www.aspsms.com/asp.net/identity/testcredits/) account.</span></span>
2. <span data-ttu-id="c89e1-136">**Installazione di pacchetti aggiuntivi o aggiunta di riferimenti al servizio**</span><span class="sxs-lookup"><span data-stu-id="c89e1-136">**Installing additional packages or adding service references**</span></span>  
  
   <span data-ttu-id="c89e1-137">Twilio</span><span class="sxs-lookup"><span data-stu-id="c89e1-137">Twilio:</span></span>  
   <span data-ttu-id="c89e1-138">Nella console di gestione pacchetti immettere il comando seguente:</span><span class="sxs-lookup"><span data-stu-id="c89e1-138">In the Package Manager Console, enter the following command:</span></span>  
    `Install-Package Twilio`  
  
   <span data-ttu-id="c89e1-139">ASPSMS:</span><span class="sxs-lookup"><span data-stu-id="c89e1-139">ASPSMS:</span></span>  
   <span data-ttu-id="c89e1-140">È necessario aggiungere il seguente riferimento al servizio:</span><span class="sxs-lookup"><span data-stu-id="c89e1-140">The following service reference needs to be added:</span></span>  
  
    ![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image1.png)  
  
   <span data-ttu-id="c89e1-141">Indirizzo:</span><span class="sxs-lookup"><span data-stu-id="c89e1-141">Address:</span></span>  
    `https://webservice.aspsms.com/aspsmsx2.asmx?WSDL`  
  
   <span data-ttu-id="c89e1-142">Spazio dei nomi:</span><span class="sxs-lookup"><span data-stu-id="c89e1-142">Namespace:</span></span>  
    `ASPSMSX2`
3. <span data-ttu-id="c89e1-143">**Individuazione delle credenziali utente del provider SMS**</span><span class="sxs-lookup"><span data-stu-id="c89e1-143">**Figuring out SMS Provider User credentials**</span></span>  
  
   <span data-ttu-id="c89e1-144">Twilio</span><span class="sxs-lookup"><span data-stu-id="c89e1-144">Twilio:</span></span>  
   <span data-ttu-id="c89e1-145">Dalla scheda **Dashboard** dell'account Twilio copiare il **SID dell'account** e il **token di autenticazione**.</span><span class="sxs-lookup"><span data-stu-id="c89e1-145">From the **Dashboard** tab of your Twilio account, copy the **Account SID** and **Auth token**.</span></span>  
  
   <span data-ttu-id="c89e1-146">ASPSMS:</span><span class="sxs-lookup"><span data-stu-id="c89e1-146">ASPSMS:</span></span>  
   <span data-ttu-id="c89e1-147">Dalle impostazioni dell'account, passare a **userKey** e copiarlo insieme alla **password**definita autonomamente.</span><span class="sxs-lookup"><span data-stu-id="c89e1-147">From your account settings, navigate to **Userkey** and copy it together with your self-defined **Password**.</span></span>  
  
   <span data-ttu-id="c89e1-148">Questi valori vengono archiviati in un secondo momento nelle variabili `SMSAccountIdentification` e `SMSAccountPassword`.</span><span class="sxs-lookup"><span data-stu-id="c89e1-148">We will later store these values in the variables `SMSAccountIdentification` and `SMSAccountPassword` .</span></span>
4. <span data-ttu-id="c89e1-149">**Specifica di SenderID/originator**</span><span class="sxs-lookup"><span data-stu-id="c89e1-149">**Specifying SenderID / Originator**</span></span>  
  
   <span data-ttu-id="c89e1-150">Twilio</span><span class="sxs-lookup"><span data-stu-id="c89e1-150">Twilio:</span></span>  
   <span data-ttu-id="c89e1-151">Dalla scheda **numeri** copiare il numero di telefono Twilio.</span><span class="sxs-lookup"><span data-stu-id="c89e1-151">From the **Numbers** tab, copy your Twilio phone number.</span></span>  
  
   <span data-ttu-id="c89e1-152">ASPSMS:</span><span class="sxs-lookup"><span data-stu-id="c89e1-152">ASPSMS:</span></span>  
   <span data-ttu-id="c89e1-153">Nel menu **Sblocca autori** sbloccare uno o più autori o scegliere un originatore alfanumerico (non supportato da tutte le reti).</span><span class="sxs-lookup"><span data-stu-id="c89e1-153">Within the **Unlock Originators** Menu, unlock one or more Originators or choose an alphanumeric Originator (Not supported by all networks).</span></span>  
  
   <span data-ttu-id="c89e1-154">Questo valore verrà archiviato in un secondo momento nella variabile `SMSAccountFrom`.</span><span class="sxs-lookup"><span data-stu-id="c89e1-154">We will later store this value in the variable `SMSAccountFrom` .</span></span>
5. <span data-ttu-id="c89e1-155">**Trasferimento delle credenziali del provider SMS nell'app**</span><span class="sxs-lookup"><span data-stu-id="c89e1-155">**Transferring SMS provider credentials into app**</span></span>  
  
   <span data-ttu-id="c89e1-156">Rendere disponibili le credenziali e il numero di telefono del mittente per l'app:</span><span class="sxs-lookup"><span data-stu-id="c89e1-156">Make the credentials and sender phone number available to the app:</span></span>

    [!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample1.cs)]

    > [!WARNING]
    > <span data-ttu-id="c89e1-157">Sicurezza: non archiviare mai dati sensibili nel codice sorgente.</span><span class="sxs-lookup"><span data-stu-id="c89e1-157">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="c89e1-158">L'account e le credenziali vengono aggiunti al codice riportato sopra per semplificare l'esempio.</span><span class="sxs-lookup"><span data-stu-id="c89e1-158">The account and credentials are added to the code above to keep the sample simple.</span></span> <span data-ttu-id="c89e1-159">Vedere l'ASP.NET MVC di Jon atten [: Mantieni le impostazioni private dal controllo del codice sorgente](http://typecastexception.com/post/2014/04/06/ASPNET-MVC-Keep-Private-Settings-Out-of-Source-Control.aspx).</span><span class="sxs-lookup"><span data-stu-id="c89e1-159">See Jon Atten's [ASP.NET MVC: Keep Private Settings Out of Source Control](http://typecastexception.com/post/2014/04/06/ASPNET-MVC-Keep-Private-Settings-Out-of-Source-Control.aspx).</span></span>
6. <span data-ttu-id="c89e1-160">**Implementazione del trasferimento dati al provider SMS**</span><span class="sxs-lookup"><span data-stu-id="c89e1-160">**Implementation of data transfer to SMS provider**</span></span>  
  
   <span data-ttu-id="c89e1-161">Configurare la classe `SmsService` nel file *App\_Start\IdentityConfig.cs* .</span><span class="sxs-lookup"><span data-stu-id="c89e1-161">Configure the `SmsService`  class in the *App\_Start\IdentityConfig.cs* file.</span></span>  
  
   <span data-ttu-id="c89e1-162">A seconda del provider SMS utilizzato, attivare la sezione **Twilio** o **ASPSMS** :</span><span class="sxs-lookup"><span data-stu-id="c89e1-162">Depending on the used SMS provider activate either the **Twilio** or the **ASPSMS** section:</span></span> 

    [!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample2.cs)]
7. <span data-ttu-id="c89e1-163">Eseguire l'app e accedere con l'account registrato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="c89e1-163">Run the app and log in with the account you previously registered.</span></span>
8. <span data-ttu-id="c89e1-164">Fare clic sull'ID utente, che attiva il metodo di azione `Index` in `Manage` controller.</span><span class="sxs-lookup"><span data-stu-id="c89e1-164">Click on your User ID, which activates the `Index` action method in `Manage` controller.</span></span>  
  
    ![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image2.png)
9. <span data-ttu-id="c89e1-165">Fare clic su Aggiungi.</span><span class="sxs-lookup"><span data-stu-id="c89e1-165">Click Add.</span></span>  
  
    ![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image3.png)
10. <span data-ttu-id="c89e1-166">In pochi secondi si riceverà un messaggio di testo con il codice di verifica.</span><span class="sxs-lookup"><span data-stu-id="c89e1-166">In a few seconds you will get a text message with the verification code.</span></span> <span data-ttu-id="c89e1-167">Immetterla e premere **invio**.</span><span class="sxs-lookup"><span data-stu-id="c89e1-167">Enter it and press **Submit**.</span></span>  
  
    ![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image4.png)
11. <span data-ttu-id="c89e1-168">La visualizzazione gestione mostra che è stato aggiunto il numero di telefono.</span><span class="sxs-lookup"><span data-stu-id="c89e1-168">The Manage view shows your phone number was added.</span></span>  
  
    ![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image5.png)

### <a name="examine-the-code"></a><span data-ttu-id="c89e1-169">Esaminare il codice</span><span class="sxs-lookup"><span data-stu-id="c89e1-169">Examine the code</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample3.cs?highlight=2)]

<span data-ttu-id="c89e1-170">Il metodo di azione `Index` nel controller `Manage` imposta il messaggio di stato in base all'azione precedente e fornisce collegamenti per modificare la password locale o aggiungere un account locale.</span><span class="sxs-lookup"><span data-stu-id="c89e1-170">The `Index` action method in `Manage` controller sets the status message based on your previous action and provides links to change your local password or add a local account.</span></span> <span data-ttu-id="c89e1-171">Il metodo `Index` Visualizza anche lo stato o il numero di telefono 2FA, gli account di accesso esterni, 2FA abilitati e ricorda il metodo 2FA per il browser (descritto più avanti).</span><span class="sxs-lookup"><span data-stu-id="c89e1-171">The `Index` method also displays the state or your 2FA phone number, external logins, 2FA enabled, and remember 2FA method for this browser(explained later).</span></span> <span data-ttu-id="c89e1-172">Facendo clic sull'ID utente (indirizzo di posta elettronica) nella barra del titolo non viene passato alcun messaggio.</span><span class="sxs-lookup"><span data-stu-id="c89e1-172">Clicking on your user ID (email) in the title bar doesn't pass a message.</span></span> <span data-ttu-id="c89e1-173">Facendo clic sul **numero di telefono: Rimuovi** collegamento passa `Message=RemovePhoneSuccess` come stringa di query.</span><span class="sxs-lookup"><span data-stu-id="c89e1-173">Clicking on the **Phone Number : remove** link passes `Message=RemovePhoneSuccess` as a query string.</span></span>  
  
`https://localhost:44300/Manage?Message=RemovePhoneSuccess`

<span data-ttu-id="c89e1-174">[![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image6.png)]</span><span class="sxs-lookup"><span data-stu-id="c89e1-174">[![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image6.png)]</span></span>

<span data-ttu-id="c89e1-175">Il metodo di azione `AddPhoneNumber` Visualizza una finestra di dialogo per immettere un numero di telefono che può ricevere messaggi SMS.</span><span class="sxs-lookup"><span data-stu-id="c89e1-175">The `AddPhoneNumber` action method displays a dialog box to enter a phone number that can receive SMS messages.</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample4.cs)]

![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image7.png)

<span data-ttu-id="c89e1-176">Facendo clic sul pulsante **Invia codice di verifica** il numero di telefono viene inserito nel metodo di azione HTTP post `AddPhoneNumber`.</span><span class="sxs-lookup"><span data-stu-id="c89e1-176">Clicking on the **Send verification code** button posts the phone number to the HTTP POST `AddPhoneNumber` action method.</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample5.cs?highlight=12)]

<span data-ttu-id="c89e1-177">Il metodo `GenerateChangePhoneNumberTokenAsync` genera il token di sicurezza che verrà impostato nel messaggio SMS.</span><span class="sxs-lookup"><span data-stu-id="c89e1-177">The `GenerateChangePhoneNumberTokenAsync` method generates the security token which will be set in the SMS message.</span></span> <span data-ttu-id="c89e1-178">Se il servizio SMS è stato configurato, il token viene inviato come stringa &quot;il codice di sicurezza è &lt;token&gt;&quot;.</span><span class="sxs-lookup"><span data-stu-id="c89e1-178">If the SMS service has been configured, the token is sent as the string &quot;Your security code is &lt;token&gt;&quot;.</span></span> <span data-ttu-id="c89e1-179">Il metodo `SmsService.SendAsync` a viene chiamato in modo asincrono, quindi l'app viene reindirizzata al metodo di azione `VerifyPhoneNumber`, che visualizza la finestra di dialogo seguente, in cui è possibile immettere il codice di verifica.</span><span class="sxs-lookup"><span data-stu-id="c89e1-179">The `SmsService.SendAsync` method to is called asynchronously, then the app is redirected to the `VerifyPhoneNumber` action method (which displays the following dialog), where you can enter the verification code.</span></span>

![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image8.png)

<span data-ttu-id="c89e1-180">Una volta immesso il codice e fatto clic su Submit, il codice viene inserito nel metodo di azione HTTP POST `VerifyPhoneNumber`.</span><span class="sxs-lookup"><span data-stu-id="c89e1-180">Once you enter the code and click submit, the code is posted to the HTTP POST `VerifyPhoneNumber` action method.</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="c89e1-181">Il metodo `ChangePhoneNumberAsync` controlla il codice di sicurezza inviato.</span><span class="sxs-lookup"><span data-stu-id="c89e1-181">The `ChangePhoneNumberAsync` method checks the posted security code.</span></span> <span data-ttu-id="c89e1-182">Se il codice è corretto, il numero di telefono viene aggiunto al campo `PhoneNumber` della tabella `AspNetUsers`.</span><span class="sxs-lookup"><span data-stu-id="c89e1-182">If the code is correct, the phone number is added to the `PhoneNumber` field of the `AspNetUsers` table.</span></span> <span data-ttu-id="c89e1-183">Se la chiamata ha esito positivo, viene chiamato il metodo `SignInAsync`:</span><span class="sxs-lookup"><span data-stu-id="c89e1-183">If that call is successful, the `SignInAsync` method is called:</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample7.cs)]

<span data-ttu-id="c89e1-184">Il parametro `isPersistent` imposta se la sessione di autenticazione viene mantenute in più richieste.</span><span class="sxs-lookup"><span data-stu-id="c89e1-184">The `isPersistent` parameter sets whether the authentication session is persisted across multiple requests.</span></span>

<span data-ttu-id="c89e1-185">Quando si modifica il profilo di sicurezza, viene generato e archiviato un nuovo indicatore di sicurezza nel campo `SecurityStamp` della tabella *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="c89e1-185">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="c89e1-186">Si noti che il campo `SecurityStamp` è diverso dal cookie di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="c89e1-186">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="c89e1-187">Il cookie di sicurezza non è archiviato nella tabella `AspNetUsers` (o altrove nel database di identità).</span><span class="sxs-lookup"><span data-stu-id="c89e1-187">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="c89e1-188">Il token del cookie di sicurezza è autofirmato tramite [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) e viene creato con le informazioni relative a `UserId, SecurityStamp` e ora di scadenza.</span><span class="sxs-lookup"><span data-stu-id="c89e1-188">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="c89e1-189">Il middleware dei cookie controlla il cookie per ogni richiesta.</span><span class="sxs-lookup"><span data-stu-id="c89e1-189">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="c89e1-190">Il metodo `SecurityStampValidator` nella classe `Startup` raggiunge il database e controlla periodicamente il timbro di sicurezza, come specificato con il `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="c89e1-190">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="c89e1-191">Questo problema si verifica solo ogni 30 minuti (in questo esempio), a meno che non si modifichi il profilo di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="c89e1-191">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="c89e1-192">È stato scelto l'intervallo di 30 minuti per ridurre al minimo i viaggi al database.</span><span class="sxs-lookup"><span data-stu-id="c89e1-192">The 30 minute interval was chosen to minimize trips to the database.</span></span>

<span data-ttu-id="c89e1-193">Il metodo di `SignInAsync` deve essere chiamato quando viene apportata una modifica al profilo di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="c89e1-193">The `SignInAsync` method needs to be called when any change is made to the security profile.</span></span> <span data-ttu-id="c89e1-194">Quando viene modificato il profilo di sicurezza, il database aggiorna il campo `SecurityStamp` e senza chiamare il metodo di `SignInAsync` si rimarrà connessi *solo* fino alla successiva esecuzione della pipeline OWIN al database (il `validateInterval`).</span><span class="sxs-lookup"><span data-stu-id="c89e1-194">When the security profile changes, the database is updates the `SecurityStamp` field, and without calling the `SignInAsync` method you would stay logged in *only* until the next time the OWIN pipeline hits the database (the `validateInterval`).</span></span> <span data-ttu-id="c89e1-195">Per eseguire questa verifica, modificare il metodo `SignInAsync` in modo che venga restituito immediatamente e impostare la proprietà cookie `validateInterval` da 30 minuti a 5 secondi:</span><span class="sxs-lookup"><span data-stu-id="c89e1-195">You can test this by changing the `SignInAsync` method to return immediately, and setting the cookie `validateInterval` property from 30 minutes to 5 seconds:</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample8.cs?highlight=3)]

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample9.cs?highlight=20-21)]

<span data-ttu-id="c89e1-196">Con le modifiche al codice sopra riportate, è possibile modificare il profilo di sicurezza, ad esempio modificando lo stato di **due fattori abilitati**, e si verrà disconnessi in 5 secondi in caso di errore del metodo `SecurityStampValidator.OnValidateIdentity`.</span><span class="sxs-lookup"><span data-stu-id="c89e1-196">With the above code changes, you can change your security profile (for example, by changing the state of **Two Factor Enabled**) and you will be logged out in 5 seconds when the `SecurityStampValidator.OnValidateIdentity` method fails.</span></span> <span data-ttu-id="c89e1-197">Rimuovere la riga di ritorno nel metodo di `SignInAsync`, apportare un'altra modifica del profilo di sicurezza e non verrà effettuata la disconnessione. Il metodo `SignInAsync` genera un nuovo cookie di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="c89e1-197">Remove the return line in the `SignInAsync` method, make another security profile change and you will not be logged out. The `SignInAsync` method generates a new security cookie.</span></span>

<a id="enable2"></a>

## <a name="enable-two-factor-authentication"></a><span data-ttu-id="c89e1-198">Abilitare l'autenticazione a due fattori</span><span class="sxs-lookup"><span data-stu-id="c89e1-198">Enable two-factor authentication</span></span>

<span data-ttu-id="c89e1-199">Nell'app di esempio è necessario usare l'interfaccia utente per abilitare l'autenticazione a due fattori (2FA).</span><span class="sxs-lookup"><span data-stu-id="c89e1-199">In the sample app, you need to use the UI to enable two-factor authentication (2FA).</span></span> <span data-ttu-id="c89e1-200">Per abilitare 2FA, fare clic sull'ID utente (alias di posta elettronica) nella barra di spostamento.![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="c89e1-200">To enable 2FA, click on your user ID (email alias) in the navigation bar.![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image9.png)</span></span>  
<span data-ttu-id="c89e1-201">Fare clic su Abilita 2FA.![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="c89e1-201">Click on enable 2FA.![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image10.png)</span></span> <span data-ttu-id="c89e1-202">Disconnettersi, quindi eseguire di nuovo l'accesso.</span><span class="sxs-lookup"><span data-stu-id="c89e1-202">Log out, then log back in.</span></span> <span data-ttu-id="c89e1-203">Se è stata abilitata la posta elettronica (vedere l' [esercitazione precedente](account-confirmation-and-password-recovery-with-aspnet-identity.md)), è possibile selezionare SMS o messaggio di posta elettronica per 2FA.![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="c89e1-203">If you've enabled email (see my [previous tutorial](account-confirmation-and-password-recovery-with-aspnet-identity.md)), you can select the SMS or email for 2FA.![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image11.png)</span></span> <span data-ttu-id="c89e1-204">Viene visualizzata la pagina Verifica codice in cui è possibile immettere il codice (da SMS o posta elettronica).![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image12.png)</span><span class="sxs-lookup"><span data-stu-id="c89e1-204">The Verify Code page is displayed where you can enter the code (from SMS or email).![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image12.png)</span></span> <span data-ttu-id="c89e1-205">Se si fa clic sulla casella di controllo **memorizza questo browser** , non sarà più necessario usare 2FA per accedere a tale computer e browser.</span><span class="sxs-lookup"><span data-stu-id="c89e1-205">Clicking on the **Remember this browser** check box will exempt you from needing to use 2FA to log on with that computer and browser.</span></span> <span data-ttu-id="c89e1-206">Se si Abilita 2FA e si fa clic sul pulsante **ricorda, questo browser** fornirà una protezione 2FA avanzata da utenti malintenzionati che tentano di accedere all'account, purché non dispongano dell'accesso al computer.</span><span class="sxs-lookup"><span data-stu-id="c89e1-206">Enabling 2FA and clicking on the **Remember this browser** will provide you with strong 2FA protection from malicious users trying to access your account, as long as they don't have access to your computer.</span></span> <span data-ttu-id="c89e1-207">Questa operazione può essere eseguita in qualsiasi computer privato utilizzato regolarmente.</span><span class="sxs-lookup"><span data-stu-id="c89e1-207">You can do this on any private machine you regularly use.</span></span> <span data-ttu-id="c89e1-208">Impostando **ricorda questo browser**, si ottiene la maggiore sicurezza di 2FA dai computer che non vengono usati regolarmente e si ottiene la comodità di non dover passare attraverso 2FA nei propri computer.</span><span class="sxs-lookup"><span data-stu-id="c89e1-208">By setting **Remember this browser**, you get the added security of 2FA from computers you don't regularly use, and you get the convenience on not having to go through 2FA on your own computers.</span></span> 

<a id="reg"></a>
## <a name="how-to-register-a-two-factor-authentication-provider"></a><span data-ttu-id="c89e1-209">Come registrare un provider di autenticazione a due fattori</span><span class="sxs-lookup"><span data-stu-id="c89e1-209">How to register a Two-factor authentication provider</span></span>

<span data-ttu-id="c89e1-210">Quando si crea un nuovo progetto MVC, il file *IdentityConfig.cs* contiene il codice seguente per registrare un provider di autenticazione a due fattori:</span><span class="sxs-lookup"><span data-stu-id="c89e1-210">When you create a new MVC project, the *IdentityConfig.cs* file contains the following code to register a Two-factor authentication provider:</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample10.cs?highlight=22-35)]

## <a name="add-a-phone-number-for-2fa"></a><span data-ttu-id="c89e1-211">Aggiungere un numero di telefono per 2FA</span><span class="sxs-lookup"><span data-stu-id="c89e1-211">Add a phone number for 2FA</span></span>

<span data-ttu-id="c89e1-212">Il metodo di azione `AddPhoneNumber` nel controller `Manage` genera un token di sicurezza e lo invia al numero di telefono fornito.</span><span class="sxs-lookup"><span data-stu-id="c89e1-212">The `AddPhoneNumber` action method in the `Manage` controller generates a security token and sends it to the phone number you have provided.</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample11.cs)]

<span data-ttu-id="c89e1-213">Dopo l'invio del token, viene reindirizzato al metodo di azione `VerifyPhoneNumber`, in cui è possibile immettere il codice per registrare SMS per 2FA.</span><span class="sxs-lookup"><span data-stu-id="c89e1-213">After sending the token, it redirects to the `VerifyPhoneNumber` action method, where you can enter the code to register SMS for 2FA.</span></span> <span data-ttu-id="c89e1-214">SMS 2FA non viene usato fino a quando non si verifica il numero di telefono.</span><span class="sxs-lookup"><span data-stu-id="c89e1-214">SMS 2FA is not used until you have verified the phone number.</span></span>

## <a name="enabling-2fa"></a><span data-ttu-id="c89e1-215">Abilitazione di 2FA</span><span class="sxs-lookup"><span data-stu-id="c89e1-215">Enabling 2FA</span></span>

<span data-ttu-id="c89e1-216">Il metodo di azione `EnableTFA` Abilita 2FA:</span><span class="sxs-lookup"><span data-stu-id="c89e1-216">The `EnableTFA` action method enables 2FA:</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample12.cs)]

<span data-ttu-id="c89e1-217">Si noti che è necessario chiamare il `SignInAsync` perché Enable 2FA è una modifica al profilo di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="c89e1-217">Note the `SignInAsync` must be called because enable 2FA is a change to the security profile.</span></span> <span data-ttu-id="c89e1-218">Quando 2FA è abilitato, l'utente dovrà usare 2FA per accedere, usando gli approcci 2FA registrati (SMS e posta elettronica nell'esempio).</span><span class="sxs-lookup"><span data-stu-id="c89e1-218">When 2FA is enabled, the user will need to use 2FA to log in, using the 2FA approaches they have registered (SMS and email in the sample).</span></span>

<span data-ttu-id="c89e1-219">È possibile aggiungere altri provider 2FA, ad esempio generatori di codice a matrice, oppure è possibile scrivere i propri (vedere [uso di Google Authenticator con ASP.NET Identity](https://www.jerriepelser.com//blog/using-google-authenticator-asp-net-identity/)).</span><span class="sxs-lookup"><span data-stu-id="c89e1-219">You can add more 2FA providers such as QR code generators or you can write you own (See [Using Google Authenticator with ASP.NET Identity](https://www.jerriepelser.com//blog/using-google-authenticator-asp-net-identity/)).</span></span>

> [!NOTE]
> <span data-ttu-id="c89e1-220">I codici 2FA vengono generati usando [un algoritmo di password monouso basato sul tempo](http://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm) e i codici sono validi per sei minuti.</span><span class="sxs-lookup"><span data-stu-id="c89e1-220">The 2FA codes are generated using [Time-based One-time Password Algorithm](http://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm) and codes are valid for six minutes.</span></span> <span data-ttu-id="c89e1-221">Se si immettono più di sei minuti per l'immissione del codice, verrà ricevuto un messaggio di errore di codice non valido.</span><span class="sxs-lookup"><span data-stu-id="c89e1-221">If you take more than six minutes to enter the code, you'll get an Invalid code error message.</span></span>

<a id="combine"></a>

## <a name="combine-social-and-local-login-accounts"></a><span data-ttu-id="c89e1-222">Combinare account di accesso di social networking e locali</span><span class="sxs-lookup"><span data-stu-id="c89e1-222">Combine social and local login accounts</span></span>

<span data-ttu-id="c89e1-223">È possibile combinare account locali e di social networking facendo clic sul collegamento di posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="c89e1-223">You can combine local and social accounts by clicking on your email link.</span></span> <span data-ttu-id="c89e1-224">Nella sequenza seguente &quot;RickAndMSFT@gmail.com&quot; viene creato per la prima volta come account di accesso locale, ma è possibile creare prima l'account come log di social networking, quindi aggiungere un account di accesso locale.</span><span class="sxs-lookup"><span data-stu-id="c89e1-224">In the following sequence &quot;RickAndMSFT@gmail.com&quot; is first created as a local login, but you can create the account as a social log in first, then add a local login.</span></span>

![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image13.png)

<span data-ttu-id="c89e1-225">Fare clic sul collegamento **Gestisci** .</span><span class="sxs-lookup"><span data-stu-id="c89e1-225">Click on the **Manage** link.</span></span> <span data-ttu-id="c89e1-226">Si notino gli account di accesso di social network (0) esterni associati a questo account.</span><span class="sxs-lookup"><span data-stu-id="c89e1-226">Note the 0 external (social logins) associated with this account.</span></span>

![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image14.png)

<span data-ttu-id="c89e1-227">Fai clic sul collegamento a un altro servizio di accesso e accetta le richieste dell'app.</span><span class="sxs-lookup"><span data-stu-id="c89e1-227">Click the link to another log in service and accept the app requests.</span></span> <span data-ttu-id="c89e1-228">I due account sono stati combinati e sarà possibile accedere con entrambi gli account.</span><span class="sxs-lookup"><span data-stu-id="c89e1-228">The two accounts have been combined, you will be able to log on with either account.</span></span> <span data-ttu-id="c89e1-229">Potrebbe essere necessario che gli utenti aggiungano gli account locali nel caso in cui il servizio di autenticazione dei log sociali sia inattivo o più probabilmente abbiano perso l'accesso al proprio account di social networking.</span><span class="sxs-lookup"><span data-stu-id="c89e1-229">You might want your users to add local accounts in case their social log in authentication service is down, or more likely they have lost access to their social account.</span></span>

<span data-ttu-id="c89e1-230">Nella figura seguente Tom è un log di social networking, che è possibile visualizzare dagli account di **accesso esterni: 1** visualizzati nella pagina.</span><span class="sxs-lookup"><span data-stu-id="c89e1-230">In the following image, Tom is a social log in (which you can see from the **External Logins: 1** shown on the page).</span></span>

![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image15.png)

<span data-ttu-id="c89e1-231">Quando si fa clic su **Seleziona una password** è possibile aggiungere un log locale associato allo stesso account.</span><span class="sxs-lookup"><span data-stu-id="c89e1-231">Clicking on **Pick a password** allows you to add a local log on associated with the same account.</span></span>

![](two-factor-authentication-using-sms-and-email-with-aspnet-identity/_static/image16.png)

<a id="lock"></a>

## <a name="account-lockout-from-brute-force-attacks"></a><span data-ttu-id="c89e1-232">Blocco degli account da attacchi di forza bruta</span><span class="sxs-lookup"><span data-stu-id="c89e1-232">Account lockout from brute force attacks</span></span>

<span data-ttu-id="c89e1-233">È possibile proteggere gli account nell'app da attacchi con dizionario abilitando il blocco degli utenti.</span><span class="sxs-lookup"><span data-stu-id="c89e1-233">You can protect the accounts on your app from dictionary attacks by enabling user lockout.</span></span> <span data-ttu-id="c89e1-234">Il codice seguente nel metodo `ApplicationUserManager Create` configura lock out:</span><span class="sxs-lookup"><span data-stu-id="c89e1-234">The following code in the `ApplicationUserManager Create` method configures lock out:</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample13.cs)]

<span data-ttu-id="c89e1-235">Il codice precedente Abilita il blocco solo per l'autenticazione a due fattori.</span><span class="sxs-lookup"><span data-stu-id="c89e1-235">The code above enables lockout for two factor authentication only.</span></span> <span data-ttu-id="c89e1-236">Sebbene sia possibile abilitare il blocco per gli account di accesso modificando `shouldLockout` su true nel metodo `Login` del controller di account, è consigliabile non abilitare il blocco per gli account di accesso perché rende l'account vulnerabile agli attacchi di accesso [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) .</span><span class="sxs-lookup"><span data-stu-id="c89e1-236">While you can enable lock out for logins by changing `shouldLockout` to true in the `Login` method of the account controller, we recommend you not enable lock out for logins because it makes the account susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) login attacks.</span></span> <span data-ttu-id="c89e1-237">Nel codice di esempio, il blocco è disabilitato per l'account amministratore creato nel metodo `ApplicationDbInitializer Seed`:</span><span class="sxs-lookup"><span data-stu-id="c89e1-237">In the sample code, lockout is disabled for the admin account created in the `ApplicationDbInitializer Seed` method:</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample14.cs?highlight=19)]

## <a name="requiring-a-user-to-have-a-validated-email-account"></a><span data-ttu-id="c89e1-238">Richiedere a un utente di avere un account di posta elettronica convalidato</span><span class="sxs-lookup"><span data-stu-id="c89e1-238">Requiring a user to have a validated email account</span></span>

<span data-ttu-id="c89e1-239">Il codice seguente richiede che un utente disponga di un account di posta elettronica convalidato prima di poter eseguire l'accesso:</span><span class="sxs-lookup"><span data-stu-id="c89e1-239">The following code requires a user to have a validated email account before they can log in:</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample15.cs?highlight=8-17)]

## <a name="how-signinmanager-checks-for-2fa-requirement"></a><span data-ttu-id="c89e1-240">Come SignInManager verifica il requisito di 2FA</span><span class="sxs-lookup"><span data-stu-id="c89e1-240">How SignInManager checks for 2FA requirement</span></span>

<span data-ttu-id="c89e1-241">Sia il registro locale che quello di social networking verificano se 2FA è abilitato.</span><span class="sxs-lookup"><span data-stu-id="c89e1-241">Both the local log in and social log in check to see if 2FA is enabled.</span></span> <span data-ttu-id="c89e1-242">Se 2FA è abilitato, il metodo di accesso `SignInManager` restituisce `SignInStatus.RequiresVerification`e l'utente verrà reindirizzato al metodo di azione `SendCode`, in cui sarà necessario immettere il codice per completare il log in sequenza.</span><span class="sxs-lookup"><span data-stu-id="c89e1-242">If 2FA is enabled, the `SignInManager` logon method returns `SignInStatus.RequiresVerification`, and the user will be redirected to the `SendCode` action method, where they will have to enter the code to complete the log in sequence.</span></span> <span data-ttu-id="c89e1-243">Se per l'utente è impostato RememberMe sul cookie locale Users, il `SignInManager` restituirà `SignInStatus.Success` e non sarà necessario passare attraverso 2FA.</span><span class="sxs-lookup"><span data-stu-id="c89e1-243">If the user has RememberMe is set on the users local cookie, the `SignInManager` will return `SignInStatus.Success` and they will not have to go through 2FA.</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample16.cs?highlight=20-22)]

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample17.cs?highlight=10-11,17-18)]

<span data-ttu-id="c89e1-244">Nel codice seguente viene illustrato il metodo di azione `SendCode`.</span><span class="sxs-lookup"><span data-stu-id="c89e1-244">The following code shows the `SendCode` action method.</span></span> <span data-ttu-id="c89e1-245">Viene creato un [SelectListItem](https://msdn.microsoft.com/library/system.web.mvc.selectlistitem.aspx) con tutti i metodi 2FA abilitati per l'utente.</span><span class="sxs-lookup"><span data-stu-id="c89e1-245">A [SelectListItem](https://msdn.microsoft.com/library/system.web.mvc.selectlistitem.aspx) is created with all the 2FA methods enabled for the user.</span></span> <span data-ttu-id="c89e1-246">Il [SelectListItem](https://msdn.microsoft.com/library/system.web.mvc.selectlistitem.aspx) viene passato all'helper [DropDownListFor](https://msdn.microsoft.com/library/system.web.ui.webcontrols.dropdownlist.aspx) , che consente all'utente di selezionare l'approccio 2FA, in genere posta elettronica e SMS.</span><span class="sxs-lookup"><span data-stu-id="c89e1-246">The [SelectListItem](https://msdn.microsoft.com/library/system.web.mvc.selectlistitem.aspx) is passed to the [DropDownListFor](https://msdn.microsoft.com/library/system.web.ui.webcontrols.dropdownlist.aspx) helper, which allows the user to select the 2FA approach (typically email and SMS).</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample18.cs)]

<span data-ttu-id="c89e1-247">Una volta che l'utente ha inserito l'approccio 2FA, viene chiamato il metodo di azione `HTTP POST SendCode`, il `SignInManager` invia il codice 2FA e l'utente viene reindirizzato al metodo di azione `VerifyCode` in cui è possibile immettere il codice per completare l'accesso.</span><span class="sxs-lookup"><span data-stu-id="c89e1-247">Once the user posts the 2FA approach, the `HTTP POST SendCode` action method is called, the `SignInManager` sends the 2FA code, and the user is redirected to the `VerifyCode` action method where they can enter the code to complete the log in.</span></span>

[!code-csharp[Main](two-factor-authentication-using-sms-and-email-with-aspnet-identity/samples/sample19.cs?highlight=3,13-14,18)]

## <a name="2fa-lockout"></a><span data-ttu-id="c89e1-248">Blocco 2FA</span><span class="sxs-lookup"><span data-stu-id="c89e1-248">2FA Lockout</span></span>

<span data-ttu-id="c89e1-249">Sebbene sia possibile impostare il blocco degli account per gli errori dei tentativi di accesso alla password, questo approccio rende l'accesso vulnerabile ai blocchi [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) .</span><span class="sxs-lookup"><span data-stu-id="c89e1-249">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="c89e1-250">Si consiglia di usare il blocco degli account solo con 2FA.</span><span class="sxs-lookup"><span data-stu-id="c89e1-250">We recommend you use account lockout only with 2FA.</span></span> <span data-ttu-id="c89e1-251">Quando viene creata la `ApplicationUserManager`, il codice di esempio imposta il blocco 2FA e `MaxFailedAccessAttemptsBeforeLockout` su cinque.</span><span class="sxs-lookup"><span data-stu-id="c89e1-251">When the `ApplicationUserManager` is created, the sample code sets 2FA lockout and `MaxFailedAccessAttemptsBeforeLockout` to five.</span></span> <span data-ttu-id="c89e1-252">Dopo che un utente ha eseguito l'accesso (tramite un account locale o un account di social networking), ogni tentativo non riuscito in 2FA viene archiviato e se viene raggiunto il numero massimo di tentativi, l'utente viene bloccato per cinque minuti (è possibile impostare l'ora di blocco con `DefaultAccountLockoutTimeSpan`).</span><span class="sxs-lookup"><span data-stu-id="c89e1-252">Once a user logs in (through local account or social account), each failed attempt at 2FA is stored, and if the maximum attempts is reached, the user is locked out for five minutes (you can set the lock out time with `DefaultAccountLockoutTimeSpan`).</span></span>

<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="c89e1-253">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="c89e1-253">Additional Resources</span></span>

- <span data-ttu-id="c89e1-254">[ASP.NET Identity risorse consigliate](../getting-started/aspnet-identity-recommended-resources.md) Elenco completo di Blog di identità, video, esercitazioni e collegamenti eccezionali.</span><span class="sxs-lookup"><span data-stu-id="c89e1-254">[ASP.NET Identity Recommended Resources](../getting-started/aspnet-identity-recommended-resources.md) Complete list of Identity blogs, videos, tutorials and great SO links.</span></span>
- <span data-ttu-id="c89e1-255">L' [app MVC 5 con l'accesso a Facebook, Twitter, LinkedIn e Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) Mostra anche come aggiungere informazioni sul profilo alla tabella users.</span><span class="sxs-lookup"><span data-stu-id="c89e1-255">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="c89e1-256">[ASP.NET MVC and Identity 2,0: informazioni sulle nozioni di base](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) di John atten.</span><span class="sxs-lookup"><span data-stu-id="c89e1-256">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="c89e1-257">Conferma dell'account e recupero della password con ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="c89e1-257">Account Confirmation and Password Recovery with ASP.NET Identity</span></span>](account-confirmation-and-password-recovery-with-aspnet-identity.md)
- [<span data-ttu-id="c89e1-258">Introduzione ad ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="c89e1-258">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="c89e1-259">[Annuncio della versione RTM di ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) di Rastogi.</span><span class="sxs-lookup"><span data-stu-id="c89e1-259">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
- <span data-ttu-id="c89e1-260">[ASP.NET Identity 2,0: configurazione della convalida dell'account e dell'autorizzazione a due fattori](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) di John atten.</span><span class="sxs-lookup"><span data-stu-id="c89e1-260">[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span>
