---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: Conferma dell'account & il ripristino della passwordC#-ASP.NET Identity ()-ASP.NET 4. x
author: HaoK
description: Prima di eseguire questa esercitazione, è necessario completare la creazione di un'app Web ASP.NET MVC 5 sicura con accesso, conferma tramite posta elettronica e reimpostazione della password. Questa esercitazione...
ms.author: riande
ms.date: 01/23/2019
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 4b2c88280df39aa81d60f9508910e8fe5d6db6b8
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/06/2020
ms.locfileid: "78616816"
---
# <a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="0f766-104">Conferma dell'account e recupero della password conC#ASP.NET Identity ()</span><span class="sxs-lookup"><span data-stu-id="0f766-104">Account confirmation and password recovery with ASP.NET Identity (C#)</span></span>

> <span data-ttu-id="0f766-105">Prima di eseguire questa esercitazione, è necessario completare [la creazione di un'app web ASP.NET MVC 5 sicura con accesso, conferma tramite posta elettronica e reimpostazione della password](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="0f766-105">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="0f766-106">Questa esercitazione contiene ulteriori dettagli e Mostra come configurare la posta elettronica per la conferma dell'account locale e consentire agli utenti di reimpostare la password dimenticata in ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="0f766-106">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span>

<span data-ttu-id="0f766-107">Un account utente locale richiede all'utente di creare una password per l'account e la password viene archiviata (in modo sicuro) nell'app Web.</span><span class="sxs-lookup"><span data-stu-id="0f766-107">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="0f766-108">ASP.NET Identity supporta anche gli account di social networking, che non richiedono che l'utente crei una password per l'app.</span><span class="sxs-lookup"><span data-stu-id="0f766-108">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="0f766-109">Gli [account di social](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) networking usano una terza parte (ad esempio Google, Twitter, Facebook o Microsoft) per autenticare gli utenti.</span><span class="sxs-lookup"><span data-stu-id="0f766-109">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook, or Microsoft) to authenticate users.</span></span> <span data-ttu-id="0f766-110">Questo argomento illustra quanto segue:</span><span class="sxs-lookup"><span data-stu-id="0f766-110">This topic covers the following:</span></span>

- <span data-ttu-id="0f766-111">[Creare un'app MVC ASP.NET](#createMvc) ed esplorare ASP.NET Identity funzionalità.</span><span class="sxs-lookup"><span data-stu-id="0f766-111">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="0f766-112">Compilare l'esempio di identità</span><span class="sxs-lookup"><span data-stu-id="0f766-112">Build the Identity sample</span></span>](#build)
- [<span data-ttu-id="0f766-113">Configurare la conferma della posta elettronica</span><span class="sxs-lookup"><span data-stu-id="0f766-113">Set up email confirmation</span></span>](#email)

<span data-ttu-id="0f766-114">I nuovi utenti registrano l'alias di posta elettronica, che crea un account locale.</span><span class="sxs-lookup"><span data-stu-id="0f766-114">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="0f766-115">Selezionando il pulsante Register, viene inviato un messaggio di posta elettronica di conferma contenente un token di convalida all'indirizzo di posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="0f766-115">Selecting the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="0f766-116">All'utente viene inviato un messaggio di posta elettronica con un token di conferma per il proprio account.</span><span class="sxs-lookup"><span data-stu-id="0f766-116">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="0f766-117">Selezionare il collegamento per confermare l'account.</span><span class="sxs-lookup"><span data-stu-id="0f766-117">Selecting the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="0f766-118">Ripristino/reimpostazione della password</span><span class="sxs-lookup"><span data-stu-id="0f766-118">Password recovery/reset</span></span>

<span data-ttu-id="0f766-119">Gli utenti locali che dimenticano la password possono avere un token di sicurezza inviato al proprio account di posta elettronica, consentendo loro di reimpostare la password.</span><span class="sxs-lookup"><span data-stu-id="0f766-119">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="0f766-120">L'utente riceverà presto un messaggio di posta elettronica con un collegamento che consente di reimpostare la password.</span><span class="sxs-lookup"><span data-stu-id="0f766-120">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="0f766-121">Se si seleziona il collegamento, verrà visualizzata la pagina Reimposta.</span><span class="sxs-lookup"><span data-stu-id="0f766-121">Selecting the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="0f766-122">Se si seleziona il pulsante **Reimposta** , viene confermata la reimpostazione della password.</span><span class="sxs-lookup"><span data-stu-id="0f766-122">Selecting the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="0f766-123">Creare un'app Web ASP.NET</span><span class="sxs-lookup"><span data-stu-id="0f766-123">Create an ASP.NET web app</span></span>

<span data-ttu-id="0f766-124">Per iniziare, installare ed eseguire [Visual Studio 2017](https://visualstudio.microsoft.com/).</span><span class="sxs-lookup"><span data-stu-id="0f766-124">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/).</span></span>

1. <span data-ttu-id="0f766-125">Creare un nuovo progetto Web ASP.NET e selezionare il modello MVC.</span><span class="sxs-lookup"><span data-stu-id="0f766-125">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="0f766-126">I Web Form supportano anche ASP.NET Identity, quindi è possibile seguire una procedura simile in un'app Web Form.</span><span class="sxs-lookup"><span data-stu-id="0f766-126">Web Forms also support ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="0f766-127">Modificare l'autenticazione per **singoli account utente**.</span><span class="sxs-lookup"><span data-stu-id="0f766-127">Change the authentication to **Individual User Accounts**.</span></span>
3. <span data-ttu-id="0f766-128">Eseguire l'app, selezionare il collegamento **Register** e registrare un utente.</span><span class="sxs-lookup"><span data-stu-id="0f766-128">Run the app, select the **Register** link and register a user.</span></span> <span data-ttu-id="0f766-129">A questo punto, l'unica convalida sul messaggio di posta elettronica è l'attributo [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) .</span><span class="sxs-lookup"><span data-stu-id="0f766-129">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="0f766-130">In Esplora server passare a **Data Connections\DefaultConnection\Tables\AspNetUsers**, fare clic con il pulsante destro del mouse e selezionare **Apri definizione tabella**.</span><span class="sxs-lookup"><span data-stu-id="0f766-130">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right-click and select **Open table definition**.</span></span>

    <span data-ttu-id="0f766-131">Nella figura seguente viene illustrato lo schema `AspNetUsers`:</span><span class="sxs-lookup"><span data-stu-id="0f766-131">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="0f766-132">Fare clic con il pulsante destro del mouse sulla tabella **AspNetUsers** e scegliere **Mostra dati tabella**.</span><span class="sxs-lookup"><span data-stu-id="0f766-132">Right-click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="0f766-133">A questo punto, il messaggio di posta elettronica non è stato confermato.</span><span class="sxs-lookup"><span data-stu-id="0f766-133">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="0f766-134">L'archivio dati predefinito per ASP.NET Identity è Entity Framework, ma è possibile configurarlo per l'uso di altri archivi dati e per aggiungere campi aggiuntivi.</span><span class="sxs-lookup"><span data-stu-id="0f766-134">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="0f766-135">Vedere la sezione [risorse aggiuntive](#addRes) alla fine di questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="0f766-135">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="0f766-136">La [classe Startup OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) viene chiamata quando l'app viene avviata e richiama il metodo `ConfigureAuth` nell' *app\_Start\Startup.auth.cs*, che configura la pipeline OWIN e inizializza ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="0f766-136">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="0f766-137">Esaminare il metodo `ConfigureAuth`.</span><span class="sxs-lookup"><span data-stu-id="0f766-137">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="0f766-138">Ogni chiamata di `CreatePerOwinContext` registra un callback, salvato nella `OwinContext`, che verrà chiamato una volta per ogni richiesta per creare un'istanza del tipo specificato.</span><span class="sxs-lookup"><span data-stu-id="0f766-138">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="0f766-139">È possibile impostare un punto di rottura nel costruttore e `Create` metodo di ogni tipo (`ApplicationDbContext, ApplicationUserManager`) e verificare che vengano chiamati a ogni richiesta.</span><span class="sxs-lookup"><span data-stu-id="0f766-139">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="0f766-140">Un'istanza di `ApplicationDbContext` e `ApplicationUserManager` viene archiviata nel contesto OWIN, a cui è possibile accedere in tutta l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="0f766-140">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="0f766-141">ASP.NET Identity hook nella pipeline OWIN tramite il middleware dei cookie.</span><span class="sxs-lookup"><span data-stu-id="0f766-141">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="0f766-142">Per ulteriori informazioni, vedere [la pagina relativa alla gestione della durata per richiesta per la classe usermanager in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="0f766-142">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="0f766-143">Quando si modifica il profilo di sicurezza, viene generato e archiviato un nuovo indicatore di sicurezza nel campo `SecurityStamp` della tabella *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="0f766-143">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="0f766-144">Si noti che il campo `SecurityStamp` è diverso dal cookie di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="0f766-144">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="0f766-145">Il cookie di sicurezza non è archiviato nella tabella `AspNetUsers` (o altrove nel database di identità).</span><span class="sxs-lookup"><span data-stu-id="0f766-145">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="0f766-146">Il token del cookie di sicurezza è autofirmato tramite [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) e viene creato con le informazioni relative a `UserId, SecurityStamp` e ora di scadenza.</span><span class="sxs-lookup"><span data-stu-id="0f766-146">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="0f766-147">Il middleware dei cookie controlla il cookie per ogni richiesta.</span><span class="sxs-lookup"><span data-stu-id="0f766-147">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="0f766-148">Il metodo `SecurityStampValidator` nella classe `Startup` raggiunge il database e controlla periodicamente il timbro di sicurezza, come specificato con il `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="0f766-148">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="0f766-149">Questo problema si verifica solo ogni 30 minuti (in questo esempio), a meno che non si modifichi il profilo di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="0f766-149">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="0f766-150">È stato scelto l'intervallo di 30 minuti per ridurre al minimo i viaggi al database.</span><span class="sxs-lookup"><span data-stu-id="0f766-150">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="0f766-151">Per ulteriori informazioni, vedere [l'esercitazione sull'autenticazione a due fattori](index.md) .</span><span class="sxs-lookup"><span data-stu-id="0f766-151">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="0f766-152">Per i commenti nel codice, il metodo `UseCookieAuthentication` supporta l'autenticazione dei cookie.</span><span class="sxs-lookup"><span data-stu-id="0f766-152">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="0f766-153">Il campo `SecurityStamp` e il codice associato forniscono un livello di sicurezza aggiuntivo per l'app. quando si cambia la password, si verrà disconnessi dal browser con cui si è effettuato l'accesso.</span><span class="sxs-lookup"><span data-stu-id="0f766-153">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="0f766-154">Il metodo `SecurityStampValidator.OnValidateIdentity` consente all'app di convalidare il token di sicurezza quando l'utente esegue l'accesso, che viene usato quando si modifica una password o si usa l'account di accesso esterno.</span><span class="sxs-lookup"><span data-stu-id="0f766-154">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="0f766-155">Questa operazione è necessaria per garantire che tutti i token (cookie) generati con la vecchia password vengano invalidati.</span><span class="sxs-lookup"><span data-stu-id="0f766-155">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="0f766-156">Nel progetto di esempio, se si modifica la password degli utenti, viene generato un nuovo token per l'utente, tutti i token precedenti vengono invalidati e il campo `SecurityStamp` viene aggiornato.</span><span class="sxs-lookup"><span data-stu-id="0f766-156">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="0f766-157">Il sistema di identità consente di configurare l'app in modo che quando viene modificato il profilo di sicurezza degli utenti (ad esempio, quando l'utente modifica la password o modifica l'accesso associato, ad esempio da Facebook, Google, account Microsoft e così via), l'utente viene disconnesso da tutti istanze del browser.</span><span class="sxs-lookup"><span data-stu-id="0f766-157">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="0f766-158">Ad esempio, l'immagine seguente mostra l'app di [esempio Single Sign](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) -out, che consente all'utente di disconnettersi da tutte le istanze del browser (in questo caso, IE, Firefox e Chrome) selezionando un pulsante.</span><span class="sxs-lookup"><span data-stu-id="0f766-158">For example, the image below shows the [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by selecting one button.</span></span> <span data-ttu-id="0f766-159">In alternativa, l'esempio consente di disconnettersi solo da una specifica istanza del browser.</span><span class="sxs-lookup"><span data-stu-id="0f766-159">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="0f766-160">L'app di [esempio Single Sign](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) -out mostra come ASP.NET Identity consente di rigenerare il token di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="0f766-160">The [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="0f766-161">Questa operazione è necessaria per garantire che tutti i token (cookie) generati con la vecchia password vengano invalidati.</span><span class="sxs-lookup"><span data-stu-id="0f766-161">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="0f766-162">Questa funzionalità offre un livello aggiuntivo di sicurezza per l'applicazione. Quando si cambia la password, si viene disconnessi da dove è stato effettuato l'accesso a questa applicazione.</span><span class="sxs-lookup"><span data-stu-id="0f766-162">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="0f766-163">Il file *Start\IdentityConfig.cs dell'App\_* contiene le classi `ApplicationUserManager`, `EmailService` e `SmsService`.</span><span class="sxs-lookup"><span data-stu-id="0f766-163">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="0f766-164">Le classi `EmailService` e `SmsService` implementano ciascuna l'interfaccia `IIdentityMessageService`, quindi sono disponibili metodi comuni in ogni classe per la configurazione di posta elettronica e SMS.</span><span class="sxs-lookup"><span data-stu-id="0f766-164">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="0f766-165">Sebbene questa esercitazione mostri solo come aggiungere notifiche tramite posta elettronica tramite [SendGrid](http://sendgrid.com/), è possibile inviare messaggi di posta elettronica usando SMTP e altri meccanismi.</span><span class="sxs-lookup"><span data-stu-id="0f766-165">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="0f766-166">La classe `Startup` contiene anche una piastra calda per aggiungere account di accesso ai social network (Facebook, Twitter e così via). per altre informazioni, vedere l' [app MVC 5 dell'esercitazione con Facebook, Twitter, LinkedIn e Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) .</span><span class="sxs-lookup"><span data-stu-id="0f766-166">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="0f766-167">Esaminare la classe `ApplicationUserManager` contenente le informazioni sull'identità degli utenti e configurare le funzionalità seguenti:</span><span class="sxs-lookup"><span data-stu-id="0f766-167">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="0f766-168">Requisiti di complessità della password.</span><span class="sxs-lookup"><span data-stu-id="0f766-168">Password strength requirements.</span></span>
- <span data-ttu-id="0f766-169">Blocco utente (tentativi e tempo).</span><span class="sxs-lookup"><span data-stu-id="0f766-169">User lock out (attempts and time).</span></span>
- <span data-ttu-id="0f766-170">Autenticazione a due fattori (2FA).</span><span class="sxs-lookup"><span data-stu-id="0f766-170">Two-factor authentication (2FA).</span></span> <span data-ttu-id="0f766-171">Illustrerò 2FA e SMS in un'altra esercitazione.</span><span class="sxs-lookup"><span data-stu-id="0f766-171">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="0f766-172">Associazione dei servizi di posta elettronica e SMS.</span><span class="sxs-lookup"><span data-stu-id="0f766-172">Hooking up the email and SMS services.</span></span> <span data-ttu-id="0f766-173">(Si tratterà di un SMS in un'altra esercitazione).</span><span class="sxs-lookup"><span data-stu-id="0f766-173">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="0f766-174">La classe `ApplicationUserManager` deriva dalla classe `UserManager<ApplicationUser>` generica.</span><span class="sxs-lookup"><span data-stu-id="0f766-174">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="0f766-175">`ApplicationUser` deriva da [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="0f766-175">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="0f766-176">`IdentityUser` deriva dalla classe `IdentityUser` generica:</span><span class="sxs-lookup"><span data-stu-id="0f766-176">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="0f766-177">Le proprietà precedenti coincidono con le proprietà nella tabella `AspNetUsers`, illustrata in precedenza.</span><span class="sxs-lookup"><span data-stu-id="0f766-177">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="0f766-178">Gli argomenti generici in `IUser` consentono di derivare una classe utilizzando tipi diversi per la chiave primaria.</span><span class="sxs-lookup"><span data-stu-id="0f766-178">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="0f766-179">Vedere l'esempio [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) che Mostra come modificare la chiave primaria da stringa a int o GUID.</span><span class="sxs-lookup"><span data-stu-id="0f766-179">See the [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="0f766-180">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="0f766-180">ApplicationUser</span></span>

<span data-ttu-id="0f766-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) viene definito in *Models\IdentityModels.cs* come:</span><span class="sxs-lookup"><span data-stu-id="0f766-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="0f766-182">Il codice evidenziato sopra genera un [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="0f766-182">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="0f766-183">ASP.NET Identity e l'autenticazione dei cookie OWIN sono basate su attestazioni, pertanto il Framework richiede che l'app generi una `ClaimsIdentity` per l'utente.</span><span class="sxs-lookup"><span data-stu-id="0f766-183">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="0f766-184">`ClaimsIdentity` dispone di informazioni su tutte le attestazioni per l'utente, ad esempio il nome dell'utente, l'età e i ruoli a cui appartiene l'utente.</span><span class="sxs-lookup"><span data-stu-id="0f766-184">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="0f766-185">In questa fase è anche possibile aggiungere altre attestazioni per l'utente.</span><span class="sxs-lookup"><span data-stu-id="0f766-185">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="0f766-186">Il metodo `AuthenticationManager.SignIn` OWIN passa l'`ClaimsIdentity` e firma l'utente:</span><span class="sxs-lookup"><span data-stu-id="0f766-186">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="0f766-187">L' [app MVC 5 con l'accesso a Facebook, Twitter, LinkedIn e Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) Mostra come aggiungere altre proprietà alla classe `ApplicationUser`.</span><span class="sxs-lookup"><span data-stu-id="0f766-187">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="0f766-188">Conferma tramite posta elettronica</span><span class="sxs-lookup"><span data-stu-id="0f766-188">Email confirmation</span></span>

<span data-ttu-id="0f766-189">È consigliabile verificare che il messaggio di posta elettronica di un nuovo utente venga registrato per verificare che non stiano usando un altro utente, ovvero che non sono stati registrati con il messaggio di posta elettronica di un altro utente.</span><span class="sxs-lookup"><span data-stu-id="0f766-189">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="0f766-190">Si supponga di avere un forum di discussione che si vuole impedire che `"bob@example.com"` venga registrato come `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="0f766-190">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="0f766-191">Senza la conferma della posta elettronica, `"joe@contoso.com"` possibile ricevere messaggi di posta elettronica indesiderati dall'app.</span><span class="sxs-lookup"><span data-stu-id="0f766-191">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="0f766-192">Supponiamo che Bob sia stato accidentalmente registrato come `"bib@example.com"` e non sia stato notato, non sarebbe in grado di usare il ripristino della password perché l'app non ha la posta elettronica corretta.</span><span class="sxs-lookup"><span data-stu-id="0f766-192">Suppose Bob accidentally registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="0f766-193">La conferma tramite posta elettronica offre solo una protezione limitata dai bot e non fornisce protezione da spammer determinati, ma ha molti alias di posta elettronica di lavoro che possono usare per la registrazione. Nell'esempio seguente, l'utente non sarà in grado di modificare la password fino a quando l'account non è stato confermato (selezionando un collegamento di conferma ricevuto per l'account di posta elettronica con cui è stato registrato.) È possibile applicare questo flusso di lavoro ad altri scenari, ad esempio inviando un collegamento per confermare e reimpostare la password per i nuovi account creati dall'amministratore, inviando all'utente un messaggio di posta elettronica al momento della modifica del profilo e così via.</span><span class="sxs-lookup"><span data-stu-id="0f766-193">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them selecting a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="0f766-194">In genere si desidera impedire ai nuovi utenti di inviare dati al sito Web prima che siano stati confermati tramite posta elettronica, un SMS o un altro meccanismo.</span><span class="sxs-lookup"><span data-stu-id="0f766-194">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="build-a-more-complete-sample"></a><span data-ttu-id="0f766-195">Compilare un esempio più completo</span><span class="sxs-lookup"><span data-stu-id="0f766-195">Build a more complete sample</span></span>

<span data-ttu-id="0f766-196">In questa sezione si userà NuGet per scaricare un esempio più completo che verrà usato con.</span><span class="sxs-lookup"><span data-stu-id="0f766-196">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="0f766-197">Creare un nuovo progetto Web ASP.NET ***vuoto*** .</span><span class="sxs-lookup"><span data-stu-id="0f766-197">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="0f766-198">Nella console di gestione pacchetti immettere i comandi seguenti:</span><span class="sxs-lookup"><span data-stu-id="0f766-198">In the Package Manager Console, enter the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="0f766-199">In questa esercitazione verrà usato [SendGrid](http://sendgrid.com/) per inviare messaggi di posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="0f766-199">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="0f766-200">Il pacchetto di `Identity.Samples` installa il codice che verrà usato.</span><span class="sxs-lookup"><span data-stu-id="0f766-200">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="0f766-201">Impostare il [progetto per l'utilizzo di SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="0f766-201">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="0f766-202">Testare la creazione dell'account locale eseguendo l'app, selezionando il collegamento **Register** e pubblicando il modulo di registrazione.</span><span class="sxs-lookup"><span data-stu-id="0f766-202">Test local account creation by running the app, selecting the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="0f766-203">Selezionare il collegamento demo email che simula la conferma della posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="0f766-203">Select the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="0f766-204">Rimuovere il codice di conferma del collegamento di posta elettronica demo dall'esempio (il codice `ViewBag.Link` nel controller account.</span><span class="sxs-lookup"><span data-stu-id="0f766-204">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="0f766-205">Vedere i metodi di azione `DisplayEmail` e `ForgotPasswordConfirmation` e le visualizzazioni Razor).</span><span class="sxs-lookup"><span data-stu-id="0f766-205">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!WARNING]
> <span data-ttu-id="0f766-206">Se si modifica una delle impostazioni di sicurezza in questo esempio, le app Productions dovranno sottoporsi a un controllo di sicurezza che chiama in modo esplicito le modifiche apportate.</span><span class="sxs-lookup"><span data-stu-id="0f766-206">If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>

## <a name="examine-the-code-in-app_startidentityconfigcs"></a><span data-ttu-id="0f766-207">Esaminare il codice in app\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="0f766-207">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="0f766-208">Nell'esempio viene illustrato come creare un account e aggiungerlo al ruolo di *amministratore* .</span><span class="sxs-lookup"><span data-stu-id="0f766-208">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="0f766-209">È necessario sostituire il messaggio di posta elettronica nell'esempio con il messaggio di posta elettronica che verrà usato per l'account amministratore.</span><span class="sxs-lookup"><span data-stu-id="0f766-209">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="0f766-210">Il modo più semplice per creare un account amministratore è a livello di codice nel metodo `Seed`.</span><span class="sxs-lookup"><span data-stu-id="0f766-210">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="0f766-211">Ci auguriamo che in futuro sia presente uno strumento che consente di creare e amministrare utenti e ruoli.</span><span class="sxs-lookup"><span data-stu-id="0f766-211">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="0f766-212">Il codice di esempio consente di creare e gestire utenti e ruoli, ma è necessario innanzitutto disporre di un account amministratori per eseguire le pagine ruoli e Amministratore utenti.</span><span class="sxs-lookup"><span data-stu-id="0f766-212">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="0f766-213">In questo esempio, l'account amministratore viene creato quando viene creato il seeding del database.</span><span class="sxs-lookup"><span data-stu-id="0f766-213">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="0f766-214">Modificare la password e modificare il nome in un account in cui è possibile ricevere notifiche tramite posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="0f766-214">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="0f766-215">Sicurezza: non archiviare mai dati sensibili nel codice sorgente.</span><span class="sxs-lookup"><span data-stu-id="0f766-215">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="0f766-216">Come indicato in precedenza, la chiamata `app.CreatePerOwinContext` nella classe Startup aggiunge i callback al metodo `Create` delle classi Content del database App, gestione utenti e gestione ruoli.</span><span class="sxs-lookup"><span data-stu-id="0f766-216">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="0f766-217">La pipeline OWIN chiama il metodo `Create` su queste classi per ogni richiesta e archivia il contesto per ogni classe.</span><span class="sxs-lookup"><span data-stu-id="0f766-217">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="0f766-218">Il controller di account espone il gestore utenti dal contesto HTTP (che contiene il contesto OWIN):</span><span class="sxs-lookup"><span data-stu-id="0f766-218">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="0f766-219">Quando un utente registra un account locale, viene chiamato il metodo `HTTP Post Register`:</span><span class="sxs-lookup"><span data-stu-id="0f766-219">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="0f766-220">Il codice precedente usa i dati del modello per creare un nuovo account utente usando il messaggio di posta elettronica e la password immessi.</span><span class="sxs-lookup"><span data-stu-id="0f766-220">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="0f766-221">Se l'alias di posta elettronica è presente nell'archivio dati, la creazione dell'account ha esito negativo e il modulo viene nuovamente visualizzato.</span><span class="sxs-lookup"><span data-stu-id="0f766-221">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="0f766-222">Il metodo `GenerateEmailConfirmationTokenAsync` crea un token di conferma sicuro e lo archivia nell'archivio dati ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="0f766-222">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="0f766-223">Il metodo [URL. Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) crea un collegamento che contiene il `UserId` e il token di conferma.</span><span class="sxs-lookup"><span data-stu-id="0f766-223">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="0f766-224">Questo collegamento viene quindi inviato tramite posta elettronica all'utente, l'utente può selezionare il collegamento nell'app di posta elettronica per confermare l'account.</span><span class="sxs-lookup"><span data-stu-id="0f766-224">This link is then emailed to the user, the user can select on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="0f766-225">Configurare la conferma della posta elettronica</span><span class="sxs-lookup"><span data-stu-id="0f766-225">Set up email confirmation</span></span>

<span data-ttu-id="0f766-226">Vai alla [pagina di iscrizione di Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) e registrati per ottenere un account gratuito.</span><span class="sxs-lookup"><span data-stu-id="0f766-226">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="0f766-227">Aggiungere codice simile al seguente per configurare SendGrid:</span><span class="sxs-lookup"><span data-stu-id="0f766-227">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="0f766-228">I client di posta elettronica accettano spesso solo SMS (nessun HTML).</span><span class="sxs-lookup"><span data-stu-id="0f766-228">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="0f766-229">È necessario fornire il messaggio in formato testo e HTML.</span><span class="sxs-lookup"><span data-stu-id="0f766-229">You should provide the message in text and HTML.</span></span> <span data-ttu-id="0f766-230">Nell'esempio precedente di SendGrid questa operazione viene eseguita con il `myMessage.Text` e `myMessage.Html` codice illustrato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="0f766-230">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>

<span data-ttu-id="0f766-231">Il codice seguente illustra come inviare messaggi di posta elettronica usando la classe [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) in cui `message.Body` restituisce solo il collegamento.</span><span class="sxs-lookup"><span data-stu-id="0f766-231">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="0f766-232">Sicurezza: non archiviare mai dati sensibili nel codice sorgente.</span><span class="sxs-lookup"><span data-stu-id="0f766-232">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="0f766-233">L'account e le credenziali vengono archiviati in appSetting.</span><span class="sxs-lookup"><span data-stu-id="0f766-233">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="0f766-234">In Azure è possibile archiviare in modo sicuro questi valori nella scheda **[Configura](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** della portale di Azure.</span><span class="sxs-lookup"><span data-stu-id="0f766-234">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="0f766-235">Vedere [le procedure consigliate per la distribuzione di password e altri dati sensibili in ASP.NET e Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="0f766-235">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>

<span data-ttu-id="0f766-236">Immettere le credenziali di SendGrid, eseguire l'app, registrarsi con un alias di posta elettronica può selezionare il collegamento confirm (conferma) nel messaggio di posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="0f766-236">Enter your SendGrid credentials, run the app, register with an email alias can select the confirm link in your email.</span></span> <span data-ttu-id="0f766-237">Per informazioni su come eseguire questa operazione con l'account di posta elettronica di [Outlook.com](http://outlook.com) , vedere la pagina relativa alla configurazione [ C# SMTP di John atten per l'host SMTP Outlook.com](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) e alla sua[ASP.NET Identity 2,0: impostazione della convalida dell'account e](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) dei post di autorizzazione a due fattori.</span><span class="sxs-lookup"><span data-stu-id="0f766-237">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="0f766-238">Quando un utente seleziona il pulsante **Register** , viene inviato un messaggio di posta elettronica di conferma contenente un token di convalida al proprio indirizzo di posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="0f766-238">Once a user selects the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="0f766-239">All'utente viene inviato un messaggio di posta elettronica con un token di conferma per il proprio account.</span><span class="sxs-lookup"><span data-stu-id="0f766-239">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="0f766-240">Esaminare il codice</span><span class="sxs-lookup"><span data-stu-id="0f766-240">Examine the code</span></span>

<span data-ttu-id="0f766-241">Nel codice seguente viene illustrato il metodo `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="0f766-241">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="0f766-242">Il metodo ha esito negativo automaticamente se l'indirizzo di posta elettronica dell'utente non è stato confermato.</span><span class="sxs-lookup"><span data-stu-id="0f766-242">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="0f766-243">Se è stato pubblicato un errore per un indirizzo di posta elettronica non valido, gli utenti malintenzionati potrebbero usare tali informazioni per trovare un ID utente valido (alias di posta elettronica) per attaccare.</span><span class="sxs-lookup"><span data-stu-id="0f766-243">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="0f766-244">Il codice seguente illustra il metodo `ConfirmEmail` nel controller di account che viene chiamato quando l'utente seleziona il collegamento di conferma nel messaggio di posta elettronica inviato:</span><span class="sxs-lookup"><span data-stu-id="0f766-244">The following code shows the `ConfirmEmail` method in the account controller that is called when the user selects the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="0f766-245">Una volta usato, il token della password dimenticata è invalidato.</span><span class="sxs-lookup"><span data-stu-id="0f766-245">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="0f766-246">La seguente modifica del codice nel metodo `Create` (nel file *App\_Start\IdentityConfig.cs* ) imposta i token in modo che scadano tra 3 ore.</span><span class="sxs-lookup"><span data-stu-id="0f766-246">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="0f766-247">Con il codice precedente, la password dimenticata e i token di conferma della posta elettronica scadranno tra 3 ore.</span><span class="sxs-lookup"><span data-stu-id="0f766-247">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="0f766-248">Il `TokenLifespan` predefinito è un giorno.</span><span class="sxs-lookup"><span data-stu-id="0f766-248">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="0f766-249">Il codice seguente illustra il metodo di conferma della posta elettronica:</span><span class="sxs-lookup"><span data-stu-id="0f766-249">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="0f766-250">Per rendere l'app più sicura, ASP.NET Identity supporta l'autenticazione a due fattori (2FA).</span><span class="sxs-lookup"><span data-stu-id="0f766-250">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="0f766-251">Vedere [ASP.NET Identity 2,0: impostazione della convalida dell'account e dell'autorizzazione a due fattori](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) di John atten.</span><span class="sxs-lookup"><span data-stu-id="0f766-251">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="0f766-252">Sebbene sia possibile impostare il blocco degli account per gli errori dei tentativi di accesso alla password, questo approccio rende l'accesso vulnerabile ai blocchi [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) .</span><span class="sxs-lookup"><span data-stu-id="0f766-252">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="0f766-253">Si consiglia di usare il blocco degli account solo con 2FA.</span><span class="sxs-lookup"><span data-stu-id="0f766-253">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="0f766-254">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="0f766-254">Additional resources</span></span>

- [<span data-ttu-id="0f766-255">Panoramica dei provider di archiviazione personalizzati per ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="0f766-255">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="0f766-256">L' [app MVC 5 con l'accesso a Facebook, Twitter, LinkedIn e Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) Mostra anche come aggiungere informazioni sul profilo alla tabella users.</span><span class="sxs-lookup"><span data-stu-id="0f766-256">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="0f766-257">[ASP.NET MVC and Identity 2,0: informazioni sulle nozioni di base](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) di John atten.</span><span class="sxs-lookup"><span data-stu-id="0f766-257">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="0f766-258">Introduzione ad ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="0f766-258">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="0f766-259">[Annuncio della versione RTM di ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) di Rastogi.</span><span class="sxs-lookup"><span data-stu-id="0f766-259">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
