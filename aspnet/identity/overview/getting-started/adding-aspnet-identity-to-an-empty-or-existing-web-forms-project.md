---
uid: identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
title: Aggiunta di ASP.NET Identity a un progetto Web Form vuoto o esistente-ASP.NET 4. x
author: raquelsa
description: Questa esercitazione illustra come aggiungere ASP.NET Identity (il sistema di appartenenze per ASP.NET) a un'applicazione ASP.NET. Quando si crea un nuovo Web Form o MVC...
ms.author: riande
ms.date: 01/22/2019
ms.assetid: 1cbc0ed2-5bd6-4b62-8d34-4c193dcd8b25
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
msc.type: authoredcontent
ms.openlocfilehash: 8e82951d57f0b8052ee3f6530a7470be7d030206
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/06/2020
ms.locfileid: "78584126"
---
# <a name="adding-aspnet-identity-to-an-empty-or-existing-web-forms-project"></a><span data-ttu-id="d86c1-104">Aggiunta di ASP.NET Identity a un progetto Web Forms vuoto o esistente</span><span class="sxs-lookup"><span data-stu-id="d86c1-104">Adding ASP.NET Identity to an Empty or Existing Web Forms Project</span></span>

> <span data-ttu-id="d86c1-105">Questa esercitazione illustra come aggiungere [ASP.NET Identity](introduction-to-aspnet-identity.md) (il nuovo sistema di appartenenza per ASP.NET) a un'applicazione ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d86c1-105">This tutorial shows you how to add [ASP.NET Identity](introduction-to-aspnet-identity.md) (the new membership system for ASP.NET) to an ASP.NET application.</span></span>
> 
> <span data-ttu-id="d86c1-106">Quando si crea un nuovo progetto Web Form o MVC in Visual Studio 2017 RTM con singoli account, Visual Studio installerà tutti i pacchetti necessari e aggiungerà tutte le classi necessarie.</span><span class="sxs-lookup"><span data-stu-id="d86c1-106">When you create a new Web Forms or MVC project in Visual Studio 2017 RTM with Individual Accounts, Visual Studio will install all the required packages and add all necessary classes for you.</span></span> <span data-ttu-id="d86c1-107">In questa esercitazione vengono illustrati i passaggi per aggiungere ASP.NET Identity supporto al progetto Web Form esistente o a un nuovo progetto vuoto.</span><span class="sxs-lookup"><span data-stu-id="d86c1-107">This tutorial will illustrate the steps to add ASP.NET Identity support to your existing Web Forms project or a new empty project.</span></span> <span data-ttu-id="d86c1-108">Illustrerò tutti i pacchetti NuGet che è necessario installare e le classi da aggiungere.</span><span class="sxs-lookup"><span data-stu-id="d86c1-108">I will outline all the NuGet packages you need to install, and classes you need to add.</span></span> <span data-ttu-id="d86c1-109">Verranno esaminati i Web Form di esempio per la registrazione di nuovi utenti e l'accesso, evidenziando tutte le API principali del punto di ingresso per la gestione e l'autenticazione degli utenti.</span><span class="sxs-lookup"><span data-stu-id="d86c1-109">I will go over sample Web Forms for registering new users and logging in while highlighting all main entry point APIs for user management and authentication.</span></span> <span data-ttu-id="d86c1-110">In questo esempio verrà utilizzata l'implementazione predefinita di ASP.NET Identity per l'archiviazione di dati SQL basata su Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d86c1-110">This sample will use the ASP.NET Identity default implementation for SQL data storage which is built on Entity Framework.</span></span> <span data-ttu-id="d86c1-111">In questa esercitazione verrà usato il database locale per il database SQL.</span><span class="sxs-lookup"><span data-stu-id="d86c1-111">This tutorial, we will use LocalDB for the SQL database.</span></span>
> 

## <a name="get-started-with-aspnet-identity"></a><span data-ttu-id="d86c1-112">Inizia a usare ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="d86c1-112">Get started with ASP.NET Identity</span></span>

1. <span data-ttu-id="d86c1-113">Per iniziare, installare ed eseguire [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/).</span><span class="sxs-lookup"><span data-stu-id="d86c1-113">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/).</span></span>
2. <span data-ttu-id="d86c1-114">Selezionare **nuovo progetto** dalla pagina iniziale oppure è possibile usare il menu e selezionare **file**, quindi **nuovo progetto**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-114">Select **New Project** from the Start page, or you can use the menu and select **File**, and then **New Project**.</span></span>
3. <span data-ttu-id="d86c1-115">Nel riquadro sinistro espandere oggetto **visivo C#** , quindi selezionare **Web**, quindi **applicazione Web ASP.NET (.NET Framework)** .</span><span class="sxs-lookup"><span data-stu-id="d86c1-115">In the left pane, expand **Visual C#**, then select **Web**, then **ASP.NET Web Application (.Net Framework)**.</span></span> <span data-ttu-id="d86c1-116">Assegnare al progetto il nome "WebFormsIdentity" e fare clic su **OK**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-116">Name your project "WebFormsIdentity" and select **OK**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image17.png)
4. <span data-ttu-id="d86c1-117">Nella finestra di dialogo **nuovo progetto ASP.NET** selezionare il modello **vuoto** .</span><span class="sxs-lookup"><span data-stu-id="d86c1-117">In the **New ASP.NET Project** dialog, select the **Empty** template.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image2.png)  
  
   <span data-ttu-id="d86c1-118">Si noti che il pulsante **Cambia autenticazione** è disabilitato e non è disponibile alcun supporto per l'autenticazione in questo modello.</span><span class="sxs-lookup"><span data-stu-id="d86c1-118">Notice the **Change Authentication** button is disabled and no authentication support is provided in this template.</span></span> <span data-ttu-id="d86c1-119">I modelli Web Form, MVC e API Web consentono di selezionare l'approccio di autenticazione.</span><span class="sxs-lookup"><span data-stu-id="d86c1-119">The Web Forms, MVC and Web API templates allow you to select the authentication approach.</span></span>

## <a name="add-identity-packages-to-your-app"></a><span data-ttu-id="d86c1-120">Aggiungere pacchetti di identità all'app</span><span class="sxs-lookup"><span data-stu-id="d86c1-120">Add Identity packages to your app</span></span>

<span data-ttu-id="d86c1-121">In Esplora soluzioni fare clic con il pulsante destro del mouse sul progetto e scegliere **Gestisci pacchetti NuGet**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-121">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="d86c1-122">Cercare e installare il pacchetto **Microsoft. AspNet. Identity. EntityFramework** .</span><span class="sxs-lookup"><span data-stu-id="d86c1-122">Search for and install the **Microsoft.AspNet.Identity.EntityFramework** package.</span></span> 
  
![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image15.png)
  
<span data-ttu-id="d86c1-123">Si noti che questo pacchetto installerà i pacchetti di dipendenza: **EntityFramework** e **Microsoft ASP.NET Identity Core**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-123">Note that this package will install the dependency packages: **EntityFramework** and **Microsoft ASP.NET Identity Core**.</span></span>

## <a name="add-a-web-form-to-register-users"></a><span data-ttu-id="d86c1-124">Aggiungere un Web Form per registrare gli utenti</span><span class="sxs-lookup"><span data-stu-id="d86c1-124">Add a web form to register users</span></span>

1. <span data-ttu-id="d86c1-125">In **Esplora soluzioni**fare clic con il pulsante destro del mouse sul progetto e scegliere **Aggiungi**, quindi **Web Form**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-125">In **Solution Explorer**, right-click your project and select **Add**, and then **Web Form**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image4.png)
2. <span data-ttu-id="d86c1-126">Nella finestra di dialogo **Specifica nome per l'elemento** assegnare un nome al nuovo **Registro**Web Form, quindi selezionare **OK** .</span><span class="sxs-lookup"><span data-stu-id="d86c1-126">In the **Specify Name for Item** dialog box, name the new web form **Register**, and then select **OK**</span></span>
3. <span data-ttu-id="d86c1-127">Sostituire il markup nel file *Register. aspx* generato con il codice riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="d86c1-127">Replace the markup in the generated *Register.aspx* file with the code below.</span></span> <span data-ttu-id="d86c1-128">Le modifiche al codice sono evidenziate.</span><span class="sxs-lookup"><span data-stu-id="d86c1-128">The code changes are highlighted.</span></span> 

    [!code-html[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample1.aspx?highlight=9,12-40)]

    > [!NOTE]
    > <span data-ttu-id="d86c1-129">Si tratta semplicemente di una versione semplificata del file *Register. aspx* creato quando si crea un nuovo progetto Web Form ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d86c1-129">This is just a simplified version of the *Register.aspx* file that is created when you create a new ASP.NET Web Forms project.</span></span> <span data-ttu-id="d86c1-130">Il markup precedente aggiunge campi del modulo e un pulsante per registrare un nuovo utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-130">The markup above adds form fields and a button to register a new user.</span></span>
4. <span data-ttu-id="d86c1-131">Aprire il file *Register.aspx.cs* e sostituire il contenuto del file con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="d86c1-131">Open the *Register.aspx.cs* file and replace the contents of the file with the following code:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample2.cs)]

    > [!NOTE] 
    > 
    > 1. <span data-ttu-id="d86c1-132">Il codice precedente è una versione semplificata del file *Register.aspx.cs* creato quando si crea un nuovo progetto Web Form ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d86c1-132">The code above is a simplified version of the *Register.aspx.cs* file that is created when you create a new ASP.NET Web Forms project.</span></span>
    > 2. <span data-ttu-id="d86c1-133">La classe *IdentityUser* è l'implementazione predefinita di EntityFramework dell'interfaccia *IUser* .</span><span class="sxs-lookup"><span data-stu-id="d86c1-133">The *IdentityUser* class is the default EntityFramework implementation of the *IUser* interface.</span></span> <span data-ttu-id="d86c1-134">L'interfaccia *IUser* è l'interfaccia minima per un utente in ASP.NET Identity core.</span><span class="sxs-lookup"><span data-stu-id="d86c1-134">*IUser* interface is the minimal interface for a user on ASP.NET Identity Core.</span></span>
    > 3. <span data-ttu-id="d86c1-135">La classe *userStore ambito* è l'implementazione EntityFramework predefinita di un archivio utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-135">The *UserStore* class is the default EntityFramework implementation of a user store.</span></span> <span data-ttu-id="d86c1-136">Questa classe implementa le interfacce minime del ASP.NET Identity core, ovvero *IUserStore*, *IUserLoginStore*, *IUserClaimStore* e *IUserRoleStore*.</span><span class="sxs-lookup"><span data-stu-id="d86c1-136">This class implements the ASP.NET Identity Core's minimal interfaces: *IUserStore*, *IUserLoginStore*, *IUserClaimStore* and *IUserRoleStore*.</span></span>
    > 4. <span data-ttu-id="d86c1-137">La classe *usermanager* espone le API correlate all'utente che salveranno automaticamente le modifiche apportate a *userStore ambito*.</span><span class="sxs-lookup"><span data-stu-id="d86c1-137">The *UserManager* class exposes user related APIs which will automatically save changes to the *UserStore*.</span></span>
    > 5. <span data-ttu-id="d86c1-138">La classe *IdentityResult* rappresenta il risultato di un'operazione di identità.</span><span class="sxs-lookup"><span data-stu-id="d86c1-138">The *IdentityResult* class represents the result of an identity operation.</span></span>
5. <span data-ttu-id="d86c1-139">In **Esplora soluzioni**fare clic con il pulsante destro del mouse sul progetto e scegliere **Aggiungi**, **Aggiungi cartella ASP.NET** e quindi **dati\_app**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-139">In **Solution Explorer**, right-click your project and select **Add**, **Add ASP.NET Folder** and then **App\_Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image5.png)
6. <span data-ttu-id="d86c1-140">Aprire il file *Web. config* e aggiungere una voce della stringa di connessione per il database che si utilizzerà per archiviare le informazioni utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-140">Open the *Web.config* file and add a connection string entry for the database we will use to store user information.</span></span> <span data-ttu-id="d86c1-141">Il database verrà creato in fase di esecuzione da EntityFramework per le entità Identity.</span><span class="sxs-lookup"><span data-stu-id="d86c1-141">The database will be created at runtime by EntityFramework for the Identity entities.</span></span> <span data-ttu-id="d86c1-142">La stringa di connessione è simile a una creata automaticamente quando si crea un nuovo progetto Web Form.</span><span class="sxs-lookup"><span data-stu-id="d86c1-142">The connection string is similar to one created for you when you create a new Web Forms project.</span></span> <span data-ttu-id="d86c1-143">Il codice evidenziato Mostra il markup che è necessario aggiungere:</span><span class="sxs-lookup"><span data-stu-id="d86c1-143">The highlighted code shows the markup you should add:</span></span>

    [!code-xml[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample3.xml?highlight=11-14)]
    
    > [!NOTE] 
    > <span data-ttu-id="d86c1-144">Per Visual Studio 2015 o versione successiva, sostituire `(localdb)\v11.0` con `(localdb)\MSSQLLocalDB` nella stringa di connessione.</span><span class="sxs-lookup"><span data-stu-id="d86c1-144">For Visual Studio 2015 or higher, replace `(localdb)\v11.0` with `(localdb)\MSSQLLocalDB` in your connection string.</span></span>
    
7. <span data-ttu-id="d86c1-145">Fare clic con il pulsante destro del mouse su file *Register. aspx* nel progetto e selezionare **Imposta come pagina iniziale**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-145">Right click file *Register.aspx* in your project and select **Set as Start Page**.</span></span> <span data-ttu-id="d86c1-146">Premere CTRL + F5 per compilare ed eseguire l'applicazione Web.</span><span class="sxs-lookup"><span data-stu-id="d86c1-146">Press Ctrl + F5 to build and run the web application.</span></span> <span data-ttu-id="d86c1-147">Immettere un nuovo nome utente e una nuova password, quindi selezionare **registra**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-147">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image6.png)  

    > [!NOTE]
    > <span data-ttu-id="d86c1-148">ASP.NET Identity dispone del supporto per la convalida e in questo esempio è possibile verificare il comportamento predefinito sui validator utente e password che provengono dal pacchetto Identity core.</span><span class="sxs-lookup"><span data-stu-id="d86c1-148">ASP.NET Identity has support for validation and in this sample you can verify the default behavior on User and Password validators that come from the Identity Core package.</span></span> <span data-ttu-id="d86c1-149">Il validator predefinito per User (`UserValidator`) dispone di una proprietà `AllowOnlyAlphanumericUserNames` il cui valore predefinito è impostato su `true`.</span><span class="sxs-lookup"><span data-stu-id="d86c1-149">The default validator for User (`UserValidator`) has a property `AllowOnlyAlphanumericUserNames` that has default value set to `true`.</span></span> <span data-ttu-id="d86c1-150">Il validator predefinito per la password (`MinimumLengthValidator`) garantisce che la password contenga almeno 6 caratteri.</span><span class="sxs-lookup"><span data-stu-id="d86c1-150">The default validator for Password (`MinimumLengthValidator`) ensures that password has at least 6 characters.</span></span> <span data-ttu-id="d86c1-151">Questi validator sono proprietà di `UserManager` di cui è possibile eseguire l'override se si desidera eseguire la convalida personalizzata,</span><span class="sxs-lookup"><span data-stu-id="d86c1-151">These validators are properties on `UserManager` that can be overridden if you want to have custom validation,</span></span>

## <a name="verify-the-localdb-identity-database-and-tables-generated-by-entity-framework"></a><span data-ttu-id="d86c1-152">Verificare il database di identità e le tabelle del database locale generati da Entity Framework</span><span class="sxs-lookup"><span data-stu-id="d86c1-152">Verify the LocalDb Identity database and tables generated by Entity Framework</span></span>

1. <span data-ttu-id="d86c1-153">Scegliere **Esplora server**dal menu **Visualizza** .</span><span class="sxs-lookup"><span data-stu-id="d86c1-153">In the **View** menu, select **Server Explorer**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image7.png)
2. <span data-ttu-id="d86c1-154">Espandere **DefaultConnection (WebFormsIdentity)** , espandere **tabelle**, fare clic con il pulsante destro del mouse su **AspNetUsers** , quindi scegliere **Mostra dati tabella**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-154">Expand **DefaultConnection (WebFormsIdentity)**, expand **Tables**, right-click **AspNetUsers** and then select **Show Table Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image8.png)  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image9.png)

## <a name="configure-the-application-for-owin-authentication"></a><span data-ttu-id="d86c1-155">Configurare l'applicazione per l'autenticazione OWIN</span><span class="sxs-lookup"><span data-stu-id="d86c1-155">Configure the application for OWIN authentication</span></span>

<span data-ttu-id="d86c1-156">A questo punto è stato aggiunto il supporto per la creazione di utenti.</span><span class="sxs-lookup"><span data-stu-id="d86c1-156">At this point we have only added support for creating users.</span></span> <span data-ttu-id="d86c1-157">Ora verrà illustrato come è possibile aggiungere l'autenticazione per l'accesso a un utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-157">Now, we are going to demonstrate how we can add authentication to login a user.</span></span> <span data-ttu-id="d86c1-158">ASP.NET Identity usa il middleware di autenticazione di Microsoft OWIN per l'autenticazione basata su form.</span><span class="sxs-lookup"><span data-stu-id="d86c1-158">ASP.NET Identity uses Microsoft OWIN Authentication middleware for forms authentication.</span></span> <span data-ttu-id="d86c1-159">L'autenticazione del cookie OWIN è un meccanismo di autenticazione basato su cookie e attestazioni che può essere usato da qualsiasi framework ospitato in [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) o IIS.</span><span class="sxs-lookup"><span data-stu-id="d86c1-159">The OWIN Cookie Authentication is a cookie and claims based authentication mechanism that can be used by any framework hosted on [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) or IIS.</span></span> <span data-ttu-id="d86c1-160">Con questo modello, è possibile usare gli stessi pacchetti di autenticazione in più Framework, tra cui ASP.NET MVC e Web Form.</span><span class="sxs-lookup"><span data-stu-id="d86c1-160">With this model, the same authentication packages can be used across multiple frameworks including ASP.NET MVC and Web Forms.</span></span> <span data-ttu-id="d86c1-161">Per altre informazioni sul progetto Katana e su come eseguire il middleware in un host agnostico, vedere [Introduzione con il progetto Katana](https://msdn.microsoft.com/magazine/dn451439.aspx).</span><span class="sxs-lookup"><span data-stu-id="d86c1-161">For more information on project Katana and how to run middleware in a host agnostic see [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx).</span></span>

## <a name="install-authentication-packages-to-your-application"></a><span data-ttu-id="d86c1-162">Installare i pacchetti di autenticazione nell'applicazione</span><span class="sxs-lookup"><span data-stu-id="d86c1-162">Install authentication packages to your application</span></span>

1. <span data-ttu-id="d86c1-163">In Esplora soluzioni fare clic con il pulsante destro del mouse sul progetto e scegliere **Gestisci pacchetti NuGet**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-163">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="d86c1-164">Cercare e installare il pacchetto ***Microsoft. AspNet. Identity. Owin*** .</span><span class="sxs-lookup"><span data-stu-id="d86c1-164">Search for and install the ***Microsoft.AspNet.Identity.Owin*** package.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image16.png)

2. <span data-ttu-id="d86c1-165">Cercare e installare il pacchetto ***Microsoft. Owin. host. systemWeb*** .</span><span class="sxs-lookup"><span data-stu-id="d86c1-165">Search for and install the ***Microsoft.Owin.Host.SystemWeb*** package.</span></span>

    > [!NOTE]
    > <span data-ttu-id="d86c1-166">Il pacchetto **Microsoft. AspNet. Identity. Owin** contiene un set di classi di estensione Owin per gestire e configurare il middleware di autenticazione Owin che deve essere utilizzato dai pacchetti ASP.NET Identity core.</span><span class="sxs-lookup"><span data-stu-id="d86c1-166">The **Microsoft.Aspnet.Identity.Owin** package contains a set of OWIN extension classes to manage and configure OWIN authentication middleware to be consumed by ASP.NET Identity Core packages.</span></span>
    > <span data-ttu-id="d86c1-167">Il pacchetto **Microsoft. Owin. host. systemWeb** contiene un server Owin che consente l'esecuzione di applicazioni basate su OWIN in IIS tramite la pipeline delle richieste ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d86c1-167">The **Microsoft.Owin.Host.SystemWeb** package contains an OWIN server that enables OWIN-based applications to run on IIS using the ASP.NET request pipeline.</span></span> <span data-ttu-id="d86c1-168">Per altre informazioni, vedere [il middleware OWIN nella pipeline integrata di IIS](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span><span class="sxs-lookup"><span data-stu-id="d86c1-168">For more information see [OWIN Middleware in the IIS integrated pipeline](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span></span>

## <a name="add-owin-startup-and-authentication-configuration-classes"></a><span data-ttu-id="d86c1-169">Aggiungere classi di configurazione di avvio e autenticazione OWIN</span><span class="sxs-lookup"><span data-stu-id="d86c1-169">Add OWIN startup and authentication configuration classes</span></span>

1. <span data-ttu-id="d86c1-170">In **Esplora soluzioni**fare clic con il pulsante destro del mouse sul progetto, scegliere **Aggiungi**, quindi **Aggiungi nuovo elemento**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-170">In **Solution Explorer**, right-click your project, select **Add**, and then **Add New Item**.</span></span> <span data-ttu-id="d86c1-171">Nella finestra di dialogo Cerca casella di testo digitare "*Owin*".</span><span class="sxs-lookup"><span data-stu-id="d86c1-171">In the search text box dialog, type "*owin*".</span></span> <span data-ttu-id="d86c1-172">Assegnare alla classe il nome "*Startup*" e selezionare **Aggiungi**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-172">Name the class "*Startup*" and select **Add**.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image11.png)
2. <span data-ttu-id="d86c1-173">Nel file Startup.cs aggiungere il codice evidenziato riportato di seguito per configurare l'autenticazione di OWIN cookie.</span><span class="sxs-lookup"><span data-stu-id="d86c1-173">In the Startup.cs file, add the highlighted code shown below to configure OWIN cookie authentication.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample4.cs?highlight=1,3,15-19)]

    > [!NOTE]
    > <span data-ttu-id="d86c1-174">Questa classe contiene l'attributo `OwinStartup` per specificare la classe di avvio OWIN.</span><span class="sxs-lookup"><span data-stu-id="d86c1-174">This class contains the `OwinStartup` attribute for specifying the OWIN startup class.</span></span> <span data-ttu-id="d86c1-175">Ogni applicazione OWIN dispone di una classe startup in cui è possibile specificare i componenti per la pipeline dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d86c1-175">Every OWIN application has a startup class where you specify components for the application pipeline.</span></span> <span data-ttu-id="d86c1-176">Per altre informazioni su questo modello, vedere [rilevamento della classe di avvio OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) .</span><span class="sxs-lookup"><span data-stu-id="d86c1-176">See [OWIN Startup Class Detection](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) for more info on this model.</span></span>

## <a name="add-web-forms-for-registering-and-signing-in-users"></a><span data-ttu-id="d86c1-177">Aggiungere Web Form per la registrazione e l'accesso degli utenti</span><span class="sxs-lookup"><span data-stu-id="d86c1-177">Add web forms for registering and signing in users</span></span>

1. <span data-ttu-id="d86c1-178">Aprire il file *Register.aspx.cs* e aggiungere il codice seguente che esegue l'accesso all'utente quando la registrazione ha esito positivo.</span><span class="sxs-lookup"><span data-stu-id="d86c1-178">Open the *Register.aspx.cs* file and add the following code which signs in the user when registration succeeds.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample5.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="d86c1-179">Poiché l'autenticazione dei cookie ASP.NET Identity e OWIN è basata su attestazioni, il Framework richiede che lo sviluppatore di app generi un [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) per l'utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-179">Since ASP.NET Identity and OWIN Cookie Authentication are claims based system, the framework requires the app developer to generate a [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) for the user.</span></span> <span data-ttu-id="d86c1-180">ClaimsIdentity contiene informazioni su tutte le attestazioni per l'utente, ad esempio i ruoli a cui appartiene l'utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-180">ClaimsIdentity has information about all the claims for the user such as what Roles the user belongs to.</span></span> <span data-ttu-id="d86c1-181">In questa fase è anche possibile aggiungere altre attestazioni per l'utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-181">You can also add more claims for the user at this stage.</span></span>
    > - <span data-ttu-id="d86c1-182">È possibile accedere all'utente usando AuthenticationManager da OWIN e chiamando `SignIn` e passando il ClaimsIdentity come illustrato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="d86c1-182">You can sign in the user by using the AuthenticationManager from OWIN and calling `SignIn` and passing in the ClaimsIdentity as shown above.</span></span> <span data-ttu-id="d86c1-183">Questo codice effettuerà l'accesso dell'utente e genererà anche un cookie.</span><span class="sxs-lookup"><span data-stu-id="d86c1-183">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="d86c1-184">Questa chiamata è analoga a [FormAuthentication. SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) usato dal modulo [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) .</span><span class="sxs-lookup"><span data-stu-id="d86c1-184">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
2. <span data-ttu-id="d86c1-185">In **Esplora soluzioni**fare clic con il pulsante destro del mouse sul progetto, scegliere **Aggiungi**, quindi **Web Form**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-185">In **Solution Explorer**, right-click your project, select **Add**, and then **Web Form**.</span></span> <span data-ttu-id="d86c1-186">Assegnare un nome all' **account di accesso**Web Form.</span><span class="sxs-lookup"><span data-stu-id="d86c1-186">Name the web form **Login**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image12.png)
3. <span data-ttu-id="d86c1-187">Sostituire il contenuto del file *login. aspx* con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="d86c1-187">Replace the contents of the *Login.aspx* file with the following code:</span></span>

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample6.aspx)]
4. <span data-ttu-id="d86c1-188">Sostituire il contenuto del file *login.aspx.cs* con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="d86c1-188">Replace the contents of the *Login.aspx.cs* file with the following:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample7.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="d86c1-189">Il `Page_Load` ora verifica lo stato dell'utente corrente ed esegue un'azione in base al relativo stato di `Context.User.Identity.IsAuthenticated`.</span><span class="sxs-lookup"><span data-stu-id="d86c1-189">The `Page_Load` now checks for the status of current user and takes action based on its `Context.User.Identity.IsAuthenticated` status.</span></span>
    >   <span data-ttu-id="d86c1-190">**Visualizzazione del nome utente connesso** : il Framework di identità Microsoft ASP.NET ha aggiunto metodi di estensione su [System. Security. Principal. IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) che consente di ottenere il `UserName` e `UserId` per l'utente connesso.</span><span class="sxs-lookup"><span data-stu-id="d86c1-190">**Display Logged in User Name** : The Microsoft ASP.NET Identity Framework has added extension methods on [System.Security.Principal.IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) that allows you to get the `UserName` and `UserId`  for the logged in User.</span></span> <span data-ttu-id="d86c1-191">Questi metodi di estensione sono definiti nell'assembly `Microsoft.AspNet.Identity.Core`.</span><span class="sxs-lookup"><span data-stu-id="d86c1-191">These extension methods are defined in the `Microsoft.AspNet.Identity.Core` assembly.</span></span> <span data-ttu-id="d86c1-192">Questi metodi di estensione sono la sostituzione di [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span><span class="sxs-lookup"><span data-stu-id="d86c1-192">These extension methods are the replacement for [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span></span>
    > - <span data-ttu-id="d86c1-193">Metodo SignIn: `This` metodo sostituisce il metodo `CreateUser_Click` precedente in questo esempio e ora accede all'utente dopo la creazione dell'utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-193">SignIn method: `This` method replaces the previous `CreateUser_Click` method in this sample and now signs in the user after successfully creating the user.</span></span>   
    >   <span data-ttu-id="d86c1-194">Microsoft OWIN Framework ha aggiunto metodi di estensione su `System.Web.HttpContext` che consente di ottenere un riferimento a un `IOwinContext`.</span><span class="sxs-lookup"><span data-stu-id="d86c1-194">The Microsoft OWIN Framework has added extension methods on `System.Web.HttpContext` that allows you to get a reference to an `IOwinContext`.</span></span> <span data-ttu-id="d86c1-195">Questi metodi di estensione sono definiti nell'assembly `Microsoft.Owin.Host.SystemWeb`.</span><span class="sxs-lookup"><span data-stu-id="d86c1-195">These extension methods are defined in `Microsoft.Owin.Host.SystemWeb` assembly.</span></span> <span data-ttu-id="d86c1-196">La classe `OwinContext` espone una proprietà `IAuthenticationManager` che rappresenta la funzionalità del middleware di autenticazione disponibile nella richiesta corrente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-196">The `OwinContext` class exposes an `IAuthenticationManager` property that represents the Authentication middleware functionality available on the current request.</span></span> <span data-ttu-id="d86c1-197">È possibile accedere all'utente usando il `AuthenticationManager` da OWIN e chiamando `SignIn` e passando il `ClaimsIdentity` come illustrato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="d86c1-197">You can sign in the user by using the `AuthenticationManager` from OWIN and calling `SignIn` and passing in the `ClaimsIdentity` as shown above.</span></span> <span data-ttu-id="d86c1-198">Poiché l'autenticazione dei cookie ASP.NET Identity e OWIN è un sistema basato su attestazioni, il Framework richiede che l'app generi un `ClaimsIdentity` per l'utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-198">Because ASP.NET Identity and OWIN Cookie Authentication are claims-based system, the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="d86c1-199">Il `ClaimsIdentity` dispone di informazioni su tutte le attestazioni per l'utente, ad esempio i ruoli a cui appartiene l'utente.</span><span class="sxs-lookup"><span data-stu-id="d86c1-199">The `ClaimsIdentity` has information about all the claims for the user, such as what roles the user belongs to.</span></span> <span data-ttu-id="d86c1-200">In questa fase è anche possibile aggiungere altre attestazioni per l'utente. questo codice effettuerà l'accesso dell'utente e genererà anche un cookie.</span><span class="sxs-lookup"><span data-stu-id="d86c1-200">You can also add more claims for the user at this stage This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="d86c1-201">Questa chiamata è analoga a [FormAuthentication. SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) usato dal modulo [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) .</span><span class="sxs-lookup"><span data-stu-id="d86c1-201">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
    > - <span data-ttu-id="d86c1-202">Metodo `SignOut`: ottiene un riferimento al `AuthenticationManager` da OWIN e chiama `SignOut`.</span><span class="sxs-lookup"><span data-stu-id="d86c1-202">`SignOut` method: Gets a reference to the `AuthenticationManager` from OWIN and calls `SignOut`.</span></span> <span data-ttu-id="d86c1-203">Questo è analogo al metodo [FormsAuthentication. Sign](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) out usato dal modulo [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) .</span><span class="sxs-lookup"><span data-stu-id="d86c1-203">This is analogous to [FormsAuthentication.SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) method used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
5. <span data-ttu-id="d86c1-204">Premere **CTRL + F5** per compilare ed eseguire l'applicazione Web.</span><span class="sxs-lookup"><span data-stu-id="d86c1-204">Press **Ctrl + F5** to build and run the web application.</span></span> <span data-ttu-id="d86c1-205">Immettere un nuovo nome utente e una nuova password, quindi selezionare **registra**.</span><span class="sxs-lookup"><span data-stu-id="d86c1-205">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image13.png)  
   <span data-ttu-id="d86c1-206">Nota: a questo punto, il nuovo utente viene creato e connesso.</span><span class="sxs-lookup"><span data-stu-id="d86c1-206">Note: At this point, the new user is created and logged in.</span></span>
6. <span data-ttu-id="d86c1-207">Selezionare il pulsante **Disconnetti** .</span><span class="sxs-lookup"><span data-stu-id="d86c1-207">Select the **Log out** button.</span></span> <span data-ttu-id="d86c1-208">Si verrà reindirizzati al modulo di accesso.</span><span class="sxs-lookup"><span data-stu-id="d86c1-208">You are redirected to the Log in form.</span></span>
7. <span data-ttu-id="d86c1-209">Immettere un nome utente o una password non valida e selezionare il pulsante **Accedi** .</span><span class="sxs-lookup"><span data-stu-id="d86c1-209">Enter an invalid user name or password and select the **Log in** button.</span></span> 
   <span data-ttu-id="d86c1-210">Il metodo `UserManager.Find` restituirà null e verrà visualizzato il messaggio di errore: " *nome utente o password non valida* ".</span><span class="sxs-lookup"><span data-stu-id="d86c1-210">The `UserManager.Find`  method will return null and the error message: " *Invalid user name or password* " will be displayed.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image14.png)
