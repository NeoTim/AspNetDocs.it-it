---
uid: mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
title: Implementazione dei modelli di repository e unità di lavoro in un'applicazione MVC ASP.NET (9 di 10) | Microsoft Docs
author: tdykstra
description: L'applicazione Web di esempio di Contoso University illustra come creare applicazioni ASP.NET MVC 4 usando il Entity Framework 5 Code First e Visual Studio...
ms.author: riande
ms.date: 07/30/2013
ms.assetid: 44761193-04ba-4990-9f90-145d3c10a716
msc.legacyurl: /mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 18de9b125ee5d10795b9ce1a366918dadf4fc4e3
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 11/28/2019
ms.locfileid: "74595234"
---
# <a name="implementing-the-repository-and-unit-of-work-patterns-in-an-aspnet-mvc-application-9-of-10"></a><span data-ttu-id="76d2d-103">Implementazione dei modelli di repository e unità di lavoro in un'applicazione MVC ASP.NET (9 di 10)</span><span class="sxs-lookup"><span data-stu-id="76d2d-103">Implementing the Repository and Unit of Work Patterns in an ASP.NET MVC Application (9 of 10)</span></span>

<span data-ttu-id="76d2d-104">di [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="76d2d-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

[<span data-ttu-id="76d2d-105">Scarica progetto completato</span><span class="sxs-lookup"><span data-stu-id="76d2d-105">Download Completed Project</span></span>](https://code.msdn.microsoft.com/Getting-Started-with-dd0e2ed8)

> <span data-ttu-id="76d2d-106">L'applicazione Web di esempio di Contoso University illustra come creare applicazioni ASP.NET MVC 4 usando i Entity Framework 5 Code First e Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="76d2d-106">The Contoso University sample web application demonstrates how to create ASP.NET MVC 4 applications using the Entity Framework 5 Code First and Visual Studio 2012.</span></span> <span data-ttu-id="76d2d-107">Per informazioni sulla serie di esercitazioni, vedere la [prima esercitazione della serie](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span><span class="sxs-lookup"><span data-stu-id="76d2d-107">For information about the tutorial series, see [the first tutorial in the series](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span> <span data-ttu-id="76d2d-108">È possibile avviare la serie di esercitazioni dall'inizio o [scaricare un progetto iniziale per questo capitolo](building-the-ef5-mvc4-chapter-downloads.md) e iniziare da qui.</span><span class="sxs-lookup"><span data-stu-id="76d2d-108">You can start the tutorial series from the beginning or [download a starter project for this chapter](building-the-ef5-mvc4-chapter-downloads.md) and start here.</span></span>
> 
> > [!NOTE] 
> > 
> > <span data-ttu-id="76d2d-109">Se si riscontra un problema che non è possibile risolvere, [scaricare il capitolo completato](building-the-ef5-mvc4-chapter-downloads.md) e provare a riprodurre il problema.</span><span class="sxs-lookup"><span data-stu-id="76d2d-109">If you run into a problem you can't resolve, [download the completed chapter](building-the-ef5-mvc4-chapter-downloads.md) and try to reproduce your problem.</span></span> <span data-ttu-id="76d2d-110">È in genere possibile trovare la soluzione al problema confrontando il codice con il codice completato.</span><span class="sxs-lookup"><span data-stu-id="76d2d-110">You can generally find the solution to the problem by comparing your code to the completed code.</span></span> <span data-ttu-id="76d2d-111">Per alcuni errori comuni e per informazioni su come risolverli, vedere [errori e soluzioni alternative.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span><span class="sxs-lookup"><span data-stu-id="76d2d-111">For some common errors and how to solve them, see [Errors and Workarounds.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span></span>

<span data-ttu-id="76d2d-112">Nell'esercitazione precedente è stata usata l'ereditarietà per ridurre il codice ridondante nelle classi di entità `Student` e `Instructor`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-112">In the previous tutorial you used inheritance to reduce redundant code in the `Student` and `Instructor` entity classes.</span></span> <span data-ttu-id="76d2d-113">In questa esercitazione verranno illustrati alcuni modi per usare i modelli di repository e unità di lavoro per le operazioni CRUD.</span><span class="sxs-lookup"><span data-stu-id="76d2d-113">In this tutorial you'll see some ways to use the repository and unit of work patterns for CRUD operations.</span></span> <span data-ttu-id="76d2d-114">Come nell'esercitazione precedente, in questo esempio verrà modificato il modo in cui il codice funziona con le pagine già create anziché creare nuove pagine.</span><span class="sxs-lookup"><span data-stu-id="76d2d-114">As in the previous tutorial, in this one you'll change the way your code works with pages you already created rather than creating new pages.</span></span>

## <a name="the-repository-and-unit-of-work-patterns"></a><span data-ttu-id="76d2d-115">Repository e modelli di unità di lavoro</span><span class="sxs-lookup"><span data-stu-id="76d2d-115">The Repository and Unit of Work Patterns</span></span>

<span data-ttu-id="76d2d-116">I modelli di repository e unità di lavoro hanno lo scopo di creare un livello di astrazione tra il livello di accesso ai dati e il livello della logica di business di un'applicazione.</span><span class="sxs-lookup"><span data-stu-id="76d2d-116">The repository and unit of work patterns are intended to create an abstraction layer between the data access layer and the business logic layer of an application.</span></span> <span data-ttu-id="76d2d-117">L'implementazione di questi modelli può essere utile per isolare l'applicazione dalle modifiche nell'archivio dati e può semplificare il testing unità automatizzato o lo sviluppo basato su test (TDD).</span><span class="sxs-lookup"><span data-stu-id="76d2d-117">Implementing these patterns can help insulate your application from changes in the data store and can facilitate automated unit testing or test-driven development (TDD).</span></span>

<span data-ttu-id="76d2d-118">In questa esercitazione verrà implementata una classe di repository per ogni tipo di entità.</span><span class="sxs-lookup"><span data-stu-id="76d2d-118">In this tutorial you'll implement a repository class for each entity type.</span></span> <span data-ttu-id="76d2d-119">Per il tipo di entità `Student` si creeranno un'interfaccia del repository e una classe di repository.</span><span class="sxs-lookup"><span data-stu-id="76d2d-119">For the `Student` entity type you'll create a repository interface and a repository class.</span></span> <span data-ttu-id="76d2d-120">Quando si crea un'istanza del repository nel controller, si userà l'interfaccia in modo che il controller accetti un riferimento a qualsiasi oggetto che implementi l'interfaccia del repository.</span><span class="sxs-lookup"><span data-stu-id="76d2d-120">When you instantiate the repository in your controller, you'll use the interface so that the controller will accept a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="76d2d-121">Quando il controller viene eseguito in un server Web, riceve un repository che funziona con il Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="76d2d-121">When the controller runs under a web server, it receives a repository that works with the Entity Framework.</span></span> <span data-ttu-id="76d2d-122">Quando il controller viene eseguito in una classe di unit test, riceve un repository che funziona con i dati archiviati in un modo che è possibile modificare facilmente per i test, ad esempio una raccolta in memoria.</span><span class="sxs-lookup"><span data-stu-id="76d2d-122">When the controller runs under a unit test class, it receives a repository that works with data stored in a way that you can easily manipulate for testing, such as an in-memory collection.</span></span>

<span data-ttu-id="76d2d-123">Più avanti nell'esercitazione si useranno più repository e una classe Unit of work per il `Course` e `Department` i tipi di entità nel controller `Course`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-123">Later in the tutorial you'll use multiple repositories and a unit of work class for the `Course` and `Department` entity types in the `Course` controller.</span></span> <span data-ttu-id="76d2d-124">La classe Unit of work coordina il lavoro di più repository creando una singola classe del contesto di database condivisa da tutti.</span><span class="sxs-lookup"><span data-stu-id="76d2d-124">The unit of work class coordinates the work of multiple repositories by creating a single database context class shared by all of them.</span></span> <span data-ttu-id="76d2d-125">Per poter eseguire il testing unità automatizzato, è possibile creare e usare le interfacce per queste classi nello stesso modo usato per il repository `Student`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-125">If you wanted to be able to perform automated unit testing, you'd create and use interfaces for these classes in the same way you did for the `Student` repository.</span></span> <span data-ttu-id="76d2d-126">Tuttavia, per semplificare l'esercitazione, è possibile creare e usare queste classi senza interfacce.</span><span class="sxs-lookup"><span data-stu-id="76d2d-126">However, to keep the tutorial simple, you'll create and use these classes without interfaces.</span></span>

<span data-ttu-id="76d2d-127">Nella figura seguente viene illustrato un modo per concettualizzare le relazioni tra il controller e le classi del contesto rispetto a non usare il repository o il modello di unità di lavoro.</span><span class="sxs-lookup"><span data-stu-id="76d2d-127">The following illustration shows one way to conceptualize the relationships between the controller and context classes compared to not using the repository or unit of work pattern at all.</span></span>

![Repository_pattern_diagram](https://asp.net/media/2578149/Windows-Live-Writer_8c4963ba1fa3_CE3B_Repository_pattern_diagram_1df790d3-bdf2-4c11-9098-946ddd9cd884.png)

<span data-ttu-id="76d2d-129">In questa serie di esercitazioni non verranno creati unit test.</span><span class="sxs-lookup"><span data-stu-id="76d2d-129">You won't create unit tests in this tutorial series.</span></span> <span data-ttu-id="76d2d-130">Per un'introduzione a TDD con un'applicazione MVC che usa il modello di repository, vedere [procedura dettagliata: uso di TDD con ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span><span class="sxs-lookup"><span data-stu-id="76d2d-130">For an introduction to TDD with an MVC application that uses the repository pattern, see [Walkthrough: Using TDD with ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span></span> <span data-ttu-id="76d2d-131">Per ulteriori informazioni sul modello di repository, vedere le risorse seguenti:</span><span class="sxs-lookup"><span data-stu-id="76d2d-131">For more information about the repository pattern, see the following resources:</span></span>

- <span data-ttu-id="76d2d-132">[Il modello di repository](https://msdn.microsoft.com/library/ff649690.aspx) su MSDN.</span><span class="sxs-lookup"><span data-stu-id="76d2d-132">[The Repository Pattern](https://msdn.microsoft.com/library/ff649690.aspx) on MSDN.</span></span>
- <span data-ttu-id="76d2d-133">[Uso dei modelli di repository e unità di lavoro con Entity Framework 4,0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) nel Blog del team di Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="76d2d-133">[Using Repository and Unit of Work patterns with Entity Framework 4.0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) on the Entity Framework team blog.</span></span>
- <span data-ttu-id="76d2d-134">Serie di [repository Agile Entity Framework 4](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) dei post sul Blog di Julie Lerman.</span><span class="sxs-lookup"><span data-stu-id="76d2d-134">[Agile Entity Framework 4 Repository](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) series of posts on Julie Lerman's blog.</span></span>
- <span data-ttu-id="76d2d-135">[Creazione dell'account a colpo d'occhio HTML5/jQuery](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) nel Blog di Dan Wahlin.</span><span class="sxs-lookup"><span data-stu-id="76d2d-135">[Building the Account at a Glance HTML5/jQuery Application](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) on Dan Wahlin's blog.</span></span>

> [!NOTE]
> <span data-ttu-id="76d2d-136">Esistono diversi modi per implementare i modelli di repository e unità di lavoro.</span><span class="sxs-lookup"><span data-stu-id="76d2d-136">There are many ways to implement the repository and unit of work patterns.</span></span> <span data-ttu-id="76d2d-137">È possibile usare le classi di repository con o senza una classe Unit of work.</span><span class="sxs-lookup"><span data-stu-id="76d2d-137">You can use repository classes with or without a unit of work class.</span></span> <span data-ttu-id="76d2d-138">È possibile implementare un unico repository per tutti i tipi di entità o uno per ogni tipo.</span><span class="sxs-lookup"><span data-stu-id="76d2d-138">You can implement a single repository for all entity types, or one for each type.</span></span> <span data-ttu-id="76d2d-139">Se si implementa uno per ogni tipo, è possibile usare classi separate, una classe base generica e classi derivate oppure una classe base astratta e classi derivate.</span><span class="sxs-lookup"><span data-stu-id="76d2d-139">If you implement one for each type, you can use separate classes, a generic base class and derived classes, or an abstract base class and derived classes.</span></span> <span data-ttu-id="76d2d-140">È possibile includere la logica di business nel repository o limitarla alla logica di accesso ai dati.</span><span class="sxs-lookup"><span data-stu-id="76d2d-140">You can include business logic in your repository or restrict it to data access logic.</span></span> <span data-ttu-id="76d2d-141">È anche possibile creare un livello di astrazione nella classe del contesto di database usando le interfacce [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) invece dei tipi [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) per i set di entità.</span><span class="sxs-lookup"><span data-stu-id="76d2d-141">You can also build an abstraction layer into your database context class by using [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) interfaces there instead of [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) types for your entity sets.</span></span> <span data-ttu-id="76d2d-142">L'approccio all'implementazione di un livello di astrazione illustrato in questa esercitazione è una delle opzioni da prendere in considerazione, non un Consiglio per tutti gli scenari e gli ambienti.</span><span class="sxs-lookup"><span data-stu-id="76d2d-142">The approach to implementing an abstraction layer shown in this tutorial is one option for you to consider, not a recommendation for all scenarios and environments.</span></span>

## <a name="creating-the-student-repository-class"></a><span data-ttu-id="76d2d-143">Creazione della classe del repository Student</span><span class="sxs-lookup"><span data-stu-id="76d2d-143">Creating the Student Repository Class</span></span>

<span data-ttu-id="76d2d-144">Nella cartella *dal* creare un file di classe denominato *IStudentRepository.cs* e sostituire il codice esistente con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="76d2d-144">In the *DAL* folder, create a class file named *IStudentRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="76d2d-145">Questo codice dichiara un set tipico di metodi CRUD, inclusi due metodi Read, uno che restituisce tutte le entità `Student` e uno che trova una singola entità `Student` in base all'ID.</span><span class="sxs-lookup"><span data-stu-id="76d2d-145">This code declares a typical set of CRUD methods, including two read methods — one that returns all `Student` entities, and one that finds a single `Student` entity by ID.</span></span>

<span data-ttu-id="76d2d-146">Nella cartella *dal* creare un file di classe denominato *StudentRepository.cs* file.</span><span class="sxs-lookup"><span data-stu-id="76d2d-146">In the *DAL* folder, create a class file named *StudentRepository.cs* file.</span></span> <span data-ttu-id="76d2d-147">Sostituire il codice esistente con il codice seguente, che implementa l'interfaccia `IStudentRepository`:</span><span class="sxs-lookup"><span data-stu-id="76d2d-147">Replace the existing code with the following code, which implements the `IStudentRepository` interface:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample2.cs)]

<span data-ttu-id="76d2d-148">Il contesto del database è definito in una variabile di classe e il costruttore prevede che l'oggetto chiamante passi in un'istanza del contesto:</span><span class="sxs-lookup"><span data-stu-id="76d2d-148">The database context is defined in a class variable, and the constructor expects the calling object to pass in an instance of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample3.cs)]

<span data-ttu-id="76d2d-149">È possibile creare un'istanza di un nuovo contesto nel repository, ma se si usano più repository in un controller, ognuno di essi finirebbe con un contesto separato.</span><span class="sxs-lookup"><span data-stu-id="76d2d-149">You could instantiate a new context in the repository, but then if you used multiple repositories in one controller, each would end up with a separate context.</span></span> <span data-ttu-id="76d2d-150">In un secondo momento si useranno più repository nel controller `Course` e si vedrà come una classe unità di lavoro può garantire che tutti i repository usino lo stesso contesto.</span><span class="sxs-lookup"><span data-stu-id="76d2d-150">Later you'll use multiple repositories in the `Course` controller, and you'll see how a unit of work class can ensure that all repositories use the same context.</span></span>

<span data-ttu-id="76d2d-151">Il repository implementa [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) ed Elimina il contesto del database come è stato illustrato in precedenza nel controller e i relativi metodi CRUD effettuano chiamate al contesto del database nello stesso modo in cui si è visto in precedenza.</span><span class="sxs-lookup"><span data-stu-id="76d2d-151">The repository implements [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) and disposes the database context as you saw earlier in the controller, and its CRUD methods make calls to the database context in the same way that you saw earlier.</span></span>

## <a name="change-the-student-controller-to-use-the-repository"></a><span data-ttu-id="76d2d-152">Modificare il controller studente per usare il repository</span><span class="sxs-lookup"><span data-stu-id="76d2d-152">Change the Student Controller to Use the Repository</span></span>

<span data-ttu-id="76d2d-153">In *StudentController.cs*sostituire il codice attualmente presente nella classe con il codice seguente.</span><span class="sxs-lookup"><span data-stu-id="76d2d-153">In *StudentController.cs*, replace the code currently in the class with the following code.</span></span> <span data-ttu-id="76d2d-154">Le modifiche vengono evidenziate.</span><span class="sxs-lookup"><span data-stu-id="76d2d-154">The changes are highlighted.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample4.cs?highlight=13-18,44,75,77,102-103,120,137-138,159,172-174,186)]

<span data-ttu-id="76d2d-155">Il controller dichiara ora una variabile di classe per un oggetto che implementa l'interfaccia `IStudentRepository` anziché la classe Context:</span><span class="sxs-lookup"><span data-stu-id="76d2d-155">The controller now declares a class variable for an object that implements the `IStudentRepository` interface instead of the context class:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample5.cs)]

<span data-ttu-id="76d2d-156">Il costruttore predefinito (senza parametri) crea una nuova istanza del contesto e un costruttore facoltativo consente al chiamante di passare un'istanza del contesto.</span><span class="sxs-lookup"><span data-stu-id="76d2d-156">The default (parameterless) constructor creates a new context instance, and an optional constructor allows the caller to pass in a context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample6.cs)]

<span data-ttu-id="76d2d-157">(Se si usa l' *inserimento delle dipendenze*o di, non è necessario il costruttore predefinito perché il software di di per garantisce che venga sempre fornito l'oggetto repository corretto).</span><span class="sxs-lookup"><span data-stu-id="76d2d-157">(If you were using *dependency injection*, or DI, you wouldn't need the default constructor because the DI software would ensure that the correct repository object would always be provided.)</span></span>

<span data-ttu-id="76d2d-158">Nei metodi CRUD viene ora chiamato il repository anziché il contesto:</span><span class="sxs-lookup"><span data-stu-id="76d2d-158">In the CRUD methods, the repository is now called instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample7.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample8.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample9.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample10.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample11.cs)]

<span data-ttu-id="76d2d-159">Il metodo `Dispose` ora elimina il repository anziché il contesto:</span><span class="sxs-lookup"><span data-stu-id="76d2d-159">And the `Dispose` method now disposes the repository instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample12.cs)]

<span data-ttu-id="76d2d-160">Eseguire il sito e fare clic sulla scheda **students** .</span><span class="sxs-lookup"><span data-stu-id="76d2d-160">Run the site and click the **Students** tab.</span></span>

![Students_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image1.png)

<span data-ttu-id="76d2d-162">La pagina viene visualizzata e funziona allo stesso modo di quando è stato modificato il codice per l'uso del repository e anche le altre pagine degli studenti funzionano allo stesso modo.</span><span class="sxs-lookup"><span data-stu-id="76d2d-162">The page looks and works the same as it did before you changed the code to use the repository, and the other Student pages also work the same.</span></span> <span data-ttu-id="76d2d-163">Tuttavia, c'è una differenza importante nel modo in cui il `Index` metodo del controller esegue il filtro e l'ordinamento.</span><span class="sxs-lookup"><span data-stu-id="76d2d-163">However, there's an important difference in the way the `Index` method of the controller does filtering and ordering.</span></span> <span data-ttu-id="76d2d-164">La versione originale di questo metodo contiene il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="76d2d-164">The original version of this method contained the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample13.cs?highlight=1)]

<span data-ttu-id="76d2d-165">Il metodo `Index` aggiornato contiene il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="76d2d-165">The updated `Index` method contains the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample14.cs?highlight=1)]

<span data-ttu-id="76d2d-166">Solo il codice evidenziato è stato modificato.</span><span class="sxs-lookup"><span data-stu-id="76d2d-166">Only the highlighted code has changed.</span></span>

<span data-ttu-id="76d2d-167">Nella versione originale del codice `students` viene digitato come oggetto `IQueryable`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-167">In the original version of the code, `students` is typed as an `IQueryable` object.</span></span> <span data-ttu-id="76d2d-168">La query non viene inviata al database finché non viene convertita in una raccolta usando un metodo come `ToList`, che non si verifica finché la visualizzazione dell'indice non accede al modello Student.</span><span class="sxs-lookup"><span data-stu-id="76d2d-168">The query isn't sent to the database until it's converted into a collection using a method such as `ToList`, which doesn't occur until the Index view accesses the student model.</span></span> <span data-ttu-id="76d2d-169">Il metodo `Where` nel codice originale precedente diventa una clausola `WHERE` nella query SQL che viene inviata al database.</span><span class="sxs-lookup"><span data-stu-id="76d2d-169">The `Where` method in the original code above becomes a `WHERE` clause in the SQL query that is sent to the database.</span></span> <span data-ttu-id="76d2d-170">Ciò significa a sua volta che il database restituisce solo le entità selezionate.</span><span class="sxs-lookup"><span data-stu-id="76d2d-170">That in turn means that only the selected entities are returned by the database.</span></span> <span data-ttu-id="76d2d-171">Tuttavia, in seguito alla modifica di `context.Students` `studentRepository.GetStudents()`, la variabile `students` dopo questa istruzione è una raccolta `IEnumerable` che include tutti gli studenti nel database.</span><span class="sxs-lookup"><span data-stu-id="76d2d-171">However, as a result of changing `context.Students` to `studentRepository.GetStudents()`, the `students` variable after this statement is an `IEnumerable` collection that includes all students in the database.</span></span> <span data-ttu-id="76d2d-172">Il risultato finale dell'applicazione del metodo `Where` è lo stesso, ma ora il lavoro viene eseguito in memoria sul server Web e non dal database.</span><span class="sxs-lookup"><span data-stu-id="76d2d-172">The end result of applying the `Where` method is the same, but now the work is done in memory on the web server and not by the database.</span></span> <span data-ttu-id="76d2d-173">Per le query che restituiscono volumi elevati di dati, questo può risultare inefficiente.</span><span class="sxs-lookup"><span data-stu-id="76d2d-173">For queries that return large volumes of data, this can be inefficient.</span></span>

> [!TIP]
> 
> <span data-ttu-id="76d2d-174">**IQueryable rispetto a IEnumerable**</span><span class="sxs-lookup"><span data-stu-id="76d2d-174">**IQueryable vs. IEnumerable**</span></span>
> 
> <span data-ttu-id="76d2d-175">Dopo aver implementato il repository come illustrato qui, anche se si immette un elemento nella casella di **ricerca** , la query inviata a SQL Server restituisce tutte le righe degli studenti perché non include i criteri di ricerca:</span><span class="sxs-lookup"><span data-stu-id="76d2d-175">After you implement the repository as shown here, even if you enter something in the **Search** box the query sent to SQL Server returns all Student rows because it doesn't include your search criteria:</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image2.png)
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample15.sql)]
> 
> <span data-ttu-id="76d2d-176">Questa query restituisce tutti i dati degli studenti perché il repository ha eseguito la query senza conoscere i criteri di ricerca.</span><span class="sxs-lookup"><span data-stu-id="76d2d-176">This query returns all of the student data because the repository executed the query without knowing about the search criteria.</span></span> <span data-ttu-id="76d2d-177">Il processo di ordinamento, applicazione dei criteri di ricerca e selezione di un subset di dati per il paging (in questo caso solo 3 righe) viene eseguito in memoria in un secondo momento quando viene chiamato il metodo `ToPagedList` sulla raccolta di `IEnumerable`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-177">The process of sorting, applying search criteria, and selecting a subset of the data for paging (showing only 3 rows in this case) is done in memory later when the `ToPagedList` method is called on the `IEnumerable` collection.</span></span>
> 
> <span data-ttu-id="76d2d-178">Nella versione precedente del codice (prima dell'implementazione del repository), la query non viene inviata al database finché non si applicano i criteri di ricerca, quando `ToPagedList` viene chiamato sull'oggetto `IQueryable`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-178">In the previous version of the code (before you implemented the repository), the query is not sent to the database until after you apply the search criteria, when `ToPagedList` is called on the `IQueryable` object.</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image3.png)
> 
> <span data-ttu-id="76d2d-179">Quando viene chiamato in un oggetto `IQueryable`, la query inviata a SQL Server specifica la stringa di ricerca e, di conseguenza, vengono restituite solo le righe che soddisfano i criteri di ricerca e non è necessario eseguire alcun filtro in memoria.</span><span class="sxs-lookup"><span data-stu-id="76d2d-179">When ToPagedList is called on an `IQueryable` object, the query sent to SQL Server specifies the search string, and as a result only rows that meet the search criteria are returned, and no filtering needs to be done in memory.</span></span>
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample16.sql)]
> 
> <span data-ttu-id="76d2d-180">Nell'esercitazione seguente viene illustrato come esaminare le query inviate a SQL Server.</span><span class="sxs-lookup"><span data-stu-id="76d2d-180">(The following tutorial explains how to examine queries sent to SQL Server.)</span></span>

<span data-ttu-id="76d2d-181">Nella sezione seguente viene illustrato come implementare metodi di repository che consentono di specificare che questa operazione deve essere eseguita dal database.</span><span class="sxs-lookup"><span data-stu-id="76d2d-181">The following section shows how to implement repository methods that enable you to specify that this work should be done by the database.</span></span>

<span data-ttu-id="76d2d-182">A questo punto è stato creato un livello di astrazione tra il controller e il Entity Framework contesto di database.</span><span class="sxs-lookup"><span data-stu-id="76d2d-182">You've now created an abstraction layer between the controller and the Entity Framework database context.</span></span> <span data-ttu-id="76d2d-183">Se si prevede di eseguire unit test automatizzati con questa applicazione, è possibile creare una classe di repository alternativa in un unit test progetto che implementi `IStudentRepository` *.*</span><span class="sxs-lookup"><span data-stu-id="76d2d-183">If you were going to perform automated unit testing with this application, you could create an alternative repository class in a unit test project that implements `IStudentRepository`*.*</span></span> <span data-ttu-id="76d2d-184">Anziché chiamare il contesto per la lettura e la scrittura dei dati, questa classe di repository fittizio potrebbe modificare le raccolte in memoria per test controller funzioni.</span><span class="sxs-lookup"><span data-stu-id="76d2d-184">Instead of calling the context to read and write data, this mock repository class could manipulate in-memory collections in order to test controller functions.</span></span>

## <a name="implement-a-generic-repository-and-a-unit-of-work-class"></a><span data-ttu-id="76d2d-185">Implementare un repository generico e una classe Unit of work</span><span class="sxs-lookup"><span data-stu-id="76d2d-185">Implement a Generic Repository and a Unit of Work Class</span></span>

<span data-ttu-id="76d2d-186">La creazione di una classe di repository per ogni tipo di entità può comportare un numero elevato di codice ridondante e può causare aggiornamenti parziali.</span><span class="sxs-lookup"><span data-stu-id="76d2d-186">Creating a repository class for each entity type could result in a lot of redundant code, and it could result in partial updates.</span></span> <span data-ttu-id="76d2d-187">Si supponga, ad esempio, di dover aggiornare due tipi di entità diversi come parte della stessa transazione.</span><span class="sxs-lookup"><span data-stu-id="76d2d-187">For example, suppose you have to update two different entity types as part of the same transaction.</span></span> <span data-ttu-id="76d2d-188">Se ognuna utilizza un'istanza separata del contesto di database, una potrebbe avere esito positivo e l'altra potrebbe non riuscire.</span><span class="sxs-lookup"><span data-stu-id="76d2d-188">If each uses a separate database context instance, one might succeed and the other might fail.</span></span> <span data-ttu-id="76d2d-189">Un modo per ridurre al minimo il codice ridondante consiste nell'usare un repository generico e un modo per assicurarsi che tutti i repository usino lo stesso contesto di database (e coordinano quindi tutti gli aggiornamenti) consiste nell'usare una classe di unità di lavoro.</span><span class="sxs-lookup"><span data-stu-id="76d2d-189">One way to minimize redundant code is to use a generic repository, and one way to ensure that all repositories use the same database context (and thus coordinate all updates) is to use a unit of work class.</span></span>

<span data-ttu-id="76d2d-190">In questa sezione dell'esercitazione si creeranno una classe `GenericRepository` e una classe `UnitOfWork` e verranno usate nel controller `Course` per accedere ai set di entità `Department` e `Course`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-190">In this section of the tutorial, you'll create a `GenericRepository` class and a `UnitOfWork` class, and use them in the `Course` controller to access both the `Department` and the `Course` entity sets.</span></span> <span data-ttu-id="76d2d-191">Come spiegato in precedenza, per semplificare questa parte dell'esercitazione, non è possibile creare interfacce per queste classi.</span><span class="sxs-lookup"><span data-stu-id="76d2d-191">As explained earlier, to keep this part of the tutorial simple, you aren't creating interfaces for these classes.</span></span> <span data-ttu-id="76d2d-192">Tuttavia, se si intende usarle per semplificare il TDD, in genere è possibile implementarle con le interfacce nello stesso modo in cui è stato fatto il repository `Student`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-192">But if you were going to use them to facilitate TDD, you'd typically implement them with interfaces the same way you did the `Student` repository.</span></span>

### <a name="create-a-generic-repository"></a><span data-ttu-id="76d2d-193">Creare un repository generico</span><span class="sxs-lookup"><span data-stu-id="76d2d-193">Create a Generic Repository</span></span>

<span data-ttu-id="76d2d-194">Nella cartella *dal* creare *GenericRepository.cs* e sostituire il codice esistente con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="76d2d-194">In the *DAL* folder, create *GenericRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample17.cs)]

<span data-ttu-id="76d2d-195">Le variabili di classe sono dichiarate per il contesto di database e per il set di entità di cui viene creata un'istanza per il repository:</span><span class="sxs-lookup"><span data-stu-id="76d2d-195">Class variables are declared for the database context and for the entity set that the repository is instantiated for:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample18.cs)]

<span data-ttu-id="76d2d-196">Il costruttore accetta un'istanza del contesto di database e inizializza la variabile del set di entità:</span><span class="sxs-lookup"><span data-stu-id="76d2d-196">The constructor accepts a database context instance and initializes the entity set variable:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample19.cs)]

<span data-ttu-id="76d2d-197">Il metodo `Get` usa le espressioni lambda per consentire al codice chiamante di specificare una condizione di filtro e una colonna per ordinare i risultati in base a e un parametro di stringa consente al chiamante di fornire un elenco delimitato da virgole delle proprietà di navigazione per il caricamento eager:</span><span class="sxs-lookup"><span data-stu-id="76d2d-197">The `Get` method uses lambda expressions to allow the calling code to specify a filter condition and a column to order the results by, and a string parameter lets the caller provide a comma-delimited list of navigation properties for eager loading:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample20.cs)]

<span data-ttu-id="76d2d-198">Il codice `Expression<Func<TEntity, bool>> filter` indica che il chiamante fornirà un'espressione lambda in base al tipo di `TEntity` e questa espressione restituirà un valore booleano.</span><span class="sxs-lookup"><span data-stu-id="76d2d-198">The code `Expression<Func<TEntity, bool>> filter` means the caller will provide a lambda expression based on the `TEntity` type, and this expression will return a Boolean value.</span></span> <span data-ttu-id="76d2d-199">Se, ad esempio, viene creata un'istanza del repository per il tipo di entità `Student`, il codice nel metodo chiamante potrebbe specificare `student => student.LastName == "Smith`&quot; per il parametro `filter`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-199">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `student => student.LastName == "Smith`&quot; for the `filter` parameter.</span></span>

<span data-ttu-id="76d2d-200">Il codice `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` significa anche che il chiamante fornirà un'espressione lambda.</span><span class="sxs-lookup"><span data-stu-id="76d2d-200">The code `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` also means the caller will provide a lambda expression.</span></span> <span data-ttu-id="76d2d-201">Tuttavia, in questo caso, l'input per l'espressione è un oggetto `IQueryable` per il tipo di `TEntity`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-201">But in this case, the input to the expression is an `IQueryable` object for the `TEntity` type.</span></span> <span data-ttu-id="76d2d-202">L'espressione restituirà una versione ordinata di quell'oggetto `IQueryable`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-202">The expression will return an ordered version of that `IQueryable` object.</span></span> <span data-ttu-id="76d2d-203">Se, ad esempio, viene creata un'istanza del repository per il tipo di entità `Student`, il codice nel metodo chiamante potrebbe specificare `q => q.OrderBy(s => s.LastName)` per il parametro `orderBy`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-203">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `q => q.OrderBy(s => s.LastName)` for the `orderBy` parameter.</span></span>

<span data-ttu-id="76d2d-204">Il codice nel metodo `Get` crea un oggetto `IQueryable` e quindi applica l'espressione di filtro se ne esiste uno:</span><span class="sxs-lookup"><span data-stu-id="76d2d-204">The code in the `Get` method creates an `IQueryable` object and then applies the filter expression if there is one:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample21.cs)]

<span data-ttu-id="76d2d-205">Successivamente, applica le espressioni di caricamento eager dopo l'analisi dell'elenco delimitato da virgole:</span><span class="sxs-lookup"><span data-stu-id="76d2d-205">Next it applies the eager-loading expressions after parsing the comma-delimited list:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample22.cs)]

<span data-ttu-id="76d2d-206">Infine, applica l'espressione `orderBy` se ne esiste una e restituisce i risultati; in caso contrario, restituisce i risultati della query non ordinata:</span><span class="sxs-lookup"><span data-stu-id="76d2d-206">Finally, it applies the `orderBy` expression if there is one and returns the results; otherwise it returns the results from the unordered query:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample23.cs)]

<span data-ttu-id="76d2d-207">Quando si chiama il metodo `Get`, è possibile eseguire operazioni di filtro e ordinamento sulla raccolta di `IEnumerable` restituita dal metodo anziché fornire parametri per queste funzioni.</span><span class="sxs-lookup"><span data-stu-id="76d2d-207">When you call the `Get` method, you could do filtering and sorting on the `IEnumerable` collection returned by the method instead of providing parameters for these functions.</span></span> <span data-ttu-id="76d2d-208">Tuttavia, le operazioni di ordinamento e filtro verranno eseguite in memoria sul server Web.</span><span class="sxs-lookup"><span data-stu-id="76d2d-208">But the sorting and filtering work would then be done in memory on the web server.</span></span> <span data-ttu-id="76d2d-209">Utilizzando questi parametri, si garantisce che il lavoro venga eseguito dal database piuttosto che dal server Web.</span><span class="sxs-lookup"><span data-stu-id="76d2d-209">By using these parameters, you ensure that the work is done by the database rather than the web server.</span></span> <span data-ttu-id="76d2d-210">In alternativa, è possibile creare classi derivate per tipi di entità specifici e aggiungere metodi di `Get` specializzati, ad esempio `GetStudentsInNameOrder` o `GetStudentsByName`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-210">An alternative is to create derived classes for specific entity types and add specialized `Get` methods, such as `GetStudentsInNameOrder` or `GetStudentsByName`.</span></span> <span data-ttu-id="76d2d-211">Tuttavia, in un'applicazione complessa, questo può comportare un numero elevato di classi derivate e metodi specializzati, che potrebbero essere più lavoro da gestire.</span><span class="sxs-lookup"><span data-stu-id="76d2d-211">However, in a complex application, this can result in a large number of such derived classes and specialized methods, which could be more work to maintain.</span></span>

<span data-ttu-id="76d2d-212">Il codice nei metodi `GetByID`, `Insert`e `Update` è simile a quello che è stato visto nel repository non generico.</span><span class="sxs-lookup"><span data-stu-id="76d2d-212">The code in the `GetByID`, `Insert`, and `Update` methods is similar to what you saw in the non-generic repository.</span></span> <span data-ttu-id="76d2d-213">Non è stato fornito un parametro di caricamento eager nella firma `GetByID`, perché non è possibile eseguire il caricamento eager con il metodo `Find`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-213">(You aren't providing an eager loading parameter in the `GetByID` signature, because you can't do eager loading with the `Find` method.)</span></span>

<span data-ttu-id="76d2d-214">Per il metodo `Delete` sono disponibili due overload:</span><span class="sxs-lookup"><span data-stu-id="76d2d-214">Two overloads are provided for the `Delete` method:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample24.cs)]

<span data-ttu-id="76d2d-215">Uno di questi consente di passare solo l'ID dell'entità da eliminare e uno accetta un'istanza di entità.</span><span class="sxs-lookup"><span data-stu-id="76d2d-215">One of these lets you pass in just the ID of the entity to be deleted, and one takes an entity instance.</span></span> <span data-ttu-id="76d2d-216">Come si è visto nell'esercitazione sulla [gestione della concorrenza](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) , per la gestione della concorrenza è necessario un metodo di `Delete` che accetta un'istanza di entità che include il valore originale di una proprietà di rilevamento.</span><span class="sxs-lookup"><span data-stu-id="76d2d-216">As you saw in the [Handling Concurrency](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial, for concurrency handling you need a `Delete` method that takes an entity instance that includes the original value of a tracking property.</span></span>

<span data-ttu-id="76d2d-217">Questo repository generico gestirà i requisiti CRUD tipici.</span><span class="sxs-lookup"><span data-stu-id="76d2d-217">This generic repository will handle typical CRUD requirements.</span></span> <span data-ttu-id="76d2d-218">Quando un particolare tipo di entità dispone di requisiti speciali, ad esempio un filtro o un ordinamento più complesso, è possibile creare una classe derivata con metodi aggiuntivi per quel tipo.</span><span class="sxs-lookup"><span data-stu-id="76d2d-218">When a particular entity type has special requirements, such as more complex filtering or ordering, you can create a derived class that has additional methods for that type.</span></span>

## <a name="creating-the-unit-of-work-class"></a><span data-ttu-id="76d2d-219">Creazione della classe Unit of work</span><span class="sxs-lookup"><span data-stu-id="76d2d-219">Creating the Unit of Work Class</span></span>

<span data-ttu-id="76d2d-220">La classe Unit of work serve uno scopo: per assicurarsi che, quando si usano più repository, condividono un unico contesto di database.</span><span class="sxs-lookup"><span data-stu-id="76d2d-220">The unit of work class serves one purpose: to make sure that when you use multiple repositories, they share a single database context.</span></span> <span data-ttu-id="76d2d-221">In questo modo, quando un'unità di lavoro viene completata, è possibile chiamare il metodo `SaveChanges` su tale istanza del contesto e assicurarsi che tutte le modifiche correlate vengano coordinate.</span><span class="sxs-lookup"><span data-stu-id="76d2d-221">That way, when a unit of work is complete you can call the `SaveChanges` method on that instance of the context and be assured that all related changes will be coordinated.</span></span> <span data-ttu-id="76d2d-222">Tutti i requisiti della classe sono un metodo `Save` e una proprietà per ogni repository.</span><span class="sxs-lookup"><span data-stu-id="76d2d-222">All that the class needs is a `Save` method and a property for each repository.</span></span> <span data-ttu-id="76d2d-223">Ogni proprietà del repository restituisce un'istanza del repository di cui è stata creata un'istanza utilizzando la stessa istanza del contesto di database delle altre istanze del repository.</span><span class="sxs-lookup"><span data-stu-id="76d2d-223">Each repository property returns a repository instance that has been instantiated using the same database context instance as the other repository instances.</span></span>

<span data-ttu-id="76d2d-224">Nella cartella *dal* creare un file di classe denominato *UnitOfWork.cs* e sostituire il codice del modello con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="76d2d-224">In the *DAL* folder, create a class file named *UnitOfWork.cs* and replace the template code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample25.cs)]

<span data-ttu-id="76d2d-225">Il codice crea variabili di classe per il contesto del database e per ogni repository.</span><span class="sxs-lookup"><span data-stu-id="76d2d-225">The code creates class variables for the database context and each repository.</span></span> <span data-ttu-id="76d2d-226">Per la variabile `context`, viene creata un'istanza di un nuovo contesto:</span><span class="sxs-lookup"><span data-stu-id="76d2d-226">For the `context` variable, a new context is instantiated:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample26.cs)]

<span data-ttu-id="76d2d-227">Ogni proprietà del repository controlla se il repository esiste già.</span><span class="sxs-lookup"><span data-stu-id="76d2d-227">Each repository property checks whether the repository already exists.</span></span> <span data-ttu-id="76d2d-228">In caso contrario, crea un'istanza del repository, passando l'istanza del contesto.</span><span class="sxs-lookup"><span data-stu-id="76d2d-228">If not, it instantiates the repository, passing in the context instance.</span></span> <span data-ttu-id="76d2d-229">Di conseguenza, tutti i repository condividono la stessa istanza del contesto.</span><span class="sxs-lookup"><span data-stu-id="76d2d-229">As a result, all repositories share the same context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample27.cs)]

<span data-ttu-id="76d2d-230">Il metodo `Save` chiama `SaveChanges` nel contesto del database.</span><span class="sxs-lookup"><span data-stu-id="76d2d-230">The `Save` method calls `SaveChanges` on the database context.</span></span>

<span data-ttu-id="76d2d-231">Analogamente a qualsiasi classe che crea un'istanza di un contesto di database in una variabile di classe, la classe `UnitOfWork` implementa `IDisposable` ed Elimina il contesto.</span><span class="sxs-lookup"><span data-stu-id="76d2d-231">Like any class that instantiates a database context in a class variable, the `UnitOfWork` class implements `IDisposable` and disposes the context.</span></span>

### <a name="changing-the-course-controller-to-use-the-unitofwork-class-and-repositories"></a><span data-ttu-id="76d2d-232">Modifica del controller di corso per l'uso della classe UnitOfWork e dei repository</span><span class="sxs-lookup"><span data-stu-id="76d2d-232">Changing the Course Controller to use the UnitOfWork Class and Repositories</span></span>

<span data-ttu-id="76d2d-233">Sostituire il codice attualmente disponibile in *CourseController.cs* con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="76d2d-233">Replace the code you currently have in *CourseController.cs* with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample28.cs?highlight=15,20,22,31,54-55,70,85-86,101-102,122-124,130)]

<span data-ttu-id="76d2d-234">Questo codice aggiunge una variabile di classe per la classe `UnitOfWork`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-234">This code adds a class variable for the `UnitOfWork` class.</span></span> <span data-ttu-id="76d2d-235">Se si usano le interfacce in questo punto, non è necessario inizializzare la variabile qui, bensì implementare un modello di due costruttori come per il repository `Student`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-235">(If you were using interfaces here, you wouldn't initialize the variable here; instead, you'd implement a pattern of two constructors just as you did for the `Student` repository.)</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample29.cs)]

<span data-ttu-id="76d2d-236">Nel resto della classe tutti i riferimenti al contesto del database vengono sostituiti dai riferimenti al repository appropriato, usando `UnitOfWork` proprietà per accedere al repository.</span><span class="sxs-lookup"><span data-stu-id="76d2d-236">In the rest of the class, all references to the database context are replaced by references to the appropriate repository, using `UnitOfWork` properties to access the repository.</span></span> <span data-ttu-id="76d2d-237">Il metodo `Dispose` Elimina l'istanza di `UnitOfWork`.</span><span class="sxs-lookup"><span data-stu-id="76d2d-237">The `Dispose` method disposes the `UnitOfWork` instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample30.cs)]

<span data-ttu-id="76d2d-238">Eseguire il sito e fare clic sulla scheda **Courses (corsi** ).</span><span class="sxs-lookup"><span data-stu-id="76d2d-238">Run the site and click the **Courses** tab.</span></span>

![Courses_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image4.png)

<span data-ttu-id="76d2d-240">La pagina viene visualizzata e funziona allo stesso modo di prima delle modifiche e anche le altre pagine del corso funzionano allo stesso modo.</span><span class="sxs-lookup"><span data-stu-id="76d2d-240">The page looks and works the same as it did before your changes, and the other Course pages also work the same.</span></span>

## <a name="summary"></a><span data-ttu-id="76d2d-241">Riepilogo</span><span class="sxs-lookup"><span data-stu-id="76d2d-241">Summary</span></span>

<span data-ttu-id="76d2d-242">A questo punto sono stati implementati i modelli di repository e unità di lavoro.</span><span class="sxs-lookup"><span data-stu-id="76d2d-242">You have now implemented both the repository and unit of work patterns.</span></span> <span data-ttu-id="76d2d-243">Sono state usate espressioni lambda come parametri del metodo nel repository generico.</span><span class="sxs-lookup"><span data-stu-id="76d2d-243">You have used lambda expressions as method parameters in the generic repository.</span></span> <span data-ttu-id="76d2d-244">Per ulteriori informazioni sull'utilizzo di queste espressioni con un oggetto `IQueryable`, vedere [interfaccia IQueryable (t) (System. Linq)](https://msdn.microsoft.com/library/bb351562.aspx) in MSDN Library.</span><span class="sxs-lookup"><span data-stu-id="76d2d-244">For more information about how to use these expressions with an `IQueryable` object, see [IQueryable(T) Interface (System.Linq)](https://msdn.microsoft.com/library/bb351562.aspx) in the MSDN Library.</span></span> <span data-ttu-id="76d2d-245">Nell'esercitazione successiva si apprenderà come gestire alcuni scenari avanzati.</span><span class="sxs-lookup"><span data-stu-id="76d2d-245">In the next tutorial you'll learn how to handle some advanced scenarios.</span></span>

<span data-ttu-id="76d2d-246">I collegamenti ad altre risorse Entity Framework sono disponibili nella [mappa del contenuto di ASP.NET Data Access](../../../../whitepapers/aspnet-data-access-content-map.md).</span><span class="sxs-lookup"><span data-stu-id="76d2d-246">Links to other Entity Framework resources can be found in the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="76d2d-247">[Precedente](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
> [Successivo](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="76d2d-247">[Previous](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
[Next](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span></span>
