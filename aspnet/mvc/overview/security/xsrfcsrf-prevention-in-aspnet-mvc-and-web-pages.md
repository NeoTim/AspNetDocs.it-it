---
uid: mvc/overview/security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages
title: Prevenzione di XSRF/CSRF in ASP.NET MVC e pagine Web | Microsoft Docs
author: Rick-Anderson
description: Richiesta intersito falsa (nota anche come XSRF o CSRF) è un attacco contro applicazioni ospitate sul web in base al quale un sito web dannoso può influenzare il interacti...
ms.author: riande
ms.date: 03/14/2013
ms.assetid: aadc5fa4-8215-4fc7-afd5-bcd2ef879728
msc.legacyurl: /mvc/overview/security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages
msc.type: authoredcontent
ms.openlocfilehash: de0e9cc168b9f18fd2bd83329106df45d7551b1a
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/09/2019
ms.locfileid: "59386560"
---
# <a name="xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages"></a><span data-ttu-id="a8c96-103">Prevenzione di XSRF/CSRF in ASP.NET MVC e pagine Web</span><span class="sxs-lookup"><span data-stu-id="a8c96-103">XSRF/CSRF Prevention in ASP.NET MVC and Web Pages</span></span>

<span data-ttu-id="a8c96-104">da [Rick Anderson]((https://twitter.com/RickAndMSFT))</span><span class="sxs-lookup"><span data-stu-id="a8c96-104">by [Rick Anderson]((https://twitter.com/RickAndMSFT))</span></span>

> <span data-ttu-id="a8c96-105">Richiesta intersito falsa (nota anche come XSRF o CSRF) è un attacco contro applicazioni ospitate sul web in base al quale un sito web dannoso può influenzare l'interazione tra un browser client e un sito web considerato attendibile da tale browser.</span><span class="sxs-lookup"><span data-stu-id="a8c96-105">Cross-site request forgery (also known as XSRF or CSRF) is an attack against web-hosted applications whereby a malicious web site can influence the interaction between a client browser and a web site trusted by that browser.</span></span> <span data-ttu-id="a8c96-106">Questi attacchi sono possibili in quanto i web browser invia i token di autenticazione automaticamente con ogni richiesta a un sito web.</span><span class="sxs-lookup"><span data-stu-id="a8c96-106">These attacks are made possible because web browsers will send authentication tokens automatically with every request to a web site.</span></span> <span data-ttu-id="a8c96-107">L'esempio canonico è un cookie di autenticazione, ad esempio, ASP. Ticket di autenticazione basata su form di NET.</span><span class="sxs-lookup"><span data-stu-id="a8c96-107">The canonical example is an authentication cookie, such as ASP.NET's Forms Authentication ticket.</span></span> <span data-ttu-id="a8c96-108">Tuttavia, siti web che utilizzano qualsiasi meccanismo di autenticazione persistente (ad esempio l'autenticazione di Windows, Basic e così via) di destinazione per questi attacchi.</span><span class="sxs-lookup"><span data-stu-id="a8c96-108">However, web sites which use any persistent authentication mechanism (such as Windows Authentication, Basic, and so forth) can be targeted by these attacks.</span></span>
> 
> <span data-ttu-id="a8c96-109">Un attacco XSRF è diverso da un attacco di phishing.</span><span class="sxs-lookup"><span data-stu-id="a8c96-109">An XSRF attack is distinct from a phishing attack.</span></span> <span data-ttu-id="a8c96-110">Gli attacchi di phishing richiedono l'interazione da parte della vittima.</span><span class="sxs-lookup"><span data-stu-id="a8c96-110">Phishing attacks require interaction from the victim.</span></span> <span data-ttu-id="a8c96-111">In un attacco di phishing, un sito web dannoso imita il sito web di destinazione e la vittima viene indotta a fornire le informazioni riservate all'autore dell'attacco.</span><span class="sxs-lookup"><span data-stu-id="a8c96-111">In a phishing attack, a malicious web site will mimic the target web site, and the victim is fooled into providing sensitive information to the attacker.</span></span> <span data-ttu-id="a8c96-112">In un attacco XSRF non è spesso interagisce necessaria da parte della vittima.</span><span class="sxs-lookup"><span data-stu-id="a8c96-112">In an XSRF attack, there is often no interaction necessary from the victim.</span></span> <span data-ttu-id="a8c96-113">Piuttosto, l'autore dell'attacco si basa il browser invii automaticamente tutti i cookie pertinenti al sito web di destinazione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-113">Rather, the attacker is relying on the browser automatically sending all relevant cookies to the destination web site.</span></span>
> 
> <span data-ttu-id="a8c96-114">Per altre informazioni, vedere la [Open Web Application Security Project](https://www.owasp.org/index.php/Main_Page)(OWASP) [XSRF](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)).</span><span class="sxs-lookup"><span data-stu-id="a8c96-114">For more information, see the [Open Web Application Security Project](https://www.owasp.org/index.php/Main_Page)(OWASP) [XSRF](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)).</span></span>


## <a name="anatomy-of-an-attack"></a><span data-ttu-id="a8c96-115">Anatomia di un attacco</span><span class="sxs-lookup"><span data-stu-id="a8c96-115">Anatomy of an attack</span></span>

<span data-ttu-id="a8c96-116">Per spostarsi all'interno di un attacco XSRF, prendere in considerazione un utente che si desidera eseguire alcune operazioni di banking online.</span><span class="sxs-lookup"><span data-stu-id="a8c96-116">To walk through an XSRF attack, consider a user who wants to perform some online banking transactions.</span></span> <span data-ttu-id="a8c96-117">L'utente visita prima WoodgroveBank.com e i log, a quel punto l'intestazione della risposta conterrà il cookie di autenticazione:</span><span class="sxs-lookup"><span data-stu-id="a8c96-117">This user first visits WoodgroveBank.com and logs in, at which point the response header will contain her authentication cookie:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample1.cmd)]

<span data-ttu-id="a8c96-118">Poiché il cookie di autenticazione è un cookie di sessione, si verrà cancellato automaticamente dal browser alla chiusura del processo del browser.</span><span class="sxs-lookup"><span data-stu-id="a8c96-118">Because the authentication cookie is a session cookie, it will be automatically cleared by the browser when the browser process exits.</span></span> <span data-ttu-id="a8c96-119">Tuttavia, fino a quel momento, il browser includerà automaticamente i cookie con ogni richiesta a WoodgroveBank.com.</span><span class="sxs-lookup"><span data-stu-id="a8c96-119">However, until that time, the browser will automatically include the cookie with each request to WoodgroveBank.com.</span></span> <span data-ttu-id="a8c96-120">A questo punto, l'utente vuole trasferire 1000 dollari per un altro account, in modo che Anna compila un modulo nel sito di servizi bancari, e il browser invia la richiesta al server:</span><span class="sxs-lookup"><span data-stu-id="a8c96-120">The user now wants to transfer $1000 to another account, so she fills out a form on the banking site, and the browser makes this request to the server:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample2.cmd)]

<span data-ttu-id="a8c96-121">Poiché questa operazione ha un effetto collaterale (all'avvio di una transazione monetaria), il sito di servizi bancari ha scelto di richiedere una richiesta HTTP POST per avviare l'operazione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-121">Because this operation has a side effect (it initiates a monetary transaction), the banking site has chosen to require an HTTP POST in order to initiate this operation.</span></span> <span data-ttu-id="a8c96-122">Il server legge il token di autenticazione della richiesta, Cerca il numero di account dell'utente corrente, verifica che i fondi sufficienti esiste e quindi avvia la transazione nell'account di destinazione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-122">The server reads the authentication token from the request, looks up the current user's account number, verifies that sufficient funds exist, and then initiates the transaction into the destination account.</span></span>

<span data-ttu-id="a8c96-123">L'utente online banking completo, l'utente visita il sito di servizi bancari e visita altri percorsi sul web.</span><span class="sxs-lookup"><span data-stu-id="a8c96-123">Her online banking complete, the user navigates away from the banking site and visits other locations on the web.</span></span> <span data-ttu-id="a8c96-124">Uno di quei siti – fabrikam.com – include il markup seguente in una pagina incorporata all'interno di un' &lt;iframe&gt;:</span><span class="sxs-lookup"><span data-stu-id="a8c96-124">One of those sites – fabrikam.com – includes the following markup on a page embedded within an &lt;iframe&gt;:</span></span>

[!code-html[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample3.html)]

<span data-ttu-id="a8c96-125">Che a sua fa sì che il browser effettuare questa richiesta:</span><span class="sxs-lookup"><span data-stu-id="a8c96-125">Which then causes the browser to make this request:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample4.cmd)]

<span data-ttu-id="a8c96-126">L'autore dell'attacco sta sfruttando il fatto che l'utente potrebbe avere ancora un token di autenticazione valido per il sito web di destinazione e Anna Usa un piccolo frammento di codice di Javascript per fare in modo il browser apportare automaticamente una richiesta HTTP POST al sito di destinazione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-126">The attacker is exploiting the fact that the user might still have a valid authentication token for the target web site, and she is using a small snippet of Javascript to cause the browser to make an HTTP POST to the target site automatically.</span></span> <span data-ttu-id="a8c96-127">Se il token di autenticazione è ancora valido, il sito di servizi bancari avvierà un trasferimento di $250 conto della scelta dell'utente malintenzionato.</span><span class="sxs-lookup"><span data-stu-id="a8c96-127">If the authentication token is still valid, the banking site will initiate a transfer of $250 into the account of the attacker's choosing.</span></span>

### <a name="ineffective-mitigations"></a><span data-ttu-id="a8c96-128">Mitigazioni inefficaci</span><span class="sxs-lookup"><span data-stu-id="a8c96-128">Ineffective mitigations</span></span>

<span data-ttu-id="a8c96-129">È interessante notare che nello scenario precedente, il fatto che WoodgroveBank.com è stato possibile accedere tramite SSL e ha un cookie di autenticazione solo SSL è stato sufficiente per contrastare l'attacco.</span><span class="sxs-lookup"><span data-stu-id="a8c96-129">It is interesting to note that in the above scenario, the fact that WoodgroveBank.com was being accessed via SSL and had an SSL-only authentication cookie was insufficient to thwart the attack.</span></span> <span data-ttu-id="a8c96-130">L'autore dell'attacco è in grado di specificare il [schema URI](http://en.wikipedia.org/wiki/URI_scheme) (https) nel proprio &lt;form&gt; elemento e il browser continuerà a inviare i cookie non scaduti al sito di destinazione, purché i cookie sono coerenti con l'URI schema di destinazione prevista.</span><span class="sxs-lookup"><span data-stu-id="a8c96-130">The attacker is able to specify the [URI scheme](http://en.wikipedia.org/wiki/URI_scheme) (https) in her &lt;form&gt; element, and the browser will continue to send unexpired cookies to the target site as long as those cookies are consistent with the URI scheme of the intended target.</span></span>

<span data-ttu-id="a8c96-131">Si potrebbe sostenere che l'utente deve semplicemente non visitare siti non attendibili, come visitato solo siti attendibili è consente di rimanere sicuri.</span><span class="sxs-lookup"><span data-stu-id="a8c96-131">One could argue that the user should simply not visit untrusted sites, as visiting only trusted sites is helps to remain safe online.</span></span> <span data-ttu-id="a8c96-132">Ecco alcuni dati reali a questo, ma purtroppo questa raccomandazione non è sempre pratica.</span><span class="sxs-lookup"><span data-stu-id="a8c96-132">There is some truth to this, but unfortunately this advice is not always practical.</span></span> <span data-ttu-id="a8c96-133">Ad esempio l'utente "considera attendibile" il sito di notizie locali ConsolidatedMessenger.</span><span class="sxs-lookup"><span data-stu-id="a8c96-133">Perhaps the user "trusts" the local news site ConsolidatedMessenger.</span></span> <span data-ttu-id="a8c96-134">Una vulnerabilità XSS che consente a un utente malintenzionato di inserire lo stesso frammento di codice che era in esecuzione in fabrikam.com ConsolidatedMessenger.com e passa alla visita che invece del sito, ma tale sito.</span><span class="sxs-lookup"><span data-stu-id="a8c96-134">ConsolidatedMessenger.com and goes to visit that site instead, but that site has an XSS vulnerability which allows an attacker to inject the same snippet of code that was running on fabrikam.com.</span></span>

<span data-ttu-id="a8c96-135">È possibile verificare che le richieste in ingresso hanno una [intestazione Referer](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) che fa riferimento il dominio.</span><span class="sxs-lookup"><span data-stu-id="a8c96-135">You can verify that incoming requests have a [Referer header](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) referencing your domain.</span></span> <span data-ttu-id="a8c96-136">L'operazione arresterà involontariamente autore richieste di un dominio di terze parti.</span><span class="sxs-lookup"><span data-stu-id="a8c96-136">This will stop requests unwittingly submitted from a third-party domain.</span></span> <span data-ttu-id="a8c96-137">Tuttavia, alcune persone disabilitare intestazione Referer del browser per motivi di privacy e gli utenti malintenzionati possono talvolta effettuare lo spoofing tale intestazione se la vittima è determinate installato software non sicuri.</span><span class="sxs-lookup"><span data-stu-id="a8c96-137">However, some people disable their browser's Referer header for privacy reasons, and attackers can sometimes spoof that header if the victim has certain insecure software installed.</span></span> <span data-ttu-id="a8c96-138">Verifica per determinare se il [intestazione Referer](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) non viene considerato un approccio sicuro per la prevenzione degli attacchi XSRF.</span><span class="sxs-lookup"><span data-stu-id="a8c96-138">Verifying the [Referer header](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) is not considered a secure approach to preventing XSRF attacks.</span></span>

## <a name="web-stack-runtime-xsrf-mitigations"></a><span data-ttu-id="a8c96-139">Prevenzione di XSRF Runtime Stack Web</span><span class="sxs-lookup"><span data-stu-id="a8c96-139">Web Stack Runtime XSRF mitigations</span></span>

<span data-ttu-id="a8c96-140">ASP.NET Web Stack di Runtime Usa una variante del [modello di token sincronizzatore](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern) per difendersi da attacchi XSRF.</span><span class="sxs-lookup"><span data-stu-id="a8c96-140">The ASP.NET Web Stack Runtime uses a variant of the [synchronizer token pattern](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern) to defend against XSRF attacks.</span></span> <span data-ttu-id="a8c96-141">La forma generale del modello di token del programma di sincronizzazione è che due token anti-XSRF vengano inviate al server con ogni richiesta HTTP POST (oltre al token di autenticazione): un token come un cookie e l'altro come valore di modulo.</span><span class="sxs-lookup"><span data-stu-id="a8c96-141">The general form of the synchronizer token pattern is that two anti-XSRF tokens are submitted to the server with each HTTP POST (In addition to the authentication token): one token as a cookie, and the other as a form value.</span></span> <span data-ttu-id="a8c96-142">I valori del token generati dal runtime di ASP.NET non sono deterministiche o stimabile da un utente malintenzionato.</span><span class="sxs-lookup"><span data-stu-id="a8c96-142">The token values generated by the ASP.NET runtime are not deterministic or predictable by an attacker.</span></span> <span data-ttu-id="a8c96-143">Quando vengono inviati i token, il server consentirà alla richiesta di procedere solo se entrambi i token superano un controllo di confronto.</span><span class="sxs-lookup"><span data-stu-id="a8c96-143">When the tokens are submitted, the server will allow the request to proceed only if both tokens pass a comparison check.</span></span>

<span data-ttu-id="a8c96-144">La verifica della richiesta XSRF *token di sessione* viene archiviato come un cookie HTTP e attualmente contiene le informazioni seguenti nel relativo payload:</span><span class="sxs-lookup"><span data-stu-id="a8c96-144">The XSRF request verification *session token* is stored as an HTTP cookie and currently contains the following information in its payload:</span></span>

- <span data-ttu-id="a8c96-145">Un token di sicurezza, costituito da un identificatore casuale a 128 bit.</span><span class="sxs-lookup"><span data-stu-id="a8c96-145">A security token, consisting of a random 128-bit identifier.</span></span>   
 <span data-ttu-id="a8c96-146">L'immagine seguente mostra il token di sessione XSRF richiesta verifica visualizzato con strumenti di sviluppo F12 di Internet Explorer: (Nota di questo è l'implementazione corrente ed è soggetto, ancora soggette a modifica.)</span><span class="sxs-lookup"><span data-stu-id="a8c96-146">The following image shows the XSRF request verification session token displayed with the Internet Explorer F12 developer tools: (Note this is the current implementation and is subject, even likely, to change.)</span></span>

![](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/_static/image1.png)

<span data-ttu-id="a8c96-147">Il *token pole* viene archiviato come un `<input type="hidden" />` e contiene le informazioni seguenti nel relativo payload:</span><span class="sxs-lookup"><span data-stu-id="a8c96-147">The *field token* is stored as an `<input type="hidden" />` and contains the following information in its payload:</span></span>

- <span data-ttu-id="a8c96-148">Nome utente dell'utente connesso (se autenticato).</span><span class="sxs-lookup"><span data-stu-id="a8c96-148">The logged-in user's username (if authenticated).</span></span>
- <span data-ttu-id="a8c96-149">I dati aggiuntivi forniti da un' [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx).</span><span class="sxs-lookup"><span data-stu-id="a8c96-149">Any additional data provided by an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx).</span></span>

<span data-ttu-id="a8c96-150">I payload dei token anti-XSRF vengono crittografati e firmati, pertanto non è possibile visualizzare il nome utente quando si usano strumenti per esaminare i token.</span><span class="sxs-lookup"><span data-stu-id="a8c96-150">The payloads of the anti-XSRF tokens are encrypted and signed, so you can't view the username when using tools to examine the tokens.</span></span> <span data-ttu-id="a8c96-151">Quando l'applicazione web è la destinazione di ASP.NET 4.0, forniti da servizi di crittografia di [machineKey](https://msdn.microsoft.com/library/system.web.security.machinekey.encode.aspx) routine.</span><span class="sxs-lookup"><span data-stu-id="a8c96-151">When the web application is targeting ASP.NET 4.0, cryptographic services are provided by the [MachineKey.Encode](https://msdn.microsoft.com/library/system.web.security.machinekey.encode.aspx) routine.</span></span> <span data-ttu-id="a8c96-152">Quando l'applicazione web è destinato a ASP.NET 4.5 o versione successiva, crittografia servizi vengono forniti dal [machineKey. Protect](https://msdn.microsoft.com/library/system.web.security.machinekey.protect(v=vs.110)) routine, che offre migliori prestazioni, estendibilità e sicurezza.</span><span class="sxs-lookup"><span data-stu-id="a8c96-152">When the web application is targeting ASP.NET 4.5 or higher, cryptographic services are provided by the [MachineKey.Protect](https://msdn.microsoft.com/library/system.web.security.machinekey.protect(v=vs.110)) routine, which offers better performance, extensibility, and security.</span></span> <span data-ttu-id="a8c96-153">Il seguente post di blog per altri dettagli, vedere:</span><span class="sxs-lookup"><span data-stu-id="a8c96-153">See the following blog posts for more details:</span></span>

- [<span data-ttu-id="a8c96-154">Miglioramenti crittografici in ASP.NET 4.5, pt.</span><span class="sxs-lookup"><span data-stu-id="a8c96-154">Cryptographic Improvements in ASP.NET 4.5, pt.</span></span> <span data-ttu-id="a8c96-155">1</span><span class="sxs-lookup"><span data-stu-id="a8c96-155">1</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/22/cryptographic-improvements-in-asp-net-4-5-pt-1.aspx)
- [<span data-ttu-id="a8c96-156">Miglioramenti crittografici in ASP.NET 4.5, pt.</span><span class="sxs-lookup"><span data-stu-id="a8c96-156">Cryptographic Improvements in ASP.NET 4.5, pt.</span></span> <span data-ttu-id="a8c96-157">2</span><span class="sxs-lookup"><span data-stu-id="a8c96-157">2</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/23/cryptographic-improvements-in-asp-net-4-5-pt-2.aspx)
- [<span data-ttu-id="a8c96-158">Miglioramenti crittografici in ASP.NET 4.5, pt.</span><span class="sxs-lookup"><span data-stu-id="a8c96-158">Cryptographic Improvements in ASP.NET 4.5, pt.</span></span> <span data-ttu-id="a8c96-159">3</span><span class="sxs-lookup"><span data-stu-id="a8c96-159">3</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/24/cryptographic-improvements-in-asp-net-4-5-pt-3.aspx)

## <a name="generating-the-tokens"></a><span data-ttu-id="a8c96-160">Generazione di token</span><span class="sxs-lookup"><span data-stu-id="a8c96-160">Generating the tokens</span></span>

<span data-ttu-id="a8c96-161">Per generare i token anti-XSRF, chiamare il [ @Html.AntiForgeryToken ](https://msdn.microsoft.com/library/dd470175.aspx) metodo da una visualizzazione MVC o @AntiForgery.GetHtml() da una pagina Razor.</span><span class="sxs-lookup"><span data-stu-id="a8c96-161">To generate the anti-XSRF tokens, call the [@Html.AntiForgeryToken](https://msdn.microsoft.com/library/dd470175.aspx) method from an MVC view or @AntiForgery.GetHtml() from a Razor page.</span></span> <span data-ttu-id="a8c96-162">Il runtime eseguirà quindi i passaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="a8c96-162">The runtime will then perform the following steps:</span></span>

1. <span data-ttu-id="a8c96-163">Se la richiesta HTTP corrente contiene già un token di sessione di anti-XSRF (il cookie di anti-XSRF \_ \_RequestVerificationToken), il token di sicurezza verrà estratti da quest'ultimo.</span><span class="sxs-lookup"><span data-stu-id="a8c96-163">If the current HTTP request already contains an anti-XSRF session token (the anti-XSRF cookie \_\_RequestVerificationToken), the security token is extracted from it.</span></span> <span data-ttu-id="a8c96-164">Se la richiesta HTTP non contiene un token di sessione di anti-XSRF o estrazione del token di sicurezza non riesce, verrà generato un nuovo token anti-XSRF casuale.</span><span class="sxs-lookup"><span data-stu-id="a8c96-164">If the HTTP request does not contain an anti-XSRF session token or if extraction of the security token fails, a new random anti-XSRF token will be generated.</span></span>
2. <span data-ttu-id="a8c96-165">Un token di anti-XSRF campo viene generato usando il token di sicurezza dal passaggio (1) e l'identità dell'utente corrente ha eseguito l'accesso.</span><span class="sxs-lookup"><span data-stu-id="a8c96-165">An anti-XSRF field token is generated using the security token from step (1) above and the identity of the current logged-in user.</span></span> <span data-ttu-id="a8c96-166">(Per altre informazioni su come determinare l'identità dell'utente, vedere la **[scenari con un supporto speciale](#_Scenarios_with_special)** sezione riportata di seguito.) Inoltre, se un' [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/jj158328(v=vs.111).aspx) è configurato, il runtime chiama relativo [GetAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.getadditionaldata(v=vs.111).aspx) (metodo) e includere la stringa restituita nel token di campo.</span><span class="sxs-lookup"><span data-stu-id="a8c96-166">(For more information on determining user identity, see the **[Scenarios with special support](#_Scenarios_with_special)** section below.) Additionally, if an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/jj158328(v=vs.111).aspx) is configured, the runtime will call its [GetAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.getadditionaldata(v=vs.111).aspx) method and include the returned string in the field token.</span></span> <span data-ttu-id="a8c96-167">(Vedere la **[Configuration ed estendibilità](#_Configuration_and_extensibility)** sezione per altre informazioni.)</span><span class="sxs-lookup"><span data-stu-id="a8c96-167">(See the **[Configuration and extensibility](#_Configuration_and_extensibility)** section for more information.)</span></span>
3. <span data-ttu-id="a8c96-168">Se un nuovo token anti-XSRF è stato generato nel passaggio (1), un nuovo token di sessione per contenerlo verrà creato e verrà aggiunto all'insieme di cookie HTTP in uscita.</span><span class="sxs-lookup"><span data-stu-id="a8c96-168">If a new anti-XSRF token was generated in step (1), a new session token will be created to contain it and will be added to the outbound HTTP cookies collection.</span></span> <span data-ttu-id="a8c96-169">Il token del campo ottenuto nel passaggio (2) verrà eseguito in un' `<input type="hidden" />` elemento e il markup HTML sarà il valore restituito di `Html.AntiForgeryToken()` o `AntiForgery.GetHtml()`.</span><span class="sxs-lookup"><span data-stu-id="a8c96-169">The field token from step (2) will be wrapped in an `<input type="hidden" />` element, and this HTML markup will be the return value of `Html.AntiForgeryToken()` or `AntiForgery.GetHtml()`.</span></span>

## <a name="validating-the-tokens"></a><span data-ttu-id="a8c96-170">Convalida i token</span><span class="sxs-lookup"><span data-stu-id="a8c96-170">Validating the tokens</span></span>

<span data-ttu-id="a8c96-171">Per convalidare il token anti-XSRF in ingresso, lo sviluppatore include un' [ValidateAntiForgeryToken](https://msdn.microsoft.com/library/system.web.mvc.validateantiforgerytokenattribute(VS.108).aspx) attributo sul suo azione MVC o controller oppure digita `@AntiForgery.Validate()` dalla propria pagina Razor.</span><span class="sxs-lookup"><span data-stu-id="a8c96-171">To validate the incoming anti-XSRF tokens, the developer includes a [ValidateAntiForgeryToken](https://msdn.microsoft.com/library/system.web.mvc.validateantiforgerytokenattribute(VS.108).aspx) attribute on her MVC action or controller, or she calls `@AntiForgery.Validate()` from her Razor page.</span></span> <span data-ttu-id="a8c96-172">Il runtime eseguirà i passaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="a8c96-172">The runtime will perform the following steps:</span></span>

1. <span data-ttu-id="a8c96-173">Il token di sessione in ingresso e un token di campo vengono letti e il token anti-XSRF estratti da ognuna.</span><span class="sxs-lookup"><span data-stu-id="a8c96-173">The incoming session token and field token are read and the anti-XSRF token extracted from each.</span></span> <span data-ttu-id="a8c96-174">I token anti-XSRF devono essere identici per ogni passaggio (2) nella routine di generazione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-174">The anti-XSRF tokens must be identical per step (2) in the generation routine.</span></span>
2. <span data-ttu-id="a8c96-175">Se l'utente corrente è autenticato, il suo nome utente viene confrontato con il nome utente archiviato nel token di campo.</span><span class="sxs-lookup"><span data-stu-id="a8c96-175">If the current user is authenticated, her username is compared with the username stored in the field token.</span></span> <span data-ttu-id="a8c96-176">I nomi utente devono corrispondere.</span><span class="sxs-lookup"><span data-stu-id="a8c96-176">The usernames must match.</span></span>
3. <span data-ttu-id="a8c96-177">Se un' [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) configurato, il runtime chiama relativo *ValidateAdditionalData* (metodo).</span><span class="sxs-lookup"><span data-stu-id="a8c96-177">If an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) is configured, the runtime calls its *ValidateAdditionalData* method.</span></span> <span data-ttu-id="a8c96-178">Il metodo deve restituire il valore booleano *true*.</span><span class="sxs-lookup"><span data-stu-id="a8c96-178">The method must return the Boolean value *true*.</span></span>

<span data-ttu-id="a8c96-179">Se la convalida ha esito positivo, la richiesta può continuare.</span><span class="sxs-lookup"><span data-stu-id="a8c96-179">If validation succeeds, the request is allowed to proceed.</span></span> <span data-ttu-id="a8c96-180">Se la convalida non riesce, il framework genera una *HttpAntiForgeryException*.</span><span class="sxs-lookup"><span data-stu-id="a8c96-180">If validation fails, the framework will throw an *HttpAntiForgeryException*.</span></span>

## <a name="failure-conditions"></a><span data-ttu-id="a8c96-181">Condizioni di errore</span><span class="sxs-lookup"><span data-stu-id="a8c96-181">Failure conditions</span></span>

<span data-ttu-id="a8c96-182">Inizia con il Runtime di Stack Web ASP.NET v2, qualsiasi *HttpAntiForgeryException* che viene generata un'eccezione durante la convalida conterrà informazioni dettagliate sulle cause dell'errore.</span><span class="sxs-lookup"><span data-stu-id="a8c96-182">Starting with The ASP.NET Web Stack Runtime v2, any *HttpAntiForgeryException* that is thrown during validation will contain detailed information about what went wrong.</span></span> <span data-ttu-id="a8c96-183">Le condizioni di errore attualmente definiti sono:</span><span class="sxs-lookup"><span data-stu-id="a8c96-183">The currently defined failure conditions are:</span></span>

- <span data-ttu-id="a8c96-184">Il token di sessione o un token del form non è presente nella richiesta.</span><span class="sxs-lookup"><span data-stu-id="a8c96-184">The session token or form token is not present in the request.</span></span>
- <span data-ttu-id="a8c96-185">Il token di sessione o un token del form è illeggibile.</span><span class="sxs-lookup"><span data-stu-id="a8c96-185">The session token or form token is unreadable.</span></span> <span data-ttu-id="a8c96-186">La causa più probabile di questo oggetto è una farm che eseguono versioni non corrispondenti di The ASP.NET Web Stack di Runtime o in una farm in cui il &lt;machineKey&gt; in Web. config è diverso tra i computer.</span><span class="sxs-lookup"><span data-stu-id="a8c96-186">The most likely cause of this is a farm running mismatched versions of The ASP.NET Web Stack Runtime or a farm where the &lt;machineKey&gt; element in Web.config differs between machines.</span></span> <span data-ttu-id="a8c96-187">È possibile utilizzare uno strumento come Fiddler per forzare questa eccezione, la manomissione di uno dei due token anti-XSRF.</span><span class="sxs-lookup"><span data-stu-id="a8c96-187">You can use a tool such as Fiddler to force this exception by tampering with either anti-XSRF token.</span></span>
- <span data-ttu-id="a8c96-188">Il token di sessione e token pole sono stati scambiati.</span><span class="sxs-lookup"><span data-stu-id="a8c96-188">The session token and field token were swapped.</span></span>
- <span data-ttu-id="a8c96-189">Il token di sessione e token pole contengono i token di sicurezza non corrispondenti.</span><span class="sxs-lookup"><span data-stu-id="a8c96-189">The session token and field token contain mismatched security tokens.</span></span>
- <span data-ttu-id="a8c96-190">Il nome utente incorporato all'interno del token di campo non corrisponde a username ha eseguito l'accesso dell'utente corrente.</span><span class="sxs-lookup"><span data-stu-id="a8c96-190">The username embedded within the field token does not match the current logged-in user's username.</span></span>
- <span data-ttu-id="a8c96-191">Il *[IAntiForgeryAdditionalDataProvider.ValidateAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.validateadditionaldata(v=vs.111).aspx)* metodo restituito *false*.</span><span class="sxs-lookup"><span data-stu-id="a8c96-191">The *[IAntiForgeryAdditionalDataProvider.ValidateAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.validateadditionaldata(v=vs.111).aspx)* method returned *false*.</span></span>

<span data-ttu-id="a8c96-192">Le funzionalità di anti-XSRF possono anche eseguire controlli aggiuntivi durante la generazione di token o la convalida e la generazione di eccezioni possono verificarsi errori durante questi controlli.</span><span class="sxs-lookup"><span data-stu-id="a8c96-192">The anti-XSRF facilities may also perform additional checking during token generation or validation, and failures during these checks may result in exceptions being thrown.</span></span> <span data-ttu-id="a8c96-193">Vedere la [WIF / ACS / basata su attestazioni authentication](#_WIF_ACS) e **[Configuration ed estendibilità](#_Configuration_and_extensibility)** sezioni per ulteriori informazioni.</span><span class="sxs-lookup"><span data-stu-id="a8c96-193">See the [WIF / ACS / claims-based authentication](#_WIF_ACS) and **[Configuration and extensibility](#_Configuration_and_extensibility)** sections for more information.</span></span>

<a id="_Scenarios_with_special"></a>

## <a name="scenarios-with-special-support"></a><span data-ttu-id="a8c96-194">Scenari con un supporto speciale</span><span class="sxs-lookup"><span data-stu-id="a8c96-194">Scenarios with special support</span></span>

### <a name="anonymous-authentication"></a><span data-ttu-id="a8c96-195">Autenticazione anonima</span><span class="sxs-lookup"><span data-stu-id="a8c96-195">Anonymous authentication</span></span>

<span data-ttu-id="a8c96-196">Il sistema di anti-XSRF contiene un supporto speciale per gli utenti anonimi, dove "anonymous" è definito come un utente in cui il *IIdentity* restituisce proprietà *false*.</span><span class="sxs-lookup"><span data-stu-id="a8c96-196">The anti-XSRF system contains special support for anonymous users, where "anonymous" is defined as a user where the *IIdentity.IsAuthenticated* property returns *false*.</span></span> <span data-ttu-id="a8c96-197">Gli scenari includono la protezione XSRF alla pagina di accesso (prima che l'utente viene autenticato) e gli schemi di autenticazione personalizzata in cui l'applicazione usa un meccanismo diverso da *IIdentity* per identificare gli utenti.</span><span class="sxs-lookup"><span data-stu-id="a8c96-197">Scenarios include providing XSRF protection to the login page (before the user is authenticated) and custom authentication schemes where the application uses a mechanism other than *IIdentity* to identify users.</span></span>

<span data-ttu-id="a8c96-198">Per supportare questi scenari, è importante ricordare che i token di sessione e campo vengono uniti mediante un token di sicurezza, ovvero un identificatore opaco a 128 bit generato in modo casuale.</span><span class="sxs-lookup"><span data-stu-id="a8c96-198">To support these scenarios, recall that the session and field tokens are joined by a security token, which is a 128-bit randomly-generated opaque identifier.</span></span> <span data-ttu-id="a8c96-199">Questo token di sicurezza viene usato per tenere traccia della sessione di un singolo utente come Anna passa il sito, in modo che svolge in modo efficace la funzione di un identificatore anonimo.</span><span class="sxs-lookup"><span data-stu-id="a8c96-199">This security token is used to track an individual user's session as she navigates the site, so it effectively serves the purpose of an anonymous identifier.</span></span> <span data-ttu-id="a8c96-200">Una stringa vuota viene usata al posto del nome utente per le routine di convalida e generazione descritte in precedenza.</span><span class="sxs-lookup"><span data-stu-id="a8c96-200">An empty string is used in place of the username for the generation and validation routines described above.</span></span>

<a id="_WIF_ACS"></a>

### <a name="wif--acs--claims-based-authentication"></a><span data-ttu-id="a8c96-201">WIF / ACS / basata su attestazioni autenticazione</span><span class="sxs-lookup"><span data-stu-id="a8c96-201">WIF / ACS / claims-based authentication</span></span>

<span data-ttu-id="a8c96-202">In genere, il *IIdentity* classi incorporate .NET Framework dispongono della proprietà che *IIdentity.Name* è sufficiente per identificare in modo univoco un utente specifico all'interno di una determinata applicazione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-202">Normally, the *IIdentity* classes built in to the .NET Framework have the property that *IIdentity.Name* is sufficient to uniquely identify a particular user within a particular application.</span></span> <span data-ttu-id="a8c96-203">Ad esempio, *FormsIdentity.Name* restituisce il nome utente archiviato nel database delle appartenenze (che è univoco per tutte le applicazioni a seconda di quel database), *WindowsIdentity.Name* restituisce il identità di dominio completo dell'utente e così via.</span><span class="sxs-lookup"><span data-stu-id="a8c96-203">For example, *FormsIdentity.Name* returns the username stored in the membership database (which is unique for all applications depending on that database), *WindowsIdentity.Name* returns the domain-qualified identity of the user, and so on.</span></span> <span data-ttu-id="a8c96-204">Questi sistemi forniscono non solo l'autenticazione. sono inoltre *identificare* agli utenti di un'applicazione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-204">These systems provide not only authentication; they also *identify* users to an application.</span></span>

<span data-ttu-id="a8c96-205">L'autenticazione basata su attestazioni, d'altra parte, non necessariamente richiedono l'identificazione di un determinato utente.</span><span class="sxs-lookup"><span data-stu-id="a8c96-205">Claims-based authentication, on the other hand, does not necessarily require identifying a particular user.</span></span> <span data-ttu-id="a8c96-206">Al contrario, il *ClaimsPrincipal* e *ClaimsIdentity* tipi sono associati a un set di *attestazione* istanze, in cui le singole attestazioni potrebbero essere "is 18 anni di età" o " è un amministratore"in un account.</span><span class="sxs-lookup"><span data-stu-id="a8c96-206">Instead, the *ClaimsPrincipal* and *ClaimsIdentity* types are associated with a set of *Claim* instances, where the individual claims might be "is 18+ years of age" or "is an administrator" to anything else.</span></span> <span data-ttu-id="a8c96-207">Poiché l'utente non ha necessariamente stato identificato, il runtime non è possibile usare la *ClaimsIdentity.Name* proprietà come un identificatore univoco per questo utente specifico.</span><span class="sxs-lookup"><span data-stu-id="a8c96-207">Since the user hasn't necessarily been identified, the runtime cannot use the *ClaimsIdentity.Name* property as a unique identifier for this particular user.</span></span> <span data-ttu-id="a8c96-208">Il team ha riscontrato esempi reali in cui *ClaimsIdentity.Name* restituisce *null*, restituisce un nome descrittivo (display) o in caso contrario, restituisce una stringa che non è appropriata per l'utilizzo come un identificatore univoco per l'utente.</span><span class="sxs-lookup"><span data-stu-id="a8c96-208">The team has seen real-world examples where *ClaimsIdentity.Name* returns *null*, returns a friendly (display) name, or otherwise returns a string that isn't appropriate for use as a unique identifier for the user.</span></span>

<span data-ttu-id="a8c96-209">Molte delle distribuzioni che usano l'autenticazione basata su attestazioni usano [Azure Access Control Service](https://msdn.microsoft.com/library/windowsazure/gg429786.aspx) (ACS) in particolare.</span><span class="sxs-lookup"><span data-stu-id="a8c96-209">Many of deployments which use claims-based authentication are using [Azure Access Control Service](https://msdn.microsoft.com/library/windowsazure/gg429786.aspx) (ACS) in particular.</span></span> <span data-ttu-id="a8c96-210">Servizio contenitore di AZURE consente allo sviluppatore di configurare singole *provider di identità* (ad esempio ad FS, il provider di Account Microsoft, OpenID provider, ad esempio Yahoo!, e così via), e restituiscono i provider di identità *denominare gli identificatori*.</span><span class="sxs-lookup"><span data-stu-id="a8c96-210">ACS allows the developer to configure individual *identity providers* (such as ADFS, the Microsoft Account provider, OpenID providers like Yahoo!, etc.), and the identity providers return *name identifiers*.</span></span> <span data-ttu-id="a8c96-211">Questi identificatori del nome possono contenere informazioni identificabili personalmente (PII), ad esempio un indirizzo di posta elettronica o potrebbe essere resi anonimi, ad esempio una personale privato identificatore (PPID).</span><span class="sxs-lookup"><span data-stu-id="a8c96-211">These name identifiers may contain Personally Identifiable Information (PII) like an email address, or they could be anonymized like a Private Personal Identifier (PPID).</span></span> <span data-ttu-id="a8c96-212">Indipendentemente da ciò, la tupla (provider di identità, identificatore nome) sufficientemente funge da un token di rilevamento appropriato per un determinato utente mentre Anna durante l'esplorazione del sito, in modo che il Runtime di ASP.NET Web Stack può utilizzare la tupla al posto del nome utente durante la generazione e la convalida dei token di campo anti-XSRF.</span><span class="sxs-lookup"><span data-stu-id="a8c96-212">Regardless, the tuple (identity provider, name identifier) sufficiently serves as an appropriate tracking token for a particular user while she is browsing the site, so the ASP.NET Web Stack Runtime can use the tuple in place of the username when generating and validating anti-XSRF field tokens.</span></span> <span data-ttu-id="a8c96-213">Gli URI specifico per il provider di identità e l'identificatore del nome sono:</span><span class="sxs-lookup"><span data-stu-id="a8c96-213">The particular URIs for the identity provider and the name identifier are :</span></span>

- `http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider`
- `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier`

<span data-ttu-id="a8c96-214">(vedere questo [pagina di documentazione di ACS](https://msdn.microsoft.com/library/windowsazure/gg185971.aspx) per altre informazioni.)</span><span class="sxs-lookup"><span data-stu-id="a8c96-214">(see this [ACS doc page](https://msdn.microsoft.com/library/windowsazure/gg185971.aspx) for more info.)</span></span>

<span data-ttu-id="a8c96-215">Durante la generazione o la convalida un token, il Runtime di ASP.NET Web Stack in fase di runtime tenterà di associazione ai tipi:</span><span class="sxs-lookup"><span data-stu-id="a8c96-215">When generating or validating a token, the ASP.NET Web Stack Runtime will at runtime try binding to the types:</span></span>

- `Microsoft.IdentityModel.Claims.IClaimsIdentity, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35` <span data-ttu-id="a8c96-216">(Per il SDK WIF.)</span><span class="sxs-lookup"><span data-stu-id="a8c96-216">(For the WIF SDK.)</span></span>
- `System.Security.Claims.ClaimsIdentity` <span data-ttu-id="a8c96-217">(Per .NET 4.5).</span><span class="sxs-lookup"><span data-stu-id="a8c96-217">(For .NET 4.5).</span></span>

<span data-ttu-id="a8c96-218">In presenza di questi tipi e se l'utente corrente *IIIIdentity* implementa o alle sottoclassi uno di questi tipi, la funzionalità di anti-XSRF userà (provider di identità, identificatore nome) tuple anziché il nome utente durante la generazione e convalida i token.</span><span class="sxs-lookup"><span data-stu-id="a8c96-218">If these types exist, and if the current user's *IIIIdentity* implements or subclasses one of these types, the anti-XSRF facility will use the (identity provider, name identifier) tuple in place of the username when generating and validating the tokens.</span></span> <span data-ttu-id="a8c96-219">Se non è presente alcun tale tupla, la richiesta avrà esito negativo con un errore che descrive allo sviluppatore di come configurare il sistema di anti-XSRF per comprendere il meccanismo di autenticazione basata sulle attestazioni specifico in uso.</span><span class="sxs-lookup"><span data-stu-id="a8c96-219">If no such tuple is present, the request will fail with an error describing to the developer how to configure the anti-XSRF system to understand the particular claims-based authentication mechanism in use.</span></span> <span data-ttu-id="a8c96-220">Vedere le **[Configuration ed estendibilità](#_Configuration_and_extensibility)** sezione per altre informazioni.</span><span class="sxs-lookup"><span data-stu-id="a8c96-220">See the **[Configuration and extensibility](#_Configuration_and_extensibility)** section for more information.</span></span>

### <a name="oauth--openid-authentication"></a><span data-ttu-id="a8c96-221">OAuth / OpenID autenticazione</span><span class="sxs-lookup"><span data-stu-id="a8c96-221">OAuth / OpenID authentication</span></span>

<span data-ttu-id="a8c96-222">Infine, la funzionalità di anti-XSRF include uno speciale supporto per le applicazioni che usano l'autenticazione OAuth o OpenID.</span><span class="sxs-lookup"><span data-stu-id="a8c96-222">Finally, the anti-XSRF facility has special support for applications which use OAuth or OpenID authentication.</span></span> <span data-ttu-id="a8c96-223">Questo supporto è basato sull'approccio euristico: se l'oggetto corrente *IIdentity.Name* inizi con http:// o https://, quindi i confronti di nome utente verranno eseguiti usando un operatore di confronto ordinale anziché l'operatore di confronto OrdinalIgnoreCase.</span><span class="sxs-lookup"><span data-stu-id="a8c96-223">This support is heuristic-based: if the current *IIdentity.Name* begins with http:// or https://, then username comparisons will be done using an Ordinal comparer rather than the default OrdinalIgnoreCase comparer.</span></span>

<a id="_Configuration_and_extensibility"></a>

## <a name="configuration-and-extensibility"></a><span data-ttu-id="a8c96-224">Configurazione ed estendibilità</span><span class="sxs-lookup"><span data-stu-id="a8c96-224">Configuration and extensibility</span></span>

<span data-ttu-id="a8c96-225">In alcuni casi, gli sviluppatori potrebbe essere necessario un controllo sulla generazione di anti-XSRF e i comportamenti di convalida.</span><span class="sxs-lookup"><span data-stu-id="a8c96-225">Occasionally, developers may want tighter control over the anti-XSRF generation and validation behaviors.</span></span> <span data-ttu-id="a8c96-226">Ad esempio, il comportamento predefinito degli helper MVC e pagine Web di aggiungendo automaticamente i cookie HTTP alla risposta è probabilmente indesiderato e lo sviluppatore può essere utile rendere persistenti i token in un' posizione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-226">For example, perhaps the MVC and Web Pages helpers' default behavior of automatically adding HTTP cookies to the response is undesirable, and the developer may wish to persist the tokens elsewhere.</span></span> <span data-ttu-id="a8c96-227">Esistono due API per agevolare questo:</span><span class="sxs-lookup"><span data-stu-id="a8c96-227">There exist two APIs to assist with this:</span></span>

`AntiForgery.GetTokens(string oldCookieToken, out string newCookieToken, out string formToken);`  
`AntiForgery.Validate(string cookieToken, string formToken);`

<span data-ttu-id="a8c96-228">Il *GetTokens* metodo accetta come input un XSRF richiesta verifica sessione token esistente (che può essere null) e produce come output un nuovo token della sessione verifica XSRF richiesta e token pole.</span><span class="sxs-lookup"><span data-stu-id="a8c96-228">The *GetTokens* method takes as input an existing XSRF request verification session token (which may be null) and produces as output a new XSRF request verification session token and field token.</span></span> <span data-ttu-id="a8c96-229">I token sono stringhe opache semplicemente senza decorazioni; il *formToken* valore, ad esempio non verrà racchiusi un &lt;input&gt; tag.</span><span class="sxs-lookup"><span data-stu-id="a8c96-229">The tokens are simply opaque strings with no decoration; the *formToken* value will for instance not be wrapped in an &lt;input&gt; tag.</span></span> <span data-ttu-id="a8c96-230">Il *newCookieToken* valore può essere null; in tal caso, il *oldCookieToken* valore sia ancora valido e nessun nuovo cookie di risposta debba essere impostata.</span><span class="sxs-lookup"><span data-stu-id="a8c96-230">The *newCookieToken* value may be null; if this occurs, then the *oldCookieToken* value is still valid and no new response cookie need be set.</span></span> <span data-ttu-id="a8c96-231">Il chiamante *GetTokens* è responsabile della persistenza di tutti i cookie di risposta necessarie o la generazione di alcun markup necessarie; le *GetTokens* metodo di stesso non modificherà la risposta come un effetto collaterale.</span><span class="sxs-lookup"><span data-stu-id="a8c96-231">The caller of *GetTokens* is responsible for persisting any necessary response cookies or generating any necessary markup; the *GetTokens* method itself will not alter the response as a side effect.</span></span> <span data-ttu-id="a8c96-232">Il *Validate* metodo accetta la sessione in ingresso e campo dei token e si esegue la logica di convalida menzionati in precedenza su di essi.</span><span class="sxs-lookup"><span data-stu-id="a8c96-232">The *Validate* method takes the incoming session and field tokens and runs the aforementioned validation logic over them.</span></span>

### <a name="antiforgeryconfig"></a><span data-ttu-id="a8c96-233">AntiForgeryConfig</span><span class="sxs-lookup"><span data-stu-id="a8c96-233">AntiForgeryConfig</span></span>

<span data-ttu-id="a8c96-234">Lo sviluppatore può configurare il sistema di anti-XSRF dall'applicazione\_Start.</span><span class="sxs-lookup"><span data-stu-id="a8c96-234">The developer may configure the anti-XSRF system from Application\_Start.</span></span> <span data-ttu-id="a8c96-235">La configurazione è a livello di codice.</span><span class="sxs-lookup"><span data-stu-id="a8c96-235">Configuration is programmatic.</span></span> <span data-ttu-id="a8c96-236">Le proprietà di statica *AntiForgeryConfig* tipo sono descritti di seguito.</span><span class="sxs-lookup"><span data-stu-id="a8c96-236">The properties of the static *AntiForgeryConfig* type are described below.</span></span> <span data-ttu-id="a8c96-237">La maggior parte degli utenti che usano attestazioni saranno possibile impostare la proprietà UniqueClaimTypeIdentifier.</span><span class="sxs-lookup"><span data-stu-id="a8c96-237">Most users using claims will want to set the UniqueClaimTypeIdentifier property.</span></span>

| **<span data-ttu-id="a8c96-238">Proprietà</span><span class="sxs-lookup"><span data-stu-id="a8c96-238">Property</span></span>** | **<span data-ttu-id="a8c96-239">Descrizione</span><span class="sxs-lookup"><span data-stu-id="a8c96-239">Description</span></span>** |
| --- | --- |
| **<span data-ttu-id="a8c96-240">AdditionalDataProvider</span><span class="sxs-lookup"><span data-stu-id="a8c96-240">AdditionalDataProvider</span></span>** | <span data-ttu-id="a8c96-241">Un' [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) che fornisce dati aggiuntivi durante la generazione di token e utilizza i dati aggiuntivi durante la convalida del token.</span><span class="sxs-lookup"><span data-stu-id="a8c96-241">An [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) that provides additional data during token generation and consumes additional data during token validation.</span></span> <span data-ttu-id="a8c96-242">Il valore predefinito è *null*.</span><span class="sxs-lookup"><span data-stu-id="a8c96-242">The default value is *null*.</span></span> <span data-ttu-id="a8c96-243">Per altre informazioni, vedere la [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) sezione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-243">For more information, see the [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) section.</span></span> |
| **<span data-ttu-id="a8c96-244">CookieName</span><span class="sxs-lookup"><span data-stu-id="a8c96-244">CookieName</span></span>** | <span data-ttu-id="a8c96-245">Stringa che specifica il nome del cookie HTTP a cui viene usato per archiviare il token di sessione di anti-XSRF.</span><span class="sxs-lookup"><span data-stu-id="a8c96-245">A string that provides the name of the HTTP cookie that is used to store the anti-XSRF session token.</span></span> <span data-ttu-id="a8c96-246">Se questo valore non è impostato, verrà generato un nome da automaticamente in base al percorso virtuale distribuito dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-246">If this value is not set, a name will be automatically generated based on the application's deployed virtual path.</span></span> <span data-ttu-id="a8c96-247">Il valore predefinito è *null*.</span><span class="sxs-lookup"><span data-stu-id="a8c96-247">The default value is *null*.</span></span> |
| **<span data-ttu-id="a8c96-248">RequireSsl</span><span class="sxs-lookup"><span data-stu-id="a8c96-248">RequireSsl</span></span>** | <span data-ttu-id="a8c96-249">Valore booleano che determina se il token anti-XSRF sono necessarie da inviare tramite un canale protetto con SSL.</span><span class="sxs-lookup"><span data-stu-id="a8c96-249">A Boolean that dictates whether the anti-XSRF tokens are required to be submitted over an SSL-secured channel.</span></span> <span data-ttu-id="a8c96-250">Se questo valore è *true*, qualsiasi cookie generato automaticamente verranno impostato il flag "secure" e le API di anti-XSRF genererà se chiamato dall'interno di una richiesta che non viene inviata tramite SSL.</span><span class="sxs-lookup"><span data-stu-id="a8c96-250">If this value is *true*, any automatically-generated cookies will have the "secure" flag set, and the anti-XSRF APIs will throw if called from within a request that is not submitted via SSL.</span></span> <span data-ttu-id="a8c96-251">Il valore predefinito è *false*.</span><span class="sxs-lookup"><span data-stu-id="a8c96-251">The default value is *false*.</span></span> |
| **<span data-ttu-id="a8c96-252">SuppressIdentityHeuristicChecks</span><span class="sxs-lookup"><span data-stu-id="a8c96-252">SuppressIdentityHeuristicChecks</span></span>** | <span data-ttu-id="a8c96-253">Valore booleano che determina se il sistema di anti-XSRF verrà disattivato il supporto per identità basate sulle attestazioni.</span><span class="sxs-lookup"><span data-stu-id="a8c96-253">A Boolean that dictates whether the anti-XSRF system should deactivate its support for claims-based identities.</span></span> <span data-ttu-id="a8c96-254">Se questo valore è *true*, il sistema presupporrà che *IIdentity.Name* può essere usata come identificatore utente univoco e non proverà a caso speciale *IClaimsIdentity*oppure *ClClaimsIdentity* come descritto nel [WIF / ACS / basata su attestazioni autenticazione](#_WIF_ACS) sezione.</span><span class="sxs-lookup"><span data-stu-id="a8c96-254">If this value is *true*, the system will assume that *IIdentity.Name* is appropriate for use as a unique per-user identifier and will not try to special-case *IClaimsIdentity* or *ClClaimsIdentity* as described in the [WIF / ACS / claims-based authentication](#_WIF_ACS) section.</span></span> <span data-ttu-id="a8c96-255">Il valore predefinito è `false`.</span><span class="sxs-lookup"><span data-stu-id="a8c96-255">The default value is `false`.</span></span> |
| **<span data-ttu-id="a8c96-256">UniqueClaimTypeIdentifier</span><span class="sxs-lookup"><span data-stu-id="a8c96-256">UniqueClaimTypeIdentifier</span></span>** | <span data-ttu-id="a8c96-257">Una stringa che indica il tipo di attestazione che può essere usata come identificatore univoco per ogni utente.</span><span class="sxs-lookup"><span data-stu-id="a8c96-257">A string that indicates which claim type is appropriate for use as a unique per-user identifier.</span></span> <span data-ttu-id="a8c96-258">Se questo valore viene impostato e l'oggetto corrente *IIdentity* basata sulle attestazioni, il sistema tenterà di estrarre un'attestazione del tipo specificata da *UniqueClaimTypeIdentifier*, e verrà usato il valore corrispondente al posto di nome utente dell'utente durante la generazione del token di campo.</span><span class="sxs-lookup"><span data-stu-id="a8c96-258">If this value is set and the current *IIdentity* is claims-based, the system will attempt to extract a claim of the type specified by *UniqueClaimTypeIdentifier*, and the corresponding value will be used in place of the user's username when generating the field token.</span></span> <span data-ttu-id="a8c96-259">Se il tipo di attestazione non viene trovato, il sistema avrà esito negativo della richiesta.</span><span class="sxs-lookup"><span data-stu-id="a8c96-259">If the claim type is not found, the system will fail the request.</span></span> <span data-ttu-id="a8c96-260">Il valore predefinito è *null*, che indica che il sistema deve utilizzare (provider di identità, identificatore nome) tupla come descritto in precedenza al posto di nome utente dell'utente.</span><span class="sxs-lookup"><span data-stu-id="a8c96-260">The default value is *null*, which indicates that the system should use the (identity provider, name identifier) tuple as previously described in place of the user's username.</span></span> |

<a id="_IAntiForgeryAdditionalDataProvider"></a>

### <a name="iantiforgeryadditionaldataprovider"></a><span data-ttu-id="a8c96-261">IAntiForgeryAdditionalDataProvider</span><span class="sxs-lookup"><span data-stu-id="a8c96-261">IAntiForgeryAdditionalDataProvider</span></span>

<span data-ttu-id="a8c96-262">Il *[IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx)* tipo consente agli sviluppatori di estendere il comportamento del sistema anti-XSRF, i dati aggiuntivi di andata e ritorno in ogni token.</span><span class="sxs-lookup"><span data-stu-id="a8c96-262">The *[IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx)* type allows developers to extend the behavior of the anti-XSRF system by round-tripping additional data in each token.</span></span> <span data-ttu-id="a8c96-263">Il *GetAdditionalData* viene chiamato ogni volta che viene generato un token di campo e il valore restituito è incorporato all'interno del token generato.</span><span class="sxs-lookup"><span data-stu-id="a8c96-263">The *GetAdditionalData* method is called each time a field token is generated, and the return value is embedded within the generated token.</span></span> <span data-ttu-id="a8c96-264">Un implementatore potrebbe restituire un timestamp, un parametro nonce o qualsiasi altro valore che Anna vuole che da questo metodo.</span><span class="sxs-lookup"><span data-stu-id="a8c96-264">An implementer could return a timestamp, a nonce, or any other value she wishes from this method.</span></span>

<span data-ttu-id="a8c96-265">Analogamente, il *ValidateAdditionalData* viene chiamato ogni volta che viene convalidato un token di campo e la stringa "dati aggiuntivi" che è stata incorporata all'interno del token viene passata al metodo.</span><span class="sxs-lookup"><span data-stu-id="a8c96-265">Similarly, the *ValidateAdditionalData* method is called each time a field token is validated, and the "additional data" string that was embedded within the token is passed to the method.</span></span> <span data-ttu-id="a8c96-266">La routine di convalida è stato possibile implementare un timeout (controllando l'ora corrente con l'ora in cui è stato archiviato quando è stato creato il token), un controllo della routine o qualsiasi altro parametro nonce desiderate per la logica.</span><span class="sxs-lookup"><span data-stu-id="a8c96-266">The validation routine could implement a timeout (by checking the current time against the time that was stored when the token was created), a nonce checking routine, or any other desired logic.</span></span>

## <a name="design-decisions-and-security-considerations"></a><span data-ttu-id="a8c96-267">Decisioni di progettazione e considerazioni sulla sicurezza</span><span class="sxs-lookup"><span data-stu-id="a8c96-267">Design decisions and security considerations</span></span>

<span data-ttu-id="a8c96-268">Il token di sicurezza che collega i token di sessione e il campo è tecnicamente necessario solo quando si tenta di proteggere gli utenti anonimi o autenticati da attacchi XSRF.</span><span class="sxs-lookup"><span data-stu-id="a8c96-268">The security token that links the session and field tokens is technically only necessary when trying to protect anonymous / unauthenticated users against XSRF attacks.</span></span> <span data-ttu-id="a8c96-269">Quando l'utente è autenticato, il token di autenticazione stesso (presumibilmente inviati sotto forma di cookie) può essere utilizzato come una coppia di metà di una sincronizzazione del token.</span><span class="sxs-lookup"><span data-stu-id="a8c96-269">When the user is authenticated, the authentication token itself (presumably submitted in the form of a cookie) could be used as one half of a synchronizer token pair.</span></span> <span data-ttu-id="a8c96-270">Tuttavia, esistono scenari validi per la protezione delle pagine di accesso, l'hit testing, gli utenti non autenticati e la logica di anti-XSRF è stata resa più semplice da sempre la generazione e la convalida del token di sicurezza, anche per gli utenti autenticati.</span><span class="sxs-lookup"><span data-stu-id="a8c96-270">However, there are valid scenarios for protecting login pages hit by unauthenticated users, and the anti-XSRF logic was made simpler by always generating and validating the security token, even for authenticated users.</span></span> <span data-ttu-id="a8c96-271">È inoltre fornire un livello di protezione aggiuntiva nel caso in cui un token di campo viene danneggiato da un utente malintenzionato, come l'impostazione o un'ipotesi che il token di sessione sarebbe un altro ostacolo per l'utente malintenzionato superare.</span><span class="sxs-lookup"><span data-stu-id="a8c96-271">It also does provide some additional protection in the event that a field token is ever compromised by an attacker, as setting or guessing the session token would be another hurdle for the attacker to overcome.</span></span>

<span data-ttu-id="a8c96-272">Gli sviluppatori devono prestare attenzione quando più applicazioni sono ospitate in un singolo dominio.</span><span class="sxs-lookup"><span data-stu-id="a8c96-272">Developers should use caution when multiple applications are hosted in a single domain.</span></span> <span data-ttu-id="a8c96-273">Ad esempio, anche se *example1.cloudapp.net* e *example2.cloudapp.net* sono diversi host, c'è una relazione di trust implicita tra tutti gli host sotto il  *\*. cloudapp.net* dominio.</span><span class="sxs-lookup"><span data-stu-id="a8c96-273">For example, even though *example1.cloudapp.net* and *example2.cloudapp.net* are different hosts, there is an implicit trust relationship between all hosts under the *\*.cloudapp.net* domain.</span></span> <span data-ttu-id="a8c96-274">Questa relazione di trust implicita [consente agli host potenzialmente non attendibili a hanno effetto sui cookie reciproci](http://stackoverflow.com/questions/9636857/how-can-asp-net-or-asp-net-mvc-be-protected-from-related-domain-cookie-attacks) (lo stessa origine che regolano le richieste AJAX non vengono necessariamente applicati criteri per i cookie HTTP).</span><span class="sxs-lookup"><span data-stu-id="a8c96-274">This implicit trust relationship [allows potentially untrusted hosts to affect each other's cookies](http://stackoverflow.com/questions/9636857/how-can-asp-net-or-asp-net-mvc-be-protected-from-related-domain-cookie-attacks) (the same-origin policies that govern AJAX requests do not necessarily apply to HTTP cookies).</span></span> <span data-ttu-id="a8c96-275">Il Runtime di ASP.NET Web Stack fornisce alcuni mitigazione in quanto il nome utente viene incorporato nel token di campo, in modo che anche se un sottodominio dannoso è in grado di sovrascrivere un token di sessione non sarà in grado di generare un token di campo valido per l'utente.</span><span class="sxs-lookup"><span data-stu-id="a8c96-275">The ASP.NET Web Stack Runtime provides some mitigation in that the username is embedded into the field token, so even if a malicious subdomain is able to overwrite a session token it will be unable to generate a valid field token for the user.</span></span> <span data-ttu-id="a8c96-276">Tuttavia, quando ospitati in tale ambiente le routine incorporato anti-XSRF ancora non è possibile difendersi dal Hijack della sessione o account di accesso XSRF.</span><span class="sxs-lookup"><span data-stu-id="a8c96-276">However, when hosted in such an environment the built-in anti-XSRF routines still cannot defend against session hijacking or login XSRF.</span></span>

<span data-ttu-id="a8c96-277">Le routine di anti-XSRF attualmente non difendersi [clickjacking](https://www.owasp.org/index.php/Clickjacking).</span><span class="sxs-lookup"><span data-stu-id="a8c96-277">The anti-XSRF routines currently do not defend against [clickjacking](https://www.owasp.org/index.php/Clickjacking).</span></span> <span data-ttu-id="a8c96-278">Le applicazioni che intendo a difendersi contro il clickjacking possono farlo facilmente tramite l'invio di un X-Frame-Options: Intestazione SAMEORIGIN con ogni risposta.</span><span class="sxs-lookup"><span data-stu-id="a8c96-278">Applications that wish to defend themselves against clickjacking may easily do so by sending an X-Frame-Options: SAMEORIGIN header with each response.</span></span> <span data-ttu-id="a8c96-279">Questa intestazione è supportata da tutti i browser recenti.</span><span class="sxs-lookup"><span data-stu-id="a8c96-279">This header is supported by all recent browsers.</span></span> <span data-ttu-id="a8c96-280">Per altre informazioni, vedere la [blog di IE](https://blogs.msdn.com/b/ieinternals/archive/2010/03/30/combating-clickjacking-with-x-frame-options.aspx), il [blog SDL](https://blogs.msdn.com/b/sdl/archive/2009/02/05/clickjacking-defense-in-ie8.aspx), e [OWASP](https://www.owasp.org/index.php/Clickjacking).</span><span class="sxs-lookup"><span data-stu-id="a8c96-280">For more information, see the [IE blog](https://blogs.msdn.com/b/ieinternals/archive/2010/03/30/combating-clickjacking-with-x-frame-options.aspx), the [SDL blog](https://blogs.msdn.com/b/sdl/archive/2009/02/05/clickjacking-defense-in-ie8.aspx), and [OWASP](https://www.owasp.org/index.php/Clickjacking).</span></span> <span data-ttu-id="a8c96-281">Il Runtime di ASP.NET Web Stack può in alcuni assicurarsi delle prossime versioni MVC e gli helper di anti-XSRF pagine Web questa intestazione viene impostata automaticamente in modo che le applicazioni vengano protetti automaticamente da questi attacchi.</span><span class="sxs-lookup"><span data-stu-id="a8c96-281">The ASP.NET Web Stack Runtime may in some future release make the MVC and Web Pages anti-XSRF helpers automatically set this header so that applications are automatically protected against this attack.</span></span>

<span data-ttu-id="a8c96-282">Gli sviluppatori Web devono continuare ad assicurarsi che il sito non sia vulnerabile ad attacchi XSS.</span><span class="sxs-lookup"><span data-stu-id="a8c96-282">Web developers should continue to ensure that their site is not vulnerable to XSS attacks.</span></span> <span data-ttu-id="a8c96-283">Gli attacchi XSS sono molto potenti, e se l'attacco riesce anche interromperebbe il Runtime di ASP.NET Web Stack difese contro gli attacchi XSRF.</span><span class="sxs-lookup"><span data-stu-id="a8c96-283">XSS attacks are very powerful, and a successful exploit would also break the ASP.NET Web Stack Runtime defenses against XSRF attacks.</span></span>

## <a name="acknowledgment"></a><span data-ttu-id="a8c96-284">Riconoscimento</span><span class="sxs-lookup"><span data-stu-id="a8c96-284">Acknowledgment</span></span>

<span data-ttu-id="a8c96-285">[@LeviBroderick](https://twitter.com/LeviBroderick), che ha scritto gran parte del codice di protezione ASP.NET la maggior parte di queste informazioni.</span><span class="sxs-lookup"><span data-stu-id="a8c96-285">[@LeviBroderick](https://twitter.com/LeviBroderick), who wrote much of the ASP.NET security code the bulk of this information.</span></span>
