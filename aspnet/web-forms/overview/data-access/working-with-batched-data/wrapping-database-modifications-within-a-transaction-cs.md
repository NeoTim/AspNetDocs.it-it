---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: Wrapping delle modifiche al database all'internoC#di una transazione () | Microsoft Docs
author: rick-anderson
description: Questa esercitazione è la prima di quattro che esamina l'aggiornamento, l'eliminazione e l'inserimento di batch di dati. In questa esercitazione si apprenderà come consentire le transazioni del database...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: da69e466a5b506b869dc8fc0624f3e6a479199a8
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 11/28/2019
ms.locfileid: "74624641"
---
# <a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="3f41e-104">Wrapping delle modifiche al database in una transazione (C#)</span><span class="sxs-lookup"><span data-stu-id="3f41e-104">Wrapping Database Modifications within a Transaction (C#)</span></span>

<span data-ttu-id="3f41e-105">di [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="3f41e-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="3f41e-106">[Scarica codice](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) o [Scarica PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="3f41e-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="3f41e-107">Questa esercitazione è la prima di quattro che esamina l'aggiornamento, l'eliminazione e l'inserimento di batch di dati.</span><span class="sxs-lookup"><span data-stu-id="3f41e-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="3f41e-108">In questa esercitazione si apprenderà come le transazioni del database consentano di eseguire le modifiche batch come operazione atomica, che garantisce che tutti i passaggi abbiano esito positivo o che tutti i passaggi abbiano esito negativo.</span><span class="sxs-lookup"><span data-stu-id="3f41e-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>

## <a name="introduction"></a><span data-ttu-id="3f41e-109">Introduzione</span><span class="sxs-lookup"><span data-stu-id="3f41e-109">Introduction</span></span>

<span data-ttu-id="3f41e-110">Come è stato illustrato a partire da [una panoramica dell'esercitazione sull'inserimento, l'aggiornamento e l'eliminazione dei dati](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) , GridView fornisce supporto incorporato per la modifica e l'eliminazione a livello di riga.</span><span class="sxs-lookup"><span data-stu-id="3f41e-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="3f41e-111">Con pochi clic del mouse è possibile creare un'interfaccia di modifica dei dati avanzata senza scrivere una riga di codice, a condizione che il contenuto venga modificato ed eliminato in base alle singole righe.</span><span class="sxs-lookup"><span data-stu-id="3f41e-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="3f41e-112">Tuttavia, in alcuni scenari questa operazione non è sufficiente ed è necessario fornire agli utenti la possibilità di modificare o eliminare un batch di record.</span><span class="sxs-lookup"><span data-stu-id="3f41e-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="3f41e-113">Per la maggior parte dei client di posta elettronica basati sul Web, ad esempio, viene utilizzata una griglia per elencare ogni messaggio in cui ogni riga include una casella di controllo con le informazioni relative al messaggio di posta elettronica (oggetto, mittente e così via).</span><span class="sxs-lookup"><span data-stu-id="3f41e-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="3f41e-114">Questa interfaccia consente all'utente di eliminare più messaggi controllando questi ultimi e facendo clic sul pulsante Elimina messaggi selezionati.</span><span class="sxs-lookup"><span data-stu-id="3f41e-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="3f41e-115">Un'interfaccia di modifica batch è ideale nelle situazioni in cui gli utenti modificano in genere molti record diversi.</span><span class="sxs-lookup"><span data-stu-id="3f41e-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="3f41e-116">Anziché forzare l'utente a fare clic su modifica, apportare le modifiche e quindi fare clic su Aggiorna per ogni record che deve essere modificato, un'interfaccia di modifica batch esegue il rendering di ogni riga con la relativa interfaccia di modifica.</span><span class="sxs-lookup"><span data-stu-id="3f41e-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="3f41e-117">L'utente può modificare rapidamente il set di righe che devono essere modificate, quindi salvare le modifiche facendo clic su un pulsante Aggiorna tutto.</span><span class="sxs-lookup"><span data-stu-id="3f41e-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="3f41e-118">In questo set di esercitazioni si esaminerà come creare interfacce per l'inserimento, la modifica e l'eliminazione di batch di dati.</span><span class="sxs-lookup"><span data-stu-id="3f41e-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="3f41e-119">Quando si eseguono operazioni batch, è importante stabilire se è necessario che alcune delle operazioni nel batch abbiano esito positivo mentre altre hanno esito negativo.</span><span class="sxs-lookup"><span data-stu-id="3f41e-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="3f41e-120">Si consideri un'interfaccia di eliminazione batch: cosa dovrebbe accadere se il primo record selezionato viene eliminato correttamente, ma il secondo errore, ad esempio, a causa di una violazione del vincolo di chiave esterna?</span><span class="sxs-lookup"><span data-stu-id="3f41e-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="3f41e-121">Se viene eseguito il rollback del primo record o se è accettabile che il primo record rimanga eliminato?</span><span class="sxs-lookup"><span data-stu-id="3f41e-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="3f41e-122">Se si desidera che l'operazione batch venga considerata come un' [operazione atomica](http://en.wikipedia.org/wiki/Atomic_operation), una in cui tutti i passaggi hanno esito positivo o se tutti i passaggi hanno esito negativo, è necessario aumentare il livello di accesso ai dati in modo da includere il supporto per [le transazioni del database](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="3f41e-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="3f41e-123">Le transazioni di database garantiscono l'atomicità per il set di istruzioni `INSERT`, `UPDATE`e `DELETE` eseguite nell'ambito della transazione e sono una funzionalità supportata dalla maggior parte dei sistemi di database moderni.</span><span class="sxs-lookup"><span data-stu-id="3f41e-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="3f41e-124">In questa esercitazione verrà esaminato come estendere il DAL per l'utilizzo delle transazioni di database.</span><span class="sxs-lookup"><span data-stu-id="3f41e-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="3f41e-125">Nelle esercitazioni successive verrà esaminata l'implementazione di pagine Web per l'inserimento, l'aggiornamento e l'eliminazione delle interfacce batch.</span><span class="sxs-lookup"><span data-stu-id="3f41e-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="3f41e-126">Inizia subito.</span><span class="sxs-lookup"><span data-stu-id="3f41e-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="3f41e-127">Quando si modificano i dati in una transazione batch, l'atomicità non è sempre necessaria.</span><span class="sxs-lookup"><span data-stu-id="3f41e-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="3f41e-128">In alcuni scenari può essere accettabile che alcune modifiche ai dati abbiano esito positivo e che altre nello stesso batch abbiano esito negativo, ad esempio quando si elimina un set di messaggi di posta elettronica da un client di posta elettronica basato sul Web.</span><span class="sxs-lookup"><span data-stu-id="3f41e-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="3f41e-129">Se si verifica un errore di database a metà del processo di eliminazione, è probabile che i record elaborati senza errori rimangano eliminati.</span><span class="sxs-lookup"><span data-stu-id="3f41e-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="3f41e-130">In questi casi, non è necessario modificare il DAL per supportare le transazioni del database.</span><span class="sxs-lookup"><span data-stu-id="3f41e-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="3f41e-131">Esistono tuttavia altri scenari di operazione batch, in cui l'atomicità è fondamentale.</span><span class="sxs-lookup"><span data-stu-id="3f41e-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="3f41e-132">Quando un cliente sposta i propri fondi da un conto bancario a un altro, è necessario eseguire due operazioni: i fondi devono essere dedotti dal primo account e quindi aggiunti al secondo.</span><span class="sxs-lookup"><span data-stu-id="3f41e-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="3f41e-133">Sebbene la banca possa non ricordare che il primo passaggio ha esito positivo, ma il secondo passaggio ha esito negativo, i clienti sarebbero comprensibilmente sconvolti.</span><span class="sxs-lookup"><span data-stu-id="3f41e-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="3f41e-134">Si consiglia di eseguire questa esercitazione e di implementare i miglioramenti apportati al DAL per supportare le transazioni di database anche se non si prevede di utilizzarli nell'inserimento di batch, nell'aggiornamento e nell'eliminazione delle interfacce che verranno compilate nelle tre esercitazioni seguenti.</span><span class="sxs-lookup"><span data-stu-id="3f41e-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>

## <a name="an-overview-of-transactions"></a><span data-ttu-id="3f41e-135">Panoramica delle transazioni</span><span class="sxs-lookup"><span data-stu-id="3f41e-135">An Overview of Transactions</span></span>

<span data-ttu-id="3f41e-136">La maggior parte dei database include il supporto per *le transazioni*, che consentono di raggruppare più comandi di database in un'unica unità logica di lavoro.</span><span class="sxs-lookup"><span data-stu-id="3f41e-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="3f41e-137">I comandi di database che comprendono una transazione sono sicuramente atomici, ovvero tutti i comandi avranno esito negativo o tutti avranno esito positivo.</span><span class="sxs-lookup"><span data-stu-id="3f41e-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="3f41e-138">In generale, le transazioni vengono implementate tramite istruzioni SQL usando il modello seguente:</span><span class="sxs-lookup"><span data-stu-id="3f41e-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="3f41e-139">Indica l'inizio di una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="3f41e-140">Eseguire le istruzioni SQL che compongono la transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="3f41e-141">Se si verifica un errore in una delle istruzioni del passaggio 2, eseguire il rollback della transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="3f41e-142">Se tutte le istruzioni del passaggio 2 sono state completate senza errori, eseguire il commit della transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="3f41e-143">Le istruzioni SQL utilizzate per creare, eseguire il commit e il rollback della transazione possono essere immesse manualmente durante la scrittura di script SQL o la creazione di stored procedure oppure tramite l'utilizzo di ADO.NET o delle classi nello [spazio dei nomi`System.Transactions`](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="3f41e-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="3f41e-144">In questa esercitazione verrà esaminata solo la gestione delle transazioni con ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="3f41e-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="3f41e-145">In un'esercitazione futura verrà illustrato come utilizzare le stored procedure nel livello di accesso ai dati. in questo caso verranno esaminate le istruzioni SQL per la creazione, il rollback e il commit delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="3f41e-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="3f41e-146">Nel frattempo, consultare la pagina relativa alla [gestione delle transazioni in SQL Server stored procedure](http://www.4guysfromrolla.com/webtech/080305-1.shtml) per ulteriori informazioni.</span><span class="sxs-lookup"><span data-stu-id="3f41e-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="3f41e-147">La [classe`TransactionScope`](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) nello spazio dei nomi `System.Transactions` consente agli sviluppatori di eseguire il wrapping a livello di codice di una serie di istruzioni all'interno dell'ambito di una transazione e include il supporto per transazioni complesse che coinvolgono più origini, ad esempio due database diversi o anche tipi eterogenei di archivi dati, ad esempio un database Microsoft SQL Server, un database Oracle e un servizio Web.</span><span class="sxs-lookup"><span data-stu-id="3f41e-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="3f41e-148">Ho deciso di usare le transazioni ADO.NET per questa esercitazione invece della classe `TransactionScope` perché ADO.NET è più specifico per le transazioni di database e, in molti casi, è molto meno impegnativo in termini di risorse.</span><span class="sxs-lookup"><span data-stu-id="3f41e-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="3f41e-149">Inoltre, in alcuni scenari la classe `TransactionScope` utilizza Microsoft Distributed Transaction Coordinator (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="3f41e-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="3f41e-150">La configurazione, l'implementazione e i problemi di prestazioni che circondano MSDTC lo rendono un argomento piuttosto specializzato e avanzato, oltre all'ambito di queste esercitazioni.</span><span class="sxs-lookup"><span data-stu-id="3f41e-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>

<span data-ttu-id="3f41e-151">Quando si utilizza il provider SqlClient in ADO.NET, le transazioni vengono avviate tramite una chiamata al metodo [`SqlConnection` Class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), che restituisce un [oggetto`SqlTransaction`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="3f41e-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="3f41e-152">Le istruzioni di modifica dei dati che compongono la transazione vengono inserite in un blocco `try...catch`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="3f41e-153">Se si verifica un errore in un'istruzione nel blocco `try`, l'esecuzione viene trasferita al blocco `catch` in cui è possibile eseguire il rollback della transazione tramite il [metodo`Rollback`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx)dell'oggetto `SqlTransaction`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="3f41e-154">Se tutte le istruzioni vengono completate correttamente, una chiamata al metodo dell'oggetto `SqlTransaction` [`Commit`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) alla fine del blocco `try` eseguirà il commit della transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="3f41e-155">Il frammento di codice seguente illustra questo modello.</span><span class="sxs-lookup"><span data-stu-id="3f41e-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="3f41e-156">Per ulteriori sintassi ed esempi sull'utilizzo di transazioni con ADO.NET, vedere [gestione della coerenza dei database con le transazioni](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) .</span><span class="sxs-lookup"><span data-stu-id="3f41e-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="3f41e-157">Per impostazione predefinita, gli oggetti TableAdapter in un DataSet tipizzato non utilizzano le transazioni.</span><span class="sxs-lookup"><span data-stu-id="3f41e-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="3f41e-158">Per fornire supporto per le transazioni, è necessario aumentare le classi TableAdapter per includere metodi aggiuntivi che utilizzano il modello precedente per eseguire una serie di istruzioni di modifica dei dati nell'ambito di una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="3f41e-159">Nel passaggio 2 si vedrà come usare le classi parziali per aggiungere questi metodi.</span><span class="sxs-lookup"><span data-stu-id="3f41e-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="3f41e-160">Passaggio 1: creazione di pagine Web di utilizzo di dati in batch</span><span class="sxs-lookup"><span data-stu-id="3f41e-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="3f41e-161">Prima di iniziare a scoprire come aumentare il valore di DAL per supportare le transazioni di database, è necessario prima di tutto creare le pagine Web di ASP.NET necessarie per questa esercitazione e le tre seguenti.</span><span class="sxs-lookup"><span data-stu-id="3f41e-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="3f41e-162">Per iniziare, aggiungere una nuova cartella denominata `BatchData`, quindi aggiungere le pagine ASP.NET seguenti, associando ogni pagina alla pagina master `Site.master`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`

![Aggiungere le pagine ASP.NET per le esercitazioni correlate a SqlDataSource](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="3f41e-164">**Figura 1**: aggiungere le pagine ASP.NET per le esercitazioni correlate a SqlDataSource</span><span class="sxs-lookup"><span data-stu-id="3f41e-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>

<span data-ttu-id="3f41e-165">Come per le altre cartelle, `Default.aspx` utilizzerà il controllo utente `SectionLevelTutorialListing.ascx` per elencare le esercitazioni nella sezione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="3f41e-166">Quindi, aggiungere questo controllo utente a `Default.aspx` trascinandolo dall'Esplora soluzioni nella visualizzazione di progettazione della pagina.</span><span class="sxs-lookup"><span data-stu-id="3f41e-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>

<span data-ttu-id="3f41e-167">[![aggiungere il controllo utente SectionLevelTutorialListing. ascx a default. aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="3f41e-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span></span>

<span data-ttu-id="3f41e-168">**Figura 2**: aggiungere il controllo utente `SectionLevelTutorialListing.ascx` al `Default.aspx` ([fare clic per visualizzare l'immagine con dimensioni complete](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="3f41e-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>

<span data-ttu-id="3f41e-169">Infine, aggiungere le quattro pagine come voci al file di `Web.sitemap`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="3f41e-170">In particolare, aggiungere il markup seguente dopo il `<siteMapNode>`di personalizzazione della mappa del sito:</span><span class="sxs-lookup"><span data-stu-id="3f41e-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>

[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="3f41e-171">Dopo avere aggiornato `Web.sitemap`, è possibile visualizzare il sito Web delle esercitazioni tramite un browser.</span><span class="sxs-lookup"><span data-stu-id="3f41e-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="3f41e-172">Il menu a sinistra include ora gli elementi per le esercitazioni su come usare i dati in batch.</span><span class="sxs-lookup"><span data-stu-id="3f41e-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>

![La mappa del sito include ora le voci per le esercitazioni sull'utilizzo di dati in batch](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="3f41e-174">**Figura 3**: la mappa del sito include ora le voci per le esercitazioni sull'uso di dati in batch</span><span class="sxs-lookup"><span data-stu-id="3f41e-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>

## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="3f41e-175">Passaggio 2: aggiornamento del livello di accesso ai dati per supportare le transazioni del database</span><span class="sxs-lookup"><span data-stu-id="3f41e-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="3f41e-176">Come è stato illustrato nella prima esercitazione, [creazione di un livello di accesso ai dati](../introduction/creating-a-data-access-layer-cs.md), il set di dati tipizzato in dal è costituito da DataTable e oggetti TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="3f41e-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="3f41e-177">Le DataTable contengono dati mentre gli oggetti TableAdapter forniscono la funzionalità per la lettura dei dati dal database nelle tabelle dati, per aggiornare il database con le modifiche apportate alle DataTable e così via.</span><span class="sxs-lookup"><span data-stu-id="3f41e-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="3f41e-178">Tenere presente che gli oggetti TableAdapter forniscono due modelli per l'aggiornamento dei dati, detti aggiornamenti batch e DB-Direct.</span><span class="sxs-lookup"><span data-stu-id="3f41e-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="3f41e-179">Con il modello di aggiornamento batch, al TableAdapter viene passato un DataSet, una DataTable o una raccolta di oggetti DataRows.</span><span class="sxs-lookup"><span data-stu-id="3f41e-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="3f41e-180">Questi dati vengono enumerati e per ogni riga inserita, modificata o eliminata, viene eseguito il `InsertCommand`, `UpdateCommand`o `DeleteCommand`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="3f41e-181">Con il modello DB-Direct, al TableAdapter vengono invece passati i valori delle colonne necessarie per l'inserimento, l'aggiornamento o l'eliminazione di un singolo record.</span><span class="sxs-lookup"><span data-stu-id="3f41e-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="3f41e-182">Il metodo del modello Direct di database usa quindi i valori passati per eseguire l'istruzione `InsertCommand`, `UpdateCommand`o `DeleteCommand` appropriata.</span><span class="sxs-lookup"><span data-stu-id="3f41e-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="3f41e-183">Indipendentemente dal modello di aggiornamento utilizzato, i metodi generati automaticamente dai TableAdapter non utilizzano le transazioni.</span><span class="sxs-lookup"><span data-stu-id="3f41e-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="3f41e-184">Per impostazione predefinita, ogni istruzione INSERT, Update o DELETE eseguita dal TableAdapter viene considerata come una singola operazione discreta.</span><span class="sxs-lookup"><span data-stu-id="3f41e-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="3f41e-185">Si supponga, ad esempio, che il modello DB-Direct venga utilizzato da parte del codice del BLL per inserire dieci record nel database.</span><span class="sxs-lookup"><span data-stu-id="3f41e-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="3f41e-186">Questo codice chiama il metodo TableAdapter s `Insert` dieci volte.</span><span class="sxs-lookup"><span data-stu-id="3f41e-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="3f41e-187">Se i primi cinque inserimenti hanno esito positivo, ma il sesto ha generato un'eccezione, i primi cinque record inseriti rimarranno nel database.</span><span class="sxs-lookup"><span data-stu-id="3f41e-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="3f41e-188">Analogamente, se il modello di aggiornamento batch viene utilizzato per eseguire inserimenti, aggiornamenti ed eliminazioni nelle righe inserite, modificate ed eliminate in un oggetto DataTable, se le prime modifiche sono state completate, ma in seguito si è verificato un errore, le modifiche precedenti che il completamento rimarrà nel database.</span><span class="sxs-lookup"><span data-stu-id="3f41e-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="3f41e-189">In alcuni scenari è necessario garantire l'atomicità in una serie di modifiche.</span><span class="sxs-lookup"><span data-stu-id="3f41e-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="3f41e-190">A tale scopo, è necessario estendere manualmente il TableAdapter aggiungendo nuovi metodi che eseguono la `InsertCommand`, `UpdateCommand`e `DeleteCommand` s sotto l'ombrello di una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="3f41e-191">Durante la [creazione di un livello di accesso ai dati](../introduction/creating-a-data-access-layer-cs.md) è stato esaminato l'utilizzo di [classi parziali](http://en.wikipedia.org/wiki/Partial_type) per estendere la funzionalità delle tabelle dati all'interno del DataSet tipizzato.</span><span class="sxs-lookup"><span data-stu-id="3f41e-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="3f41e-192">Questa tecnica può essere usata anche con i TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="3f41e-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="3f41e-193">Il set di dati tipizzato `Northwind.xsd` si trova nel `App_Code` cartella `DAL` sottocartella.</span><span class="sxs-lookup"><span data-stu-id="3f41e-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="3f41e-194">Creare una sottocartella nella cartella `DAL` denominata `TransactionSupport` e aggiungere un nuovo file di classe denominato `ProductsTableAdapter.TransactionSupport.cs` (vedere la figura 4).</span><span class="sxs-lookup"><span data-stu-id="3f41e-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="3f41e-195">Questo file conterrà l'implementazione parziale del `ProductsTableAdapter` che include i metodi per l'esecuzione di modifiche ai dati mediante una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>

![Aggiungere una cartella denominata TransactionSupport e un file di classe denominato ProductsTableAdapter.TransactionSupport.cs](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="3f41e-197">**Figura 4**: aggiungere una cartella denominata `TransactionSupport` e un file di classe denominato `ProductsTableAdapter.TransactionSupport.cs`</span><span class="sxs-lookup"><span data-stu-id="3f41e-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.cs`</span></span>

<span data-ttu-id="3f41e-198">Immettere il codice seguente nel file di `ProductsTableAdapter.TransactionSupport.cs`:</span><span class="sxs-lookup"><span data-stu-id="3f41e-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="3f41e-199">La parola chiave `partial` nella dichiarazione di classe indica al compilatore che i membri aggiunti all'interno di devono essere aggiunti alla classe `ProductsTableAdapter` nello spazio dei nomi `NorthwindTableAdapters`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="3f41e-200">Si noti l'istruzione `using System.Data.SqlClient` all'inizio del file.</span><span class="sxs-lookup"><span data-stu-id="3f41e-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="3f41e-201">Poiché il TableAdapter è stato configurato per l'utilizzo del provider SqlClient, viene utilizzato internamente un oggetto [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) per eseguire i relativi comandi al database.</span><span class="sxs-lookup"><span data-stu-id="3f41e-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="3f41e-202">Di conseguenza, è necessario usare la classe `SqlTransaction` per avviare la transazione e quindi eseguirne il commit o eseguire il rollback.</span><span class="sxs-lookup"><span data-stu-id="3f41e-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="3f41e-203">Se si usa un archivio dati diverso da Microsoft SQL Server, sarà necessario usare il provider appropriato.</span><span class="sxs-lookup"><span data-stu-id="3f41e-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="3f41e-204">Questi metodi forniscono i blocchi predefiniti necessari per avviare, eseguire il rollback ed eseguire il commit di una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="3f41e-205">Sono contrassegnate come `public`, in modo da poterle usare dall'interno del `ProductsTableAdapter`, da un'altra classe nel DAL o da un altro livello nell'architettura, ad esempio BLL.</span><span class="sxs-lookup"><span data-stu-id="3f41e-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="3f41e-206">`BeginTransaction` apre la `SqlConnection` interna del TableAdapter (se necessario), avvia la transazione e la assegna alla proprietà `Transaction` e associa la transazione agli oggetti `SqlCommand` `SqlDataAdapter` interni.</span><span class="sxs-lookup"><span data-stu-id="3f41e-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="3f41e-207">`CommitTransaction` e `RollbackTransaction` chiamano rispettivamente i metodi `Commit` e `Rollback` dell'oggetto `Transaction` prima di chiudere l'oggetto `Connection` interno.</span><span class="sxs-lookup"><span data-stu-id="3f41e-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="3f41e-208">Passaggio 3: aggiunta di metodi per aggiornare ed eliminare dati sotto l'ombrello di una transazione</span><span class="sxs-lookup"><span data-stu-id="3f41e-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="3f41e-209">Con questi metodi completi, è possibile aggiungere metodi a `ProductsDataTable` o al BLL che eseguono una serie di comandi sotto l'ombrello di una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="3f41e-210">Il metodo seguente utilizza il modello di aggiornamento batch per aggiornare un'istanza di `ProductsDataTable` utilizzando una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="3f41e-211">Viene avviata una transazione chiamando il metodo `BeginTransaction` e quindi viene utilizzato un blocco `try...catch` per emettere le istruzioni di modifica dei dati.</span><span class="sxs-lookup"><span data-stu-id="3f41e-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="3f41e-212">Se la chiamata al metodo dell'oggetto `Adapter` `Update` genera un'eccezione, l'esecuzione viene trasferita al blocco `catch` in cui verrà eseguito il rollback della transazione e generata nuovamente l'eccezione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="3f41e-213">Si ricordi che il metodo `Update` implementa il modello di aggiornamento batch enumerando le righe del `ProductsDataTable` fornito ed eseguendo le `InsertCommand`, `UpdateCommand`e `DeleteCommand` necessari.</span><span class="sxs-lookup"><span data-stu-id="3f41e-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="3f41e-214">Se uno di questi comandi genera un errore, viene eseguito il rollback della transazione, annullando le modifiche precedenti apportate durante la durata della transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="3f41e-215">Se l'istruzione `Update` viene completata senza errori, viene eseguito il commit della transazione nel suo complesso.</span><span class="sxs-lookup"><span data-stu-id="3f41e-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="3f41e-216">Aggiungere il metodo `UpdateWithTransaction` alla classe `ProductsTableAdapter` tramite la classe parziale in `ProductsTableAdapter.TransactionSupport.cs`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="3f41e-217">In alternativa, è possibile aggiungere questo metodo alla classe `ProductsBLL` del livello della logica di business con alcune piccole modifiche sintattiche.</span><span class="sxs-lookup"><span data-stu-id="3f41e-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="3f41e-218">In particolare, la parola chiave this in `this.BeginTransaction()`, `this.CommitTransaction()`e `this.RollbackTransaction()` deve essere sostituita con `Adapter` (ricordare che `Adapter` è il nome di una proprietà in `ProductsBLL` di tipo `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="3f41e-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="3f41e-219">Il metodo `UpdateWithTransaction` usa il modello di aggiornamento batch, ma è anche possibile usare una serie di chiamate DB-Direct nell'ambito di una transazione, come illustrato nel metodo seguente.</span><span class="sxs-lookup"><span data-stu-id="3f41e-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="3f41e-220">Il metodo `DeleteProductsWithTransaction` accetta come input un `List<T>` di tipo `int`, che sono i `ProductID` da eliminare.</span><span class="sxs-lookup"><span data-stu-id="3f41e-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="3f41e-221">Il metodo avvia la transazione tramite una chiamata a `BeginTransaction` e quindi, nel blocco di `try`, scorre l'elenco fornito chiamando il metodo di `Delete` del metodo DB-Direct per ogni valore di `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="3f41e-222">Se una delle chiamate a `Delete` ha esito negativo, il controllo viene trasferito al `catch` blocco in cui viene eseguito il rollback della transazione e l'eccezione viene generata nuovamente.</span><span class="sxs-lookup"><span data-stu-id="3f41e-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="3f41e-223">Se tutte le chiamate a `Delete` hanno esito positivo, viene eseguito il commit della transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="3f41e-224">Aggiungere questo metodo alla classe `ProductsBLL`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-224">Add this method to the `ProductsBLL` class.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="3f41e-225">Applicazione di transazioni tra più oggetti TableAdapter</span><span class="sxs-lookup"><span data-stu-id="3f41e-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="3f41e-226">Il codice correlato alla transazione esaminato in questa esercitazione consente di considerare più istruzioni sul `ProductsTableAdapter` come operazione atomica.</span><span class="sxs-lookup"><span data-stu-id="3f41e-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="3f41e-227">Cosa accade se è necessario eseguire in modo atomico più modifiche a tabelle di database diverse?</span><span class="sxs-lookup"><span data-stu-id="3f41e-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="3f41e-228">Ad esempio, quando si elimina una categoria, potrebbe essere necessario riassegnare i prodotti correnti a un'altra categoria.</span><span class="sxs-lookup"><span data-stu-id="3f41e-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="3f41e-229">Questi due passaggi per riassegnare i prodotti ed eliminare la categoria devono essere eseguiti come operazione atomica.</span><span class="sxs-lookup"><span data-stu-id="3f41e-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="3f41e-230">Il `ProductsTableAdapter` include tuttavia solo metodi per la modifica della tabella `Products` e la `CategoriesTableAdapter` include solo metodi per la modifica della tabella `Categories`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="3f41e-231">Quindi, in che modo una transazione può includere entrambi i TableAdapter?</span><span class="sxs-lookup"><span data-stu-id="3f41e-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="3f41e-232">Un'opzione consiste nell'aggiungere un metodo al `CategoriesTableAdapter` denominato `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` e fare in modo che il metodo chiami un stored procedure che riassegni i prodotti ed elimini la categoria nell'ambito di una transazione definita all'interno dell'stored procedure.</span><span class="sxs-lookup"><span data-stu-id="3f41e-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="3f41e-233">Si esaminerà come iniziare, eseguire il commit e il rollback delle transazioni nelle stored procedure in un'esercitazione futura.</span><span class="sxs-lookup"><span data-stu-id="3f41e-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="3f41e-234">Un'altra opzione consiste nel creare una classe helper nell'oggetto DAL che contiene il metodo `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="3f41e-235">Questo metodo creerebbe un'istanza del `CategoriesTableAdapter` e il `ProductsTableAdapter` e quindi imposterà questi due oggetti TableAdapter `Connection` proprietà sulla stessa istanza di `SqlConnection`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="3f41e-236">A questo punto, uno dei due TableAdapter avvierà la transazione con una chiamata a `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="3f41e-237">I metodi TableAdapter per riassegnare i prodotti ed eliminare la categoria vengono richiamati in un blocco di `try...catch` con il commit o il rollback della transazione in base alle esigenze.</span><span class="sxs-lookup"><span data-stu-id="3f41e-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="3f41e-238">Passaggio 4: aggiunta del metodo`UpdateWithTransaction`al livello della logica di business</span><span class="sxs-lookup"><span data-stu-id="3f41e-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="3f41e-239">Nel passaggio 3 è stato aggiunto un metodo di `UpdateWithTransaction` al `ProductsTableAdapter` nel DAL.</span><span class="sxs-lookup"><span data-stu-id="3f41e-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="3f41e-240">È necessario aggiungere un metodo corrispondente al BLL.</span><span class="sxs-lookup"><span data-stu-id="3f41e-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="3f41e-241">Sebbene il livello di presentazione possa chiamare direttamente il DAL per richiamare il metodo `UpdateWithTransaction`, queste esercitazioni hanno cercato di definire un'architettura a più livelli che isola dal livello di presentazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="3f41e-242">Quindi, è necessario continuare questo approccio.</span><span class="sxs-lookup"><span data-stu-id="3f41e-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="3f41e-243">Aprire il file di classe `ProductsBLL` e aggiungere un metodo denominato `UpdateWithTransaction` che chiama semplicemente il metodo DAL corrispondente.</span><span class="sxs-lookup"><span data-stu-id="3f41e-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="3f41e-244">Sono ora disponibili due nuovi metodi in `ProductsBLL`: `UpdateWithTransaction`, appena aggiunto e `DeleteProductsWithTransaction`, che è stato aggiunto nel passaggio 3.</span><span class="sxs-lookup"><span data-stu-id="3f41e-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="3f41e-245">Questi metodi non includono l'attributo `DataObjectMethodAttribute` assegnato alla maggior parte degli altri metodi nella classe `ProductsBLL` perché questi metodi verranno richiamati direttamente dalle classi code-behind delle pagine ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="3f41e-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="3f41e-246">Ricordare che `DataObjectMethodAttribute` viene utilizzato per contrassegnare i metodi che devono essere visualizzati nella configurazione guidata origine dati di ObjectDataSource e nella scheda (SELECT, UPDATE, INSERT o DELETE).</span><span class="sxs-lookup"><span data-stu-id="3f41e-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="3f41e-247">Poiché GridView non dispone di alcun supporto incorporato per la modifica o l'eliminazione di batch, è necessario richiamare questi metodi a livello di codice anziché utilizzare l'approccio dichiarativo senza codice.</span><span class="sxs-lookup"><span data-stu-id="3f41e-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>

## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="3f41e-248">Passaggio 5: aggiornamento atomico dei dati del database dal livello di presentazione</span><span class="sxs-lookup"><span data-stu-id="3f41e-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="3f41e-249">Per illustrare l'effetto che la transazione ha quando si aggiorna un batch di record, si crea un'interfaccia utente che elenca tutti i prodotti in GridView e include un controllo Web Button che, quando selezionato, riassegna i prodotti `CategoryID` valori.</span><span class="sxs-lookup"><span data-stu-id="3f41e-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="3f41e-250">In particolare, la riassegnazione della categoria verrà progredita in modo che ai primi prodotti venga assegnato un valore di `CategoryID` valido mentre ad altri viene assegnato intenzionalmente un valore `CategoryID` non esistente.</span><span class="sxs-lookup"><span data-stu-id="3f41e-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="3f41e-251">Se si tenta di aggiornare il database con un prodotto il cui `CategoryID` non corrisponde a una categoria esistente `CategoryID`, si verificherà una violazione del vincolo di chiave esterna e verrà generata un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="3f41e-252">In questo esempio si noterà che quando si usa una transazione, l'eccezione generata dalla violazione del vincolo di chiave esterna causerà il rollback delle modifiche `CategoryID` valide precedenti.</span><span class="sxs-lookup"><span data-stu-id="3f41e-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="3f41e-253">Quando non si utilizza una transazione, tuttavia, le modifiche apportate alle categorie iniziali rimarranno.</span><span class="sxs-lookup"><span data-stu-id="3f41e-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="3f41e-254">Per iniziare, aprire la pagina `Transactions.aspx` nella cartella `BatchData` e trascinare un controllo GridView dalla casella degli strumenti nella finestra di progettazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="3f41e-255">Impostare il `ID` su `Products` e, dal relativo smart tag, associarlo a un nuovo ObjectDataSource denominato `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="3f41e-256">Configurare ObjectDataSource per eseguire il pull dei dati dal metodo `GetProducts` della classe `ProductsBLL`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="3f41e-257">Si tratta di un GridView di sola lettura, quindi impostare gli elenchi a discesa nelle schede Aggiorna, Inserisci ed Elimina su (nessuno), quindi fare clic su fine.</span><span class="sxs-lookup"><span data-stu-id="3f41e-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>

<span data-ttu-id="3f41e-258">[![figura 5: configurare ObjectDataSource per l'uso del metodo ProductsBLL della classe s GetProducts](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="3f41e-258">[![Figure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span></span>

<span data-ttu-id="3f41e-259">**Figura 5**: Figura 5: configurare ObjectDataSource per l'uso del metodo `ProductsBLL` Class s `GetProducts` ([fare clic per visualizzare l'immagine con dimensioni complete](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="3f41e-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>

<span data-ttu-id="3f41e-260">[![impostare gli elenchi a discesa nelle schede Aggiorna, Inserisci ed Elimina su (nessuno)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="3f41e-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span></span>

<span data-ttu-id="3f41e-261">**Figura 6**: impostare gli elenchi a discesa nelle schede di aggiornamento, inserimento ed eliminazione su (nessuno) ([fare clic per visualizzare l'immagine con dimensioni complete](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="3f41e-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>

<span data-ttu-id="3f41e-262">Dopo aver completato la configurazione guidata origine dati, Visual Studio creerà i BoundField e un CheckBoxField per i campi dati prodotto.</span><span class="sxs-lookup"><span data-stu-id="3f41e-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="3f41e-263">Rimuovere tutti questi campi ad eccezione di `ProductID`, `ProductName`, `CategoryID`e `CategoryName`, quindi rinominare i BoundField `ProductName` e `CategoryName` `HeaderText` proprietà rispettivamente su prodotto e categoria.</span><span class="sxs-lookup"><span data-stu-id="3f41e-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="3f41e-264">Dallo smart tag selezionare l'opzione Abilita paging.</span><span class="sxs-lookup"><span data-stu-id="3f41e-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="3f41e-265">Dopo avere apportato queste modifiche, il markup dichiarativo GridView e ObjectDataSource dovrebbe essere simile al seguente:</span><span class="sxs-lookup"><span data-stu-id="3f41e-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="3f41e-266">Quindi, aggiungere i controlli Web di tre pulsanti sopra GridView.</span><span class="sxs-lookup"><span data-stu-id="3f41e-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="3f41e-267">Impostare la proprietà Text del primo pulsante su Aggiorna griglia, la seconda s per modificare le categorie (con transazione) e la terza per modificare le categorie (senza transazione).</span><span class="sxs-lookup"><span data-stu-id="3f41e-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="3f41e-268">A questo punto la visualizzazione progettazione in Visual Studio dovrebbe avere un aspetto simile allo screenshot illustrato nella figura 7.</span><span class="sxs-lookup"><span data-stu-id="3f41e-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>

<span data-ttu-id="3f41e-269">[![la pagina contiene controlli Web GridView e tre pulsanti](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="3f41e-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span></span>

<span data-ttu-id="3f41e-270">**Figura 7**: la pagina contiene controlli Web GridView e tre pulsanti ([fare clic per visualizzare l'immagine con dimensioni complete](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="3f41e-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>

<span data-ttu-id="3f41e-271">Creare gestori di eventi per ognuno dei tre `Click` di pulsanti e usare il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="3f41e-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="3f41e-272">Il pulsante di aggiornamento s `Click` gestore eventi semplicemente riassocia i dati al controllo GridView chiamando il metodo `Products` GridView s `DataBind`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="3f41e-273">Il secondo gestore eventi riassegna i prodotti `CategoryID` s e utilizza il nuovo metodo di transazione da BLL per eseguire gli aggiornamenti del database sotto l'ombrello di una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="3f41e-274">Si noti che ogni `CategoryID` del prodotto viene impostata in modo arbitrario sullo stesso valore del `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="3f41e-275">Questa operazione funzionerà correttamente per i primi prodotti, perché questi prodotti hanno `ProductID` valori che si verificano per eseguire il mapping a `CategoryID` validi.</span><span class="sxs-lookup"><span data-stu-id="3f41e-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="3f41e-276">Tuttavia, una volta che il `ProductID` s inizia a essere troppo grande, questa sovrapposizione di coincidenti di `ProductID` s e `CategoryID` non è più applicabile.</span><span class="sxs-lookup"><span data-stu-id="3f41e-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="3f41e-277">Il terzo gestore dell'evento `Click` aggiorna i prodotti `CategoryID` s nello stesso modo, ma invia l'aggiornamento al database usando il metodo di `Update` di `ProductsTableAdapter` s predefinito.</span><span class="sxs-lookup"><span data-stu-id="3f41e-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="3f41e-278">Questo metodo `Update` non esegue il wrapping della serie di comandi all'interno di una transazione, pertanto le modifiche apportate prima del primo errore di violazione del vincolo di chiave esterna verranno mantenute.</span><span class="sxs-lookup"><span data-stu-id="3f41e-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="3f41e-279">Per illustrare questo comportamento, visitare questa pagina tramite un browser.</span><span class="sxs-lookup"><span data-stu-id="3f41e-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="3f41e-280">Inizialmente dovrebbe essere visualizzata la prima pagina di dati, come illustrato nella figura 8.</span><span class="sxs-lookup"><span data-stu-id="3f41e-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="3f41e-281">Fare quindi clic sul pulsante Modifica categorie (con transazione).</span><span class="sxs-lookup"><span data-stu-id="3f41e-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="3f41e-282">In questo modo si verificherà un postback e si tenterà di aggiornare tutti i prodotti `CategoryID` valori, ma si verificherà una violazione del vincolo di chiave esterna (vedere la figura 9).</span><span class="sxs-lookup"><span data-stu-id="3f41e-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>

<span data-ttu-id="3f41e-283">[![i prodotti vengono visualizzati in un GridView paginabile](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="3f41e-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span></span>

<span data-ttu-id="3f41e-284">**Figura 8**: i prodotti vengono visualizzati in un GridView paginabile ([fare clic per visualizzare l'immagine con dimensioni complete](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="3f41e-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>

<span data-ttu-id="3f41e-285">[![riassegnazione delle categorie comporta una violazione del vincolo di chiave esterna](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="3f41e-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span></span>

<span data-ttu-id="3f41e-286">**Figura 9**: la riassegnazione delle categorie comporta una violazione del vincolo di chiave esterna ([fare clic per visualizzare l'immagine con dimensioni complete](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="3f41e-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>

<span data-ttu-id="3f41e-287">Premere il pulsante indietro del browser e quindi fare clic sul pulsante Aggiorna griglia.</span><span class="sxs-lookup"><span data-stu-id="3f41e-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="3f41e-288">Quando si aggiornano i dati, dovrebbe essere visualizzato esattamente lo stesso output illustrato nella figura 8.</span><span class="sxs-lookup"><span data-stu-id="3f41e-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="3f41e-289">Ovvero, anche se alcuni dei prodotti `CategoryID` sono stati modificati in valori validi e aggiornati nel database, ne è stato eseguito il rollback quando si è verificata la violazione del vincolo di chiave esterna.</span><span class="sxs-lookup"><span data-stu-id="3f41e-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="3f41e-290">A questo punto, provare a fare clic sul pulsante Modifica categorie (senza transazione).</span><span class="sxs-lookup"><span data-stu-id="3f41e-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="3f41e-291">Verrà generato lo stesso errore di violazione di vincolo di chiave esterna (vedere la figura 9), ma questa volta i prodotti i cui valori `CategoryID` sono stati modificati in un valore valido non verrà eseguito il rollback.</span><span class="sxs-lookup"><span data-stu-id="3f41e-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="3f41e-292">Premere il pulsante indietro del browser e quindi il pulsante Aggiorna griglia.</span><span class="sxs-lookup"><span data-stu-id="3f41e-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="3f41e-293">Come illustrato nella figura 10, i `CategoryID` dei primi otto prodotti sono stati riassegnati.</span><span class="sxs-lookup"><span data-stu-id="3f41e-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="3f41e-294">Nella figura 8, ad esempio, Chang aveva un `CategoryID` di 1, ma nella figura 10 è stato riassegnato a 2.</span><span class="sxs-lookup"><span data-stu-id="3f41e-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>

<span data-ttu-id="3f41e-295">[![alcuni prodotti CategoryID i valori sono stati aggiornati mentre altri non lo erano](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="3f41e-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span></span>

<span data-ttu-id="3f41e-296">**Figura 10**: alcuni prodotti `CategoryID` valori sono stati aggiornati mentre altri non lo erano ([fare clic per visualizzare l'immagine con dimensioni complete](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="3f41e-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>

## <a name="summary"></a><span data-ttu-id="3f41e-297">Riepilogo</span><span class="sxs-lookup"><span data-stu-id="3f41e-297">Summary</span></span>

<span data-ttu-id="3f41e-298">Per impostazione predefinita, i metodi di TableAdapter non eseguono il wrapping delle istruzioni di database eseguite nell'ambito di una transazione, ma con un po' di lavoro è possibile aggiungere metodi per la creazione, il commit e il rollback di una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="3f41e-299">In questa esercitazione sono stati creati tre metodi nella classe `ProductsTableAdapter`: `BeginTransaction`, `CommitTransaction`e `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="3f41e-300">Abbiamo visto come usare questi metodi insieme a un blocco di `try...catch` per rendere atomica una serie di istruzioni di modifica dei dati.</span><span class="sxs-lookup"><span data-stu-id="3f41e-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="3f41e-301">In particolare, è stato creato il metodo `UpdateWithTransaction` nel `ProductsTableAdapter`, che usa il modello di aggiornamento batch per eseguire le modifiche necessarie alle righe di un `ProductsDataTable`fornito.</span><span class="sxs-lookup"><span data-stu-id="3f41e-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="3f41e-302">È stato inoltre aggiunto il metodo `DeleteProductsWithTransaction` alla classe `ProductsBLL` nell'oggetto BLL, che accetta un `List` di `ProductID` valori come input e chiama il metodo del criterio DB-Direct `Delete` per ogni `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="3f41e-303">Entrambi i metodi iniziano creando una transazione e quindi eseguendo le istruzioni di modifica dei dati all'interno di un blocco `try...catch`.</span><span class="sxs-lookup"><span data-stu-id="3f41e-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="3f41e-304">Se si verifica un'eccezione, viene eseguito il rollback della transazione; in caso contrario, viene eseguito il commit.</span><span class="sxs-lookup"><span data-stu-id="3f41e-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="3f41e-305">Nel passaggio 5 è stato illustrato l'effetto degli aggiornamenti batch transazionali rispetto agli aggiornamenti batch che hanno ignorato l'utilizzo di una transazione.</span><span class="sxs-lookup"><span data-stu-id="3f41e-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="3f41e-306">Nelle tre esercitazioni successive verranno sviluppate le basi illustrate in questa esercitazione e verranno create le interfacce utente per l'esecuzione di aggiornamenti, eliminazioni e inserimenti in batch.</span><span class="sxs-lookup"><span data-stu-id="3f41e-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="3f41e-307">Buona programmazione!</span><span class="sxs-lookup"><span data-stu-id="3f41e-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="3f41e-308">Ulteriori informazioni</span><span class="sxs-lookup"><span data-stu-id="3f41e-308">Further Reading</span></span>

<span data-ttu-id="3f41e-309">Per ulteriori informazioni sugli argomenti trattati in questa esercitazione, fare riferimento alle risorse seguenti:</span><span class="sxs-lookup"><span data-stu-id="3f41e-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="3f41e-310">Gestione della coerenza dei database con le transazioni</span><span class="sxs-lookup"><span data-stu-id="3f41e-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="3f41e-311">Gestione delle transazioni in SQL Server stored procedure</span><span class="sxs-lookup"><span data-stu-id="3f41e-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="3f41e-312">Transazioni semplificate: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="3f41e-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="3f41e-313">TransactionScope e DataAdapter</span><span class="sxs-lookup"><span data-stu-id="3f41e-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="3f41e-314">Uso di transazioni Oracle Database in .NET</span><span class="sxs-lookup"><span data-stu-id="3f41e-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="3f41e-315">Informazioni sull'autore</span><span class="sxs-lookup"><span data-stu-id="3f41e-315">About the Author</span></span>

<span data-ttu-id="3f41e-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autore di sette ASP/ASP. NET Books e fondatore di [4GuysFromRolla.com](http://www.4guysfromrolla.com), collabora con le tecnologie Web Microsoft a partire da 1998.</span><span class="sxs-lookup"><span data-stu-id="3f41e-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="3f41e-317">Scott lavora come consulente, trainer e writer indipendenti.</span><span class="sxs-lookup"><span data-stu-id="3f41e-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="3f41e-318">Il suo ultimo libro è [*Sams Teach Yourself ASP.NET 2,0 in 24 ore*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="3f41e-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="3f41e-319">Può essere raggiunto in [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="3f41e-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="3f41e-320">o tramite il suo Blog, disponibile in [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="3f41e-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="3f41e-321">Grazie speciale</span><span class="sxs-lookup"><span data-stu-id="3f41e-321">Special Thanks To</span></span>

<span data-ttu-id="3f41e-322">Questa serie di esercitazioni è stata esaminata da molti revisori utili.</span><span class="sxs-lookup"><span data-stu-id="3f41e-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="3f41e-323">I revisori del lead per questa esercitazione erano Dave Gardner, Hilton Giesenow e Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="3f41e-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="3f41e-324">Sei interessato a esaminare i miei prossimi articoli MSDN?</span><span class="sxs-lookup"><span data-stu-id="3f41e-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="3f41e-325">In tal caso, rilasciare una riga in [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="3f41e-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="3f41e-326">avanti</span><span class="sxs-lookup"><span data-stu-id="3f41e-326">Next</span></span>](batch-updating-cs.md)
