---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb
title: Gestione delle eccezioni a livello BLL e DAL in una pagina ASP.NET (VB) | Microsoft Docs
author: rick-anderson
description: In questa esercitazione verrà illustrato come visualizzare un messaggio di errore descrittivo e informativo se si verifica un'eccezione durante un'operazione di inserimento, aggiornamento o eliminazione di...
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 129d4338-1315-4f40-89b5-2b84b807707d
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb
msc.type: authoredcontent
ms.openlocfilehash: ee277596ade18d2603892d134b47c2c8697836bb
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/06/2020
ms.locfileid: "78592309"
---
# <a name="handling-bll--and-dal-level-exceptions-in-an-aspnet-page-vb"></a><span data-ttu-id="5f6d3-103">Gestione delle eccezioni a livello BLL e DAL in una pagina ASP.NET (VB)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-103">Handling BLL- and DAL-Level Exceptions in an ASP.NET Page (VB)</span></span>

<span data-ttu-id="5f6d3-104">di [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="5f6d3-105">[Scaricare l'app di esempio](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_VB.exe) o [scaricare il file PDF](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/datatutorial18vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-105">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_VB.exe) or [Download PDF](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/datatutorial18vb1.pdf)</span></span>

> <span data-ttu-id="5f6d3-106">In questa esercitazione verrà illustrato come visualizzare un messaggio di errore descrittivo e informativo se si verifica un'eccezione durante un'operazione di inserimento, aggiornamento o eliminazione di un controllo Web di dati ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-106">In this tutorial we will see how to display a friendly, informative error message should an exception occur during an insert, update, or delete operation of an ASP.NET data Web control.</span></span>

## <a name="introduction"></a><span data-ttu-id="5f6d3-107">Introduzione</span><span class="sxs-lookup"><span data-stu-id="5f6d3-107">Introduction</span></span>

<span data-ttu-id="5f6d3-108">L'uso di dati da un'applicazione Web ASP.NET con un'architettura di applicazione a più livelli prevede i tre passaggi generali seguenti:</span><span class="sxs-lookup"><span data-stu-id="5f6d3-108">Working with data from an ASP.NET web application using a tiered application architecture involves the following three general steps:</span></span>

1. <span data-ttu-id="5f6d3-109">Determinare il metodo del livello della logica di business che deve essere richiamato e i valori dei parametri da passare.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-109">Determine what method of the Business Logic Layer needs to be invoked and what parameter values to pass it.</span></span> <span data-ttu-id="5f6d3-110">I valori dei parametri possono essere hardcoded, assegnati a livello di codice o input immessi dall'utente.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-110">The parameter values can be hard coded, programmatically-assigned, or inputs entered by the user.</span></span>
2. <span data-ttu-id="5f6d3-111">Richiamare il metodo.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-111">Invoke the method.</span></span>
3. <span data-ttu-id="5f6d3-112">Elaborare i risultati.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-112">Process the results.</span></span> <span data-ttu-id="5f6d3-113">Quando si chiama un metodo BLL che restituisce dati, questo può comportare l'associazione dei dati a un controllo Web di dati.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-113">When calling a BLL method that returns data, this may involve binding the data to a data Web control.</span></span> <span data-ttu-id="5f6d3-114">Per i metodi BLL che modificano i dati, ciò può includere l'esecuzione di un'azione in base a un valore restituito o la gestione normale di qualsiasi eccezione generata nel passaggio 2.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-114">For BLL methods that modify data, this may include performing some action based on a return value or gracefully handling any exception that arose in Step 2.</span></span>

<span data-ttu-id="5f6d3-115">Come illustrato nell' [esercitazione precedente](examining-the-events-associated-with-inserting-updating-and-deleting-vb.md), sia ObjectDataSource che i controlli Web dati forniscono punti di estendibilità per i passaggi 1 e 3.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-115">As we saw in the [previous tutorial](examining-the-events-associated-with-inserting-updating-and-deleting-vb.md), both the ObjectDataSource and the data Web controls provide extensibility points for Steps 1 and 3.</span></span> <span data-ttu-id="5f6d3-116">GridView, ad esempio, genera l'evento `RowUpdating` prima di assegnare i valori dei campi alla raccolta di `UpdateParameters` di ObjectDataSource; il relativo evento `RowUpdated` viene generato dopo che ObjectDataSource ha completato l'operazione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-116">The GridView, for example, fires its `RowUpdating` event prior to assigning its field values to its ObjectDataSource's `UpdateParameters` collection; its `RowUpdated` event is raised after the ObjectDataSource has completed the operation.</span></span>

<span data-ttu-id="5f6d3-117">Sono già stati esaminati gli eventi che si sono verificati durante il passaggio 1 e si è visto come possono essere usati per personalizzare i parametri di input o annullare l'operazione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-117">We've already examined the events that fire during Step 1 and have seen how they can be used to customize the input parameters or cancel the operation.</span></span> <span data-ttu-id="5f6d3-118">In questa esercitazione verranno illustrati gli eventi che vengono attivati dopo il completamento dell'operazione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-118">In this tutorial we'll turn our attention to the events that fire after the operation has completed.</span></span> <span data-ttu-id="5f6d3-119">Con questi gestori di eventi di post-livello è possibile, tra le altre cose, determinare se si è verificata un'eccezione durante l'operazione e gestirla normalmente, visualizzando un messaggio di errore descrittivo e informativo sullo schermo anziché l'impostazione predefinita per il ASP.NET standard pagina eccezione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-119">With these post-level event handlers we can, among other things, determine if an exception occurred during the operation and handle it gracefully, displaying a friendly, informative error message on the screen rather than defaulting to the standard ASP.NET exception page.</span></span>

<span data-ttu-id="5f6d3-120">Per illustrare l'uso di questi eventi di post-livello, è possibile creare una pagina in cui sono elencati i prodotti in un GridView modificabile.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-120">To illustrate working with these post-level events, let's create a page that lists the products in an editable GridView.</span></span> <span data-ttu-id="5f6d3-121">Quando si aggiorna un prodotto, se viene generata un'eccezione, nella pagina ASP.NET verrà visualizzato un breve messaggio sopra il GridView che spiega che si è verificato un problema.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-121">When updating a product, if an exception is raised our ASP.NET page will display a short message above the GridView explaining that a problem has occurred.</span></span> <span data-ttu-id="5f6d3-122">Ecco come procedere.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-122">Let's get started!</span></span>

## <a name="step-1-creating-an-editable-gridview-of-products"></a><span data-ttu-id="5f6d3-123">Passaggio 1: creazione di un GridView modificabile di prodotti</span><span class="sxs-lookup"><span data-stu-id="5f6d3-123">Step 1: Creating an Editable GridView of Products</span></span>

<span data-ttu-id="5f6d3-124">Nell'esercitazione precedente è stato creato un GridView modificabile con solo due campi, `ProductName` e `UnitPrice`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-124">In the previous tutorial we created an editable GridView with just two fields, `ProductName` and `UnitPrice`.</span></span> <span data-ttu-id="5f6d3-125">Questa operazione richiedeva la creazione di un overload aggiuntivo per il metodo di `UpdateProduct` della classe `ProductsBLL`, uno che accettava solo tre parametri di input (il nome del prodotto, il prezzo unitario e l'ID), anziché un parametro per ogni campo prodotto.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-125">This required creating an additional overload for the `ProductsBLL` class's `UpdateProduct` method, one that only accepted three input parameters (the product's name, unit price, and ID) as opposed a parameter for each product field.</span></span> <span data-ttu-id="5f6d3-126">Per questa esercitazione si proverà a eseguire nuovamente questa tecnica, creando un controllo GridView modificabile che Visualizza il nome del prodotto, la quantità per unità, il prezzo unitario e le unità in magazzino, ma consente di modificare solo il nome, il prezzo unitario e le unità in magazzino.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-126">For this tutorial, let's practice this technique again, creating an editable GridView that displays the product's name, quantity per unit, unit price, and units in stock, but only allows the name, unit price, and units in stock to be edited.</span></span>

<span data-ttu-id="5f6d3-127">Per supportare questo scenario, è necessario un altro overload del metodo `UpdateProduct`, uno che accetta quattro parametri: il nome del prodotto, il prezzo unitario, le unità in magazzino e l'ID.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-127">To accommodate this scenario we'll need another overload of the `UpdateProduct` method, one that accepts four parameters: the product's name, unit price, units in stock, and ID.</span></span> <span data-ttu-id="5f6d3-128">Aggiungere il metodo seguente alla classe `ProductsBLL`:</span><span class="sxs-lookup"><span data-stu-id="5f6d3-128">Add the following method to the `ProductsBLL` class:</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample1.vb)]

<span data-ttu-id="5f6d3-129">Al termine di questo metodo, è possibile creare la pagina ASP.NET che consente di modificare questi quattro campi specifici del prodotto.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-129">With this method complete, we're ready to create the ASP.NET page that allows for editing these four particular product fields.</span></span> <span data-ttu-id="5f6d3-130">Aprire la pagina `ErrorHandling.aspx` nella cartella `EditInsertDelete` e aggiungere un controllo GridView alla pagina tramite la finestra di progettazione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-130">Open the `ErrorHandling.aspx` page in the `EditInsertDelete` folder and add a GridView to the page through the Designer.</span></span> <span data-ttu-id="5f6d3-131">Associare GridView a un nuovo ObjectDataSource, eseguendo il mapping del metodo `Select()` al metodo `GetProducts()` della classe `ProductsBLL` e il metodo `Update()` all'overload di `UpdateProduct` appena creato.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-131">Bind the GridView to a new ObjectDataSource, mapping the `Select()` method to the `ProductsBLL` class's `GetProducts()` method and the `Update()` method to the `UpdateProduct` overload just created.</span></span>

<span data-ttu-id="5f6d3-132">[![utilizzare l'overload del metodo UpdateProduct che accetta quattro parametri di input](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-132">[![Use the UpdateProduct Method Overload That Accepts Four Input Parameters](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image1.png)</span></span>

<span data-ttu-id="5f6d3-133">**Figura 1**: usare l'overload del metodo `UpdateProduct` che accetta quattro parametri di input ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-133">**Figure 1**: Use the `UpdateProduct` Method Overload That Accepts Four Input Parameters ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image3.png))</span></span>

<span data-ttu-id="5f6d3-134">Verrà creato un ObjectDataSource con una raccolta di `UpdateParameters` con quattro parametri e un controllo GridView con un campo per ogni campo prodotto.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-134">This will create an ObjectDataSource with an `UpdateParameters` collection with four parameters and a GridView with a field for each of the product fields.</span></span> <span data-ttu-id="5f6d3-135">Il markup dichiarativo di ObjectDataSource assegna alla proprietà `OldValuesParameterFormatString` il valore `original_{0}`, che genera un'eccezione poiché la classe BLL non prevede un parametro di input denominato `original_productID` da passare.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-135">The ObjectDataSource's declarative markup assigns the `OldValuesParameterFormatString` property the value `original_{0}`, which will cause an exception since our BLL class's don't expect an input parameter named `original_productID` to be passed in.</span></span> <span data-ttu-id="5f6d3-136">Non dimenticare di rimuovere completamente questa impostazione dalla sintassi dichiarativa o di impostarla sul valore predefinito `{0}`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-136">Don't forget to remove this setting altogether from the declarative syntax (or set it to the default value, `{0}`).</span></span>

<span data-ttu-id="5f6d3-137">A questo punto, è possibile ridurre il controllo GridView per includere solo i BoundField `ProductName`, `QuantityPerUnit`, `UnitPrice`e `UnitsInStock`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-137">Next, pare down the GridView to include only the `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` BoundFields.</span></span> <span data-ttu-id="5f6d3-138">È anche possibile applicare qualsiasi formattazione a livello di campo che si ritenga necessario, ad esempio la modifica delle proprietà `HeaderText`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-138">Also feel free to apply any field-level formatting you deem necessary (such as changing the `HeaderText` properties).</span></span>

<span data-ttu-id="5f6d3-139">Nell'esercitazione precedente è stato esaminato come formattare il `UnitPrice` BoundField come valuta in modalità di sola lettura e in modalità di modifica.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-139">In the previous tutorial we looked at how to format the `UnitPrice` BoundField as a currency both in read-only mode and edit mode.</span></span> <span data-ttu-id="5f6d3-140">Facciamo la stessa operazione qui.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-140">Let's do the same here.</span></span> <span data-ttu-id="5f6d3-141">Si tenga presente che questa operazione richiedeva l'impostazione della proprietà `DataFormatString` del BoundField su `{0:c}`, la relativa proprietà `HtmlEncode` su `false`e il `ApplyFormatInEditMode` per `true`, come illustrato nella figura 2.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-141">Recall that this required setting the BoundField's `DataFormatString` property to `{0:c}`, its `HtmlEncode` property to `false`, and its `ApplyFormatInEditMode` to `true`, as shown in Figure 2.</span></span>

<span data-ttu-id="5f6d3-142">[![configurare il BoundField PrezzoUnitario per la visualizzazione come valuta](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-142">[![Configure the UnitPrice BoundField to Display as a Currency](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image4.png)</span></span>

<span data-ttu-id="5f6d3-143">**Figura 2**: configurare il BoundField di `UnitPrice` per la visualizzazione come valuta ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-143">**Figure 2**: Configure the `UnitPrice` BoundField to Display as a Currency ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image6.png))</span></span>

<span data-ttu-id="5f6d3-144">Per formattare il `UnitPrice` come valuta nell'interfaccia di modifica, è necessario creare un gestore eventi per l'evento `RowUpdating` di GridView che analizza la stringa in formato valuta in un valore di `decimal`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-144">Formatting the `UnitPrice` as a currency in the editing interface requires creating an event handler for the GridView's `RowUpdating` event that parses the currency-formatted string into a `decimal` value.</span></span> <span data-ttu-id="5f6d3-145">Tenere presente che il gestore dell'evento `RowUpdating` dall'ultima esercitazione è stato controllato anche per assicurarsi che l'utente abbia fornito un valore `UnitPrice`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-145">Recall that the `RowUpdating` event handler from the last tutorial also checked to ensure that the user provided a `UnitPrice` value.</span></span> <span data-ttu-id="5f6d3-146">Tuttavia, per questa esercitazione è possibile consentire all'utente di omettere il prezzo.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-146">However, for this tutorial let's allow the user to omit the price.</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample2.vb)]

<span data-ttu-id="5f6d3-147">Il GridView include un `QuantityPerUnit` BoundField, ma questo BoundField dovrebbe essere solo a scopo di visualizzazione e non può essere modificato dall'utente.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-147">Our GridView includes a `QuantityPerUnit` BoundField, but this BoundField should be only for display purposes and should not be editable by the user.</span></span> <span data-ttu-id="5f6d3-148">Per disporre questo, è sufficiente impostare la proprietà `ReadOnly` dei BoundField su `true`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-148">To arrange this, simply set the BoundFields' `ReadOnly` property to `true`.</span></span>

<span data-ttu-id="5f6d3-149">[![rendere di sola lettura il QuantityPerUnit BoundField](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-149">[![Make the QuantityPerUnit BoundField Read-Only](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image7.png)</span></span>

<span data-ttu-id="5f6d3-150">**Figura 3**: rendere di sola lettura il `QuantityPerUnit` BoundField ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-150">**Figure 3**: Make the `QuantityPerUnit` BoundField Read-Only ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image9.png))</span></span>

<span data-ttu-id="5f6d3-151">Infine, selezionare la casella di controllo Abilita modifica dallo smart tag di GridView.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-151">Finally, check the Enable Editing checkbox from the GridView's smart tag.</span></span> <span data-ttu-id="5f6d3-152">Dopo aver completato questi passaggi, la finestra di progettazione della pagina `ErrorHandling.aspx` dovrebbe essere simile alla figura 4.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-152">After completing these steps the `ErrorHandling.aspx` page's Designer should look similar to Figure 4.</span></span>

<span data-ttu-id="5f6d3-153">[![rimuovere tutti i BoundField tranne quelli necessari e selezionare la casella di controllo Abilita modifica](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-153">[![Remove All But the Needed BoundFields and Check the Enable Editing Checkbox](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image10.png)</span></span>

<span data-ttu-id="5f6d3-154">**Figura 4**: rimuovere tutti i BoundField tranne quelli necessari e selezionare la casella di controllo Abilita modifica ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-154">**Figure 4**: Remove All But the Needed BoundFields and Check the Enable Editing Checkbox ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image12.png))</span></span>

<span data-ttu-id="5f6d3-155">A questo punto è presente un elenco di tutti i campi `ProductName`, `QuantityPerUnit`, `UnitPrice`e `UnitsInStock` dei prodotti; Tuttavia, è possibile modificare solo i campi `ProductName`, `UnitPrice`e `UnitsInStock`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-155">At this point we have a list of all of the products' `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` fields; however, only the `ProductName`, `UnitPrice`, and `UnitsInStock` fields can be edited.</span></span>

<span data-ttu-id="5f6d3-156">[![gli utenti possono ora modificare facilmente i nomi, i prezzi e le unità dei prodotti nei campi azionari](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-156">[![Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image13.png)</span></span>

<span data-ttu-id="5f6d3-157">**Figura 5**: gli utenti possono ora modificare facilmente i nomi, i prezzi e le unità dei prodotti nei campi azionari ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-157">**Figure 5**: Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image15.png))</span></span>

## <a name="step-2-gracefully-handling-dal-level-exceptions"></a><span data-ttu-id="5f6d3-158">Passaggio 2: gestione normale delle eccezioni di livello DAL</span><span class="sxs-lookup"><span data-stu-id="5f6d3-158">Step 2: Gracefully Handling DAL-Level Exceptions</span></span>

<span data-ttu-id="5f6d3-159">Sebbene il GridView modificabile funzioni in modo ottimale quando gli utenti immettono valori validi per il nome, il prezzo e le unità di prodotto modificate in magazzino, l'immissione di valori non validi comporta un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-159">While our editable GridView works wonderfully when users enter legal values for the edited product's name, price, and units in stock, entering illegal values results in an exception.</span></span> <span data-ttu-id="5f6d3-160">Se, ad esempio, si omette il valore `ProductName`, viene generata una [NoNullAllowedException](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp) poiché la proprietà `ProductName` della classe `ProductsRow` ha la proprietà `AllowDBNull` impostata su `false`; Se il database è inattivo, verrà generata un'`SqlException` dal TableAdapter durante il tentativo di connessione al database.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-160">For example, omitting the `ProductName` value causes a [NoNullAllowedException](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp) to be thrown since the `ProductName` property in the `ProductsRow` class has its `AllowDBNull` property set to `false`; if the database is down, a `SqlException` will be thrown by the TableAdapter when attempting to connect to the database.</span></span> <span data-ttu-id="5f6d3-161">Senza eseguire alcuna azione, queste eccezioni si propagano dal livello di accesso ai dati al livello della logica di business, quindi alla pagina ASP.NET e infine al runtime ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-161">Without taking any action, these exceptions bubble up from the Data Access Layer to the Business Logic Layer, then to the ASP.NET page, and finally to the ASP.NET runtime.</span></span>

<span data-ttu-id="5f6d3-162">A seconda di come è configurata l'applicazione Web e se si sta visitando l'applicazione da `localhost`, un'eccezione non gestita può comportare una pagina generica di errore del server, una segnalazione dettagliata degli errori o una pagina Web intuitiva.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-162">Depending on how your web application is configured and whether or not you're visiting the application from `localhost`, an unhandled exception can result in either a generic server-error page, a detailed error report, or a user-friendly web page.</span></span> <span data-ttu-id="5f6d3-163">Per ulteriori informazioni sul modo in cui il runtime di ASP.NET risponde a un'eccezione non rilevata, vedere [gestione degli errori dell'applicazione Web in ASP.NET](http://www.15seconds.com/issue/030102.htm) e l' [elemento customErrors](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx) .</span><span class="sxs-lookup"><span data-stu-id="5f6d3-163">See [Web Application Error Handling in ASP.NET](http://www.15seconds.com/issue/030102.htm) and the [customErrors Element](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx) for more information on how the ASP.NET runtime responds to an uncaught exception.</span></span>

<span data-ttu-id="5f6d3-164">Nella figura 6 viene illustrata la schermata che si è verificata durante il tentativo di aggiornare un prodotto senza specificare il valore `ProductName`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-164">Figure 6 shows the screen encountered when attempting to update a product without specifying the `ProductName` value.</span></span> <span data-ttu-id="5f6d3-165">Si tratta della segnalazione di errori dettagliati predefinita visualizzata quando si arriva attraverso `localhost`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-165">This is the default detailed error report displayed when coming through `localhost`.</span></span>

<span data-ttu-id="5f6d3-166">[![omettere il nome del prodotto visualizzerà i dettagli dell'eccezione](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-166">[![Omitting the Product's Name Will Display Exception Details](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image16.png)</span></span>

<span data-ttu-id="5f6d3-167">**Figura 6**: se si omette il nome del prodotto, vengono visualizzati i dettagli dell'eccezione ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-167">**Figure 6**: Omitting the Product's Name Will Display Exception Details ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image18.png))</span></span>

<span data-ttu-id="5f6d3-168">Sebbene tali dettagli delle eccezioni siano utili durante il test di un'applicazione, la presentazione di un utente finale con una schermata simile a quella di un'eccezione è inferiore alla situazione ideale.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-168">While such exception details are helpful when testing an application, presenting an end user with such a screen in the face of an exception is less than ideal.</span></span> <span data-ttu-id="5f6d3-169">È probabile che un utente finale non conosca il `NoNullAllowedException` o il motivo per cui è stato causato.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-169">An end user likely doesn't know what a `NoNullAllowedException` is or why it was caused.</span></span> <span data-ttu-id="5f6d3-170">Un approccio migliore consiste nel presentare all'utente un messaggio più semplice che spieghi che si sono verificati problemi durante il tentativo di aggiornamento del prodotto.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-170">A better approach is to present the user with a more user-friendly message explaining that there were problems attempting to update the product.</span></span>

<span data-ttu-id="5f6d3-171">Se si verifica un'eccezione durante l'esecuzione dell'operazione, gli eventi di post-livello in ObjectDataSource e nel controllo Web dati forniscono un mezzo per rilevarlo e annullare l'eccezione da bubbling fino al runtime di ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-171">If an exception occurs when performing the operation, the post-level events in both the ObjectDataSource and the data Web control provide a means to detect it and cancel the exception from bubbling up to the ASP.NET runtime.</span></span> <span data-ttu-id="5f6d3-172">Per questo esempio viene creato un gestore eventi per l'evento `RowUpdated` di GridView che determina se un'eccezione è stata attivata e, in caso affermativo, Visualizza i dettagli dell'eccezione in un controllo Web Label.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-172">For our example, let's create an event handler for the GridView's `RowUpdated` event that determines if an exception has fired and, if so, displays the exception details in a Label Web control.</span></span>

<span data-ttu-id="5f6d3-173">Iniziare aggiungendo un'etichetta alla pagina ASP.NET, impostando la relativa proprietà `ID` su `ExceptionDetails` e cancellando la relativa proprietà `Text`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-173">Start by adding a Label to the ASP.NET page, setting its `ID` property to `ExceptionDetails` and clearing out its `Text` property.</span></span> <span data-ttu-id="5f6d3-174">Per richiamare l'utente a questo messaggio, impostare la relativa proprietà `CssClass` su `Warning`, ovvero una classe CSS aggiunta al file `Styles.css` nell'esercitazione precedente.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-174">In order to draw the user's eye to this message, set its `CssClass` property to `Warning`, which is a CSS class we added to the `Styles.css` file in the previous tutorial.</span></span> <span data-ttu-id="5f6d3-175">Tenere presente che questa classe CSS fa in modo che il testo dell'etichetta venga visualizzato in un tipo di carattere rosso, corsivo, grassetto e molto grande.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-175">Recall that this CSS class causes the Label's text to be displayed in a red, italic, bold, extra large font.</span></span>

<span data-ttu-id="5f6d3-176">[![aggiungere un controllo Web Label alla pagina](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-176">[![Add a Label Web Control to the Page](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image19.png)</span></span>

<span data-ttu-id="5f6d3-177">**Figura 7**: aggiungere un controllo Web Label alla pagina ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-177">**Figure 7**: Add a Label Web Control to the Page ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image21.png))</span></span>

<span data-ttu-id="5f6d3-178">Poiché si vuole che il controllo Web dell'etichetta sia visibile solo immediatamente dopo che si è verificata un'eccezione, impostare la relativa proprietà `Visible` su false nel gestore eventi `Page_Load`:</span><span class="sxs-lookup"><span data-stu-id="5f6d3-178">Since we want this Label Web control to be visible only immediately after an exception has occurred, set its `Visible` property to false in the `Page_Load` event handler:</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample3.vb)]

<span data-ttu-id="5f6d3-179">Con questo codice, nella prima pagina visitare e i successivi postback il controllo `ExceptionDetails` avrà la relativa proprietà `Visible` impostata su `false`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-179">With this code, on the first page visit and subsequent postbacks the `ExceptionDetails` control will have its `Visible` property set to `false`.</span></span> <span data-ttu-id="5f6d3-180">In presenza di un'eccezione a livello di DAL o BLL, che è possibile rilevare nel gestore dell'evento `RowUpdated` di GridView, si imposterà la proprietà `Visible` del controllo `ExceptionDetails` su true.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-180">In the face of a DAL- or BLL-level exception, which we can detect in the GridView's `RowUpdated` event handler, we will set the `ExceptionDetails` control's `Visible` property to true.</span></span> <span data-ttu-id="5f6d3-181">Poiché i gestori eventi del controllo Web si verificano dopo il gestore dell'evento `Page_Load` nel ciclo di vita della pagina, verrà visualizzata l'etichetta.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-181">Since Web control event handlers occur after the `Page_Load` event handler in the page lifecycle, the Label will be shown.</span></span> <span data-ttu-id="5f6d3-182">Tuttavia, al successivo postback, il gestore dell'evento `Page_Load` ripristinerà nuovamente la proprietà `Visible` a `false`, nascondendo di nuovo la visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-182">However, on the next postback, the `Page_Load` event handler will revert the `Visible` property back to `false`, hiding it from view again.</span></span>

> [!NOTE]
> <span data-ttu-id="5f6d3-183">In alternativa, è possibile eliminare la necessità di impostare la proprietà `Visible` del controllo `ExceptionDetails` in `Page_Load` assegnando la relativa proprietà `Visible` `false` nella sintassi dichiarativa e disabilitando il relativo stato di visualizzazione, impostando la relativa proprietà `EnableViewState` su `false`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-183">Alternatively, we could remove the necessity for setting the `ExceptionDetails` control's `Visible` property in `Page_Load` by assigning its `Visible` property `false` in the declarative syntax and disabling its view state (setting its `EnableViewState` property to `false`).</span></span> <span data-ttu-id="5f6d3-184">Questo approccio alternativo verrà usato in un'esercitazione futura.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-184">We'll use this alternative approach in a future tutorial.</span></span>

<span data-ttu-id="5f6d3-185">Con il controllo etichetta aggiunto, il passaggio successivo consiste nel creare il gestore eventi per l'evento `RowUpdated` di GridView.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-185">With the Label control added, our next step is to create the event handler for the GridView's `RowUpdated` event.</span></span> <span data-ttu-id="5f6d3-186">Selezionare il controllo GridView nella finestra di progettazione, passare alla Finestra Proprietà e fare clic sull'icona fulmine, che elenca gli eventi di GridView.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-186">Select the GridView in the Designer, go to the Properties window, and click the lightning bolt icon, listing the GridView's events.</span></span> <span data-ttu-id="5f6d3-187">Dovrebbe essere già presente una voce per l'evento `RowUpdating` di GridView, perché è stato creato un gestore eventi per questo evento in precedenza in questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-187">There should already be an entry there for the GridView's `RowUpdating` event, as we created an event handler for this event earlier in this tutorial.</span></span> <span data-ttu-id="5f6d3-188">Creare anche un gestore eventi per l'evento `RowUpdated`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-188">Create an event handler for the `RowUpdated` event as well.</span></span>

![Creare un gestore eventi per l'evento RowUpdated di GridView](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image22.png)

<span data-ttu-id="5f6d3-190">**Figura 8**: creare un gestore eventi per l'evento `RowUpdated` di GridView</span><span class="sxs-lookup"><span data-stu-id="5f6d3-190">**Figure 8**: Create an Event Handler for the GridView's `RowUpdated` Event</span></span>

> [!NOTE]
> <span data-ttu-id="5f6d3-191">È anche possibile creare il gestore eventi tramite gli elenchi a discesa nella parte superiore del file di classe code-behind.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-191">You can also create the event handler through the drop-down lists at the top of the code-behind class file.</span></span> <span data-ttu-id="5f6d3-192">Selezionare GridView dall'elenco a discesa a sinistra e l'evento `RowUpdated` da quello a destra.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-192">Select the GridView from the drop-down list on the left and the `RowUpdated` event from the one on the right.</span></span>

<span data-ttu-id="5f6d3-193">Se si crea questo gestore eventi, il codice seguente verrà aggiunto alla classe code-behind della pagina ASP.NET:</span><span class="sxs-lookup"><span data-stu-id="5f6d3-193">Creating this event handler will add the following code to the ASP.NET page's code-behind class:</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample4.vb)]

<span data-ttu-id="5f6d3-194">Il secondo parametro di input del gestore eventi è un oggetto di tipo [GridViewUpdatedEventArgs](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx), che presenta tre proprietà di interesse per la gestione delle eccezioni:</span><span class="sxs-lookup"><span data-stu-id="5f6d3-194">This event handler's second input parameter is an object of type [GridViewUpdatedEventArgs](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx), which has three properties of interest for handling exceptions:</span></span>

- <span data-ttu-id="5f6d3-195">`Exception` un riferimento all'eccezione generata. Se non è stata generata alcuna eccezione, questa proprietà avrà un valore di `null`</span><span class="sxs-lookup"><span data-stu-id="5f6d3-195">`Exception` a reference to the thrown exception; if no exception has been thrown, this property will have a value of `null`</span></span>
- <span data-ttu-id="5f6d3-196">`ExceptionHandled` un valore booleano che indica se l'eccezione è stata gestita nel gestore eventi `RowUpdated`; Se `false` (impostazione predefinita), l'eccezione viene generata nuovamente, filtrando fino al runtime di ASP.NET</span><span class="sxs-lookup"><span data-stu-id="5f6d3-196">`ExceptionHandled` a Boolean value that indicates whether or not the exception was handled in the `RowUpdated` event handler; if `false` (the default), the exception is re-thrown, percolating up to the ASP.NET runtime</span></span>
- <span data-ttu-id="5f6d3-197">`KeepInEditMode` se impostato su `true` la riga GridView modificata rimane in modalità di modifica; Se `false` (impostazione predefinita), la riga GridView ritorna alla modalità di sola lettura</span><span class="sxs-lookup"><span data-stu-id="5f6d3-197">`KeepInEditMode` if set to `true` the edited GridView row remains in edit mode; if `false` (the default), the GridView row reverts back to its read-only mode</span></span>

<span data-ttu-id="5f6d3-198">Il codice, quindi, deve verificare se `Exception` non è `null`, ovvero se è stata generata un'eccezione durante l'esecuzione dell'operazione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-198">Our code, then, should check to see if `Exception` is not `null`, meaning that an exception was raised while performing the operation.</span></span> <span data-ttu-id="5f6d3-199">In tal caso, è necessario:</span><span class="sxs-lookup"><span data-stu-id="5f6d3-199">If this is the case, we want to:</span></span>

- <span data-ttu-id="5f6d3-200">Visualizzare un messaggio descrittivo nell'etichetta `ExceptionDetails`</span><span class="sxs-lookup"><span data-stu-id="5f6d3-200">Display a user-friendly message in the `ExceptionDetails` Label</span></span>
- <span data-ttu-id="5f6d3-201">Indica che l'eccezione è stata gestita</span><span class="sxs-lookup"><span data-stu-id="5f6d3-201">Indicate that the exception was handled</span></span>
- <span data-ttu-id="5f6d3-202">Mantieni la riga GridView in modalità di modifica</span><span class="sxs-lookup"><span data-stu-id="5f6d3-202">Keep the GridView row in edit mode</span></span>

<span data-ttu-id="5f6d3-203">Il codice seguente realizza questi obiettivi:</span><span class="sxs-lookup"><span data-stu-id="5f6d3-203">This following code accomplishes these objectives:</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample5.vb)]

<span data-ttu-id="5f6d3-204">Questo gestore eventi inizia controllando se `e.Exception` è `null`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-204">This event handler begins by checking to see if `e.Exception` is `null`.</span></span> <span data-ttu-id="5f6d3-205">In caso contrario, la proprietà `Visible` dell'etichetta `ExceptionDetails` è impostata su `true` e la relativa proprietà `Text` su "si è verificato un problema durante l'aggiornamento del prodotto".</span><span class="sxs-lookup"><span data-stu-id="5f6d3-205">If it's not, the `ExceptionDetails` Label's `Visible` property is set to `true` and its `Text` property to "There was a problem updating the product."</span></span> <span data-ttu-id="5f6d3-206">I dettagli dell'eccezione effettiva generata si trovano nella proprietà `InnerException` dell'oggetto `e.Exception`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-206">The details of the actual exception that was thrown reside in the `e.Exception` object's `InnerException` property.</span></span> <span data-ttu-id="5f6d3-207">Questa eccezione interna viene esaminata e, se è di un tipo particolare, viene aggiunto un messaggio aggiuntivo utile alla proprietà `Text` dell'etichetta `ExceptionDetails`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-207">This inner exception is examined and, if it is of a particular type, an additional, helpful message is appended to the `ExceptionDetails` Label's `Text` property.</span></span> <span data-ttu-id="5f6d3-208">Infine, le proprietà `ExceptionHandled` e `KeepInEditMode` sono entrambe impostate su `true`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-208">Lastly, the `ExceptionHandled` and `KeepInEditMode` properties are both set to `true`.</span></span>

<span data-ttu-id="5f6d3-209">La figura 9 Mostra uno screenshot di questa pagina quando si omette il nome del prodotto; La figura 10 Mostra i risultati quando si immette un valore di `UnitPrice` non valido (-50).</span><span class="sxs-lookup"><span data-stu-id="5f6d3-209">Figure 9 shows a screen shot of this page when omitting the name of the product; Figure 10 shows the results when entering an illegal `UnitPrice` value (-50).</span></span>

<span data-ttu-id="5f6d3-210">[![il BoundField di ProductName deve contenere un valore](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-210">[![The ProductName BoundField Must Contain a Value](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image23.png)</span></span>

<span data-ttu-id="5f6d3-211">**Figura 9**: il `ProductName` BoundField deve contenere un valore ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image25.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-211">**Figure 9**: The `ProductName` BoundField Must Contain a Value ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image25.png))</span></span>

<span data-ttu-id="5f6d3-212">[![valori PrezzoUnitario negativi non sono consentiti](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-212">[![Negative UnitPrice Values are Not Allowed](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image26.png)</span></span>

<span data-ttu-id="5f6d3-213">**Figura 10**: i valori di `UnitPrice` negativi non sono consentiti ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image28.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-213">**Figure 10**: Negative `UnitPrice` Values are Not Allowed ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image28.png))</span></span>

<span data-ttu-id="5f6d3-214">Impostando la proprietà `e.ExceptionHandled` su `true`, il gestore dell'evento `RowUpdated` ha indicato che è stata gestita l'eccezione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-214">By setting the `e.ExceptionHandled` property to `true`, the `RowUpdated` event handler has indicated that it has handled the exception.</span></span> <span data-ttu-id="5f6d3-215">Pertanto, l'eccezione non verrà propagata fino al runtime di ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-215">Therefore, the exception won't propagate up to the ASP.NET runtime.</span></span>

> [!NOTE]
> <span data-ttu-id="5f6d3-216">Le figure 9 e 10 mostrano un modo normale per gestire le eccezioni generate a causa di un input utente non valido.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-216">Figures 9 and 10 show a graceful way to handle exceptions raised due to invalid user input.</span></span> <span data-ttu-id="5f6d3-217">Idealmente, tuttavia, tale input non valido non raggiungerà mai il livello della logica di business, perché la pagina ASP.NET deve garantire che gli input dell'utente siano validi prima di richiamare il metodo `UpdateProduct` della classe `ProductsBLL`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-217">Ideally, though, such invalid input will never reach the Business Logic Layer in the first place, as the ASP.NET page should ensure that the user's inputs are valid before invoking the `ProductsBLL` class's `UpdateProduct` method.</span></span> <span data-ttu-id="5f6d3-218">Nell'esercitazione successiva verrà illustrato come aggiungere controlli di convalida alle interfacce di modifica e inserimento per assicurarsi che i dati inviati al livello della logica di business siano conformi alle regole di business.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-218">In our next tutorial we'll see how to add validation controls to the editing and inserting interfaces to ensure that the data submitted to the Business Logic Layer conforms to the business rules.</span></span> <span data-ttu-id="5f6d3-219">I controlli di convalida non solo impediscono la chiamata del metodo `UpdateProduct` fino a quando i dati forniti dall'utente non sono validi, ma forniscono anche un'esperienza utente più informativa per l'identificazione dei problemi di immissione dei dati.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-219">The validation controls not only prevent the invocation of the `UpdateProduct` method until the user-supplied data is valid, but also provide a more informative user experience for identifying data entry problems.</span></span>

## <a name="step-3-gracefully-handling-bll-level-exceptions"></a><span data-ttu-id="5f6d3-220">Passaggio 3: gestione normale delle eccezioni a livello di BLL</span><span class="sxs-lookup"><span data-stu-id="5f6d3-220">Step 3: Gracefully Handling BLL-Level Exceptions</span></span>

<span data-ttu-id="5f6d3-221">Quando si inseriscono, aggiornano o eliminano dati, il livello di accesso ai dati può generare un'eccezione in caso di errore correlato ai dati.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-221">When inserting, updating, or deleting data, the Data Access Layer may throw an exception in the face of a data-related error.</span></span> <span data-ttu-id="5f6d3-222">Il database potrebbe essere offline, una colonna della tabella di database obbligatoria potrebbe non avere un valore specificato oppure è possibile che sia stato violato un vincolo a livello di tabella.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-222">The database may be offline, a required database table column might not have had a value specified, or a table-level constraint may have been violated.</span></span> <span data-ttu-id="5f6d3-223">Oltre alle eccezioni strettamente correlate ai dati, il livello della logica di business può utilizzare le eccezioni per indicare quando le regole business sono state violate.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-223">In addition to strictly data-related exceptions, the Business Logic Layer can use exceptions to indicate when business rules have been violated.</span></span> <span data-ttu-id="5f6d3-224">Nell'esercitazione [creazione di un livello di logica di business](../introduction/creating-a-business-logic-layer-vb.md) , ad esempio, è stato aggiunto un controllo della regola di business all'overload originale del `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-224">In the [Creating a Business Logic Layer](../introduction/creating-a-business-logic-layer-vb.md) tutorial, for example, we added a business rule check to the original `UpdateProduct` overload.</span></span> <span data-ttu-id="5f6d3-225">In particolare, se l'utente contrassegna un prodotto come obsoleto, è necessario che il prodotto non sia l'unico fornito dal fornitore.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-225">Specifically, if the user was marking a product as discontinued, we required that the product not be the only one provided by its supplier.</span></span> <span data-ttu-id="5f6d3-226">Se questa condizione è stata violata, viene generata un'`ApplicationException`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-226">If this condition was violated, an `ApplicationException` was thrown.</span></span>

<span data-ttu-id="5f6d3-227">Per l'overload `UpdateProduct` creato in questa esercitazione, viene aggiunta una regola business che impedisce l'impostazione del campo `UnitPrice` su un nuovo valore superiore al doppio del valore `UnitPrice` originale.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-227">For the `UpdateProduct` overload created in this tutorial, let's add a business rule that prohibits the `UnitPrice` field from being set to a new value that's more than twice the original `UnitPrice` value.</span></span> <span data-ttu-id="5f6d3-228">A tale scopo, modificare l'overload di `UpdateProduct` in modo che esegua questa verifica e genera un'`ApplicationException` se la regola viene violata.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-228">To accomplish this, adjust the `UpdateProduct` overload so that it performs this check and throws an `ApplicationException` if the rule is violated.</span></span> <span data-ttu-id="5f6d3-229">Il metodo aggiornato segue:</span><span class="sxs-lookup"><span data-stu-id="5f6d3-229">The updated method follows:</span></span>

[!code-vb[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/samples/sample6.vb)]

<span data-ttu-id="5f6d3-230">Con questa modifica, qualsiasi aggiornamento del prezzo superiore al doppio del prezzo esistente causerà la generazione di un `ApplicationException`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-230">With this change, any price update that is more than twice the existing price will cause an `ApplicationException` to be thrown.</span></span> <span data-ttu-id="5f6d3-231">Proprio come l'eccezione generata da DAL, questo `ApplicationException` generato da BLL può essere rilevato e gestito nel gestore dell'evento `RowUpdated` di GridView.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-231">Just like the exception raised from the DAL, this BLL-raised `ApplicationException` can be detected and handled in the GridView's `RowUpdated` event handler.</span></span> <span data-ttu-id="5f6d3-232">Infatti, il codice del gestore dell'evento `RowUpdated`, come scritto, rileverà correttamente questa eccezione e visualizzerà il valore della proprietà `Message` della `ApplicationException`.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-232">In fact, the `RowUpdated` event handler's code, as written, will correctly detect this exception and display the `ApplicationException`'s `Message` property value.</span></span> <span data-ttu-id="5f6d3-233">La figura 11 Mostra uno screenshot quando un utente tenta di aggiornare il prezzo di Chai a $50,00, che è più del doppio rispetto al prezzo corrente di $19,95.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-233">Figure 11 shows a screen shot when a user attempts to update the price of Chai to $50.00, which is more than double its current price of $19.95.</span></span>

<span data-ttu-id="5f6d3-234">[![le regole business non consentono un aumento del prezzo superiore al doppio del prezzo di un prodotto](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-234">[![The Business Rules Disallow Price Increases That More Than Double a Product's Price](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image29.png)</span></span>

<span data-ttu-id="5f6d3-235">**Figura 11**: le regole di business non consentono un aumento del prezzo superiore al doppio del prezzo di un prodotto ([fare clic per visualizzare l'immagine con dimensioni complete](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image31.png))</span><span class="sxs-lookup"><span data-stu-id="5f6d3-235">**Figure 11**: The Business Rules Disallow Price Increases That More Than Double a Product's Price ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb/_static/image31.png))</span></span>

> [!NOTE]
> <span data-ttu-id="5f6d3-236">Idealmente, le regole della logica di business verrebbero sottoposte a refactoring fuori dagli overload del metodo `UpdateProduct` e in un metodo comune.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-236">Ideally our business logic rules would be refactored out of the `UpdateProduct` method overloads and into a common method.</span></span> <span data-ttu-id="5f6d3-237">Questa operazione viene lasciata come esercizio per il lettore.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-237">This is left as an exercise for the reader.</span></span>

## <a name="summary"></a><span data-ttu-id="5f6d3-238">Riepilogo</span><span class="sxs-lookup"><span data-stu-id="5f6d3-238">Summary</span></span>

<span data-ttu-id="5f6d3-239">Durante le operazioni di inserimento, aggiornamento ed eliminazione, sia il controllo Web dati che l'oggetto ObjectDataSource interessano eventi di pre-e post-livello che bookend l'operazione effettiva.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-239">During inserting, updating, and deleting operations, both the data Web control and the ObjectDataSource involved fire pre- and post-level events that bookend the actual operation.</span></span> <span data-ttu-id="5f6d3-240">Come illustrato in questa esercitazione e nell'esempio precedente, quando si utilizza un controllo GridView modificabile, l'evento `RowUpdating` GridView viene generato, seguito dall'evento `Updating` di ObjectDataSource, a quel punto il comando Update viene eseguito nell'oggetto sottostante di ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-240">As we saw in this tutorial and the preceding one, when working with an editable GridView the GridView's `RowUpdating` event fires, followed by the ObjectDataSource's `Updating` event, at which point the update command is made to the ObjectDataSource's underlying object.</span></span> <span data-ttu-id="5f6d3-241">Al termine dell'operazione, viene generato l'evento `Updated` di ObjectDataSource, seguito dall'evento `RowUpdated` di GridView.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-241">After the operation has completed, the ObjectDataSource's `Updated` event fires, followed by the GridView's `RowUpdated` event.</span></span>

<span data-ttu-id="5f6d3-242">È possibile creare gestori di eventi per gli eventi di pre-livello per personalizzare i parametri di input o per gli eventi di post-livello, in modo da controllare e rispondere ai risultati dell'operazione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-242">We can create event handlers for the pre-level events in order to customize the input parameters or for the post-level events in order to inspect and respond to the operation's results.</span></span> <span data-ttu-id="5f6d3-243">I gestori eventi di post-Level vengono usati più di frequente per rilevare se si è verificata un'eccezione durante l'operazione.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-243">Post-level event handlers are most commonly used to detect whether an exception occurred during the operation.</span></span> <span data-ttu-id="5f6d3-244">In presenza di un'eccezione, questi gestori di eventi di post-livello possono facoltativamente gestire l'eccezione autonomamente.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-244">In the face of an exception, these post-level event handlers can optionally handle the exception on their own.</span></span> <span data-ttu-id="5f6d3-245">In questa esercitazione è stato illustrato come gestire tale eccezione visualizzando un messaggio di errore descrittivo.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-245">In this tutorial we saw how to handle such an exception by displaying a friendly error message.</span></span>

<span data-ttu-id="5f6d3-246">Nell'esercitazione successiva si vedrà come ridurre la probabilità di eccezioni derivanti da problemi di formattazione dei dati, ad esempio l'immissione di un `UnitPrice`negativo.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-246">In the next tutorial we'll see how to lessen the likelihood of exceptions arising from data formatting issues (such as entering a negative `UnitPrice`).</span></span> <span data-ttu-id="5f6d3-247">In particolare, si esaminerà come aggiungere controlli di convalida alle interfacce di modifica e inserimento.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-247">Specifically, we'll look at how to add validation controls to the editing and inserting interfaces.</span></span>

<span data-ttu-id="5f6d3-248">Buona programmazione!</span><span class="sxs-lookup"><span data-stu-id="5f6d3-248">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="5f6d3-249">Informazioni sull'autore</span><span class="sxs-lookup"><span data-stu-id="5f6d3-249">About the Author</span></span>

<span data-ttu-id="5f6d3-250">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autore di sette ASP/ASP. NET Books e fondatore di [4GuysFromRolla.com](http://www.4guysfromrolla.com), collabora con le tecnologie Web Microsoft a partire da 1998.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-250">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="5f6d3-251">Scott lavora come consulente, trainer e writer indipendenti.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-251">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="5f6d3-252">Il suo ultimo libro è [*Sams Teach Yourself ASP.NET 2,0 in 24 ore*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="5f6d3-252">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="5f6d3-253">Può essere raggiunto in [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-253">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="5f6d3-254">o tramite il suo Blog, disponibile in [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="5f6d3-254">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="5f6d3-255">Grazie speciale</span><span class="sxs-lookup"><span data-stu-id="5f6d3-255">Special Thanks To</span></span>

<span data-ttu-id="5f6d3-256">Questa serie di esercitazioni è stata esaminata da molti revisori utili.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-256">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="5f6d3-257">Il revisore principale di questa esercitazione era Liz Shulok.</span><span class="sxs-lookup"><span data-stu-id="5f6d3-257">Lead reviewer for this tutorial was Liz Shulok.</span></span> <span data-ttu-id="5f6d3-258">Sei interessato a esaminare i miei prossimi articoli MSDN?</span><span class="sxs-lookup"><span data-stu-id="5f6d3-258">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="5f6d3-259">In tal caso, rilasciare una riga in [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-259">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="5f6d3-260">[Precedente](examining-the-events-associated-with-inserting-updating-and-deleting-vb.md)
> [Successivo](adding-validation-controls-to-the-editing-and-inserting-interfaces-vb.md)</span><span class="sxs-lookup"><span data-stu-id="5f6d3-260">[Previous](examining-the-events-associated-with-inserting-updating-and-deleting-vb.md)
[Next](adding-validation-controls-to-the-editing-and-inserting-interfaces-vb.md)</span></span>
