---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs
title: Implementazione della concorrenza ottimistica (C#) | Microsoft Docs
author: rick-anderson
description: Per un'applicazione Web che consente a più utenti di modificare i dati, è possibile che due utenti modifichino contemporaneamente gli stessi dati. In questo tutori...
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 56e15b33-93b8-43ad-8e19-44c6647ea05c
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs
msc.type: authoredcontent
ms.openlocfilehash: 3cddb0efd28249ffc5708ece39c80581d078a5a2
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 11/28/2019
ms.locfileid: "74617023"
---
# <a name="implementing-optimistic-concurrency-c"></a><span data-ttu-id="82b47-104">Implementazione della concorrenza ottimistica (C#)</span><span class="sxs-lookup"><span data-stu-id="82b47-104">Implementing Optimistic Concurrency (C#)</span></span>

<span data-ttu-id="82b47-105">di [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="82b47-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="82b47-106">[Scaricare l'app di esempio](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_CS.exe) o [scaricare il file PDF](implementing-optimistic-concurrency-cs/_static/datatutorial21cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="82b47-106">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_CS.exe) or [Download PDF](implementing-optimistic-concurrency-cs/_static/datatutorial21cs1.pdf)</span></span>

> <span data-ttu-id="82b47-107">Per un'applicazione Web che consente a più utenti di modificare i dati, è possibile che due utenti modifichino contemporaneamente gli stessi dati.</span><span class="sxs-lookup"><span data-stu-id="82b47-107">For a web application that allows multiple users to edit data, there is the risk that two users may be editing the same data at the same time.</span></span> <span data-ttu-id="82b47-108">In questa esercitazione verrà implementato il controllo della concorrenza ottimistica per gestire questo rischio.</span><span class="sxs-lookup"><span data-stu-id="82b47-108">In this tutorial we'll implement optimistic concurrency control to handle this risk.</span></span>

## <a name="introduction"></a><span data-ttu-id="82b47-109">Introduzione</span><span class="sxs-lookup"><span data-stu-id="82b47-109">Introduction</span></span>

<span data-ttu-id="82b47-110">Per le applicazioni Web che consentono agli utenti di visualizzare solo i dati o per quelli che includono solo un singolo utente che può modificare i dati, non esiste alcuna minaccia di due utenti simultanei che sovrascrivono accidentalmente le modifiche apportate da un altro utente.</span><span class="sxs-lookup"><span data-stu-id="82b47-110">For web applications that only allow users to view data, or for those that include only a single user who can modify data, there's no threat of two concurrent users accidentally overwriting one another's changes.</span></span> <span data-ttu-id="82b47-111">Per le applicazioni Web che consentono a più utenti di aggiornare o eliminare dati, tuttavia, è possibile che le modifiche di un utente si scontrino con un altro utente simultaneo.</span><span class="sxs-lookup"><span data-stu-id="82b47-111">For web applications that allow multiple users to update or delete data, however, there's the potential for one user's modifications to clash with another concurrent user's.</span></span> <span data-ttu-id="82b47-112">Senza criteri di concorrenza, quando due utenti modificano contemporaneamente un singolo record, l'utente che esegue il commit delle modifiche sostituirà le modifiche apportate dal primo.</span><span class="sxs-lookup"><span data-stu-id="82b47-112">Without any concurrency policy in place, when two users are simultaneously editing a single record, the user who commits her changes last will override the changes made by the first.</span></span>

<span data-ttu-id="82b47-113">Si supponga, ad esempio, che due utenti, Jisun e Sam, stiano visitando una pagina dell'applicazione che consentiva ai visitatori di aggiornare ed eliminare i prodotti tramite un controllo GridView.</span><span class="sxs-lookup"><span data-stu-id="82b47-113">For example, imagine that two users, Jisun and Sam, were both visiting a page in our application that allowed visitors to update and delete the products through a GridView control.</span></span> <span data-ttu-id="82b47-114">Entrambi fanno clic sul pulsante modifica in GridView intorno allo stesso tempo.</span><span class="sxs-lookup"><span data-stu-id="82b47-114">Both click the Edit button in the GridView around the same time.</span></span> <span data-ttu-id="82b47-115">Jisun modifica il nome del prodotto in "Chai Tea" e fa clic sul pulsante Aggiorna.</span><span class="sxs-lookup"><span data-stu-id="82b47-115">Jisun changes the product name to "Chai Tea" and clicks the Update button.</span></span> <span data-ttu-id="82b47-116">Il risultato finale è un'istruzione `UPDATE` inviata al database, che imposta *tutti* i campi aggiornabili del prodotto (anche se Jisun ha aggiornato solo un campo, `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="82b47-116">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product's updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="82b47-117">In questo momento, il database ha i valori "Chai Tea", la categoria Beverage, il fornitore di liquidi esotici e così via per questo prodotto specifico.</span><span class="sxs-lookup"><span data-stu-id="82b47-117">At this point in time, the database has the values "Chai Tea," the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="82b47-118">Tuttavia, il controllo GridView nella schermata di Sam Mostra ancora il nome del prodotto nella riga di GridView modificabile come "Chai".</span><span class="sxs-lookup"><span data-stu-id="82b47-118">However, the GridView on Sam's screen still shows the product name in the editable GridView row as "Chai".</span></span> <span data-ttu-id="82b47-119">Pochi secondi dopo il commit delle modifiche di Jisun, Sam aggiorna la categoria ai condimenti e fa clic su Aggiorna.</span><span class="sxs-lookup"><span data-stu-id="82b47-119">A few seconds after Jisun's changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="82b47-120">In questo modo si ottiene un'istruzione `UPDATE` inviata al database che imposta il nome del prodotto su "Chai", il `CategoryID` all'ID della categoria bevande corrispondente e così via.</span><span class="sxs-lookup"><span data-stu-id="82b47-120">This results in an `UPDATE` statement sent to the database that sets the product name to "Chai," the `CategoryID` to the corresponding Beverages category ID, and so on.</span></span> <span data-ttu-id="82b47-121">Le modifiche apportate al nome del prodotto da Jisun sono state sovrascritte.</span><span class="sxs-lookup"><span data-stu-id="82b47-121">Jisun's changes to the product name have been overwritten.</span></span> <span data-ttu-id="82b47-122">Nella figura 1 viene illustrata graficamente questa serie di eventi.</span><span class="sxs-lookup"><span data-stu-id="82b47-122">Figure 1 graphically depicts this series of events.</span></span>

<span data-ttu-id="82b47-123">[![quando due utenti aggiornano contemporaneamente un record, è possibile che un utente modifichi le modifiche per sovrascrivere le altre](implementing-optimistic-concurrency-cs/_static/image2.png)](implementing-optimistic-concurrency-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-123">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-cs/_static/image2.png)](implementing-optimistic-concurrency-cs/_static/image1.png)</span></span>

<span data-ttu-id="82b47-124">**Figura 1**: quando due utenti aggiornano contemporaneamente un record, è possibile che un utente modifichi le modifiche per sovrascrivere gli altri ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-124">**Figure 1**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image3.png))</span></span>

<span data-ttu-id="82b47-125">Analogamente, quando due utenti visitano una pagina, un utente potrebbe essere in fase di aggiornamento di un record quando viene eliminato da un altro utente.</span><span class="sxs-lookup"><span data-stu-id="82b47-125">Similarly, when two users are visiting a page, one user might be in the midst of updating a record when it is deleted by another user.</span></span> <span data-ttu-id="82b47-126">In alternativa, quando un utente carica una pagina e fa clic sul pulsante Elimina, è possibile che un altro utente abbia modificato il contenuto del record.</span><span class="sxs-lookup"><span data-stu-id="82b47-126">Or, between when a user loads a page and when they click the Delete button, another user may have modified the contents of that record.</span></span>

<span data-ttu-id="82b47-127">Sono disponibili tre strategie di [controllo della concorrenza](http://en.wikipedia.org/wiki/Concurrency_control) :</span><span class="sxs-lookup"><span data-stu-id="82b47-127">There are three [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) strategies available:</span></span>

- <span data-ttu-id="82b47-128">**Non eseguire alcuna operazione** : se gli utenti simultanei stanno modificando lo stesso record, consentire all'ultimo commit di vincere (comportamento predefinito)</span><span class="sxs-lookup"><span data-stu-id="82b47-128">**Do Nothing** -if concurrent users are modifying the same record, let the last commit win (the default behavior)</span></span>
- <span data-ttu-id="82b47-129">[**Concorrenza ottimistica**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) : si supponga che anche se possono verificarsi conflitti di concorrenza ogni ora e quindi, la maggior parte del tempo di tali conflitti non si verifica; Se pertanto si verifica un conflitto, è sufficiente informare l'utente che non è possibile salvare le modifiche perché un altro utente ha modificato gli stessi dati.</span><span class="sxs-lookup"><span data-stu-id="82b47-129">[**Optimistic Concurrency**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) - assume that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise; therefore, if a conflict does arise, simply inform the user that their changes can't be saved because another user has modified the same data</span></span>
- <span data-ttu-id="82b47-130">**Concorrenza pessimistica** : si supponga che i conflitti di concorrenza siano comuni e che gli utenti non tollerino che le modifiche non siano state salvate a causa dell'attività simultanea di un altro utente. Pertanto, quando un utente inizia ad aggiornare un record, bloccarlo, impedendo così ad altri utenti di modificare o eliminare il record fino a quando l'utente non esegue il commit delle modifiche</span><span class="sxs-lookup"><span data-stu-id="82b47-130">**Pessimistic Concurrency** - assume that concurrency conflicts are commonplace and that users won't tolerate being told their changes weren't saved due to another user's concurrent activity; therefore, when one user starts updating a record, lock it, thereby preventing any other users from editing or deleting that record until the user commits their modifications</span></span>

<span data-ttu-id="82b47-131">Tutte le esercitazioni finora hanno usato la strategia di risoluzione della concorrenza predefinita, vale a dire che è stata lasciata l'ultima scrittura.</span><span class="sxs-lookup"><span data-stu-id="82b47-131">All of our tutorials thus far have used the default concurrency resolution strategy - namely, we've let the last write win.</span></span> <span data-ttu-id="82b47-132">In questa esercitazione verrà esaminato come implementare il controllo della concorrenza ottimistica.</span><span class="sxs-lookup"><span data-stu-id="82b47-132">In this tutorial we'll examine how to implement optimistic concurrency control.</span></span>

> [!NOTE]
> <span data-ttu-id="82b47-133">In questa serie di esercitazioni non verranno esaminati gli esempi di concorrenza pessimistica.</span><span class="sxs-lookup"><span data-stu-id="82b47-133">We won't look at pessimistic concurrency examples in this tutorial series.</span></span> <span data-ttu-id="82b47-134">La concorrenza pessimistica viene utilizzata raramente perché tali blocchi, se non sono stati abbandonati correttamente, possono impedire ad altri utenti di aggiornare i dati.</span><span class="sxs-lookup"><span data-stu-id="82b47-134">Pessimistic concurrency is rarely used because such locks, if not properly relinquished, can prevent other users from updating data.</span></span> <span data-ttu-id="82b47-135">Se, ad esempio, un utente blocca un record per la modifica e quindi lascia il giorno prima di sbloccarlo, nessun altro utente potrà aggiornare tale record fino a quando l'utente originale non restituirà e completerà l'aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="82b47-135">For example, if a user locks a record for editing and then leaves for the day before unlocking it, no other user will be able to update that record until the original user returns and completes his update.</span></span> <span data-ttu-id="82b47-136">Pertanto, in situazioni in cui viene utilizzata la concorrenza pessimistica, in genere si verifica un timeout che, se raggiunto, Annulla il blocco.</span><span class="sxs-lookup"><span data-stu-id="82b47-136">Therefore, in situations where pessimistic concurrency is used, there's typically a timeout that, if reached, cancels the lock.</span></span> <span data-ttu-id="82b47-137">I siti Web di vendita di biglietti, che bloccano una particolare posizione di seduta per un breve periodo di tempo mentre l'utente completa il processo di ordine, è un esempio di controllo della concorrenza pessimistica.</span><span class="sxs-lookup"><span data-stu-id="82b47-137">Ticket sales websites, which lock a particular seating location for short period while the user completes the order process, is an example of pessimistic concurrency control.</span></span>

## <a name="step-1-looking-at-how-optimistic-concurrency-is-implemented"></a><span data-ttu-id="82b47-138">Passaggio 1: esaminare il modo in cui viene implementata la concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="82b47-138">Step 1: Looking at How Optimistic Concurrency is Implemented</span></span>

<span data-ttu-id="82b47-139">Il controllo della concorrenza ottimistica funziona assicurandosi che il record aggiornato o eliminato abbia gli stessi valori di quando è stato avviato il processo di aggiornamento o eliminazione.</span><span class="sxs-lookup"><span data-stu-id="82b47-139">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="82b47-140">Ad esempio, quando si fa clic sul pulsante modifica in un GridView modificabile, i valori del record vengono letti dal database e visualizzati in caselle di testo e altri controlli Web.</span><span class="sxs-lookup"><span data-stu-id="82b47-140">For example, when clicking the Edit button in an editable GridView, the record's values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="82b47-141">Questi valori originali vengono salvati dal controllo GridView.</span><span class="sxs-lookup"><span data-stu-id="82b47-141">These original values are saved by the GridView.</span></span> <span data-ttu-id="82b47-142">Successivamente, dopo che l'utente ha apportato le modifiche e fa clic sul pulsante Aggiorna, i valori originali più i nuovi valori vengono inviati al livello della logica di business e quindi fino al livello di accesso ai dati.</span><span class="sxs-lookup"><span data-stu-id="82b47-142">Later, after the user makes her changes and clicks the Update button, the original values plus the new values are sent to the Business Logic Layer, and then down to the Data Access Layer.</span></span> <span data-ttu-id="82b47-143">Il livello di accesso ai dati deve emettere un'istruzione SQL che aggiornerà il record solo se i valori originali che l'utente ha iniziato a modificare sono identici a quelli ancora presenti nel database.</span><span class="sxs-lookup"><span data-stu-id="82b47-143">The Data Access Layer must issue a SQL statement that will only update the record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="82b47-144">Nella figura 2 viene illustrata questa sequenza di eventi.</span><span class="sxs-lookup"><span data-stu-id="82b47-144">Figure 2 depicts this sequence of events.</span></span>

<span data-ttu-id="82b47-145">[![per la riuscita dell'operazione di aggiornamento o eliminazione, i valori originali devono essere uguali ai valori del database corrente](implementing-optimistic-concurrency-cs/_static/image5.png)](implementing-optimistic-concurrency-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-145">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-cs/_static/image5.png)](implementing-optimistic-concurrency-cs/_static/image4.png)</span></span>

<span data-ttu-id="82b47-146">**Figura 2**: affinché l'aggiornamento o l'eliminazione abbia esito positivo, i valori originali devono essere uguali ai valori di database correnti ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-146">**Figure 2**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image6.png))</span></span>

<span data-ttu-id="82b47-147">Esistono diversi approcci per l'implementazione della concorrenza ottimistica (vedere la logica di aggiornamento della [concorrenza ottimistica](http://www.eggheadcafe.com/articles/20050719.asp) di [Peter a. Bromberg](http://peterbromberg.net/)per una breve panoramica di alcune opzioni).</span><span class="sxs-lookup"><span data-stu-id="82b47-147">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://peterbromberg.net/)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="82b47-148">Il set di dati tipizzato ADO.NET fornisce un'implementazione che può essere configurata solo con il segno di spunta di una casella di controllo.</span><span class="sxs-lookup"><span data-stu-id="82b47-148">The ADO.NET Typed DataSet provides one implementation that can be configured with just the tick of a checkbox.</span></span> <span data-ttu-id="82b47-149">L'abilitazione della concorrenza ottimistica per un TableAdapter nel DataSet tipizzato aumenta le istruzioni `UPDATE` e `DELETE` del TableAdapter per includere un confronto di tutti i valori originali nella clausola `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="82b47-149">Enabling optimistic concurrency for a TableAdapter in the Typed DataSet augments the TableAdapter's `UPDATE` and `DELETE` statements to include a comparison of all of the original values in the `WHERE` clause.</span></span> <span data-ttu-id="82b47-150">L'istruzione `UPDATE` seguente, ad esempio, aggiorna il nome e il prezzo di un prodotto solo se i valori correnti del database sono uguali ai valori recuperati in origine durante l'aggiornamento del record in GridView.</span><span class="sxs-lookup"><span data-stu-id="82b47-150">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="82b47-151">I parametri `@ProductName` e `@UnitPrice` contengono i nuovi valori immessi dall'utente, mentre `@original_ProductName` e `@original_UnitPrice` contengono i valori caricati originariamente in GridView quando è stato fatto clic sul pulsante modifica:</span><span class="sxs-lookup"><span data-stu-id="82b47-151">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-cs/samples/sample1.sql)]

> [!NOTE]
> <span data-ttu-id="82b47-152">Questa istruzione `UPDATE` è stata semplificata per migliorare la leggibilità.</span><span class="sxs-lookup"><span data-stu-id="82b47-152">This `UPDATE` statement has been simplified for readability.</span></span> <span data-ttu-id="82b47-153">In pratica, il controllo `UnitPrice` nella clausola `WHERE` sarebbe più necessario perché `UnitPrice` può contenere `NULL` s e verificare se `NULL = NULL` restituisce sempre false (è invece necessario utilizzare `IS NULL`).</span><span class="sxs-lookup"><span data-stu-id="82b47-153">In practice, the `UnitPrice` check in the `WHERE` clause would be more involved since `UnitPrice` can contain `NULL` s and checking if `NULL = NULL` always returns False (instead you must use `IS NULL`).</span></span>

<span data-ttu-id="82b47-154">Oltre a utilizzare un'istruzione `UPDATE` sottostante diversa, la configurazione di un TableAdapter per l'utilizzo della concorrenza ottimistica modifica anche la firma dei metodi diretti del database.</span><span class="sxs-lookup"><span data-stu-id="82b47-154">In addition to using a different underlying `UPDATE` statement, configuring a TableAdapter to use optimistic concurrency also modifies the signature of its DB direct methods.</span></span> <span data-ttu-id="82b47-155">Dalla prima esercitazione, [*creazione di un livello di accesso ai dati*](../introduction/creating-a-data-access-layer-cs.md), i metodi diretti del database sono quelli che accettano un elenco di valori scalari come parametri di input (anziché un'istanza DataRow o DataTable fortemente tipizzata).</span><span class="sxs-lookup"><span data-stu-id="82b47-155">Recall from our first tutorial, [*Creating a Data Access Layer*](../introduction/creating-a-data-access-layer-cs.md), that DB direct methods were those that accepts a list of scalar values as input parameters (rather than a strongly-typed DataRow or DataTable instance).</span></span> <span data-ttu-id="82b47-156">Quando si usa la concorrenza ottimistica, i metodi `Update()` e `Delete()` di DB Direct includono anche parametri di input per i valori originali.</span><span class="sxs-lookup"><span data-stu-id="82b47-156">When using optimistic concurrency, the DB direct `Update()` and `Delete()` methods include input parameters for the original values as well.</span></span> <span data-ttu-id="82b47-157">Inoltre, è necessario modificare anche il codice in BLL per l'utilizzo del modello di aggiornamento batch (gli overload del metodo `Update()` che accettano DataRows e DataTables anziché i valori scalari).</span><span class="sxs-lookup"><span data-stu-id="82b47-157">Moreover, the code in the BLL for using the batch update pattern (the `Update()` method overloads that accept DataRows and DataTables rather than scalar values) must be changed as well.</span></span>

<span data-ttu-id="82b47-158">Anziché estendere i TableAdapter esistenti di DAL per usare la concorrenza ottimistica (che richiederebbe la modifica del BLL per adattarsi), verrà invece creato un nuovo set di dati tipizzato denominato `NorthwindOptimisticConcurrency`, a cui si aggiungerà un `Products` TableAdapter che usa la concorrenza ottimistica.</span><span class="sxs-lookup"><span data-stu-id="82b47-158">Rather than extend our existing DAL's TableAdapters to use optimistic concurrency (which would necessitate changing the BLL to accommodate), let's instead create a new Typed DataSet named `NorthwindOptimisticConcurrency`, to which we'll add a `Products` TableAdapter that uses optimistic concurrency.</span></span> <span data-ttu-id="82b47-159">Successivamente, verrà creata una classe `ProductsOptimisticConcurrencyBLL` livello della logica di business che presenta le modifiche appropriate per supportare il DAL di concorrenza ottimistica.</span><span class="sxs-lookup"><span data-stu-id="82b47-159">Following that, we'll create a `ProductsOptimisticConcurrencyBLL` Business Logic Layer class that has the appropriate modifications to support the optimistic concurrency DAL.</span></span> <span data-ttu-id="82b47-160">Al termine di questa operazione, si sarà pronti per creare la pagina ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="82b47-160">Once this groundwork has been laid, we'll be ready to create the ASP.NET page.</span></span>

## <a name="step-2-creating-a-data-access-layer-that-supports-optimistic-concurrency"></a><span data-ttu-id="82b47-161">Passaggio 2: creazione di un livello di accesso ai dati che supporta la concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="82b47-161">Step 2: Creating a Data Access Layer That Supports Optimistic Concurrency</span></span>

<span data-ttu-id="82b47-162">Per creare un nuovo set di dati tipizzato, fare clic con il pulsante destro del mouse sulla cartella `DAL` all'interno della cartella `App_Code` e aggiungere un nuovo set di dati denominato `NorthwindOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="82b47-162">To create a new Typed DataSet, right-click on the `DAL` folder within the `App_Code` folder and add a new DataSet named `NorthwindOptimisticConcurrency`.</span></span> <span data-ttu-id="82b47-163">Come illustrato nella prima esercitazione, in questo modo verrà aggiunto un nuovo TableAdapter al set di dati tipizzato, avviando automaticamente la configurazione guidata TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="82b47-163">As we saw in the first tutorial, doing so will add a new TableAdapter to the Typed DataSet, automatically launching the TableAdapter Configuration Wizard.</span></span> <span data-ttu-id="82b47-164">Nella prima schermata, viene richiesto di specificare il database a cui connettersi per connettersi allo stesso database Northwind usando l'impostazione `NORTHWNDConnectionString` da `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="82b47-164">In the first screen, we're prompted to specify the database to connect to - connect to the same Northwind database using the `NORTHWNDConnectionString` setting from `Web.config`.</span></span>

<span data-ttu-id="82b47-165">[![connettersi allo stesso database Northwind](implementing-optimistic-concurrency-cs/_static/image8.png)](implementing-optimistic-concurrency-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-165">[![Connect to the Same Northwind Database](implementing-optimistic-concurrency-cs/_static/image8.png)](implementing-optimistic-concurrency-cs/_static/image7.png)</span></span>

<span data-ttu-id="82b47-166">**Figura 3**: connettersi allo stesso database Northwind ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-166">**Figure 3**: Connect to the Same Northwind Database ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image9.png))</span></span>

<span data-ttu-id="82b47-167">Viene quindi richiesto come eseguire una query sui dati: tramite un'istruzione SQL ad hoc, un nuovo stored procedure o un stored procedure esistente.</span><span class="sxs-lookup"><span data-stu-id="82b47-167">Next, we are prompted as to how to query the data: through an ad-hoc SQL statement, a new stored procedure, or an existing stored procedure.</span></span> <span data-ttu-id="82b47-168">Dal momento che sono state usate query SQL ad hoc nell'origine DAL, usare anche questa opzione.</span><span class="sxs-lookup"><span data-stu-id="82b47-168">Since we used ad-hoc SQL queries in our original DAL, use this option here as well.</span></span>

<span data-ttu-id="82b47-169">[![specificare i dati da recuperare mediante un'istruzione SQL ad hoc](implementing-optimistic-concurrency-cs/_static/image11.png)](implementing-optimistic-concurrency-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-169">[![Specify the Data to Retrieve Using an Ad-Hoc SQL Statement](implementing-optimistic-concurrency-cs/_static/image11.png)](implementing-optimistic-concurrency-cs/_static/image10.png)</span></span>

<span data-ttu-id="82b47-170">**Figura 4**: specificare i dati da recuperare mediante un'istruzione SQL ad hoc ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-170">**Figure 4**: Specify the Data to Retrieve Using an Ad-Hoc SQL Statement ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image12.png))</span></span>

<span data-ttu-id="82b47-171">Nella schermata seguente immettere la query SQL da utilizzare per recuperare le informazioni sul prodotto.</span><span class="sxs-lookup"><span data-stu-id="82b47-171">On the following screen, enter the SQL query to use to retrieve the product information.</span></span> <span data-ttu-id="82b47-172">Si userà esattamente la stessa query SQL usata per il `Products` TableAdapter dal codice originale dal, che restituisce tutte le `Product` colonne insieme ai nomi di fornitore e categoria del prodotto:</span><span class="sxs-lookup"><span data-stu-id="82b47-172">Let's use the exact same SQL query used for the `Products` TableAdapter from our original DAL, which returns all of the `Product` columns along with the product's supplier and category names:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-cs/samples/sample2.sql)]

<span data-ttu-id="82b47-173">[![usare la stessa query SQL dal TableAdapter Products nel prodotto originale dal](implementing-optimistic-concurrency-cs/_static/image14.png)](implementing-optimistic-concurrency-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-173">[![Use the Same SQL Query from the Products TableAdapter in the Original DAL](implementing-optimistic-concurrency-cs/_static/image14.png)](implementing-optimistic-concurrency-cs/_static/image13.png)</span></span>

<span data-ttu-id="82b47-174">**Figura 5**: usare la stessa query SQL dal TableAdapter `Products` nel valore originale dal ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-174">**Figure 5**: Use the Same SQL Query from the `Products` TableAdapter in the Original DAL ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image15.png))</span></span>

<span data-ttu-id="82b47-175">Prima di passare alla schermata successiva, fare clic sul pulsante Opzioni avanzate.</span><span class="sxs-lookup"><span data-stu-id="82b47-175">Before moving onto the next screen, click the Advanced Options button.</span></span> <span data-ttu-id="82b47-176">Per fare in modo che questo TableAdapter usi il controllo della concorrenza ottimistica, è sufficiente selezionare la casella di controllo "Usa concorrenza ottimistica".</span><span class="sxs-lookup"><span data-stu-id="82b47-176">To have this TableAdapter employ optimistic concurrency control, simply check the "Use optimistic concurrency" checkbox.</span></span>

<span data-ttu-id="82b47-177">[![abilitare il controllo della concorrenza ottimistica selezionando la casella di controllo &quot;USA concorrenza ottimistica&quot;](implementing-optimistic-concurrency-cs/_static/image17.png)](implementing-optimistic-concurrency-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-177">[![Enable Optimistic Concurrency Control by Checking the &quot;Use optimistic concurrency&quot; CheckBox](implementing-optimistic-concurrency-cs/_static/image17.png)](implementing-optimistic-concurrency-cs/_static/image16.png)</span></span>

<span data-ttu-id="82b47-178">**Figura 6**: abilitare il controllo della concorrenza ottimistica selezionando la casella di controllo "Usa concorrenza ottimistica" ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-178">**Figure 6**: Enable Optimistic Concurrency Control by Checking the "Use optimistic concurrency" CheckBox ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image18.png))</span></span>

<span data-ttu-id="82b47-179">Infine, indicare che il TableAdapter deve usare i modelli di accesso ai dati che compilano un DataTable e restituiscono un DataTable; indica inoltre che è necessario creare i metodi diretti del database.</span><span class="sxs-lookup"><span data-stu-id="82b47-179">Lastly, indicate that the TableAdapter should use the data access patterns that both fill a DataTable and return a DataTable; also indicate that the DB direct methods should be created.</span></span> <span data-ttu-id="82b47-180">Modificare il nome del metodo per la restituzione di un modello DataTable da GetData a GetProducts, in modo da eseguire il mirroring delle convenzioni di denominazione usate nell'originale DAL.</span><span class="sxs-lookup"><span data-stu-id="82b47-180">Change the method name for the Return a DataTable pattern from GetData to GetProducts, so as to mirror the naming conventions we used in our original DAL.</span></span>

<span data-ttu-id="82b47-181">[![il TableAdapter utilizza tutti i modelli di accesso ai dati](implementing-optimistic-concurrency-cs/_static/image20.png)](implementing-optimistic-concurrency-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-181">[![Have the TableAdapter Utilize All Data Access Patterns](implementing-optimistic-concurrency-cs/_static/image20.png)](implementing-optimistic-concurrency-cs/_static/image19.png)</span></span>

<span data-ttu-id="82b47-182">**Figura 7**: fare in modo che TableAdapter utilizzi tutti i modelli di accesso ai dati ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-182">**Figure 7**: Have the TableAdapter Utilize All Data Access Patterns ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image21.png))</span></span>

<span data-ttu-id="82b47-183">Al termine della procedura guidata, Progettazione DataSet includerà un `Products` DataTable e un TableAdapter fortemente tipizzati.</span><span class="sxs-lookup"><span data-stu-id="82b47-183">After completing the wizard, the DataSet Designer will include a strongly-typed `Products` DataTable and TableAdapter.</span></span> <span data-ttu-id="82b47-184">Per rinominare il DataTable da `Products` a `ProductsOptimisticConcurrency`, è possibile fare clic con il pulsante destro del mouse sulla barra del titolo della DataTable e scegliere Rinomina dal menu di scelta rapida.</span><span class="sxs-lookup"><span data-stu-id="82b47-184">Take a moment to rename the DataTable from `Products` to `ProductsOptimisticConcurrency`, which you can do by right-clicking on the DataTable's title bar and choosing Rename from the context menu.</span></span>

<span data-ttu-id="82b47-185">[![DataTable e TableAdapter aggiunti al DataSet tipizzato](implementing-optimistic-concurrency-cs/_static/image23.png)](implementing-optimistic-concurrency-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-185">[![A DataTable and TableAdapter Have Been Added to the Typed DataSet](implementing-optimistic-concurrency-cs/_static/image23.png)](implementing-optimistic-concurrency-cs/_static/image22.png)</span></span>

<span data-ttu-id="82b47-186">**Figura 8**: è stato aggiunto un oggetto DataTable e un TableAdapter al set di dati tipizzato ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-186">**Figure 8**: A DataTable and TableAdapter Have Been Added to the Typed DataSet ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image24.png))</span></span>

<span data-ttu-id="82b47-187">Per visualizzare le differenze tra le query di `UPDATE` e `DELETE` tra il `ProductsOptimisticConcurrency` TableAdapter (che usa la concorrenza ottimistica) e l'oggetto TableAdapter dei prodotti (che non lo è), fare clic sul TableAdapter e passare al Finestra Proprietà.</span><span class="sxs-lookup"><span data-stu-id="82b47-187">To see the differences between the `UPDATE` and `DELETE` queries between the `ProductsOptimisticConcurrency` TableAdapter (which uses optimistic concurrency) and the Products TableAdapter (which doesn't), click on the TableAdapter and go to the Properties window.</span></span> <span data-ttu-id="82b47-188">Nelle proprietà `DeleteCommand` e `UpdateCommand`' `CommandText` le sottoproprietà è possibile visualizzare la sintassi SQL effettiva inviata al database quando vengono richiamati i metodi di aggiornamento o eliminazione di DAL.</span><span class="sxs-lookup"><span data-stu-id="82b47-188">In the `DeleteCommand` and `UpdateCommand` properties' `CommandText` subproperties you can see the actual SQL syntax that is sent to the database when the DAL's update or delete-related methods are invoked.</span></span> <span data-ttu-id="82b47-189">Per il `ProductsOptimisticConcurrency` TableAdapter, viene utilizzata l'istruzione `DELETE`:</span><span class="sxs-lookup"><span data-stu-id="82b47-189">For the `ProductsOptimisticConcurrency` TableAdapter the `DELETE` statement used is:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-cs/samples/sample3.sql)]

<span data-ttu-id="82b47-190">Mentre l'istruzione `DELETE` per il TableAdapter del prodotto nell'originale DAL è molto più semplice:</span><span class="sxs-lookup"><span data-stu-id="82b47-190">Whereas the `DELETE` statement for the Product TableAdapter in our original DAL is the much simpler:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-cs/samples/sample4.sql)]

<span data-ttu-id="82b47-191">Come si può notare, la clausola `WHERE` nell'istruzione `DELETE` per il TableAdapter che usa la concorrenza ottimistica include un confronto tra ognuno dei valori di colonna esistenti della tabella `Product` e i valori originali nel momento in cui è stato popolato l'ultima volta GridView (o DetailsView o FormView).</span><span class="sxs-lookup"><span data-stu-id="82b47-191">As you can see, the `WHERE` clause in the `DELETE` statement for the TableAdapter that uses optimistic concurrency includes a comparison between each of the `Product` table's existing column values and the original values at the time the GridView (or DetailsView or FormView) was last populated.</span></span> <span data-ttu-id="82b47-192">Poiché tutti i campi diversi da `ProductID`, `ProductName`e `Discontinued` possono avere valori di `NULL`, vengono inclusi parametri aggiuntivi e controlli per confrontare correttamente `NULL` valori nella clausola `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="82b47-192">Since all fields other than `ProductID`, `ProductName`, and `Discontinued` can have `NULL` values, additional parameters and checks are included to correctly compare `NULL` values in the `WHERE` clause.</span></span>

<span data-ttu-id="82b47-193">Non verrà aggiunta alcuna tabella dati aggiuntiva al set di dati che supporta la concorrenza ottimistica per questa esercitazione, in quanto la pagina ASP.NET fornirà solo le informazioni sul prodotto per l'aggiornamento e l'eliminazione.</span><span class="sxs-lookup"><span data-stu-id="82b47-193">We won't be adding any additional DataTables to the optimistic concurrency-enabled DataSet for this tutorial, as our ASP.NET page will only provide updating and deleting product information.</span></span> <span data-ttu-id="82b47-194">Tuttavia, è ancora necessario aggiungere il metodo `GetProductByProductID(productID)` al `ProductsOptimisticConcurrency` TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="82b47-194">However, we do still need to add the `GetProductByProductID(productID)` method to the `ProductsOptimisticConcurrency` TableAdapter.</span></span>

<span data-ttu-id="82b47-195">A tale scopo, fare clic con il pulsante destro del mouse sulla barra del titolo del TableAdapter (l'area al di sopra dei nomi dei metodi `Fill` e `GetProducts`) e scegliere Aggiungi query dal menu di scelta rapida.</span><span class="sxs-lookup"><span data-stu-id="82b47-195">To accomplish this, right-click on the TableAdapter's title bar (the area right above the `Fill` and `GetProducts` method names) and choose Add Query from the context menu.</span></span> <span data-ttu-id="82b47-196">Verrà avviata la configurazione guidata query TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="82b47-196">This will launch the TableAdapter Query Configuration Wizard.</span></span> <span data-ttu-id="82b47-197">Come per la configurazione iniziale del TableAdapter, scegliere di creare il metodo `GetProductByProductID(productID)` usando un'istruzione SQL ad hoc (vedere la figura 4).</span><span class="sxs-lookup"><span data-stu-id="82b47-197">As with our TableAdapter's initial configuration, opt to create the `GetProductByProductID(productID)` method using an ad-hoc SQL statement (see Figure 4).</span></span> <span data-ttu-id="82b47-198">Poiché il metodo `GetProductByProductID(productID)` restituisce informazioni su un determinato prodotto, indicare che questa query è un tipo di query `SELECT` che restituisce righe.</span><span class="sxs-lookup"><span data-stu-id="82b47-198">Since the `GetProductByProductID(productID)` method returns information about a particular product, indicate that this query is a `SELECT` query type that returns rows.</span></span>

<span data-ttu-id="82b47-199">[![contrassegnare il tipo di query come &quot;SELECT che restituisce righe&quot;](implementing-optimistic-concurrency-cs/_static/image26.png)](implementing-optimistic-concurrency-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-199">[![Mark the Query Type as a &quot;SELECT which returns rows&quot;](implementing-optimistic-concurrency-cs/_static/image26.png)](implementing-optimistic-concurrency-cs/_static/image25.png)</span></span>

<span data-ttu-id="82b47-200">**Figura 9**: contrassegnare il tipo di query come "`SELECT` che restituisce righe" ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-200">**Figure 9**: Mark the Query Type as a "`SELECT` which returns rows" ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image27.png))</span></span>

<span data-ttu-id="82b47-201">Nella schermata successiva viene richiesto di usare la query SQL, con la query predefinita del TableAdapter pre-caricata.</span><span class="sxs-lookup"><span data-stu-id="82b47-201">On the next screen we're prompted for the SQL query to use, with the TableAdapter's default query pre-loaded.</span></span> <span data-ttu-id="82b47-202">Aumentare la query esistente per includere la clausola `WHERE ProductID = @ProductID`, come illustrato nella figura 10.</span><span class="sxs-lookup"><span data-stu-id="82b47-202">Augment the existing query to include the clause `WHERE ProductID = @ProductID`, as shown in Figure 10.</span></span>

<span data-ttu-id="82b47-203">[![aggiungere una clausola WHERE alla query precaricata per restituire un record di prodotto specifico](implementing-optimistic-concurrency-cs/_static/image29.png)](implementing-optimistic-concurrency-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-203">[![Add a WHERE Clause to the Pre-Loaded Query to Return a Specific Product Record](implementing-optimistic-concurrency-cs/_static/image29.png)](implementing-optimistic-concurrency-cs/_static/image28.png)</span></span>

<span data-ttu-id="82b47-204">**Figura 10**: aggiungere una clausola `WHERE` alla query precaricata per restituire un record di prodotto specifico ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-204">**Figure 10**: Add a `WHERE` Clause to the Pre-Loaded Query to Return a Specific Product Record ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image30.png))</span></span>

<span data-ttu-id="82b47-205">Infine, modificare i nomi dei metodi generati `FillByProductID` e `GetProductByProductID`.</span><span class="sxs-lookup"><span data-stu-id="82b47-205">Finally, change the generated method names to `FillByProductID` and `GetProductByProductID`.</span></span>

<span data-ttu-id="82b47-206">[![rinominare i metodi in FillByProductID e GetProductByProductID](implementing-optimistic-concurrency-cs/_static/image32.png)](implementing-optimistic-concurrency-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-206">[![Rename the Methods to FillByProductID and GetProductByProductID](implementing-optimistic-concurrency-cs/_static/image32.png)](implementing-optimistic-concurrency-cs/_static/image31.png)</span></span>

<span data-ttu-id="82b47-207">**Figura 11**: rinominare i metodi `FillByProductID` e `GetProductByProductID` ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-207">**Figure 11**: Rename the Methods to `FillByProductID` and `GetProductByProductID` ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image33.png))</span></span>

<span data-ttu-id="82b47-208">Una volta completata questa procedura guidata, il TableAdapter contiene ora due metodi per il recupero dei dati: `GetProducts()`, che restituisce *tutti i* prodotti; e `GetProductByProductID(productID)`, che restituisce il prodotto specificato.</span><span class="sxs-lookup"><span data-stu-id="82b47-208">With this wizard complete, the TableAdapter now contains two methods for retrieving data: `GetProducts()`, which returns *all* products; and `GetProductByProductID(productID)`, which returns the specified product.</span></span>

## <a name="step-3-creating-a-business-logic-layer-for-the-optimistic-concurrency-enabled-dal"></a><span data-ttu-id="82b47-209">Passaggio 3: creazione di un livello di logica di business per l'abilitazione della concorrenza ottimistica DAL</span><span class="sxs-lookup"><span data-stu-id="82b47-209">Step 3: Creating a Business Logic Layer for the Optimistic Concurrency-Enabled DAL</span></span>

<span data-ttu-id="82b47-210">La classe `ProductsBLL` esistente include esempi di utilizzo dei modelli di aggiornamento batch e del database diretto.</span><span class="sxs-lookup"><span data-stu-id="82b47-210">Our existing `ProductsBLL` class has examples of using both the batch update and DB direct patterns.</span></span> <span data-ttu-id="82b47-211">Il metodo `AddProduct` e i `UpdateProduct` Overload usano entrambi il modello di aggiornamento batch, passando un'istanza `ProductRow` al metodo Update del TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="82b47-211">The `AddProduct` method and `UpdateProduct` overloads both use the batch update pattern, passing in a `ProductRow` instance to the TableAdapter's Update method.</span></span> <span data-ttu-id="82b47-212">Il metodo `DeleteProduct`, d'altra parte, usa il modello diretto del database, chiamando il metodo di `Delete(productID)` del TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="82b47-212">The `DeleteProduct` method, on the other hand, uses the DB direct pattern, calling the TableAdapter's `Delete(productID)` method.</span></span>

<span data-ttu-id="82b47-213">Con il nuovo `ProductsOptimisticConcurrency` TableAdapter, i metodi diretti del database richiedono ora che vengano passati anche i valori originali.</span><span class="sxs-lookup"><span data-stu-id="82b47-213">With the new `ProductsOptimisticConcurrency` TableAdapter, the DB direct methods now require that the original values also be passed in.</span></span> <span data-ttu-id="82b47-214">Ad esempio, il metodo `Delete` prevede ora dieci parametri di input: `ProductID`originale, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`e `Discontinued`.</span><span class="sxs-lookup"><span data-stu-id="82b47-214">For example, the `Delete` method now expects ten input parameters: the original `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`, and `Discontinued`.</span></span> <span data-ttu-id="82b47-215">Vengono utilizzati i valori dei parametri di input aggiuntivi nella clausola `WHERE` dell'istruzione `DELETE` inviata al database, eliminando solo il record specificato se i valori correnti del database vengono mappati a quelli originali.</span><span class="sxs-lookup"><span data-stu-id="82b47-215">It uses these additional input parameters' values in `WHERE` clause of the `DELETE` statement sent to the database, only deleting the specified record if the database's current values map up to the original ones.</span></span>

<span data-ttu-id="82b47-216">Sebbene la firma del metodo per il `Update` metodo del TableAdapter utilizzato nel modello di aggiornamento batch non sia cambiata, il codice necessario per registrare i valori originali e nuovi ha.</span><span class="sxs-lookup"><span data-stu-id="82b47-216">While the method signature for the TableAdapter's `Update` method used in the batch update pattern hasn't changed, the code needed to record the original and new values has.</span></span> <span data-ttu-id="82b47-217">Quindi, anziché tentare di usare il codice di concorrenza ottimistica con la classe di `ProductsBLL` esistente, creiamo una nuova classe di livello della logica di business per lavorare con il nuovo DAL.</span><span class="sxs-lookup"><span data-stu-id="82b47-217">Therefore, rather than attempt to use the optimistic concurrency-enabled DAL with our existing `ProductsBLL` class, let's create a new Business Logic Layer class for working with our new DAL.</span></span>

<span data-ttu-id="82b47-218">Aggiungere una classe denominata `ProductsOptimisticConcurrencyBLL` alla cartella `BLL` all'interno della cartella `App_Code`.</span><span class="sxs-lookup"><span data-stu-id="82b47-218">Add a class named `ProductsOptimisticConcurrencyBLL` to the `BLL` folder within the `App_Code` folder.</span></span>

![Aggiungere la classe ProductsOptimisticConcurrencyBLL alla cartella BLL](implementing-optimistic-concurrency-cs/_static/image34.png)

<span data-ttu-id="82b47-220">**Figura 12**: aggiungere la classe `ProductsOptimisticConcurrencyBLL` alla cartella BLL</span><span class="sxs-lookup"><span data-stu-id="82b47-220">**Figure 12**: Add the `ProductsOptimisticConcurrencyBLL` Class to the BLL Folder</span></span>

<span data-ttu-id="82b47-221">Aggiungere quindi il codice seguente alla classe `ProductsOptimisticConcurrencyBLL`:</span><span class="sxs-lookup"><span data-stu-id="82b47-221">Next, add the following code to the `ProductsOptimisticConcurrencyBLL` class:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample5.cs)]

<span data-ttu-id="82b47-222">Si noti l'istruzione using `NorthwindOptimisticConcurrencyTableAdapters` sopra l'inizio della dichiarazione di classe.</span><span class="sxs-lookup"><span data-stu-id="82b47-222">Note the using `NorthwindOptimisticConcurrencyTableAdapters` statement above the start of the class declaration.</span></span> <span data-ttu-id="82b47-223">Lo spazio dei nomi `NorthwindOptimisticConcurrencyTableAdapters` contiene la classe `ProductsOptimisticConcurrencyTableAdapter`, che fornisce i metodi DAL.</span><span class="sxs-lookup"><span data-stu-id="82b47-223">The `NorthwindOptimisticConcurrencyTableAdapters` namespace contains the `ProductsOptimisticConcurrencyTableAdapter` class, which provides the DAL's methods.</span></span> <span data-ttu-id="82b47-224">Inoltre, prima della dichiarazione di classe è possibile trovare l'attributo `System.ComponentModel.DataObject`, che indica a Visual Studio di includere questa classe nell'elenco a discesa della procedura guidata di ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="82b47-224">Also before the class declaration you'll find the `System.ComponentModel.DataObject` attribute, which instructs Visual Studio to include this class in the ObjectDataSource wizard's drop-down list.</span></span>

<span data-ttu-id="82b47-225">La proprietà `Adapter` di `ProductsOptimisticConcurrencyBLL`consente di accedere rapidamente a un'istanza della classe `ProductsOptimisticConcurrencyTableAdapter` e segue il modello utilizzato nelle classi BLL originali (`ProductsBLL`, `CategoriesBLL`e così via).</span><span class="sxs-lookup"><span data-stu-id="82b47-225">The `ProductsOptimisticConcurrencyBLL`'s `Adapter` property provides quick access to an instance of the `ProductsOptimisticConcurrencyTableAdapter` class, and follows the pattern used in our original BLL classes (`ProductsBLL`, `CategoriesBLL`, and so on).</span></span> <span data-ttu-id="82b47-226">Infine, il metodo di `GetProducts()` chiama semplicemente il metodo di `GetProducts()` DAL e restituisce un oggetto `ProductsOptimisticConcurrencyDataTable` popolato con un'istanza di `ProductsOptimisticConcurrencyRow` per ogni record di prodotto nel database.</span><span class="sxs-lookup"><span data-stu-id="82b47-226">Finally, the `GetProducts()` method simply calls down into the DAL's `GetProducts()` method and returns a `ProductsOptimisticConcurrencyDataTable` object populated with a `ProductsOptimisticConcurrencyRow` instance for each product record in the database.</span></span>

## <a name="deleting-a-product-using-the-db-direct-pattern-with-optimistic-concurrency"></a><span data-ttu-id="82b47-227">Eliminazione di un prodotto utilizzando il modello diretto del database con concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="82b47-227">Deleting a Product Using the DB Direct Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="82b47-228">Quando si utilizza il modello di database diretto per un DAL che utilizza la concorrenza ottimistica, è necessario che ai metodi vengano passati i valori nuovi e originali.</span><span class="sxs-lookup"><span data-stu-id="82b47-228">When using the DB direct pattern against a DAL that uses optimistic concurrency, the methods must be passed the new and original values.</span></span> <span data-ttu-id="82b47-229">Per eliminare, non sono presenti nuovi valori, quindi è necessario passare solo i valori originali.</span><span class="sxs-lookup"><span data-stu-id="82b47-229">For deleting, there are no new values, so only the original values need be passed in.</span></span> <span data-ttu-id="82b47-230">Nel nostro BLL, dobbiamo accettare tutti i parametri originali come parametri di input.</span><span class="sxs-lookup"><span data-stu-id="82b47-230">In our BLL, then, we must accept all of the original parameters as input parameters.</span></span> <span data-ttu-id="82b47-231">Il metodo `DeleteProduct` nella classe `ProductsOptimisticConcurrencyBLL` usa il metodo diretto del database.</span><span class="sxs-lookup"><span data-stu-id="82b47-231">Let's have the `DeleteProduct` method in the `ProductsOptimisticConcurrencyBLL` class use the DB direct method.</span></span> <span data-ttu-id="82b47-232">Questo significa che questo metodo deve assumere tutti i dieci campi dati del prodotto come parametri di input e passarli al DAL, come illustrato nel codice seguente:</span><span class="sxs-lookup"><span data-stu-id="82b47-232">This means that this method needs to take in all ten product data fields as input parameters, and pass these to the DAL, as shown in the following code:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample6.cs)]

<span data-ttu-id="82b47-233">Se i valori originali, ovvero i valori che sono stati caricati per ultimi in GridView (o DetailsView o FormView), differiscono dai valori nel database quando l'utente fa clic sul pulsante Elimina la clausola `WHERE` non corrisponderà ad alcun record del database e non sarà interessato alcun record.</span><span class="sxs-lookup"><span data-stu-id="82b47-233">If the original values - those values that were last loaded into the GridView (or DetailsView or FormView) - differ from the values in the database when the user clicks the Delete button the `WHERE` clause won't match up with any database record and no records will be affected.</span></span> <span data-ttu-id="82b47-234">Di conseguenza, il metodo di `Delete` del TableAdapter restituirà `0` e il metodo di `DeleteProduct` di BLL restituirà `false`.</span><span class="sxs-lookup"><span data-stu-id="82b47-234">Hence, the TableAdapter's `Delete` method will return `0` and the BLL's `DeleteProduct` method will return `false`.</span></span>

## <a name="updating-a-product-using-the-batch-update-pattern-with-optimistic-concurrency"></a><span data-ttu-id="82b47-235">Aggiornamento di un prodotto utilizzando il modello di aggiornamento batch con concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="82b47-235">Updating a Product Using the Batch Update Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="82b47-236">Come indicato in precedenza, il metodo `Update` del TableAdapter per il modello di aggiornamento batch ha la stessa firma del metodo, indipendentemente dal fatto che venga utilizzata o meno la concorrenza ottimistica.</span><span class="sxs-lookup"><span data-stu-id="82b47-236">As noted earlier, the TableAdapter's `Update` method for the batch update pattern has the same method signature regardless of whether or not optimistic concurrency is employed.</span></span> <span data-ttu-id="82b47-237">In particolare, il metodo `Update` prevede un DataRow, una matrice di oggetti DataRows, un oggetto DataTable o un DataSet tipizzato.</span><span class="sxs-lookup"><span data-stu-id="82b47-237">Namely, the `Update` method expects a DataRow, an array of DataRows, a DataTable, or a Typed DataSet.</span></span> <span data-ttu-id="82b47-238">Non sono presenti parametri di input aggiuntivi per specificare i valori originali.</span><span class="sxs-lookup"><span data-stu-id="82b47-238">There are no additional input parameters for specifying the original values.</span></span> <span data-ttu-id="82b47-239">Questa operazione è possibile perché la DataTable tiene traccia dei valori originali e modificati per i relativi DataRow.</span><span class="sxs-lookup"><span data-stu-id="82b47-239">This is possible because the DataTable keeps track of the original and modified values for its DataRow(s).</span></span> <span data-ttu-id="82b47-240">Quando il DAL emette la relativa istruzione `UPDATE`, i parametri del `@original_ColumnName` vengono popolati con i valori originali di DataRow, mentre i parametri di `@ColumnName` vengono popolati con i valori modificati di DataRow.</span><span class="sxs-lookup"><span data-stu-id="82b47-240">When the DAL issues its `UPDATE` statement, the `@original_ColumnName` parameters are populated with the DataRow's original values, whereas the `@ColumnName` parameters are populated with the DataRow's modified values.</span></span>

<span data-ttu-id="82b47-241">Nella classe `ProductsBLL` (che usa la nostra concorrenza originale, non ottimistica), quando si usa il modello di aggiornamento batch per aggiornare le informazioni sul prodotto, il codice esegue la sequenza di eventi seguente:</span><span class="sxs-lookup"><span data-stu-id="82b47-241">In the `ProductsBLL` class (which uses our original, non-optimistic concurrency DAL), when using the batch update pattern to update product information our code performs the following sequence of events:</span></span>

1. <span data-ttu-id="82b47-242">Leggere le informazioni sul prodotto del database corrente in un'istanza di `ProductRow` usando il metodo `GetProductByProductID(productID)` del TableAdapter</span><span class="sxs-lookup"><span data-stu-id="82b47-242">Read the current database product information into a `ProductRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="82b47-243">Assegnare i nuovi valori all'istanza di `ProductRow` del passaggio 1</span><span class="sxs-lookup"><span data-stu-id="82b47-243">Assign the new values to the `ProductRow` instance from Step 1</span></span>
3. <span data-ttu-id="82b47-244">Chiamare il metodo `Update` del TableAdapter passando l'istanza di `ProductRow`</span><span class="sxs-lookup"><span data-stu-id="82b47-244">Call the TableAdapter's `Update` method, passing in the `ProductRow` instance</span></span>

<span data-ttu-id="82b47-245">Questa sequenza di passaggi, tuttavia, non supporterà correttamente la concorrenza ottimistica perché il `ProductRow` popolato nel passaggio 1 viene popolato direttamente dal database, vale a dire che i valori originali utilizzati da DataRow sono quelli attualmente esistenti nel database e non quelli associati a GridView all'inizio del processo di modifica.</span><span class="sxs-lookup"><span data-stu-id="82b47-245">This sequence of steps, however, won't correctly support optimistic concurrency because the `ProductRow` populated in Step 1 is populated directly from the database, meaning that the original values used by the DataRow are those that currently exist in the database, and not those that were bound to the GridView at the start of the editing process.</span></span> <span data-ttu-id="82b47-246">Al contrario, quando si usa un da dalla concorrenza ottimistica, è necessario modificare gli overload del metodo `UpdateProduct` per eseguire i passaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="82b47-246">Instead, when using an optimistic concurrency-enabled DAL, we need to alter the `UpdateProduct` method overloads to use the following steps:</span></span>

1. <span data-ttu-id="82b47-247">Leggere le informazioni sul prodotto del database corrente in un'istanza di `ProductsOptimisticConcurrencyRow` usando il metodo `GetProductByProductID(productID)` del TableAdapter</span><span class="sxs-lookup"><span data-stu-id="82b47-247">Read the current database product information into a `ProductsOptimisticConcurrencyRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="82b47-248">Assegnare i valori *originali* all'istanza di `ProductsOptimisticConcurrencyRow` del passaggio 1</span><span class="sxs-lookup"><span data-stu-id="82b47-248">Assign the *original* values to the `ProductsOptimisticConcurrencyRow` instance from Step 1</span></span>
3. <span data-ttu-id="82b47-249">Chiamare il metodo `AcceptChanges()` dell'istanza di `ProductsOptimisticConcurrencyRow`, che indica a DataRow che i valori correnti sono quelli originali</span><span class="sxs-lookup"><span data-stu-id="82b47-249">Call the `ProductsOptimisticConcurrencyRow` instance's `AcceptChanges()` method, which instructs the DataRow that its current values are the "original" ones</span></span>
4. <span data-ttu-id="82b47-250">Assegnare i *nuovi* valori all'istanza di `ProductsOptimisticConcurrencyRow`</span><span class="sxs-lookup"><span data-stu-id="82b47-250">Assign the *new* values to the `ProductsOptimisticConcurrencyRow` instance</span></span>
5. <span data-ttu-id="82b47-251">Chiamare il metodo `Update` del TableAdapter passando l'istanza di `ProductsOptimisticConcurrencyRow`</span><span class="sxs-lookup"><span data-stu-id="82b47-251">Call the TableAdapter's `Update` method, passing in the `ProductsOptimisticConcurrencyRow` instance</span></span>

<span data-ttu-id="82b47-252">Il passaggio 1 legge tutti i valori del database corrente per il record di prodotto specificato.</span><span class="sxs-lookup"><span data-stu-id="82b47-252">Step 1 reads in all of the current database values for the specified product record.</span></span> <span data-ttu-id="82b47-253">Questo passaggio è superfluo nell'overload `UpdateProduct` che aggiorna *tutte* le colonne di prodotto (poiché questi valori vengono sovrascritti nel passaggio 2), ma è essenziale per gli overload in cui solo un subset dei valori della colonna viene passato come parametri di input.</span><span class="sxs-lookup"><span data-stu-id="82b47-253">This step is superfluous in the `UpdateProduct` overload that updates *all* of the product columns (as these values are overwritten in Step 2), but is essential for those overloads where only a subset of the column values are passed in as input parameters.</span></span> <span data-ttu-id="82b47-254">Una volta assegnati i valori originali all'istanza `ProductsOptimisticConcurrencyRow`, viene chiamato il metodo `AcceptChanges()`, che contrassegna i valori DataRow correnti come valori originali da usare nei parametri di `@original_ColumnName` nell'istruzione `UPDATE`.</span><span class="sxs-lookup"><span data-stu-id="82b47-254">Once the original values have been assigned to the `ProductsOptimisticConcurrencyRow` instance, the `AcceptChanges()` method is called, which marks the current DataRow values as the original values to be used in the `@original_ColumnName` parameters in the `UPDATE` statement.</span></span> <span data-ttu-id="82b47-255">Successivamente, i nuovi valori di parametro vengono assegnati alla `ProductsOptimisticConcurrencyRow` e, infine, viene richiamato il metodo `Update`, passando il DataRow.</span><span class="sxs-lookup"><span data-stu-id="82b47-255">Next, the new parameter values are assigned to the `ProductsOptimisticConcurrencyRow` and, finally, the `Update` method is invoked, passing in the DataRow.</span></span>

<span data-ttu-id="82b47-256">Nel codice seguente viene illustrato l'overload di `UpdateProduct` che accetta tutti i campi dati del prodotto come parametri di input.</span><span class="sxs-lookup"><span data-stu-id="82b47-256">The following code shows the `UpdateProduct` overload that accepts all product data fields as input parameters.</span></span> <span data-ttu-id="82b47-257">Sebbene non sia illustrato, la classe `ProductsOptimisticConcurrencyBLL` inclusa nel download di questa esercitazione contiene anche un overload `UpdateProduct` che accetta solo il nome e il prezzo del prodotto come parametri di input.</span><span class="sxs-lookup"><span data-stu-id="82b47-257">While not shown here, the `ProductsOptimisticConcurrencyBLL` class included in the download for this tutorial also contains an `UpdateProduct` overload that accepts just the product's name and price as input parameters.</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample7.cs)]

## <a name="step-4-passing-the-original-and-new-values-from-the-aspnet-page-to-the-bll-methods"></a><span data-ttu-id="82b47-258">Passaggio 4: passaggio dei valori originali e nuovi dalla pagina ASP.NET ai metodi BLL</span><span class="sxs-lookup"><span data-stu-id="82b47-258">Step 4: Passing the Original and New Values From the ASP.NET Page to the BLL Methods</span></span>

<span data-ttu-id="82b47-259">Con il completamento di DAL e BLL, rimane solo la creazione di una pagina ASP.NET che può utilizzare la logica di concorrenza ottimistica incorporata nel sistema.</span><span class="sxs-lookup"><span data-stu-id="82b47-259">With the DAL and BLL complete, all that remains is to create an ASP.NET page that can utilize the optimistic concurrency logic built in to the system.</span></span> <span data-ttu-id="82b47-260">In particolare, il controllo Web dei dati (GridView, DetailsView o FormView) deve ricordare i valori originali e ObjectDataSource deve passare entrambi i set di valori al livello della logica di business.</span><span class="sxs-lookup"><span data-stu-id="82b47-260">Specifically, the data Web control (the GridView, DetailsView, or FormView) must remember its original values and the ObjectDataSource must pass both sets of values to the Business Logic Layer.</span></span> <span data-ttu-id="82b47-261">Inoltre, la pagina ASP.NET deve essere configurata in modo da gestire correttamente le violazioni della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="82b47-261">Furthermore, the ASP.NET page must be configured to gracefully handle concurrency violations.</span></span>

<span data-ttu-id="82b47-262">Per iniziare, aprire la pagina `OptimisticConcurrency.aspx` nella cartella `EditInsertDelete` e aggiungere un controllo GridView alla finestra di progettazione, impostando la relativa proprietà `ID` su `ProductsGrid`.</span><span class="sxs-lookup"><span data-stu-id="82b47-262">Start by opening the `OptimisticConcurrency.aspx` page in the `EditInsertDelete` folder and adding a GridView to the Designer, setting its `ID` property to `ProductsGrid`.</span></span> <span data-ttu-id="82b47-263">Dallo smart tag di GridView, scegliere di creare un nuovo ObjectDataSource denominato `ProductsOptimisticConcurrencyDataSource`.</span><span class="sxs-lookup"><span data-stu-id="82b47-263">From the GridView's smart tag, opt to create a new ObjectDataSource named `ProductsOptimisticConcurrencyDataSource`.</span></span> <span data-ttu-id="82b47-264">Poiché si desidera che ObjectDataSource utilizzi il DAL che supporta la concorrenza ottimistica, configurarlo per l'utilizzo dell'oggetto `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="82b47-264">Since we want this ObjectDataSource to use the DAL that supports optimistic concurrency, configure it to use the `ProductsOptimisticConcurrencyBLL` object.</span></span>

<span data-ttu-id="82b47-265">[![usare ObjectDataSource come oggetto ProductsOptimisticConcurrencyBLL](implementing-optimistic-concurrency-cs/_static/image36.png)](implementing-optimistic-concurrency-cs/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-265">[![Have the ObjectDataSource Use the ProductsOptimisticConcurrencyBLL Object](implementing-optimistic-concurrency-cs/_static/image36.png)](implementing-optimistic-concurrency-cs/_static/image35.png)</span></span>

<span data-ttu-id="82b47-266">**Figura 13**: fare in modo che ObjectDataSource usi l'oggetto `ProductsOptimisticConcurrencyBLL` ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image37.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-266">**Figure 13**: Have the ObjectDataSource Use the `ProductsOptimisticConcurrencyBLL` Object ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image37.png))</span></span>

<span data-ttu-id="82b47-267">Scegliere i metodi `GetProducts`, `UpdateProduct`e `DeleteProduct` dagli elenchi a discesa nella procedura guidata.</span><span class="sxs-lookup"><span data-stu-id="82b47-267">Choose the `GetProducts`, `UpdateProduct`, and `DeleteProduct` methods from drop-down lists in the wizard.</span></span> <span data-ttu-id="82b47-268">Per il metodo UpdateProduct, usare l'overload che accetta tutti i campi dati del prodotto.</span><span class="sxs-lookup"><span data-stu-id="82b47-268">For the UpdateProduct method, use the overload that accepts all of the product's data fields.</span></span>

## <a name="configuring-the-objectdatasource-controls-properties"></a><span data-ttu-id="82b47-269">Configurazione delle proprietà del controllo ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="82b47-269">Configuring the ObjectDataSource Control's Properties</span></span>

<span data-ttu-id="82b47-270">Al termine della procedura guidata, il markup dichiarativo di ObjectDataSource dovrebbe essere simile al seguente:</span><span class="sxs-lookup"><span data-stu-id="82b47-270">After completing the wizard, the ObjectDataSource's declarative markup should look like the following:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample8.aspx)]

<span data-ttu-id="82b47-271">Come si può notare, la raccolta di `DeleteParameters` contiene un'istanza di `Parameter` per ognuno dei dieci parametri di input nel metodo `DeleteProduct` della classe `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="82b47-271">As you can see, the `DeleteParameters` collection contains a `Parameter` instance for each of the ten input parameters in the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method.</span></span> <span data-ttu-id="82b47-272">Analogamente, la raccolta di `UpdateParameters` contiene un'istanza di `Parameter` per ognuno dei parametri di input in `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="82b47-272">Likewise, the `UpdateParameters` collection contains a `Parameter` instance for each of the input parameters in `UpdateProduct`.</span></span>

<span data-ttu-id="82b47-273">Per le esercitazioni precedenti che comportano la modifica dei dati, è necessario rimuovere la proprietà `OldValuesParameterFormatString` di ObjectDataSource in questa fase, poiché questa proprietà indica che il metodo BLL prevede che i valori precedenti (o originali) vengano passati e i nuovi valori.</span><span class="sxs-lookup"><span data-stu-id="82b47-273">For those previous tutorials that involved data modification, we'd remove the ObjectDataSource's `OldValuesParameterFormatString` property at this point, since this property indicates that the BLL method expects the old (or original) values to be passed in as well as the new values.</span></span> <span data-ttu-id="82b47-274">Il valore di questa proprietà indica inoltre i nomi dei parametri di input per i valori originali.</span><span class="sxs-lookup"><span data-stu-id="82b47-274">Furthermore, this property value indicates the input parameter names for the original values.</span></span> <span data-ttu-id="82b47-275">Poiché i valori originali vengono passati in BLL, *non* rimuovere questa proprietà.</span><span class="sxs-lookup"><span data-stu-id="82b47-275">Since we are passing in the original values into the BLL, do *not* remove this property.</span></span>

> [!NOTE]
> <span data-ttu-id="82b47-276">È necessario eseguire il mapping del valore della proprietà `OldValuesParameterFormatString` ai nomi dei parametri di input nell'oggetto BLL che prevedono i valori originali.</span><span class="sxs-lookup"><span data-stu-id="82b47-276">The value of the `OldValuesParameterFormatString` property must map to the input parameter names in the BLL that expect the original values.</span></span> <span data-ttu-id="82b47-277">Poiché questi parametri sono stati denominati `original_productName`, `original_supplierID`e così via, è possibile lasciare il valore della proprietà `OldValuesParameterFormatString` come `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="82b47-277">Since we named these parameters `original_productName`, `original_supplierID`, and so on, you can leave the `OldValuesParameterFormatString` property value as `original_{0}`.</span></span> <span data-ttu-id="82b47-278">Se, tuttavia, i parametri di input dei metodi BLL hanno nomi come `old_productName`, `old_supplierID`e così via, è necessario aggiornare la proprietà `OldValuesParameterFormatString` in `old_{0}`.</span><span class="sxs-lookup"><span data-stu-id="82b47-278">If, however, the BLL methods' input parameters had names like `old_productName`, `old_supplierID`, and so on, you'd need to update the `OldValuesParameterFormatString` property to `old_{0}`.</span></span>

<span data-ttu-id="82b47-279">È necessaria un'impostazione di proprietà finale per consentire a ObjectDataSource di passare correttamente i valori originali ai metodi BLL.</span><span class="sxs-lookup"><span data-stu-id="82b47-279">There's one final property setting that needs to be made in order for the ObjectDataSource to correctly pass the original values to the BLL methods.</span></span> <span data-ttu-id="82b47-280">ObjectDataSource ha una [proprietà ConflictDetection](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) che può essere assegnata a [uno dei due valori](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx)seguenti:</span><span class="sxs-lookup"><span data-stu-id="82b47-280">The ObjectDataSource has a [ConflictDetection property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) that can be assigned to [one of two values](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span></span>

- <span data-ttu-id="82b47-281">`OverwriteChanges`: valore predefinito. non invia i valori originali ai parametri di input originali dei metodi BLL</span><span class="sxs-lookup"><span data-stu-id="82b47-281">`OverwriteChanges` - the default value; does not send the original values to the BLL methods' original input parameters</span></span>
- <span data-ttu-id="82b47-282">`CompareAllValues`: Invia i valori originali ai metodi BLL; scegliere questa opzione quando si usa la concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="82b47-282">`CompareAllValues` - does send the original values to the BLL methods; choose this option when using optimistic concurrency</span></span>

<span data-ttu-id="82b47-283">È necessario impostare la proprietà `ConflictDetection` su `CompareAllValues`.</span><span class="sxs-lookup"><span data-stu-id="82b47-283">Take a moment to set the `ConflictDetection` property to `CompareAllValues`.</span></span>

## <a name="configuring-the-gridviews-properties-and-fields"></a><span data-ttu-id="82b47-284">Configurazione delle proprietà e dei campi di GridView</span><span class="sxs-lookup"><span data-stu-id="82b47-284">Configuring the GridView's Properties and Fields</span></span>

<span data-ttu-id="82b47-285">Con le proprietà di ObjectDataSource configurate correttamente, è necessario fare attenzione alla configurazione di GridView.</span><span class="sxs-lookup"><span data-stu-id="82b47-285">With the ObjectDataSource's properties properly configured, let's turn our attention to setting up the GridView.</span></span> <span data-ttu-id="82b47-286">Innanzitutto, poiché si desidera che GridView supporti la modifica e l'eliminazione, fare clic sulle caselle di controllo Abilita modifica e Abilita eliminazione dallo smart tag di GridView.</span><span class="sxs-lookup"><span data-stu-id="82b47-286">First, since we want the GridView to support editing and deleting, click the Enable Editing and Enable Deleting checkboxes from the GridView's smart tag.</span></span> <span data-ttu-id="82b47-287">Verrà aggiunto un oggetto CommandField i cui `ShowEditButton` e `ShowDeleteButton` sono entrambi impostati su `true`.</span><span class="sxs-lookup"><span data-stu-id="82b47-287">This will add a CommandField whose `ShowEditButton` and `ShowDeleteButton` are both set to `true`.</span></span>

<span data-ttu-id="82b47-288">Quando viene associato a `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, GridView contiene un campo per ogni campo dati del prodotto.</span><span class="sxs-lookup"><span data-stu-id="82b47-288">When bound to the `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, the GridView contains a field for each of the product's data fields.</span></span> <span data-ttu-id="82b47-289">Sebbene sia possibile modificare tale GridView, l'esperienza utente è tutt'altro che accettabile.</span><span class="sxs-lookup"><span data-stu-id="82b47-289">While such a GridView can be edited, the user experience is anything but acceptable.</span></span> <span data-ttu-id="82b47-290">I BoundField `CategoryID` e `SupplierID` vengono visualizzati come caselle di testo, richiedendo all'utente di immettere la categoria e il fornitore appropriati come numeri ID.</span><span class="sxs-lookup"><span data-stu-id="82b47-290">The `CategoryID` and `SupplierID` BoundFields will render as TextBoxes, requiring the user to enter the appropriate category and supplier as ID numbers.</span></span> <span data-ttu-id="82b47-291">Non vi sarà alcuna formattazione per i campi numerici e nessun controllo di convalida per garantire che sia stato fornito il nome del prodotto e che il prezzo unitario, le unità in magazzino, le unità in ordine e i valori del livello di riordinamento siano entrambi valori numerici corretti e siano maggiori o uguali a zero.</span><span class="sxs-lookup"><span data-stu-id="82b47-291">There will be no formatting for the numeric fields and no validation controls to ensure that the product's name has been supplied and that the unit price, units in stock, units on order, and reorder level values are both proper numeric values and are greater than or equal to zero.</span></span>

<span data-ttu-id="82b47-292">Come illustrato nell'argomento relativo all' *aggiunta di controlli di convalida alle interfacce di modifica e inserimento* e *alla personalizzazione delle esercitazioni sull'interfaccia di modifica dei dati* , è possibile personalizzare l'interfaccia utente sostituendo i BoundField con TemplateFields.</span><span class="sxs-lookup"><span data-stu-id="82b47-292">As we discussed in the *Adding Validation Controls to the Editing and Inserting Interfaces* and *Customizing the Data Modification Interface* tutorials, the user interface can be customized by replacing the BoundFields with TemplateFields.</span></span> <span data-ttu-id="82b47-293">Ho modificato questo GridView e la relativa interfaccia di modifica nei modi seguenti:</span><span class="sxs-lookup"><span data-stu-id="82b47-293">I've modified this GridView and its editing interface in the following ways:</span></span>

- <span data-ttu-id="82b47-294">Rimossi i BoundField `ProductID`, `SupplierName`e `CategoryName`</span><span class="sxs-lookup"><span data-stu-id="82b47-294">Removed the `ProductID`, `SupplierName`, and `CategoryName` BoundFields</span></span>
- <span data-ttu-id="82b47-295">È stato convertito il BoundField `ProductName` in un TemplateField e è stato aggiunto un controllo RequiredFieldValidation.</span><span class="sxs-lookup"><span data-stu-id="82b47-295">Converted the `ProductName` BoundField to a TemplateField and added a RequiredFieldValidation control.</span></span>
- <span data-ttu-id="82b47-296">Convertito il `CategoryID` e `SupplierID` BoundField in TemplateFields e l'interfaccia di modifica per l'utilizzo di DropDownList anziché di caselle di testo.</span><span class="sxs-lookup"><span data-stu-id="82b47-296">Converted the `CategoryID` and `SupplierID` BoundFields to TemplateFields, and adjusted the editing interface to use DropDownLists rather than TextBoxes.</span></span> <span data-ttu-id="82b47-297">In questi `ItemTemplates`di TemplateFields, vengono visualizzati i campi `CategoryName` e `SupplierName` dati.</span><span class="sxs-lookup"><span data-stu-id="82b47-297">In these TemplateFields' `ItemTemplates`, the `CategoryName` and `SupplierName` data fields are displayed.</span></span>
- <span data-ttu-id="82b47-298">Convertito i BoundField `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`e `ReorderLevel` in TemplateFields e i controlli CompareValidator aggiunti.</span><span class="sxs-lookup"><span data-stu-id="82b47-298">Converted the `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, and `ReorderLevel` BoundFields to TemplateFields and added CompareValidator controls.</span></span>

<span data-ttu-id="82b47-299">Poiché abbiamo già esaminato come eseguire queste attività nelle esercitazioni precedenti, elencarò solo la sintassi dichiarativa finale e lascio l'implementazione come procedura.</span><span class="sxs-lookup"><span data-stu-id="82b47-299">Since we've already examined how to accomplish these tasks in previous tutorials, I'll just list the final declarative syntax here and leave the implementation as practice.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample9.aspx)]

<span data-ttu-id="82b47-300">Siamo molto vicini a un esempio completamente funzionante.</span><span class="sxs-lookup"><span data-stu-id="82b47-300">We're very close to having a fully-working example.</span></span> <span data-ttu-id="82b47-301">Tuttavia, vi sono alcune sottigliezze che si possono verificare e causare problemi.</span><span class="sxs-lookup"><span data-stu-id="82b47-301">However, there are a few subtleties that will creep up and cause us problems.</span></span> <span data-ttu-id="82b47-302">Inoltre, è ancora necessaria un'interfaccia per avvisare l'utente quando si è verificata una violazione della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="82b47-302">Additionally, we still need some interface that alerts the user when a concurrency violation has occurred.</span></span>

> [!NOTE]
> <span data-ttu-id="82b47-303">Affinché un controllo Web dei dati passi correttamente i valori originali a ObjectDataSource (che vengono quindi passati al BLL), è fondamentale che la proprietà `EnableViewState` di GridView sia impostata su `true` (impostazione predefinita).</span><span class="sxs-lookup"><span data-stu-id="82b47-303">In order for a data Web control to correctly pass the original values to the ObjectDataSource (which are then passed to the BLL), it's vital that the GridView's `EnableViewState` property is set to `true` (the default).</span></span> <span data-ttu-id="82b47-304">Se si disabilita lo stato di visualizzazione, i valori originali andranno perduti durante il postback.</span><span class="sxs-lookup"><span data-stu-id="82b47-304">If you disable view state, the original values are lost on postback.</span></span>

## <a name="passing-the-correct-original-values-to-the-objectdatasource"></a><span data-ttu-id="82b47-305">Passaggio dei valori originali corretti a ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="82b47-305">Passing the Correct Original Values to the ObjectDataSource</span></span>

<span data-ttu-id="82b47-306">Ci sono un paio di problemi con il modo in cui GridView è stato configurato.</span><span class="sxs-lookup"><span data-stu-id="82b47-306">There are a couple of problems with the way the GridView has been configured.</span></span> <span data-ttu-id="82b47-307">Se la proprietà `ConflictDetection` di ObjectDataSource è impostata su `CompareAllValues` (come per la nostra), quando i metodi `Update()` o `Delete()` di ObjectDataSource vengono richiamati da GridView (o DetailsView o FormView), ObjectDataSource tenta di copiare i valori originali di GridView nelle istanze `Parameter` appropriate.</span><span class="sxs-lookup"><span data-stu-id="82b47-307">If the ObjectDataSource's `ConflictDetection` property is set to `CompareAllValues` (as is ours), when the ObjectDataSource's `Update()` or `Delete()` methods are invoked by the GridView (or DetailsView or FormView), the ObjectDataSource attempts to copy the GridView's original values into its appropriate `Parameter` instances.</span></span> <span data-ttu-id="82b47-308">Per una rappresentazione grafica del processo, fare riferimento alla figura 2.</span><span class="sxs-lookup"><span data-stu-id="82b47-308">Refer back to Figure 2 for a graphical representation of this process.</span></span>

<span data-ttu-id="82b47-309">In particolare, ai valori originali di GridView vengono assegnati i valori nelle istruzioni DataBinding bidirezionali ogni volta che i dati sono associati al controllo GridView.</span><span class="sxs-lookup"><span data-stu-id="82b47-309">Specifically, the GridView's original values are assigned the values in the two-way databinding statements each time the data is bound to the GridView.</span></span> <span data-ttu-id="82b47-310">È pertanto essenziale che i valori originali necessari vengano acquisiti tramite l'associazione dati bidirezionale e che vengano forniti in formato convertibile.</span><span class="sxs-lookup"><span data-stu-id="82b47-310">Therefore, it's essential that the required original values all are captured via two-way databinding and that they are provided in a convertible format.</span></span>

<span data-ttu-id="82b47-311">Per capire il motivo per cui questa operazione è importante, è possibile visitare la pagina in un browser.</span><span class="sxs-lookup"><span data-stu-id="82b47-311">To see why this is important, take a moment to visit our page in a browser.</span></span> <span data-ttu-id="82b47-312">Come previsto, GridView elenca ogni prodotto con un pulsante modifica ed Elimina nella colonna più a sinistra.</span><span class="sxs-lookup"><span data-stu-id="82b47-312">As expected, the GridView lists each product with an Edit and Delete button in the leftmost column.</span></span>

<span data-ttu-id="82b47-313">[![i prodotti sono elencati in GridView](implementing-optimistic-concurrency-cs/_static/image39.png)](implementing-optimistic-concurrency-cs/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-313">[![The Products are Listed in a GridView](implementing-optimistic-concurrency-cs/_static/image39.png)](implementing-optimistic-concurrency-cs/_static/image38.png)</span></span>

<span data-ttu-id="82b47-314">**Figura 14**: i prodotti sono elencati in GridView ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image40.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-314">**Figure 14**: The Products are Listed in a GridView ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image40.png))</span></span>

<span data-ttu-id="82b47-315">Se si fa clic sul pulsante Elimina per qualsiasi prodotto, viene generata un'`FormatException`.</span><span class="sxs-lookup"><span data-stu-id="82b47-315">If you click the Delete button for any product, a `FormatException` is thrown.</span></span>

<span data-ttu-id="82b47-316">[![il tentativo di eliminare i risultati di un prodotto in FormatException](implementing-optimistic-concurrency-cs/_static/image42.png)](implementing-optimistic-concurrency-cs/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-316">[![Attempting to Delete Any Product Results in a FormatException](implementing-optimistic-concurrency-cs/_static/image42.png)](implementing-optimistic-concurrency-cs/_static/image41.png)</span></span>

<span data-ttu-id="82b47-317">**Figura 15**: tentativo di eliminare i risultati di un prodotto in un `FormatException` ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image43.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-317">**Figure 15**: Attempting to Delete Any Product Results in a `FormatException` ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image43.png))</span></span>

<span data-ttu-id="82b47-318">Il `FormatException` viene generato quando ObjectDataSource tenta di leggere il valore di `UnitPrice` originale.</span><span class="sxs-lookup"><span data-stu-id="82b47-318">The `FormatException` is raised when the ObjectDataSource attempts to read in the original `UnitPrice` value.</span></span> <span data-ttu-id="82b47-319">Poiché il `ItemTemplate` dispone del `UnitPrice` formattato come valuta (`<%# Bind("UnitPrice", "{0:C}") %>`), include un simbolo di valuta, ad esempio $19,95.</span><span class="sxs-lookup"><span data-stu-id="82b47-319">Since the `ItemTemplate` has the `UnitPrice` formatted as a currency (`<%# Bind("UnitPrice", "{0:C}") %>`), it includes a currency symbol, like $19.95.</span></span> <span data-ttu-id="82b47-320">Il `FormatException` si verifica quando ObjectDataSource tenta di convertire la stringa in una `decimal`.</span><span class="sxs-lookup"><span data-stu-id="82b47-320">The `FormatException` occurs as the ObjectDataSource attempts to convert this string into a `decimal`.</span></span> <span data-ttu-id="82b47-321">Per aggirare questo problema, sono disponibili diverse opzioni:</span><span class="sxs-lookup"><span data-stu-id="82b47-321">To circumvent this problem, we have a number of options:</span></span>

- <span data-ttu-id="82b47-322">Rimuovere la formattazione della valuta dal `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="82b47-322">Remove the currency formatting from the `ItemTemplate`.</span></span> <span data-ttu-id="82b47-323">Ovvero, invece di usare `<%# Bind("UnitPrice", "{0:C}") %>`, è sufficiente usare `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="82b47-323">That is, instead of using `<%# Bind("UnitPrice", "{0:C}") %>`, simply use `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="82b47-324">Lo svantaggio è che il prezzo non è più formattato.</span><span class="sxs-lookup"><span data-stu-id="82b47-324">The downside of this is that the price is no longer formatted.</span></span>
- <span data-ttu-id="82b47-325">Consente di visualizzare il `UnitPrice` formattato come valuta nel `ItemTemplate`, ma utilizzare la parola chiave `Eval` a tale scopo.</span><span class="sxs-lookup"><span data-stu-id="82b47-325">Display the `UnitPrice` formatted as a currency in the `ItemTemplate`, but use the `Eval` keyword to accomplish this.</span></span> <span data-ttu-id="82b47-326">Si ricordi che `Eval` esegue l'associazione dati unidirezionale.</span><span class="sxs-lookup"><span data-stu-id="82b47-326">Recall that `Eval` performs one-way databinding.</span></span> <span data-ttu-id="82b47-327">È ancora necessario fornire il valore `UnitPrice` per i valori originali, quindi è necessaria un'istruzione DataBinding bidirezionale nel `ItemTemplate`, ma questo può essere inserito in un controllo Web etichetta la cui proprietà `Visible` è impostata su `false`.</span><span class="sxs-lookup"><span data-stu-id="82b47-327">We still need to provide the `UnitPrice` value for the original values, so we'll still need a two-way databinding statement in the `ItemTemplate`, but this can be placed in a Label Web control whose `Visible` property is set to `false`.</span></span> <span data-ttu-id="82b47-328">In ItemTemplate è possibile utilizzare il markup seguente:</span><span class="sxs-lookup"><span data-stu-id="82b47-328">We could use the following markup in the ItemTemplate:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample10.aspx)]

- <span data-ttu-id="82b47-329">Rimuovere la formattazione della valuta dal `ItemTemplate`, usando `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="82b47-329">Remove the currency formatting from the `ItemTemplate`, using `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="82b47-330">Nel gestore dell'evento `RowDataBound` di GridView, accedere a livello di codice al controllo Web etichetta all'interno del quale viene visualizzato il valore di `UnitPrice` e impostare la relativa proprietà `Text` sulla versione formattata.</span><span class="sxs-lookup"><span data-stu-id="82b47-330">In the GridView's `RowDataBound` event handler, programmatically access the Label Web control within which the `UnitPrice` value is displayed and set its `Text` property to the formatted version.</span></span>
- <span data-ttu-id="82b47-331">Lasciare il `UnitPrice` formattato come valuta.</span><span class="sxs-lookup"><span data-stu-id="82b47-331">Leave the `UnitPrice` formatted as a currency.</span></span> <span data-ttu-id="82b47-332">Nel gestore dell'evento `RowDeleting` di GridView sostituire il valore di `UnitPrice` originale esistente ($19,95) con un valore decimale effettivo utilizzando `Decimal.Parse`.</span><span class="sxs-lookup"><span data-stu-id="82b47-332">In the GridView's `RowDeleting` event handler, replace the existing original `UnitPrice` value ($19.95) with an actual decimal value using `Decimal.Parse`.</span></span> <span data-ttu-id="82b47-333">È stato illustrato come ottenere un risultato simile nel gestore dell'evento `RowUpdating` nella [*gestione delle eccezioni a livello BLL e dal in un'esercitazione della pagina ASP.NET*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="82b47-333">We saw how to accomplish something similar in the `RowUpdating` event handler in the [*Handling BLL- and DAL-Level Exceptions in an ASP.NET Page*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial.</span></span>

<span data-ttu-id="82b47-334">Per il mio esempio, ho scelto di usare il secondo approccio, aggiungendo un controllo Web con etichetta nascosta la cui proprietà `Text` è associata a dati bidirezionali al valore `UnitPrice` non formattato.</span><span class="sxs-lookup"><span data-stu-id="82b47-334">For my example I chose to go with the second approach, adding a hidden Label Web control whose `Text` property is two-way data bound to the unformatted `UnitPrice` value.</span></span>

<span data-ttu-id="82b47-335">Dopo aver risolto il problema, provare a fare clic sul pulsante Elimina per qualsiasi prodotto.</span><span class="sxs-lookup"><span data-stu-id="82b47-335">After solving this problem, try clicking the Delete button for any product again.</span></span> <span data-ttu-id="82b47-336">Questa volta si otterrà un `InvalidOperationException` quando ObjectDataSource tenta di richiamare il metodo di `UpdateProduct` del BLL.</span><span class="sxs-lookup"><span data-stu-id="82b47-336">This time you'll get an `InvalidOperationException` when the ObjectDataSource attempts to invoke the BLL's `UpdateProduct` method.</span></span>

<span data-ttu-id="82b47-337">[![ObjectDataSource non è in grado di trovare un metodo con i parametri di input che si desidera inviare](implementing-optimistic-concurrency-cs/_static/image45.png)](implementing-optimistic-concurrency-cs/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-337">[![The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send](implementing-optimistic-concurrency-cs/_static/image45.png)](implementing-optimistic-concurrency-cs/_static/image44.png)</span></span>

<span data-ttu-id="82b47-338">**Figura 16**: ObjectDataSource non riesce a trovare un metodo con i parametri di input che desidera inviare ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image46.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-338">**Figure 16**: The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image46.png))</span></span>

<span data-ttu-id="82b47-339">Esaminando il messaggio dell'eccezione, è evidente che ObjectDataSource desidera richiamare un metodo `DeleteProduct` BLL che include `original_CategoryName` e `original_SupplierName` parametri di input.</span><span class="sxs-lookup"><span data-stu-id="82b47-339">Looking at the exception's message, it's clear that the ObjectDataSource wants to invoke a BLL `DeleteProduct` method that includes `original_CategoryName` and `original_SupplierName` input parameters.</span></span> <span data-ttu-id="82b47-340">Ciò è dovuto al fatto che i `ItemTemplate` s per i `CategoryID` e `SupplierID` TemplateFields attualmente contengono istruzioni bind bidirezionali con i campi dati `CategoryName` e `SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="82b47-340">This is because the `ItemTemplate` s for the `CategoryID` and `SupplierID` TemplateFields currently contain two-way Bind statements with the `CategoryName` and `SupplierName` data fields.</span></span> <span data-ttu-id="82b47-341">Al contrario, è necessario includere `Bind` istruzioni con i campi dati `CategoryID` e `SupplierID`.</span><span class="sxs-lookup"><span data-stu-id="82b47-341">Instead, we need to include `Bind` statements with the `CategoryID` and `SupplierID` data fields.</span></span> <span data-ttu-id="82b47-342">A tale scopo, sostituire le istruzioni bind esistenti con `Eval` istruzioni, quindi aggiungere i controlli etichetta nascosti le cui proprietà `Text` sono associate ai campi di dati `CategoryID` e `SupplierID` usando l'associazione dati bidirezionale, come illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="82b47-342">To accomplish this, replace the existing Bind statements with `Eval` statements, and then add hidden Label controls whose `Text` properties are bound to the `CategoryID` and `SupplierID` data fields using two-way databinding, as shown below:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample11.aspx)]

<span data-ttu-id="82b47-343">Con queste modifiche, è ora possibile eliminare e modificare correttamente le informazioni sul prodotto.</span><span class="sxs-lookup"><span data-stu-id="82b47-343">With these changes, we are now able to successfully delete and edit product information!</span></span> <span data-ttu-id="82b47-344">Nel passaggio 5 verrà esaminato come verificare che vengano rilevate violazioni della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="82b47-344">In Step 5 we'll look at how to verify that concurrency violations are being detected.</span></span> <span data-ttu-id="82b47-345">Per il momento, tuttavia, provare ad aggiornare ed eliminare alcuni record per assicurarsi che l'aggiornamento e l'eliminazione per un singolo utente funzionino come previsto.</span><span class="sxs-lookup"><span data-stu-id="82b47-345">But for now, take a few minutes to try updating and deleting a few records to ensure that updating and deleting for a single user works as expected.</span></span>

## <a name="step-5-testing-the-optimistic-concurrency-support"></a><span data-ttu-id="82b47-346">Passaggio 5: test del supporto della concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="82b47-346">Step 5: Testing the Optimistic Concurrency Support</span></span>

<span data-ttu-id="82b47-347">Per verificare che vengano rilevate violazioni della concorrenza, anziché causare la sovrascrittura dei dati, è necessario aprire due finestre del browser in questa pagina.</span><span class="sxs-lookup"><span data-stu-id="82b47-347">In order to verify that concurrency violations are being detected (rather than resulting in data being blindly overwritten), we need to open two browser windows to this page.</span></span> <span data-ttu-id="82b47-348">In entrambe le istanze del browser fare clic sul pulsante modifica per Chai.</span><span class="sxs-lookup"><span data-stu-id="82b47-348">In both browser instances, click on the Edit button for Chai.</span></span> <span data-ttu-id="82b47-349">Quindi, in uno solo dei browser, modificare il nome in "Chai Tea" e fare clic su Aggiorna.</span><span class="sxs-lookup"><span data-stu-id="82b47-349">Then, in just one of the browsers, change the name to "Chai Tea" and click Update.</span></span> <span data-ttu-id="82b47-350">L'aggiornamento dovrebbe avere esito positivo e restituire GridView allo stato di pre-modifica con "Chai Tea" come nuovo nome del prodotto.</span><span class="sxs-lookup"><span data-stu-id="82b47-350">The update should succeed and return the GridView to its pre-editing state, with "Chai Tea" as the new product name.</span></span>

<span data-ttu-id="82b47-351">Nell'altra istanza della finestra del browser, tuttavia, nella casella di testo Product Name viene ancora visualizzato "Chai".</span><span class="sxs-lookup"><span data-stu-id="82b47-351">In the other browser window instance, however, the product name TextBox still shows "Chai".</span></span> <span data-ttu-id="82b47-352">In questa seconda finestra del browser aggiornare il `UnitPrice` `25.00`.</span><span class="sxs-lookup"><span data-stu-id="82b47-352">In this second browser window, update the `UnitPrice` to `25.00`.</span></span> <span data-ttu-id="82b47-353">Senza il supporto della concorrenza ottimistica, fare clic su Aggiorna nella seconda istanza del browser per modificare il nome del prodotto in "Chai", sovrascrivendo quindi le modifiche apportate dalla prima istanza del browser.</span><span class="sxs-lookup"><span data-stu-id="82b47-353">Without optimistic concurrency support, clicking update in the second browser instance would change the product name back to "Chai", thereby overwriting the changes made by the first browser instance.</span></span> <span data-ttu-id="82b47-354">Con la concorrenza ottimistica utilizzata, tuttavia, facendo clic sul pulsante Aggiorna nella seconda istanza del browser si ottiene un [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="82b47-354">With optimistic concurrency employed, however, clicking the Update button in the second browser instance results in a [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span></span>

<span data-ttu-id="82b47-355">[![quando viene rilevata una violazione di concorrenza, viene generata un'eccezione DBConcurrencyException](implementing-optimistic-concurrency-cs/_static/image48.png)](implementing-optimistic-concurrency-cs/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-355">[![When a Concurrency Violation is Detected, a DBConcurrencyException is Thrown](implementing-optimistic-concurrency-cs/_static/image48.png)](implementing-optimistic-concurrency-cs/_static/image47.png)</span></span>

<span data-ttu-id="82b47-356">**Figura 17**: quando viene rilevata una violazione di concorrenza, viene generata un'`DBConcurrencyException` ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image49.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-356">**Figure 17**: When a Concurrency Violation is Detected, a `DBConcurrencyException` is Thrown ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image49.png))</span></span>

<span data-ttu-id="82b47-357">Il `DBConcurrencyException` viene generato solo quando viene utilizzato il modello di aggiornamento batch del DAL.</span><span class="sxs-lookup"><span data-stu-id="82b47-357">The `DBConcurrencyException` is only thrown when the DAL's batch update pattern is utilized.</span></span> <span data-ttu-id="82b47-358">Il modello diretto del database non genera un'eccezione, ma indica semplicemente che non sono state interessate righe.</span><span class="sxs-lookup"><span data-stu-id="82b47-358">The DB direct pattern does not raise an exception, it merely indicates that no rows were affected.</span></span> <span data-ttu-id="82b47-359">Per illustrare questa situazione, restituire il controllo GridView delle istanze del browser allo stato di pre-modifica.</span><span class="sxs-lookup"><span data-stu-id="82b47-359">To illustrate this, return both browser instances' GridView to their pre-editing state.</span></span> <span data-ttu-id="82b47-360">Quindi, nella prima istanza del browser, fare clic sul pulsante modifica e modificare il nome del prodotto da "Chai Tea" a "Chai" e fare clic su Aggiorna.</span><span class="sxs-lookup"><span data-stu-id="82b47-360">Next, in the first browser instance, click the Edit button and change the product name from "Chai Tea" back to "Chai" and click Update.</span></span> <span data-ttu-id="82b47-361">Nella seconda finestra del browser fare clic sul pulsante Elimina per Chai.</span><span class="sxs-lookup"><span data-stu-id="82b47-361">In the second browser window, click the Delete button for Chai.</span></span>

<span data-ttu-id="82b47-362">Quando si fa clic su Elimina, viene eseguito il postback della pagina, il controllo GridView richiama il metodo `Delete()` di ObjectDataSource e ObjectDataSource chiama il metodo `DeleteProduct` della classe `ProductsOptimisticConcurrencyBLL`, passando i valori originali.</span><span class="sxs-lookup"><span data-stu-id="82b47-362">Upon clicking Delete, the page posts back, the GridView invokes the ObjectDataSource's `Delete()` method, and the ObjectDataSource calls down into the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method, passing along the original values.</span></span> <span data-ttu-id="82b47-363">Il valore di `ProductName` originale per la seconda istanza del browser è "Chai Tea", che non corrisponde al valore di `ProductName` corrente nel database.</span><span class="sxs-lookup"><span data-stu-id="82b47-363">The original `ProductName` value for the second browser instance is "Chai Tea", which doesn't match up with the current `ProductName` value in the database.</span></span> <span data-ttu-id="82b47-364">Di conseguenza, l'istruzione `DELETE` inviata al database influiscono su zero righe poiché non è presente alcun record nel database soddisfatto dalla clausola `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="82b47-364">Therefore the `DELETE` statement issued to the database affects zero rows since there's no record in the database that the `WHERE` clause satisfies.</span></span> <span data-ttu-id="82b47-365">Il metodo `DeleteProduct` restituisce `false` e i dati di ObjectDataSource vengono riassociati al controllo GridView.</span><span class="sxs-lookup"><span data-stu-id="82b47-365">The `DeleteProduct` method returns `false` and the ObjectDataSource's data is rebound to the GridView.</span></span>

<span data-ttu-id="82b47-366">Dal punto di vista dell'utente finale, facendo clic sul pulsante Delete (Elimina) per Chai Tea nella seconda finestra del browser è stato attivato lo schermo Flash e, al ritorno, il prodotto è ancora disponibile, anche se ora è elencato come "Chai" (il nome del prodotto modificato dal primo browser istanza di).</span><span class="sxs-lookup"><span data-stu-id="82b47-366">From the end user's perspective, clicking on the Delete button for Chai Tea in the second browser window caused the screen to flash and, upon coming back, the product is still there, although now it's listed as "Chai" (the product name change made by the first browser instance).</span></span> <span data-ttu-id="82b47-367">Se l'utente fa nuovamente clic sul pulsante Elimina, l'eliminazione avrà esito positivo, poiché il valore di `ProductName` originale di GridView ("Chai") ora corrisponde al valore nel database.</span><span class="sxs-lookup"><span data-stu-id="82b47-367">If the user clicks the Delete button again, the Delete will succeed, as the GridView's original `ProductName` value ("Chai") now matches up with the value in the database.</span></span>

<span data-ttu-id="82b47-368">In entrambi i casi, l'esperienza utente è molto lontana dall'ideale.</span><span class="sxs-lookup"><span data-stu-id="82b47-368">In both of these cases, the user experience is far from ideal.</span></span> <span data-ttu-id="82b47-369">Quando si usa il modello di aggiornamento batch, non è necessario mostrare all'utente i dettagli essenziali dell'eccezione `DBConcurrencyException`.</span><span class="sxs-lookup"><span data-stu-id="82b47-369">We clearly don't want to show the user the nitty-gritty details of the `DBConcurrencyException` exception when using the batch update pattern.</span></span> <span data-ttu-id="82b47-370">Il comportamento quando si usa il modello di database diretto è piuttosto confuso perché il comando degli utenti non è riuscito, ma non c'è alcuna indicazione precisa del motivo per cui.</span><span class="sxs-lookup"><span data-stu-id="82b47-370">And the behavior when using the DB direct pattern is somewhat confusing as the users command failed, but there was no precise indication of why.</span></span>

<span data-ttu-id="82b47-371">Per risolvere questi due problemi, è possibile creare controlli Web etichetta nella pagina che forniscono una spiegazione del motivo per cui un aggiornamento o un'eliminazione non è riuscita.</span><span class="sxs-lookup"><span data-stu-id="82b47-371">To remedy these two issues, we can create Label Web controls on the page that provide an explanation to why an update or delete failed.</span></span> <span data-ttu-id="82b47-372">Per il modello di aggiornamento batch, è possibile determinare se si è verificata un'eccezione `DBConcurrencyException` nel gestore eventi di post-livello di GridView, visualizzando l'etichetta di avviso in base alle esigenze.</span><span class="sxs-lookup"><span data-stu-id="82b47-372">For the batch update pattern, we can determine whether or not a `DBConcurrencyException` exception occurred in the GridView's post-level event handler, displaying the warning label as needed.</span></span> <span data-ttu-id="82b47-373">Per il metodo diretto del database, è possibile esaminare il valore restituito del metodo BLL, che è `true` se una riga è interessata, `false` in caso contrario, e visualizzare un messaggio informativo in base alle esigenze.</span><span class="sxs-lookup"><span data-stu-id="82b47-373">For the DB direct method, we can examine the return value of the BLL method (which is `true` if one row was affected, `false` otherwise) and display an informational message as needed.</span></span>

## <a name="step-6-adding-informational-messages-and-displaying-them-in-the-face-of-a-concurrency-violation"></a><span data-ttu-id="82b47-374">Passaggio 6: aggiunta di messaggi informativi e visualizzazione dei messaggi in caso di violazione della concorrenza</span><span class="sxs-lookup"><span data-stu-id="82b47-374">Step 6: Adding Informational Messages and Displaying Them in the Face of a Concurrency Violation</span></span>

<span data-ttu-id="82b47-375">Quando si verifica una violazione della concorrenza, il comportamento esposto dipende dal fatto che sia stato usato il modello di aggiornamento in batch o di database diretto del DAL.</span><span class="sxs-lookup"><span data-stu-id="82b47-375">When a concurrency violation occurs, the behavior exhibited depends on whether the DAL's batch update or DB direct pattern was used.</span></span> <span data-ttu-id="82b47-376">Questa esercitazione usa entrambi i modelli, con il modello di aggiornamento batch usato per l'aggiornamento e il modello diretto del database usato per l'eliminazione.</span><span class="sxs-lookup"><span data-stu-id="82b47-376">Our tutorial uses both patterns, with the batch update pattern being used for updating and the DB direct pattern used for deleting.</span></span> <span data-ttu-id="82b47-377">Per iniziare, aggiungere due controlli Web Label alla pagina che spiegano che si è verificata una violazione della concorrenza durante il tentativo di eliminare o aggiornare i dati.</span><span class="sxs-lookup"><span data-stu-id="82b47-377">To get started, let's add two Label Web controls to our page that explain that a concurrency violation occurred when attempting to delete or update data.</span></span> <span data-ttu-id="82b47-378">Impostare le proprietà `Visible` e `EnableViewState` del controllo Label su `false`; in questo modo, tali visite verranno nascoste in ogni visita a pagina, ad eccezione di quelle determinate pagine in cui la proprietà `Visible` viene impostata a livello di codice su `true`.</span><span class="sxs-lookup"><span data-stu-id="82b47-378">Set the Label control's `Visible` and `EnableViewState` properties to `false`; this will cause them to be hidden on each page visit except for those particular page visits where their `Visible` property is programmatically set to `true`.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample12.aspx)]

<span data-ttu-id="82b47-379">Oltre a impostare le proprietà `Visible`, `EnabledViewState`e `Text`, ho impostato anche la proprietà `CssClass` su `Warning`, che fa sì che l'etichetta venga visualizzata in un tipo di carattere grande, rosso, corsivo e grassetto.</span><span class="sxs-lookup"><span data-stu-id="82b47-379">In addition to setting their `Visible`, `EnabledViewState`, and `Text` properties, I've also set the `CssClass` property to `Warning`, which causes the Label's to be displayed in a large, red, italic, bold font.</span></span> <span data-ttu-id="82b47-380">Questa classe di `Warning` CSS è stata definita e aggiunta a Styles. CSS nell'esercitazione *analisi degli eventi associati all'inserimento, aggiornamento ed eliminazione* .</span><span class="sxs-lookup"><span data-stu-id="82b47-380">This CSS `Warning` class was defined and added to Styles.css back in the *Examining the Events Associated with Inserting, Updating, and Deleting* tutorial.</span></span>

<span data-ttu-id="82b47-381">Dopo aver aggiunto queste etichette, la finestra di progettazione in Visual Studio dovrebbe avere un aspetto simile a quello della figura 18.</span><span class="sxs-lookup"><span data-stu-id="82b47-381">After adding these Labels, the Designer in Visual Studio should look similar to Figure 18.</span></span>

<span data-ttu-id="82b47-382">[![sono stati aggiunti due controlli Label alla pagina](implementing-optimistic-concurrency-cs/_static/image51.png)](implementing-optimistic-concurrency-cs/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-382">[![Two Label Controls Have Been Added to the Page](implementing-optimistic-concurrency-cs/_static/image51.png)](implementing-optimistic-concurrency-cs/_static/image50.png)</span></span>

<span data-ttu-id="82b47-383">**Figura 18**: sono stati aggiunti due controlli Label alla pagina ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image52.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-383">**Figure 18**: Two Label Controls Have Been Added to the Page ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image52.png))</span></span>

<span data-ttu-id="82b47-384">Con questi controlli Web etichetta, si è pronti per esaminare come determinare quando si è verificata una violazione della concorrenza, a questo punto è possibile impostare la proprietà `Visible` dell'etichetta appropriata su `true`, visualizzando il messaggio informativo.</span><span class="sxs-lookup"><span data-stu-id="82b47-384">With these Label Web controls in place, we're ready to examine how to determine when a concurrency violation has occurred, at which point the appropriate Label's `Visible` property can be set to `true`, displaying the informational message.</span></span>

## <a name="handling-concurrency-violations-when-updating"></a><span data-ttu-id="82b47-385">Gestione delle violazioni della concorrenza durante l'aggiornamento</span><span class="sxs-lookup"><span data-stu-id="82b47-385">Handling Concurrency Violations When Updating</span></span>

<span data-ttu-id="82b47-386">Si osservi prima di tutto come gestire le violazioni della concorrenza quando si usa il modello di aggiornamento batch.</span><span class="sxs-lookup"><span data-stu-id="82b47-386">Let's first look at how to handle concurrency violations when using the batch update pattern.</span></span> <span data-ttu-id="82b47-387">Poiché tali violazioni con il modello di aggiornamento batch causano la generazione di un'eccezione `DBConcurrencyException`, è necessario aggiungere codice alla pagina ASP.NET per determinare se si è verificata un'eccezione `DBConcurrencyException` durante il processo di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="82b47-387">Since such violations with the batch update pattern cause a `DBConcurrencyException` exception to be thrown, we need to add code to our ASP.NET page to determine whether a `DBConcurrencyException` exception occurred during the update process.</span></span> <span data-ttu-id="82b47-388">In tal caso, verrà visualizzato un messaggio all'utente che indica che le modifiche non sono state salvate perché un altro utente ha modificato gli stessi dati tra il momento in cui ha iniziato a modificare il record e quando ha fatto clic sul pulsante Aggiorna.</span><span class="sxs-lookup"><span data-stu-id="82b47-388">If so, we should display a message to the user explaining that their changes were not saved because another user had modified the same data between when they started editing the record and when they clicked the Update button.</span></span>

<span data-ttu-id="82b47-389">Come è stato illustrato nella *gestione delle eccezioni a livello BLL e dal in un'esercitazione della pagina ASP.NET* , tali eccezioni possono essere rilevate ed eliminati nei gestori eventi post-level del controllo Web di dati.</span><span class="sxs-lookup"><span data-stu-id="82b47-389">As we saw in the *Handling BLL- and DAL-Level Exceptions in an ASP.NET Page* tutorial, such exceptions can be detected and suppressed in the data Web control's post-level event handlers.</span></span> <span data-ttu-id="82b47-390">Pertanto, è necessario creare un gestore eventi per l'evento `RowUpdated` di GridView che controlla se è stata generata un'eccezione di `DBConcurrencyException`.</span><span class="sxs-lookup"><span data-stu-id="82b47-390">Therefore, we need to create an event handler for the GridView's `RowUpdated` event that checks if a `DBConcurrencyException` exception has been thrown.</span></span> <span data-ttu-id="82b47-391">A questo gestore eventi viene passato un riferimento a qualsiasi eccezione generata durante il processo di aggiornamento, come illustrato nel codice del gestore eventi riportato di seguito:</span><span class="sxs-lookup"><span data-stu-id="82b47-391">This event handler is passed a reference to any exception that was raised during the updating process, as shown in the event handler code below:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample13.cs)]

<span data-ttu-id="82b47-392">In presenza di un'eccezione di `DBConcurrencyException`, questo gestore eventi Visualizza il controllo etichetta `UpdateConflictMessage` e indica che l'eccezione è stata gestita.</span><span class="sxs-lookup"><span data-stu-id="82b47-392">In the face of a `DBConcurrencyException` exception, this event handler displays the `UpdateConflictMessage` Label control and indicates that the exception has been handled.</span></span> <span data-ttu-id="82b47-393">Con questo codice, quando si verifica una violazione della concorrenza durante l'aggiornamento di un record, le modifiche apportate dall'utente vengono perse, dal momento che avrebbero sovrascritto le modifiche di un altro utente nello stesso momento.</span><span class="sxs-lookup"><span data-stu-id="82b47-393">With this code in place, when a concurrency violation occurs when updating a record, the user's changes are lost, since they would have overwritten another user's modifications at the same time.</span></span> <span data-ttu-id="82b47-394">In particolare, GridView viene restituito allo stato di pre-modifica e associato ai dati del database corrente.</span><span class="sxs-lookup"><span data-stu-id="82b47-394">In particular, the GridView is returned to its pre-editing state and bound to the current database data.</span></span> <span data-ttu-id="82b47-395">La riga GridView verrà aggiornata con le modifiche dell'altro utente, che in precedenza non erano visibili.</span><span class="sxs-lookup"><span data-stu-id="82b47-395">This will update the GridView row with the other user's changes, which were previously not visible.</span></span> <span data-ttu-id="82b47-396">Inoltre, il controllo `UpdateConflictMessage` etichetta spiegherà all'utente cosa si è appena verificato.</span><span class="sxs-lookup"><span data-stu-id="82b47-396">Additionally, the `UpdateConflictMessage` Label control will explain to the user what just happened.</span></span> <span data-ttu-id="82b47-397">Questa sequenza di eventi è descritta in dettaglio nella figura 19.</span><span class="sxs-lookup"><span data-stu-id="82b47-397">This sequence of events is detailed in Figure 19.</span></span>

<span data-ttu-id="82b47-398">[![gli aggiornamenti di un utente vengono persi in caso di violazione della concorrenza](implementing-optimistic-concurrency-cs/_static/image54.png)](implementing-optimistic-concurrency-cs/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-398">[![A User s Updates are Lost in the Face of a Concurrency Violation](implementing-optimistic-concurrency-cs/_static/image54.png)](implementing-optimistic-concurrency-cs/_static/image53.png)</span></span>

<span data-ttu-id="82b47-399">**Figura 19**: gli aggiornamenti di un utente vengono persi in caso di violazione della concorrenza ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image55.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-399">**Figure 19**: A User s Updates are Lost in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image55.png))</span></span>

> [!NOTE]
> <span data-ttu-id="82b47-400">In alternativa, anziché restituire GridView allo stato di pre-modifica, è possibile lasciare il controllo GridView nello stato di modifica impostando la proprietà `KeepInEditMode` dell'oggetto `GridViewUpdatedEventArgs` passato su true.</span><span class="sxs-lookup"><span data-stu-id="82b47-400">Alternatively, rather than returning the GridView to the pre-editing state, we could leave the GridView in its editing state by setting the `KeepInEditMode` property of the passed-in `GridViewUpdatedEventArgs` object to true.</span></span> <span data-ttu-id="82b47-401">Se si accetta questo approccio, tuttavia, è necessario riassociare i dati al GridView (richiamando il metodo `DataBind()`) in modo che i valori dell'altro utente vengano caricati nell'interfaccia di modifica.</span><span class="sxs-lookup"><span data-stu-id="82b47-401">If you take this approach, however, be certain to rebind the data to the GridView (by invoking its `DataBind()` method) so that the other user's values are loaded into the editing interface.</span></span> <span data-ttu-id="82b47-402">Il codice disponibile per il download con questa esercitazione include le due righe di codice seguenti nel gestore eventi `RowUpdated` commentato; è sufficiente rimuovere il commento da queste righe di codice in modo che GridView rimanga in modalità di modifica dopo una violazione della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="82b47-402">The code available for download with this tutorial has these two lines of code in the `RowUpdated` event handler commented out; simply uncomment these lines of code to have the GridView remain in edit mode after a concurrency violation.</span></span>

## <a name="responding-to-concurrency-violations-when-deleting"></a><span data-ttu-id="82b47-403">Risposta alle violazioni della concorrenza durante l'eliminazione</span><span class="sxs-lookup"><span data-stu-id="82b47-403">Responding to Concurrency Violations When Deleting</span></span>

<span data-ttu-id="82b47-404">Con il modello di database diretto, non viene generata alcuna eccezione in caso di violazione della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="82b47-404">With the DB direct pattern, there is no exception raised in the face of a concurrency violation.</span></span> <span data-ttu-id="82b47-405">Al contrario, l'istruzione del database non ha alcun effetto sui record, perché la clausola WHERE non corrisponde a nessun record.</span><span class="sxs-lookup"><span data-stu-id="82b47-405">Instead, the database statement simply affects no records, as the WHERE clause does not match with any record.</span></span> <span data-ttu-id="82b47-406">Tutti i metodi di modifica dei dati creati in BLL sono stati progettati in modo tale che restituiscono un valore booleano che indica se sono stati interessati o meno esattamente un record.</span><span class="sxs-lookup"><span data-stu-id="82b47-406">All of the data modification methods created in the BLL have been designed such that they return a Boolean value indicating whether or not they affected precisely one record.</span></span> <span data-ttu-id="82b47-407">Pertanto, per determinare se si è verificata una violazione di concorrenza durante l'eliminazione di un record, è possibile esaminare il valore restituito del metodo `DeleteProduct` del BLL.</span><span class="sxs-lookup"><span data-stu-id="82b47-407">Therefore, to determine if a concurrency violation occurred when deleting a record, we can examine the return value of the BLL's `DeleteProduct` method.</span></span>

<span data-ttu-id="82b47-408">Il valore restituito per un metodo BLL può essere esaminato nei gestori eventi di post-livello di ObjectDataSource tramite la proprietà `ReturnValue` dell'oggetto `ObjectDataSourceStatusEventArgs` passato nel gestore eventi.</span><span class="sxs-lookup"><span data-stu-id="82b47-408">The return value for a BLL method can be examined in the ObjectDataSource's post-level event handlers through the `ReturnValue` property of the `ObjectDataSourceStatusEventArgs` object passed into the event handler.</span></span> <span data-ttu-id="82b47-409">Poiché si è interessati a determinare il valore restituito dal metodo `DeleteProduct`, è necessario creare un gestore eventi per l'evento `Deleted` di ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="82b47-409">Since we are interested in determining the return value from the `DeleteProduct` method, we need to create an event handler for the ObjectDataSource's `Deleted` event.</span></span> <span data-ttu-id="82b47-410">La proprietà `ReturnValue` è di tipo `object` e può essere `null` se è stata generata un'eccezione e il metodo è stato interrotto prima di poter restituire un valore.</span><span class="sxs-lookup"><span data-stu-id="82b47-410">The `ReturnValue` property is of type `object` and can be `null` if an exception was raised and the method was interrupted before it could return a value.</span></span> <span data-ttu-id="82b47-411">Pertanto, è necessario assicurarsi prima che la proprietà `ReturnValue` non sia `null` e che sia un valore booleano.</span><span class="sxs-lookup"><span data-stu-id="82b47-411">Therefore, we should first ensure that the `ReturnValue` property is not `null` and is a Boolean value.</span></span> <span data-ttu-id="82b47-412">Supponendo che questo controllo venga superato, viene visualizzato il controllo etichetta `DeleteConflictMessage` se il `ReturnValue` è `false`.</span><span class="sxs-lookup"><span data-stu-id="82b47-412">Assuming this check passes, we show the `DeleteConflictMessage` Label control if the `ReturnValue` is `false`.</span></span> <span data-ttu-id="82b47-413">Questa operazione può essere eseguita usando il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="82b47-413">This can be accomplished by using the following code:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample14.cs)]

<span data-ttu-id="82b47-414">In presenza di una violazione della concorrenza, la richiesta di eliminazione dell'utente viene annullata.</span><span class="sxs-lookup"><span data-stu-id="82b47-414">In the face of a concurrency violation, the user's delete request is canceled.</span></span> <span data-ttu-id="82b47-415">Il GridView viene aggiornato, mostrando le modifiche apportate al record tra il momento in cui l'utente ha caricato la pagina e quando ha fatto clic sul pulsante Elimina.</span><span class="sxs-lookup"><span data-stu-id="82b47-415">The GridView is refreshed, showing the changes that occurred for that record between the time the user loaded the page and when he clicked the Delete button.</span></span> <span data-ttu-id="82b47-416">Quando si verifica una violazione di questo tipo, viene visualizzata l'etichetta `DeleteConflictMessage`, che spiega cosa si è appena verificato (vedere la figura 20).</span><span class="sxs-lookup"><span data-stu-id="82b47-416">When such a violation transpires, the `DeleteConflictMessage` Label is shown, explaining what just happened (see Figure 20).</span></span>

<span data-ttu-id="82b47-417">[![l'eliminazione di un utente viene annullata in caso di violazione della concorrenza](implementing-optimistic-concurrency-cs/_static/image57.png)](implementing-optimistic-concurrency-cs/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="82b47-417">[![A User s Delete is Canceled in the Face of a Concurrency Violation](implementing-optimistic-concurrency-cs/_static/image57.png)](implementing-optimistic-concurrency-cs/_static/image56.png)</span></span>

<span data-ttu-id="82b47-418">**Figura 20**: l'eliminazione di un utente viene annullata in caso di violazione della concorrenza ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-cs/_static/image58.png))</span><span class="sxs-lookup"><span data-stu-id="82b47-418">**Figure 20**: A User s Delete is Canceled in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image58.png))</span></span>

## <a name="summary"></a><span data-ttu-id="82b47-419">Riepilogo</span><span class="sxs-lookup"><span data-stu-id="82b47-419">Summary</span></span>

<span data-ttu-id="82b47-420">In ogni applicazione sono presenti opportunità per violazioni della concorrenza che consentono a più utenti simultanei di aggiornare o eliminare dati.</span><span class="sxs-lookup"><span data-stu-id="82b47-420">Opportunities for concurrency violations exist in every application that allows multiple, concurrent users to update or delete data.</span></span> <span data-ttu-id="82b47-421">Se tali violazioni non vengono contabilizzate, quando due utenti aggiornano contemporaneamente gli stessi dati che ricevono l'ultima scrittura "WINS", sovrascrivendo le modifiche apportate dall'altro utente.</span><span class="sxs-lookup"><span data-stu-id="82b47-421">If such violations are not accounted for, when two users simultaneously update the same data whoever gets in the last write "wins," overwriting the other user's changes changes.</span></span> <span data-ttu-id="82b47-422">In alternativa, gli sviluppatori possono implementare il controllo della concorrenza ottimistica o pessimistica.</span><span class="sxs-lookup"><span data-stu-id="82b47-422">Alternatively, developers can implement either optimistic or pessimistic concurrency control.</span></span> <span data-ttu-id="82b47-423">Il controllo della concorrenza ottimistica presuppone che le violazioni della concorrenza siano poco frequenti e non consenta semplicemente un comando di aggiornamento o eliminazione che costituirebbe una violazione della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="82b47-423">Optimistic concurrency control assumes that concurrency violations are infrequent and simply disallows an update or delete command that would constitute a concurrency violation.</span></span> <span data-ttu-id="82b47-424">Il controllo della concorrenza pessimistica presuppone che le violazioni della concorrenza siano frequenti e semplicemente rifiutare il comando di aggiornamento o eliminazione di un utente non è accettabile.</span><span class="sxs-lookup"><span data-stu-id="82b47-424">Pessimistic concurrency control assumes that concurrency violations are frequent and simply rejecting one user's update or delete command is not acceptable.</span></span> <span data-ttu-id="82b47-425">Con il controllo della concorrenza pessimistica, l'aggiornamento di un record comporta il blocco, impedendo così a tutti gli altri utenti di modificare o eliminare il record mentre è bloccato.</span><span class="sxs-lookup"><span data-stu-id="82b47-425">With pessimistic concurrency control, updating a record involves locking it, thereby preventing any other users from modifying or deleting the record while it is locked.</span></span>

<span data-ttu-id="82b47-426">Il set di dati tipizzato in .NET fornisce funzionalità per il supporto del controllo della concorrenza ottimistica.</span><span class="sxs-lookup"><span data-stu-id="82b47-426">The Typed DataSet in .NET provides functionality for supporting optimistic concurrency control.</span></span> <span data-ttu-id="82b47-427">In particolare, le istruzioni `UPDATE` e `DELETE` rilasciate nel database includono tutte le colonne della tabella, garantendo in tal modo che l'aggiornamento o l'eliminazione venga eseguita solo se i dati correnti del record corrispondono ai dati originali dell'utente durante l'esecuzione dell'aggiornamento o dell'eliminazione.</span><span class="sxs-lookup"><span data-stu-id="82b47-427">In particular, the `UPDATE` and `DELETE` statements issued to the database include all of the table's columns, thereby ensuring that the update or delete will only occur if the record's current data matches with the original data the user had when performing their update or delete.</span></span> <span data-ttu-id="82b47-428">Una volta che il DAL è stato configurato per supportare la concorrenza ottimistica, è necessario aggiornare i metodi BLL.</span><span class="sxs-lookup"><span data-stu-id="82b47-428">Once the DAL has been configured to support optimistic concurrency, the BLL methods need to be updated.</span></span> <span data-ttu-id="82b47-429">Inoltre, la pagina ASP.NET che esegue la chiamata al BLL deve essere configurata in modo tale che ObjectDataSource recuperi i valori originali dal controllo Web dei dati e li passa al BLL.</span><span class="sxs-lookup"><span data-stu-id="82b47-429">Additionally, the ASP.NET page that calls down into the BLL must be configured such that the ObjectDataSource retrieves the original values from its data Web control and passes them down into the BLL.</span></span>

<span data-ttu-id="82b47-430">Come illustrato in questa esercitazione, l'implementazione del controllo della concorrenza ottimistica in un'applicazione Web ASP.NET comporta l'aggiornamento di DAL e BLL e l'aggiunta del supporto nella pagina ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="82b47-430">As we saw in this tutorial, implementing optimistic concurrency control in an ASP.NET web application involves updating the DAL and BLL and adding support in the ASP.NET page.</span></span> <span data-ttu-id="82b47-431">Indipendentemente dal fatto che il lavoro aggiunto sia un investimento sapiente del tempo e del lavoro richiesto dipende dall'applicazione.</span><span class="sxs-lookup"><span data-stu-id="82b47-431">Whether or not this added work is a wise investment of your time and effort depends on your application.</span></span> <span data-ttu-id="82b47-432">Se non si hanno spesso utenti simultanei che aggiornano i dati oppure i dati che stanno aggiornando sono diversi l'uno dall'altro, il controllo della concorrenza non è un problema chiave.</span><span class="sxs-lookup"><span data-stu-id="82b47-432">If you infrequently have concurrent users updating data, or the data they are updating is different from one another, then concurrency control is not a key issue.</span></span> <span data-ttu-id="82b47-433">Se, tuttavia, si dispone regolarmente di più utenti nel sito che utilizzano gli stessi dati, il controllo della concorrenza può impedire la sovrascrittura accidentale degli aggiornamenti o delle eliminazioni di un utente.</span><span class="sxs-lookup"><span data-stu-id="82b47-433">If, however, you routinely have multiple users on your site working with the same data, concurrency control can help prevent one user's updates or deletes from unwittingly overwriting another's.</span></span>

<span data-ttu-id="82b47-434">Buona programmazione!</span><span class="sxs-lookup"><span data-stu-id="82b47-434">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="82b47-435">Informazioni sull'autore</span><span class="sxs-lookup"><span data-stu-id="82b47-435">About the Author</span></span>

<span data-ttu-id="82b47-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autore di sette ASP/ASP. NET Books e fondatore di [4GuysFromRolla.com](http://www.4guysfromrolla.com), collabora con le tecnologie Web Microsoft a partire da 1998.</span><span class="sxs-lookup"><span data-stu-id="82b47-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="82b47-437">Scott lavora come consulente, trainer e writer indipendenti.</span><span class="sxs-lookup"><span data-stu-id="82b47-437">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="82b47-438">Il suo ultimo libro è [*Sams Teach Yourself ASP.NET 2,0 in 24 ore*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="82b47-438">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="82b47-439">Può essere raggiunto in [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="82b47-439">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="82b47-440">o tramite il suo Blog, disponibile in [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="82b47-440">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="82b47-441">[Precedente](customizing-the-data-modification-interface-cs.md)
> [Successivo](adding-client-side-confirmation-when-deleting-cs.md)</span><span class="sxs-lookup"><span data-stu-id="82b47-441">[Previous](customizing-the-data-modification-interface-cs.md)
[Next](adding-client-side-confirmation-when-deleting-cs.md)</span></span>
