---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
title: Implementazione della concorrenza ottimistica con SqlDataSource (C#) | Microsoft Docs
author: rick-anderson
description: In questa esercitazione vengono esaminati gli elementi di base del controllo della concorrenza ottimistica e viene quindi illustrato come implementarlo tramite il controllo SqlDataSource.
ms.author: riande
ms.date: 02/20/2007
ms.assetid: df999966-ac48-460e-b82b-4877a57d6ab9
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
msc.type: authoredcontent
ms.openlocfilehash: 87fca52e2e8be844411b2fff8382c6002eccbe09
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/06/2020
ms.locfileid: "78553235"
---
# <a name="implementing-optimistic-concurrency-with-the-sqldatasource-c"></a><span data-ttu-id="d5575-103">Implementazione della concorrenza ottimistica con SqlDataSource (C#)</span><span class="sxs-lookup"><span data-stu-id="d5575-103">Implementing Optimistic Concurrency with the SqlDataSource (C#)</span></span>

<span data-ttu-id="d5575-104">di [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="d5575-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="d5575-105">[Scaricare l'app di esempio](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) o [scaricare il file PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="d5575-105">[Download Sample App](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) or [Download PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span></span>

> <span data-ttu-id="d5575-106">In questa esercitazione vengono esaminati gli elementi di base del controllo della concorrenza ottimistica e viene quindi illustrato come implementarlo tramite il controllo SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="d5575-106">In this tutorial we review the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource control.</span></span>

## <a name="introduction"></a><span data-ttu-id="d5575-107">Introduzione</span><span class="sxs-lookup"><span data-stu-id="d5575-107">Introduction</span></span>

<span data-ttu-id="d5575-108">Nell'esercitazione precedente è stato esaminato come aggiungere le funzionalità di inserimento, aggiornamento ed eliminazione al controllo SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="d5575-108">In the preceding tutorial we examined how to add inserting, updating, and deleting capabilities to the SqlDataSource control.</span></span> <span data-ttu-id="d5575-109">In breve, per fornire queste funzionalità è necessario specificare l'istruzione SQL `INSERT`, `UPDATE`o `DELETE` corrispondente nelle proprietà `InsertCommand`, `UpdateCommand`o `DeleteCommand` del controllo, insieme ai parametri appropriati nelle raccolte `InsertParameters`, `UpdateParameters`e `DeleteParameters`.</span><span class="sxs-lookup"><span data-stu-id="d5575-109">In short, to provide these features we needed to specify the corresponding `INSERT`, `UPDATE`, or `DELETE` SQL statement in the control s `InsertCommand`, `UpdateCommand`, or `DeleteCommand` properties, along with the appropriate parameters in the `InsertParameters`, `UpdateParameters`, and `DeleteParameters` collections.</span></span> <span data-ttu-id="d5575-110">Anche se queste proprietà e raccolte possono essere specificate manualmente, il pulsante Avanzate della procedura guidata Configura origine dati offre una casella di controllo genera `INSERT`, `UPDATE`e `DELETE` che creerà automaticamente tali istruzioni in base all'istruzione `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="d5575-110">While these properties and collections can be specified manually, the Configure Data Source wizard s Advanced button offers a Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox that will auto-create these statements based on the `SELECT` statement.</span></span>

<span data-ttu-id="d5575-111">Insieme alla casella di controllo genera `INSERT`, `UPDATE`e `DELETE`, la finestra di dialogo Opzioni di generazione SQL avanzate include l'opzione Usa concorrenza ottimistica (vedere la figura 1).</span><span class="sxs-lookup"><span data-stu-id="d5575-111">Along with the Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox, the Advanced SQL Generation Options dialog box includes a Use optimistic concurrency option (see Figure 1).</span></span> <span data-ttu-id="d5575-112">Se questa opzione è selezionata, le clausole `WHERE` nelle istruzioni `UPDATE` e `DELETE` generate automaticamente vengono modificate in modo da eseguire l'aggiornamento o l'eliminazione solo se i dati del database sottostanti non sono stati modificati dopo l'ultima volta che l'utente ha caricato i dati nella griglia.</span><span class="sxs-lookup"><span data-stu-id="d5575-112">When checked, the `WHERE` clauses in the autogenerated `UPDATE` and `DELETE` statements are modified to only perform the update or delete if the underlying database data hasn't been modified since the user last loaded the data into the grid.</span></span>

![È possibile aggiungere il supporto della concorrenza ottimistica dalla finestra di dialogo Opzioni avanzate di generazione SQL](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.gif)

<span data-ttu-id="d5575-114">**Figura 1**: è possibile aggiungere il supporto della concorrenza ottimistica dalla finestra di dialogo Opzioni avanzate di generazione SQL</span><span class="sxs-lookup"><span data-stu-id="d5575-114">**Figure 1**: You Can Add Optimistic Concurrency Support from the Advanced SQL Generation Options Dialog Box</span></span>

<span data-ttu-id="d5575-115">Nell'esercitazione sull' [implementazione della concorrenza ottimistica](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) sono state esaminate le nozioni di base del controllo della concorrenza ottimistica e viene illustrato come aggiungerlo a ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="d5575-115">Back in the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial we examined the fundamentals of optimistic concurrency control and how to add it to the ObjectDataSource.</span></span> <span data-ttu-id="d5575-116">In questa esercitazione verranno ritoccate le nozioni di base del controllo della concorrenza ottimistica e quindi verrà illustrato come implementarlo tramite SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="d5575-116">In this tutorial we'll retouch on the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource.</span></span>

## <a name="a-recap-of-optimistic-concurrency"></a><span data-ttu-id="d5575-117">Riepilogo della concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="d5575-117">A Recap of Optimistic Concurrency</span></span>

<span data-ttu-id="d5575-118">Per le applicazioni Web che consentono a più utenti simultanei di modificare o eliminare gli stessi dati, esiste la possibilità che un utente possa sovrascrivere accidentalmente le modifiche apportate da un altro utente.</span><span class="sxs-lookup"><span data-stu-id="d5575-118">For web applications that allow multiple, simultaneous users to edit or delete the same data, there exists a possibility that one user may accidentally overwrite another s changes.</span></span> <span data-ttu-id="d5575-119">Nell'esercitazione sull' [implementazione della concorrenza ottimistica](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) è stato fornito l'esempio seguente:</span><span class="sxs-lookup"><span data-stu-id="d5575-119">In the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial I provided the following example:</span></span>

<span data-ttu-id="d5575-120">Si supponga che due utenti, Jisun e Sam, stiano visitando una pagina di un'applicazione che consentiva ai visitatori di aggiornare ed eliminare prodotti tramite un controllo GridView.</span><span class="sxs-lookup"><span data-stu-id="d5575-120">Imagine that two users, Jisun and Sam, were both visiting a page in an application that allowed visitors to update and delete products through a GridView control.</span></span> <span data-ttu-id="d5575-121">Entrambi fanno clic sul pulsante modifica per Chai intorno allo stesso tempo.</span><span class="sxs-lookup"><span data-stu-id="d5575-121">Both click the Edit button for Chai around the same time.</span></span> <span data-ttu-id="d5575-122">Jisun modifica il nome del prodotto in Chai Tea e fa clic sul pulsante Aggiorna.</span><span class="sxs-lookup"><span data-stu-id="d5575-122">Jisun changes the product name to Chai Tea and clicks the Update button.</span></span> <span data-ttu-id="d5575-123">Il risultato finale è un'istruzione `UPDATE` inviata al database, che imposta *tutti* i campi aggiornabili del prodotto (anche se Jisun ha aggiornato solo un campo, `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="d5575-123">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product s updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="d5575-124">A questo punto, nel database sono presenti i valori Chai Tea, Category Beverage, Suppliers Exotic Liquids e così via per questo prodotto specifico.</span><span class="sxs-lookup"><span data-stu-id="d5575-124">At this point in time, the database has the values Chai Tea, the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="d5575-125">Tuttavia, la schermata GridView in Sam s Mostra ancora il nome del prodotto nella riga di GridView modificabile come Chai.</span><span class="sxs-lookup"><span data-stu-id="d5575-125">However, the GridView on Sam s screen still shows the product name in the editable GridView row as Chai.</span></span> <span data-ttu-id="d5575-126">Pochi secondi dopo il commit delle modifiche apportate a Jisun, Sam aggiorna la categoria ai condimenti e fa clic su Aggiorna.</span><span class="sxs-lookup"><span data-stu-id="d5575-126">A few seconds after Jisun s changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="d5575-127">In questo modo si ottiene un'istruzione `UPDATE` inviata al database che imposta il nome del prodotto su Chai, il `CategoryID` all'ID della categoria dei condimenti corrispondente e così via.</span><span class="sxs-lookup"><span data-stu-id="d5575-127">This results in an `UPDATE` statement sent to the database that sets the product name to Chai, the `CategoryID` to the corresponding Condiments category ID, and so on.</span></span> <span data-ttu-id="d5575-128">Jisun modifiche apportate al nome del prodotto sono state sovrascritte.</span><span class="sxs-lookup"><span data-stu-id="d5575-128">Jisun s changes to the product name have been overwritten.</span></span>

<span data-ttu-id="d5575-129">Nella figura 2 viene illustrata questa interazione.</span><span class="sxs-lookup"><span data-stu-id="d5575-129">Figure 2 illustrates this interaction.</span></span>

<span data-ttu-id="d5575-130">[![quando due utenti aggiornano contemporaneamente un record, è possibile che un utente modifichi le modifiche per sovrascrivere le altre](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="d5575-130">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span></span>

<span data-ttu-id="d5575-131">**Figura 2**: quando due utenti aggiornano contemporaneamente un record, è possibile che un utente modifichi le modifiche per sovrascrivere gli altri ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="d5575-131">**Figure 2**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span></span>

<span data-ttu-id="d5575-132">Per evitare che questo scenario venga aperto, è necessario implementare un form di [controllo della concorrenza](http://en.wikipedia.org/wiki/Concurrency_control) .</span><span class="sxs-lookup"><span data-stu-id="d5575-132">To prevent this scenario from unfolding, a form of [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) must be implemented.</span></span> <span data-ttu-id="d5575-133">La [concorrenza ottimistica](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) in questa esercitazione si basa sul presupposto che anche se possono verificarsi conflitti di concorrenza ogni ora e quindi, la maggior parte del tempo di tali conflitti non si verifica.</span><span class="sxs-lookup"><span data-stu-id="d5575-133">[Optimistic concurrency](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) the focus of this tutorial works on the assumption that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise.</span></span> <span data-ttu-id="d5575-134">Se pertanto si verifica un conflitto, il controllo della concorrenza ottimistica informa semplicemente l'utente che è possibile salvare le modifiche perché un altro utente ha modificato gli stessi dati.</span><span class="sxs-lookup"><span data-stu-id="d5575-134">Therefore, if a conflict does arise, optimistic concurrency control simply informs the user that their changes can t be saved because another user has modified the same data.</span></span>

> [!NOTE]
> <span data-ttu-id="d5575-135">Per le applicazioni in cui si presuppone che vi siano molti conflitti di concorrenza o se tali conflitti non sono tollerabili, è possibile utilizzare il controllo della concorrenza pessimistica.</span><span class="sxs-lookup"><span data-stu-id="d5575-135">For applications where it is assumed that there will be many concurrency conflicts or if such conflicts are not tolerable, then pessimistic concurrency control can be used instead.</span></span> <span data-ttu-id="d5575-136">Per una discussione più approfondita sul controllo della concorrenza pessimistica, vedere l'esercitazione sull' [implementazione della concorrenza ottimistica](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="d5575-136">Refer back to the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial for a more thorough discussion on pessimistic concurrency control.</span></span>

<span data-ttu-id="d5575-137">Il controllo della concorrenza ottimistica funziona assicurandosi che il record aggiornato o eliminato abbia gli stessi valori di quando è stato avviato il processo di aggiornamento o eliminazione.</span><span class="sxs-lookup"><span data-stu-id="d5575-137">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="d5575-138">Ad esempio, quando si fa clic sul pulsante modifica in un GridView modificabile, i valori dei record vengono letti dal database e visualizzati in caselle di testo e altri controlli Web.</span><span class="sxs-lookup"><span data-stu-id="d5575-138">For example, when clicking the Edit button in an editable GridView, the record s values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="d5575-139">Questi valori originali vengono salvati dal controllo GridView.</span><span class="sxs-lookup"><span data-stu-id="d5575-139">These original values are saved by the GridView.</span></span> <span data-ttu-id="d5575-140">Successivamente, dopo che l'utente ha apportato le modifiche e fa clic sul pulsante Aggiorna, l'istruzione `UPDATE` utilizzata deve prendere in considerazione i valori originali più i nuovi valori e aggiornare solo il record del database sottostante se i valori originali che l'utente ha iniziato a modificare sono identici ai valori ancora presenti nel database.</span><span class="sxs-lookup"><span data-stu-id="d5575-140">Later, after the user makes her changes and clicks the Update button, the `UPDATE` statement used must take into account the original values plus the new values and only update the underlying database record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="d5575-141">Nella figura 3 viene illustrata questa sequenza di eventi.</span><span class="sxs-lookup"><span data-stu-id="d5575-141">Figure 3 depicts this sequence of events.</span></span>

<span data-ttu-id="d5575-142">[![per la riuscita dell'operazione di aggiornamento o eliminazione, i valori originali devono essere uguali ai valori del database corrente](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="d5575-142">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span></span>

<span data-ttu-id="d5575-143">**Figura 3**: affinché l'aggiornamento o l'eliminazione abbia esito positivo, i valori originali devono essere uguali ai valori di database correnti ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="d5575-143">**Figure 3**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span></span>

<span data-ttu-id="d5575-144">Esistono diversi approcci per l'implementazione della concorrenza ottimistica (vedere la logica di aggiornamento della [concorrenza ottimistica](http://www.eggheadcafe.com/articles/20050719.asp) di [Peter a. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp)per una breve panoramica di alcune opzioni).</span><span class="sxs-lookup"><span data-stu-id="d5575-144">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="d5575-145">La tecnica utilizzata dal SqlDataSource (e dai set di dati tipizzati ADO.NET utilizzati nel livello di accesso ai dati) aumenta la clausola `WHERE` per includere un confronto di tutti i valori originali.</span><span class="sxs-lookup"><span data-stu-id="d5575-145">The technique used by the SqlDataSource (as well as by the ADO.NET Typed DataSets used in our Data Access Layer) augments the `WHERE` clause to include a comparison of all of the original values.</span></span> <span data-ttu-id="d5575-146">L'istruzione `UPDATE` seguente, ad esempio, aggiorna il nome e il prezzo di un prodotto solo se i valori correnti del database sono uguali ai valori recuperati in origine durante l'aggiornamento del record in GridView.</span><span class="sxs-lookup"><span data-stu-id="d5575-146">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="d5575-147">I parametri `@ProductName` e `@UnitPrice` contengono i nuovi valori immessi dall'utente, mentre `@original_ProductName` e `@original_UnitPrice` contengono i valori caricati originariamente in GridView quando è stato fatto clic sul pulsante modifica:</span><span class="sxs-lookup"><span data-stu-id="d5575-147">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample1.sql)]

<span data-ttu-id="d5575-148">Come si vedrà in questa esercitazione, l'abilitazione del controllo della concorrenza ottimistica con il SqlDataSource è semplice come il controllo di una casella di controllo.</span><span class="sxs-lookup"><span data-stu-id="d5575-148">As we'll see in this tutorial, enabling optimistic concurrency control with the SqlDataSource is as simple as checking a checkbox.</span></span>

## <a name="step-1-creating-a-sqldatasource-that-supports-optimistic-concurrency"></a><span data-ttu-id="d5575-149">Passaggio 1: creazione di un SqlDataSource che supporta la concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="d5575-149">Step 1: Creating a SqlDataSource that Supports Optimistic Concurrency</span></span>

<span data-ttu-id="d5575-150">Per iniziare, aprire la pagina `OptimisticConcurrency.aspx` dalla cartella `SqlDataSource`.</span><span class="sxs-lookup"><span data-stu-id="d5575-150">Start by opening the `OptimisticConcurrency.aspx` page from the `SqlDataSource` folder.</span></span> <span data-ttu-id="d5575-151">Trascinare un controllo SqlDataSource dalla casella degli strumenti nella finestra di progettazione, impostarne la proprietà `ID` su `ProductsDataSourceWithOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="d5575-151">Drag a SqlDataSource control from the Toolbox onto the Designer, settings its `ID` property to `ProductsDataSourceWithOptimisticConcurrency`.</span></span> <span data-ttu-id="d5575-152">Quindi, fare clic sul collegamento Configura origine dati dallo smart tag del controllo.</span><span class="sxs-lookup"><span data-stu-id="d5575-152">Next, click on the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="d5575-153">Dalla prima schermata della procedura guidata, scegliere di utilizzare il `NORTHWINDConnectionString` e fare clic su Avanti.</span><span class="sxs-lookup"><span data-stu-id="d5575-153">From the first screen in the wizard, choose to work with the `NORTHWINDConnectionString` and click Next.</span></span>

<span data-ttu-id="d5575-154">[![scegliere di usare NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="d5575-154">[![Choose to Work with the NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span></span>

<span data-ttu-id="d5575-155">**Figura 4**: scegliere di utilizzare il `NORTHWINDConnectionString` ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="d5575-155">**Figure 4**: Choose to Work with the `NORTHWINDConnectionString` ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span></span>

<span data-ttu-id="d5575-156">Per questo esempio verrà aggiunto un controllo GridView che consente agli utenti di modificare la tabella `Products`.</span><span class="sxs-lookup"><span data-stu-id="d5575-156">For this example we'll be adding a GridView that enables users to edit the `Products` table.</span></span> <span data-ttu-id="d5575-157">Quindi, dalla schermata Configura istruzione SELECT scegliere la tabella `Products` dall'elenco a discesa e selezionare le colonne `ProductID`, `ProductName`, `UnitPrice`e `Discontinued`, come illustrato nella figura 5.</span><span class="sxs-lookup"><span data-stu-id="d5575-157">Therefore, from the Configure the Select Statement screen, choose the `Products` table from the drop-down list and select the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` columns, as shown in Figure 5.</span></span>

<span data-ttu-id="d5575-158">[![dalla tabella Products, restituire le colonne ProductID, ProductName, PrezzoUnitario e Discontinued](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="d5575-158">[![From the Products Table, Return the ProductID, ProductName, UnitPrice, and Discontinued Columns](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span></span>

<span data-ttu-id="d5575-159">**Figura 5**: dalla tabella `Products`, restituire le colonne `ProductID`, `ProductName`, `UnitPrice`e `Discontinued` ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="d5575-159">**Figure 5**: From the `Products` Table, Return the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` Columns ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span></span>

<span data-ttu-id="d5575-160">Al termine della selezione delle colonne, fare clic sul pulsante avanzate per visualizzare la finestra di dialogo Opzioni avanzate di generazione SQL.</span><span class="sxs-lookup"><span data-stu-id="d5575-160">After picking the columns, click the Advanced button to bring up the Advanced SQL Generation Options dialog box.</span></span> <span data-ttu-id="d5575-161">Controllare le istruzioni genera `INSERT`, `UPDATE`e `DELETE` e usare le caselle di controllo della concorrenza ottimistica e fare clic su OK. per una schermata, vedere nuovamente la figura 1.</span><span class="sxs-lookup"><span data-stu-id="d5575-161">Check the Generate `INSERT`, `UPDATE`, and `DELETE` statements and Use optimistic concurrency checkboxes and click OK (refer back to Figure 1 for a screenshot).</span></span> <span data-ttu-id="d5575-162">Completare la procedura guidata facendo clic su Avanti, quindi su fine.</span><span class="sxs-lookup"><span data-stu-id="d5575-162">Complete the wizard by clicking Next, then Finish.</span></span>

<span data-ttu-id="d5575-163">Dopo aver completato la configurazione guidata origine dati, esaminare le proprietà `DeleteCommand` e `UpdateCommand` risultanti e le raccolte di `DeleteParameters` e `UpdateParameters`.</span><span class="sxs-lookup"><span data-stu-id="d5575-163">After completing the Configure Data Source wizard, take a moment to examine the resulting `DeleteCommand` and `UpdateCommand` properties and the `DeleteParameters` and `UpdateParameters` collections.</span></span> <span data-ttu-id="d5575-164">Il modo più semplice per eseguire questa operazione consiste nel fare clic sulla scheda origine nell'angolo in basso a sinistra per visualizzare la sintassi dichiarativa della pagina.</span><span class="sxs-lookup"><span data-stu-id="d5575-164">The easiest way to do this is to click on the Source tab in the lower left corner to see the page s declarative syntax.</span></span> <span data-ttu-id="d5575-165">Qui sarà disponibile un valore `UpdateCommand`:</span><span class="sxs-lookup"><span data-stu-id="d5575-165">There you will find an `UpdateCommand` value of:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample2.sql)]

<span data-ttu-id="d5575-166">Con sette parametri nella raccolta `UpdateParameters`:</span><span class="sxs-lookup"><span data-stu-id="d5575-166">With seven parameters in the `UpdateParameters` collection:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample3.aspx)]

<span data-ttu-id="d5575-167">Analogamente, la proprietà `DeleteCommand` e la raccolta `DeleteParameters` dovrebbero avere un aspetto simile al seguente:</span><span class="sxs-lookup"><span data-stu-id="d5575-167">Similarly, the `DeleteCommand` property and `DeleteParameters` collection should look like the following:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample4.sql)]

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample5.aspx)]

<span data-ttu-id="d5575-168">Oltre ad aumentare le clausole `WHERE` delle proprietà `UpdateCommand` e `DeleteCommand` (e aggiungere i parametri aggiuntivi alle rispettive raccolte di parametri), la selezione dell'opzione Usa concorrenza ottimistica regola altre due proprietà:</span><span class="sxs-lookup"><span data-stu-id="d5575-168">In addition to augmenting the `WHERE` clauses of the `UpdateCommand` and `DeleteCommand` properties (and adding the additional parameters to the respective parameter collections), selecting the Use optimistic concurrency option adjusts two other properties:</span></span>

- <span data-ttu-id="d5575-169">Modifica la [proprietà`ConflictDetection`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) da `OverwriteChanges` (impostazione predefinita) a `CompareAllValues`</span><span class="sxs-lookup"><span data-stu-id="d5575-169">Changes the [`ConflictDetection` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) from `OverwriteChanges` (the default) to `CompareAllValues`</span></span>
- <span data-ttu-id="d5575-170">Modifica la [proprietà`OldValuesParameterFormatString`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) da {0} (impostazione predefinita) a\_originale {0}.</span><span class="sxs-lookup"><span data-stu-id="d5575-170">Changes the [`OldValuesParameterFormatString` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) from {0} (the default) to original\_{0} .</span></span>

<span data-ttu-id="d5575-171">Quando il controllo Web dati richiama il Metodo SqlDataSource s `Update()` o `Delete()`, vengono passati i valori originali.</span><span class="sxs-lookup"><span data-stu-id="d5575-171">When the data Web control invokes the SqlDataSource s `Update()` or `Delete()` method, it passes in the original values.</span></span> <span data-ttu-id="d5575-172">Se la proprietà `ConflictDetection` SqlDataSource s è impostata su `CompareAllValues`, i valori originali vengono aggiunti al comando.</span><span class="sxs-lookup"><span data-stu-id="d5575-172">If the SqlDataSource s `ConflictDetection` property is set to `CompareAllValues`, these original values are added to the command.</span></span> <span data-ttu-id="d5575-173">La proprietà `OldValuesParameterFormatString` fornisce il modello di denominazione utilizzato per questi parametri di valore originale.</span><span class="sxs-lookup"><span data-stu-id="d5575-173">The `OldValuesParameterFormatString` property provides the naming pattern used for these original value parameters.</span></span> <span data-ttu-id="d5575-174">La configurazione guidata origine dati utilizza {0} di\_originali e assegna un nome a ogni parametro originale nelle proprietà `UpdateCommand` e `DeleteCommand` e `UpdateParameters` e `DeleteParameters` di conseguenza.</span><span class="sxs-lookup"><span data-stu-id="d5575-174">The Configure Data Source wizard uses original\_{0} and names each original parameter in the `UpdateCommand` and `DeleteCommand` properties and `UpdateParameters` and `DeleteParameters` collections accordingly.</span></span>

> [!NOTE]
> <span data-ttu-id="d5575-175">Poiché non si utilizzano le funzionalità di inserimento del controllo SqlDataSource, è possibile rimuovere la proprietà `InsertCommand` e la relativa raccolta di `InsertParameters`.</span><span class="sxs-lookup"><span data-stu-id="d5575-175">Since we re not using the SqlDataSource control s inserting capabilities, feel free to remove the `InsertCommand` property and its `InsertParameters` collection.</span></span>

## <a name="correctly-handlingnullvalues"></a><span data-ttu-id="d5575-176">Gestione corretta dei valori di`NULL`</span><span class="sxs-lookup"><span data-stu-id="d5575-176">Correctly Handling`NULL`Values</span></span>

<span data-ttu-id="d5575-177">Sfortunatamente, le istruzioni `UPDATE` e `DELETE` aumentata generate automaticamente dalla configurazione guidata origine dati *quando si utilizza* la concorrenza ottimistica non funzionano con i record che contengono valori di `NULL`.</span><span class="sxs-lookup"><span data-stu-id="d5575-177">Unfortunately, the augmented `UPDATE` and `DELETE` statements autogenerated by the Configure Data Source wizard when using optimistic concurrency do *not* work with records that contain `NULL` values.</span></span> <span data-ttu-id="d5575-178">Per capire perché, prendere in considerazione il `UpdateCommand`di SqlDataSource:</span><span class="sxs-lookup"><span data-stu-id="d5575-178">To see why, consider our SqlDataSource s `UpdateCommand`:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample6.sql)]

<span data-ttu-id="d5575-179">La colonna `UnitPrice` della tabella `Products` può includere valori di `NULL`.</span><span class="sxs-lookup"><span data-stu-id="d5575-179">The `UnitPrice` column in the `Products` table can have `NULL` values.</span></span> <span data-ttu-id="d5575-180">Se un record specifico ha un valore `NULL` per `UnitPrice`, la parte della clausola `WHERE` `[UnitPrice] = @original_UnitPrice` restituirà *sempre* false perché `NULL = NULL` restituisce sempre false.</span><span class="sxs-lookup"><span data-stu-id="d5575-180">If a particular record has a `NULL` value for `UnitPrice`, the `WHERE` clause portion `[UnitPrice] = @original_UnitPrice` will *always* evaluate to False because `NULL = NULL` always returns False.</span></span> <span data-ttu-id="d5575-181">Di conseguenza, i record che contengono `NULL` valori non possono essere modificati o eliminati perché le istruzioni `UPDATE` e `DELETE` `WHERE` le clausole non restituiranno alcuna riga da aggiornare o eliminare.</span><span class="sxs-lookup"><span data-stu-id="d5575-181">Therefore, records that contain `NULL` values cannot be edited or deleted, as the `UPDATE` and `DELETE` statements `WHERE` clauses won't return any rows to update or delete.</span></span>

> [!NOTE]
> <span data-ttu-id="d5575-182">Questo bug è stato segnalato per la prima volta a Microsoft nel giugno 2004 in [SqlDataSource genera istruzioni SQL non corrette](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) e viene pianificato per essere risolto nella versione successiva di ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d5575-182">This bug was first reported to Microsoft in June of 2004 in [SqlDataSource Generates Incorrect SQL Statements](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) and is reportedly scheduled to be fixed in the next version of ASP.NET.</span></span>

<span data-ttu-id="d5575-183">Per risolvere questo problema, è necessario aggiornare manualmente le clausole `WHERE` nelle proprietà `UpdateCommand` e `DeleteCommand` per **tutte** le colonne che possono avere valori `NULL`.</span><span class="sxs-lookup"><span data-stu-id="d5575-183">To fix this, we have to manually update the `WHERE` clauses in both the `UpdateCommand` and `DeleteCommand` properties for **all** columns that can have `NULL` values.</span></span> <span data-ttu-id="d5575-184">In generale, modificare `[ColumnName] = @original_ColumnName` in:</span><span class="sxs-lookup"><span data-stu-id="d5575-184">In general, change `[ColumnName] = @original_ColumnName` to:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample7.sql)]

<span data-ttu-id="d5575-185">Questa modifica può essere eseguita direttamente tramite il markup dichiarativo, tramite le opzioni UpdateQuery o DeleteQuery della Finestra Proprietà o tramite le schede Aggiorna ed Elimina nell'opzione specificare un'istruzione SQL personalizzata o stored procedure nella pagina Configura dati Creazione guidata origine.</span><span class="sxs-lookup"><span data-stu-id="d5575-185">This modification can be made directly through the declarative markup, via the UpdateQuery or DeleteQuery options from the Properties window, or through the UPDATE and DELETE tabs in the Specify a custom SQL statement or stored procedure option in the Configure Data Source wizard.</span></span> <span data-ttu-id="d5575-186">Anche in questo caso, è necessario apportare questa modifica per *ogni* colonna della clausola `UpdateCommand` e `DeleteCommand` s `WHERE` che può contenere valori `NULL`.</span><span class="sxs-lookup"><span data-stu-id="d5575-186">Again, this modification must be made for *every* column in the `UpdateCommand` and `DeleteCommand` s `WHERE` clause that can contain `NULL` values.</span></span>

<span data-ttu-id="d5575-187">Applicando questo risultato all'esempio, i valori `UpdateCommand` e `DeleteCommand` modificati seguenti sono i seguenti:</span><span class="sxs-lookup"><span data-stu-id="d5575-187">Applying this to our example results in the following modified `UpdateCommand` and `DeleteCommand` values:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample8.sql)]

## <a name="step-2-adding-a-gridview-with-edit-and-delete-options"></a><span data-ttu-id="d5575-188">Passaggio 2: aggiunta di un controllo GridView con le opzioni di modifica ed eliminazione</span><span class="sxs-lookup"><span data-stu-id="d5575-188">Step 2: Adding a GridView with Edit and Delete Options</span></span>

<span data-ttu-id="d5575-189">Con il SqlDataSource configurato per supportare la concorrenza ottimistica, rimane solo l'aggiunta di un controllo Web dati alla pagina che utilizza questo controllo della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="d5575-189">With the SqlDataSource configured to support optimistic concurrency, all that remains is to add a data Web control to the page that utilizes this concurrency control.</span></span> <span data-ttu-id="d5575-190">Per questa esercitazione, verrà aggiunto un controllo GridView che fornisce funzionalità di modifica ed eliminazione.</span><span class="sxs-lookup"><span data-stu-id="d5575-190">For this tutorial, let s add a GridView that provides both edit and delete functionality.</span></span> <span data-ttu-id="d5575-191">A tale scopo, trascinare un controllo GridView dalla casella degli strumenti nella finestra di progettazione e impostare la relativa `ID` su `Products`.</span><span class="sxs-lookup"><span data-stu-id="d5575-191">To accomplish this, drag a GridView from the Toolbox onto the Designer and set its `ID` to `Products`.</span></span> <span data-ttu-id="d5575-192">Dallo smart tag GridView s, associarlo al controllo `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource aggiunto nel passaggio 1.</span><span class="sxs-lookup"><span data-stu-id="d5575-192">From the GridView s smart tag, bind it to the `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource control added in Step 1.</span></span> <span data-ttu-id="d5575-193">Infine, selezionare l'opzione Abilita modifica e Abilita eliminazione dallo smart tag.</span><span class="sxs-lookup"><span data-stu-id="d5575-193">Finally, check the Enable Editing and Enable Deleting options from the smart tag.</span></span>

<span data-ttu-id="d5575-194">[![associare GridView al SqlDataSource e abilitare la modifica e l'eliminazione](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="d5575-194">[![Bind the GridView to the SqlDataSource and Enable Editing and Deleting](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span></span>

<span data-ttu-id="d5575-195">**Figura 6**: associare GridView al SqlDataSource e abilitare la modifica e l'eliminazione ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="d5575-195">**Figure 6**: Bind the GridView to the SqlDataSource and Enable Editing and Deleting ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span></span>

<span data-ttu-id="d5575-196">Dopo aver aggiunto GridView, configurarne l'aspetto rimuovendo il `ProductID` BoundField, modificando la proprietà `HeaderText` di `ProductName` BoundField in Product e aggiornando il BoundField `UnitPrice` in modo che la relativa proprietà `HeaderText` sia semplicemente price.</span><span class="sxs-lookup"><span data-stu-id="d5575-196">After adding the GridView, configure its appearance by removing the `ProductID` BoundField, changing the `ProductName` BoundField s `HeaderText` property to Product, and updating the `UnitPrice` BoundField so that its `HeaderText` property is simply Price.</span></span> <span data-ttu-id="d5575-197">Idealmente, è possibile migliorare l'interfaccia di modifica per includere un RequiredFieldValidator per il valore `ProductName` e un CompareValidator per il valore di `UnitPrice` (per assicurarsi che sia un valore numerico formattato correttamente).</span><span class="sxs-lookup"><span data-stu-id="d5575-197">Ideally, we d enhance the editing interface to include a RequiredFieldValidator for the `ProductName` value and a CompareValidator for the `UnitPrice` value (to ensure it s a properly formatted numeric value).</span></span> <span data-ttu-id="d5575-198">Per un'analisi più approfondita della personalizzazione dell'interfaccia di modifica di GridView, vedere l'esercitazione [personalizzazione dell'interfaccia di modifica dei dati](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="d5575-198">Refer to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial for a more in-depth look at customizing the GridView s editing interface.</span></span>

> [!NOTE]
> <span data-ttu-id="d5575-199">È necessario abilitare lo stato di visualizzazione di GridView perché i valori originali passati da GridView al SqlDataSource vengono archiviati in stato di visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="d5575-199">The GridView s view state must be enabled since the original values passed from the GridView to the SqlDataSource are stored in view state.</span></span>

<span data-ttu-id="d5575-200">Dopo avere apportato queste modifiche a GridView, il markup dichiarativo GridView e SqlDataSource dovrebbe essere simile al seguente:</span><span class="sxs-lookup"><span data-stu-id="d5575-200">After making these modifications to the GridView, the GridView and SqlDataSource declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample9.aspx)]

<span data-ttu-id="d5575-201">Per visualizzare il controllo della concorrenza ottimistica in azione, aprire due finestre del browser e caricare la pagina `OptimisticConcurrency.aspx` in entrambi.</span><span class="sxs-lookup"><span data-stu-id="d5575-201">To see the optimistic concurrency control in action, open two browser windows and load the `OptimisticConcurrency.aspx` page in both.</span></span> <span data-ttu-id="d5575-202">Fare clic sui pulsanti Edit (modifica) per il primo prodotto in entrambi i browser.</span><span class="sxs-lookup"><span data-stu-id="d5575-202">Click on the Edit buttons for the first product in both browsers.</span></span> <span data-ttu-id="d5575-203">In un browser modificare il nome del prodotto e fare clic su Aggiorna.</span><span class="sxs-lookup"><span data-stu-id="d5575-203">In one browser, change the product name and click Update.</span></span> <span data-ttu-id="d5575-204">Il browser effettuerà il postback e GridView tornerà alla modalità di modifica precedente, mostrando il nuovo nome del prodotto per il record appena modificato.</span><span class="sxs-lookup"><span data-stu-id="d5575-204">The browser will postback and the GridView will return to its pre-editing mode, showing the new product name for the record just edited.</span></span>

<span data-ttu-id="d5575-205">Nella seconda finestra del browser modificare il prezzo (lasciando il nome del prodotto come valore originale) e fare clic su Aggiorna.</span><span class="sxs-lookup"><span data-stu-id="d5575-205">In the second browser window, change the price (but leave the product name as its original value) and click Update.</span></span> <span data-ttu-id="d5575-206">Durante il postback, la griglia torna alla modalità di modifica precedente, ma la modifica al prezzo non viene registrata.</span><span class="sxs-lookup"><span data-stu-id="d5575-206">On postback, the grid returns to its pre-editing mode, but the change to the price is not recorded.</span></span> <span data-ttu-id="d5575-207">Il secondo browser Mostra lo stesso valore del primo nome del nuovo prodotto con il prezzo precedente.</span><span class="sxs-lookup"><span data-stu-id="d5575-207">The second browser shows the same value as the first one the new product name with the old price.</span></span> <span data-ttu-id="d5575-208">Le modifiche apportate nella seconda finestra del browser sono andate perse.</span><span class="sxs-lookup"><span data-stu-id="d5575-208">The changes made in the second browser window were lost.</span></span> <span data-ttu-id="d5575-209">Inoltre, le modifiche sono andate perse piuttosto tranquillamente, perché non era presente un'eccezione o un messaggio indicante che si è verificata una violazione della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="d5575-209">Moreover, the changes were lost rather quietly, as there was no exception or message indicating that a concurrency violation just occurred.</span></span>

<span data-ttu-id="d5575-210">[![le modifiche apportate alla seconda finestra del browser sono state perse automaticamente](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="d5575-210">[![The Changes in the Second Browser Window Were Silently Lost](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span></span>

<span data-ttu-id="d5575-211">**Figura 7**: le modifiche apportate alla seconda finestra del browser sono state perse automaticamente ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="d5575-211">**Figure 7**: The Changes in the Second Browser Window Were Silently Lost ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span></span>

<span data-ttu-id="d5575-212">Il motivo per cui non è stato eseguito il commit delle modifiche apportate al secondo browser è dovuto al fatto che la clausola `UPDATE` Statement s `WHERE` ha escluso tutti i record e pertanto non ha interessato alcuna riga.</span><span class="sxs-lookup"><span data-stu-id="d5575-212">The reason why the second browser s changes were not committed was because the `UPDATE` statement s `WHERE` clause filtered out all records and therefore did not affect any rows.</span></span> <span data-ttu-id="d5575-213">Esaminiamo di nuovo l'istruzione `UPDATE`:</span><span class="sxs-lookup"><span data-stu-id="d5575-213">Let s look at the `UPDATE` statement again:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample10.sql)]

<span data-ttu-id="d5575-214">Quando la seconda finestra del browser aggiorna il record, il nome prodotto originale specificato nella clausola `WHERE` non corrisponde al nome del prodotto esistente (poiché è stato modificato dal primo browser).</span><span class="sxs-lookup"><span data-stu-id="d5575-214">When the second browser window updates the record, the original product name specified in the `WHERE` clause doesn t match up with the existing product name (since it was changed by the first browser).</span></span> <span data-ttu-id="d5575-215">Di conseguenza, l'istruzione `[ProductName] = @original_ProductName` restituisce false e il `UPDATE` non influisce su alcun record.</span><span class="sxs-lookup"><span data-stu-id="d5575-215">Therefore, the statement `[ProductName] = @original_ProductName` returns False, and the `UPDATE` does not affect any records.</span></span>

> [!NOTE]
> <span data-ttu-id="d5575-216">L'eliminazione funziona allo stesso modo.</span><span class="sxs-lookup"><span data-stu-id="d5575-216">Delete works in the same manner.</span></span> <span data-ttu-id="d5575-217">Con due finestre del browser aperte, iniziare modificando un determinato prodotto con uno e quindi salvando le modifiche.</span><span class="sxs-lookup"><span data-stu-id="d5575-217">With two browser windows open, start by editing a given product with one, and then saving its changes.</span></span> <span data-ttu-id="d5575-218">Dopo aver salvato le modifiche in un unico browser, fare clic sul pulsante Elimina per lo stesso prodotto nell'altro.</span><span class="sxs-lookup"><span data-stu-id="d5575-218">After saving the changes in the one browser, click the Delete button for the same product in the other.</span></span> <span data-ttu-id="d5575-219">Poiché i valori originali non corrispondono nella clausola `DELETE` Statement s `WHERE`, l'eliminazione non riesce automaticamente.</span><span class="sxs-lookup"><span data-stu-id="d5575-219">Since the original values don t match up in the `DELETE` statement s `WHERE` clause, the delete silently fails.</span></span>

<span data-ttu-id="d5575-220">Dal punto di vista dell'utente finale nella seconda finestra del browser, dopo aver fatto clic sul pulsante Aggiorna la griglia torna alla modalità di modifica preliminare, ma le modifiche sono andate perse.</span><span class="sxs-lookup"><span data-stu-id="d5575-220">From the end user s perspective in the second browser window, after clicking the Update button the grid returns to the pre-editing mode, but their changes were lost.</span></span> <span data-ttu-id="d5575-221">Tuttavia, non c'è alcun feedback visivo che le modifiche non sono state apportate.</span><span class="sxs-lookup"><span data-stu-id="d5575-221">However, there s no visual feedback that their changes didn't stick.</span></span> <span data-ttu-id="d5575-222">Idealmente, se le modifiche apportate a un utente vengono perse in caso di violazione della concorrenza, verranno inviate notifiche e, forse, la griglia verrà mantenuta in modalità di modifica.</span><span class="sxs-lookup"><span data-stu-id="d5575-222">Ideally, if a user s changes are lost to a concurrency violation, we d notify them and, perhaps, keep the grid in edit mode.</span></span> <span data-ttu-id="d5575-223">Si osservi come eseguire questa operazione.</span><span class="sxs-lookup"><span data-stu-id="d5575-223">Let s look at how to accomplish this.</span></span>

## <a name="step-3-determining-when-a-concurrency-violation-has-occurred"></a><span data-ttu-id="d5575-224">Passaggio 3: determinazione del momento in cui si è verificata una violazione di concorrenza</span><span class="sxs-lookup"><span data-stu-id="d5575-224">Step 3: Determining When a Concurrency Violation Has Occurred</span></span>

<span data-ttu-id="d5575-225">Poiché una violazione della concorrenza rifiuta le modifiche apportate, è utile avvisare l'utente quando si è verificata una violazione della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="d5575-225">Since a concurrency violation rejects the changes one has made, it would be nice to alert the user when a concurrency violation has occurred.</span></span> <span data-ttu-id="d5575-226">Per avvisare l'utente, aggiungere un controllo Web Label alla parte superiore della pagina denominata `ConcurrencyViolationMessage` la cui proprietà `Text` Visualizza il messaggio seguente: si è tentato di aggiornare o eliminare un record che è stato aggiornato contemporaneamente da un altro utente.</span><span class="sxs-lookup"><span data-stu-id="d5575-226">To alert the user, let s add a Label Web control to the top of the page named `ConcurrencyViolationMessage` whose `Text` property displays the following message: You have attempted to update or delete a record that was simultaneously updated by another user.</span></span> <span data-ttu-id="d5575-227">Verificare le modifiche apportate dall'altro utente e quindi ripetere l'aggiornamento o l'eliminazione.</span><span class="sxs-lookup"><span data-stu-id="d5575-227">Please review the other user's changes and then redo your update or delete.</span></span> <span data-ttu-id="d5575-228">Impostare il controllo Label s `CssClass` proprietà su Warning, ovvero una classe CSS definita in `Styles.css` che Visualizza il testo in un tipo di carattere rosso, corsivo, grassetto e grande.</span><span class="sxs-lookup"><span data-stu-id="d5575-228">Set the Label control s `CssClass` property to Warning, which is a CSS class defined in `Styles.css` that displays text in a red, italic, bold, and large font.</span></span> <span data-ttu-id="d5575-229">Infine, impostare l'etichetta s `Visible` e `EnableViewState` proprietà su `false`.</span><span class="sxs-lookup"><span data-stu-id="d5575-229">Finally, set the Label s `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="d5575-230">In questo modo, l'etichetta viene nascosta solo per i postback in cui la proprietà `Visible` viene impostata in modo esplicito su `true`.</span><span class="sxs-lookup"><span data-stu-id="d5575-230">This will hide the Label except for only those postbacks where we explicitly set its `Visible` property to `true`.</span></span>

<span data-ttu-id="d5575-231">[![aggiungere un controllo etichetta alla pagina per visualizzare l'avviso](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="d5575-231">[![Add a Label Control to the Page to Display the Warning](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span></span>

<span data-ttu-id="d5575-232">**Figura 8**: aggiungere un controllo etichetta alla pagina per visualizzare l'avviso ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="d5575-232">**Figure 8**: Add a Label Control to the Page to Display the Warning ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span></span>

<span data-ttu-id="d5575-233">Quando si esegue un aggiornamento o un'eliminazione, i gestori di eventi `RowUpdated` e `RowDeleted` di GridView vengono attivati dopo che il controllo origine dati ha eseguito l'aggiornamento o l'eliminazione richiesta.</span><span class="sxs-lookup"><span data-stu-id="d5575-233">When performing an update or delete, the GridView s `RowUpdated` and `RowDeleted` event handlers fire after its data source control has performed the requested update or delete.</span></span> <span data-ttu-id="d5575-234">È possibile determinare il numero di righe interessate dall'operazione da questi gestori eventi.</span><span class="sxs-lookup"><span data-stu-id="d5575-234">We can determine how many rows were affected by the operation from these event handlers.</span></span> <span data-ttu-id="d5575-235">Se sono state interessate zero righe, si desidera visualizzare l'etichetta `ConcurrencyViolationMessage`.</span><span class="sxs-lookup"><span data-stu-id="d5575-235">If zero rows were affected, we want to display the `ConcurrencyViolationMessage` Label.</span></span>

<span data-ttu-id="d5575-236">Creare un gestore eventi per gli eventi `RowUpdated` e `RowDeleted` e aggiungere il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="d5575-236">Create an event handler for both the `RowUpdated` and `RowDeleted` events and add the following code:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample11.cs)]

<span data-ttu-id="d5575-237">In entrambi i gestori eventi si controlla la proprietà `e.AffectedRows` e, se è uguale a 0, impostare la proprietà `Visible` `ConcurrencyViolationMessage` Label su `true`.</span><span class="sxs-lookup"><span data-stu-id="d5575-237">In both event handlers we check the `e.AffectedRows` property and, if it equals 0, set the `ConcurrencyViolationMessage` Label s `Visible` property to `true`.</span></span> <span data-ttu-id="d5575-238">Nel gestore dell'evento `RowUpdated` viene inoltre indicato a GridView di rimanere in modalità di modifica impostando la proprietà `KeepInEditMode` su true.</span><span class="sxs-lookup"><span data-stu-id="d5575-238">In the `RowUpdated` event handler, we also instruct the GridView to stay in edit mode by setting the `KeepInEditMode` property to true.</span></span> <span data-ttu-id="d5575-239">In questo modo, è necessario riassociare i dati alla griglia in modo che i dati degli altri utenti vengano caricati nell'interfaccia di modifica.</span><span class="sxs-lookup"><span data-stu-id="d5575-239">In doing so, we need to rebind the data to the grid so that the other user s data is loaded into the editing interface.</span></span> <span data-ttu-id="d5575-240">Questa operazione viene eseguita chiamando il Metodo GridView s `DataBind()`.</span><span class="sxs-lookup"><span data-stu-id="d5575-240">This is accomplished by calling the GridView s `DataBind()` method.</span></span>

<span data-ttu-id="d5575-241">Come illustrato nella figura 9, con questi due gestori eventi, viene visualizzato un messaggio molto evidente quando si verifica una violazione della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="d5575-241">As Figure 9 shows, with these two event handlers, a very noticeable message is displayed whenever a concurrency violation occurs.</span></span>

<span data-ttu-id="d5575-242">[![viene visualizzato un messaggio in caso di violazione della concorrenza](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="d5575-242">[![A Message is Displayed in the Face of a Concurrency Violation](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span></span>

<span data-ttu-id="d5575-243">**Figura 9**: viene visualizzato un messaggio in caso di violazione della concorrenza ([fare clic per visualizzare l'immagine con dimensioni complete](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="d5575-243">**Figure 9**: A Message is Displayed in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span></span>

## <a name="summary"></a><span data-ttu-id="d5575-244">Riepilogo</span><span class="sxs-lookup"><span data-stu-id="d5575-244">Summary</span></span>

<span data-ttu-id="d5575-245">Quando si crea un'applicazione Web in cui più utenti simultanei possono modificare gli stessi dati, è importante prendere in considerazione le opzioni di controllo della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="d5575-245">When creating a web application where multiple, concurrent users may be editing the same data, it is important to consider concurrency control options.</span></span> <span data-ttu-id="d5575-246">Per impostazione predefinita, i controlli Web e i controlli origine dati di ASP.NET non utilizzano alcun controllo della concorrenza.</span><span class="sxs-lookup"><span data-stu-id="d5575-246">By default, the ASP.NET data Web controls and data source controls do not employ any concurrency control.</span></span> <span data-ttu-id="d5575-247">Come illustrato in questa esercitazione, l'implementazione del controllo della concorrenza ottimistica con SqlDataSource è relativamente rapida e semplice.</span><span class="sxs-lookup"><span data-stu-id="d5575-247">As we saw in this tutorial, implementing optimistic concurrency control with the SqlDataSource is relatively quick and easy.</span></span> <span data-ttu-id="d5575-248">Il SqlDataSource gestisce la maggior parte delle operazioni preliminari per l'aggiunta delle clausole di `WHERE` aumentata alle istruzioni `UPDATE` e `DELETE` generate automaticamente, ma sono disponibili alcune sottigliezze per la gestione delle colonne di valori di `NULL`, come illustrato nella sezione corretta gestione dei valori di `NULL`.</span><span class="sxs-lookup"><span data-stu-id="d5575-248">The SqlDataSource handles most of the legwork for your adding augmented `WHERE` clauses to the autogenerated `UPDATE` and `DELETE` statements but there are a few subtleties in handling `NULL` value columns, as discussed in the Correctly Handling `NULL` Values section.</span></span>

<span data-ttu-id="d5575-249">Questa esercitazione conclude l'esame del SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="d5575-249">This tutorial concludes our examination of the SqlDataSource.</span></span> <span data-ttu-id="d5575-250">Le esercitazioni rimanenti torneranno a lavorare con i dati usando ObjectDataSource e l'architettura a livelli.</span><span class="sxs-lookup"><span data-stu-id="d5575-250">Our remaining tutorials will return to working with data using the ObjectDataSource and tiered architecture.</span></span>

<span data-ttu-id="d5575-251">Buona programmazione!</span><span class="sxs-lookup"><span data-stu-id="d5575-251">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="d5575-252">Informazioni sull'autore</span><span class="sxs-lookup"><span data-stu-id="d5575-252">About the Author</span></span>

<span data-ttu-id="d5575-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autore di sette ASP/ASP. NET Books e fondatore di [4GuysFromRolla.com](http://www.4guysfromrolla.com), collabora con le tecnologie Web Microsoft a partire da 1998.</span><span class="sxs-lookup"><span data-stu-id="d5575-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="d5575-254">Scott lavora come consulente, trainer e writer indipendenti.</span><span class="sxs-lookup"><span data-stu-id="d5575-254">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="d5575-255">Il suo ultimo libro è [*Sams Teach Yourself ASP.NET 2,0 in 24 ore*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="d5575-255">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="d5575-256">Può essere raggiunto in [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="d5575-256">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="d5575-257">o tramite il suo Blog, disponibile in [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="d5575-257">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="d5575-258">[Precedente](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
> [Successivo](querying-data-with-the-sqldatasource-control-vb.md)</span><span class="sxs-lookup"><span data-stu-id="d5575-258">[Previous](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
[Next](querying-data-with-the-sqldatasource-control-vb.md)</span></span>
