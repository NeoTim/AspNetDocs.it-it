---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: Gestione della concorrenza con il Entity Framework 4,0 in un'applicazione Web ASP.NET 4 | Microsoft Docs
author: tdykstra
description: Questa serie di esercitazioni si basa sull'applicazione Web Contoso University creata dal Introduzione con la serie di esercitazioni Entity Framework 4,0. È...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 3df5f7d9c8fb22e1ea34fe16560bdb9a1309bb56
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/06/2020
ms.locfileid: "78632587"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="a2698-104">Gestione della concorrenza con il Entity Framework 4,0 in un'applicazione Web ASP.NET 4</span><span class="sxs-lookup"><span data-stu-id="a2698-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="a2698-105">di [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="a2698-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="a2698-106">Questa serie di esercitazioni si basa sull'applicazione Web Contoso University creata dal [Introduzione con la](https://asp.net/entity-framework/tutorials#Getting%20Started) serie di esercitazioni Entity Framework 4,0.</span><span class="sxs-lookup"><span data-stu-id="a2698-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="a2698-107">Se le esercitazioni precedenti non sono state completate, come punto di partenza per questa esercitazione è possibile [scaricare l'applicazione](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) creata.</span><span class="sxs-lookup"><span data-stu-id="a2698-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="a2698-108">È anche possibile [scaricare l'applicazione](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) creata dalla serie di esercitazioni complete.</span><span class="sxs-lookup"><span data-stu-id="a2698-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="a2698-109">In caso di domande sulle esercitazioni, è possibile pubblicarle nel [Forum di ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="a2698-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="a2698-110">Nell'esercitazione precedente si è appreso come ordinare e filtrare i dati usando il controllo `ObjectDataSource` e il Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="a2698-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="a2698-111">Questa esercitazione illustra le opzioni per la gestione della concorrenza in un'applicazione Web ASP.NET che usa la Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="a2698-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="a2698-112">Si creerà una nuova pagina Web dedicata ad aggiornare le assegnazioni di Office Instructor.</span><span class="sxs-lookup"><span data-stu-id="a2698-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="a2698-113">Si gestiranno problemi di concorrenza in questa pagina e nella pagina Departments creata in precedenza.</span><span class="sxs-lookup"><span data-stu-id="a2698-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="a2698-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="a2698-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="a2698-116">Conflitti di concorrenza</span><span class="sxs-lookup"><span data-stu-id="a2698-116">Concurrency Conflicts</span></span>

<span data-ttu-id="a2698-117">Un conflitto di concorrenza si verifica quando un utente modifica un record e un altro utente modifica lo stesso record prima che la modifica del primo utente venga scritta nel database.</span><span class="sxs-lookup"><span data-stu-id="a2698-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="a2698-118">Se non si configura l'Entity Framework per rilevare tali conflitti, chi aggiorna il database sovrascrive le modifiche apportate dall'altro utente.</span><span class="sxs-lookup"><span data-stu-id="a2698-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="a2698-119">In molte applicazioni questo rischio è accettabile e non è necessario configurare l'applicazione per gestire i possibili conflitti di concorrenza.</span><span class="sxs-lookup"><span data-stu-id="a2698-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="a2698-120">Se sono presenti pochi utenti, o pochi aggiornamenti, o se non è molto importante se alcune modifiche vengono sovrascritte, il costo della programmazione per la concorrenza potrebbe superare il vantaggio. Se non è necessario preoccuparsi dei conflitti di concorrenza, è possibile ignorare questa esercitazione. le due esercitazioni rimanenti della serie non dipendono da tutto ciò che si compila in questo.</span><span class="sxs-lookup"><span data-stu-id="a2698-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="a2698-121">Concorrenza pessimistica (blocco)</span><span class="sxs-lookup"><span data-stu-id="a2698-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="a2698-122">Se è importante che l'applicazione eviti la perdita accidentale di dati in scenari di concorrenza, un metodo per garantire che ciò accada è l'uso dei blocchi di database.</span><span class="sxs-lookup"><span data-stu-id="a2698-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="a2698-123">Questa operazione viene definita *concorrenza pessimistica*.</span><span class="sxs-lookup"><span data-stu-id="a2698-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="a2698-124">Ad esempio, prima di leggere una riga da un database si richiede un blocco per l'accesso di sola lettura o per l'accesso in modalità aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="a2698-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="a2698-125">Se si blocca una riga per l'accesso di aggiornamento, nessun altro utente può bloccare la riga per l'accesso di sola lettura o di aggiornamento, perché riceverebbe una copia di dati dei quali è in corso la modifica.</span><span class="sxs-lookup"><span data-stu-id="a2698-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="a2698-126">Se si blocca una riga per l'accesso in sola lettura, anche altri utenti possono bloccarla per l'accesso in sola lettura, ma non per l'aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="a2698-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="a2698-127">La gestione dei blocchi presenta alcuni svantaggi.</span><span class="sxs-lookup"><span data-stu-id="a2698-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="a2698-128">La sua programmazione può risultare complicata.</span><span class="sxs-lookup"><span data-stu-id="a2698-128">It can be complex to program.</span></span> <span data-ttu-id="a2698-129">Richiede risorse di gestione di database significative e può causare problemi di prestazioni con l'aumentare del numero di utenti di un'applicazione (ovvero, non si adatta alla scalabilità).</span><span class="sxs-lookup"><span data-stu-id="a2698-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="a2698-130">Per questi motivi non tutti i sistemi di gestione di database supportano la concorrenza pessimistica.</span><span class="sxs-lookup"><span data-stu-id="a2698-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="a2698-131">Il Entity Framework non fornisce alcun supporto incorporato e in questa esercitazione non viene illustrato come implementarlo.</span><span class="sxs-lookup"><span data-stu-id="a2698-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="a2698-132">Concorrenza ottimistica</span><span class="sxs-lookup"><span data-stu-id="a2698-132">Optimistic Concurrency</span></span>

<span data-ttu-id="a2698-133">L'alternativa alla concorrenza pessimistica è la *concorrenza ottimistica*.</span><span class="sxs-lookup"><span data-stu-id="a2698-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="a2698-134">Nella concorrenza ottimistica si consente che i conflitti di concorrenza si verifichino, quindi si reagisce con le modalità appropriate.</span><span class="sxs-lookup"><span data-stu-id="a2698-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="a2698-135">Ad esempio, Giorgio esegue la pagina *Department. aspx* , fa clic sul collegamento **modifica** per il reparto cronologia e riduce l'importo del **Budget** compreso tra $1.000.000,00 e $125.000,00.</span><span class="sxs-lookup"><span data-stu-id="a2698-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="a2698-136">Giorgio amministra un reparto in competizione e vuole liberare denaro per il proprio reparto.</span><span class="sxs-lookup"><span data-stu-id="a2698-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="a2698-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="a2698-138">Prima che Giorgio faccia clic su **Aggiorna**, Jane esegue la stessa pagina, fa clic sul collegamento **modifica** per il reparto cronologia, quindi modifica il campo **Data di inizio** da 1/10/2011 a 1/1/1999.</span><span class="sxs-lookup"><span data-stu-id="a2698-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="a2698-139">Jane gestisce il reparto di cronologia e vuole assegnargli maggiore maggiore.</span><span class="sxs-lookup"><span data-stu-id="a2698-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="a2698-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="a2698-141">Giorgio fa clic prima su **Aggiorna** , quindi Jane fa clic su **Aggiorna**.</span><span class="sxs-lookup"><span data-stu-id="a2698-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="a2698-142">Il browser di Jane ora elenca l'importo del **budget** come $1.000.000,00, ma ciò non è corretto perché l'importo è stato modificato da giorgio a $125.000,00.</span><span class="sxs-lookup"><span data-stu-id="a2698-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="a2698-143">Di seguito sono riportate alcune delle azioni che è possibile eseguire in questo scenario:</span><span class="sxs-lookup"><span data-stu-id="a2698-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="a2698-144">È possibile tenere traccia della proprietà che un utente ha modificato e aggiornare solo le colonne corrispondenti nel database.</span><span class="sxs-lookup"><span data-stu-id="a2698-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="a2698-145">Nello scenario dell'esempio non si perde nessun dato, perché i due utenti hanno aggiornato proprietà diverse.</span><span class="sxs-lookup"><span data-stu-id="a2698-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="a2698-146">Alla successiva esplorazione del reparto cronologia, verranno visualizzati 1/1/1999 e $125.000,00.</span><span class="sxs-lookup"><span data-stu-id="a2698-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="a2698-147">Si tratta del comportamento predefinito nel Entity Framework e può ridurre notevolmente il numero di conflitti che potrebbero comportare la perdita di dati.</span><span class="sxs-lookup"><span data-stu-id="a2698-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="a2698-148">Questo comportamento, tuttavia, non consente di evitare la perdita di dati se vengono apportate modifiche in conflitto alla stessa proprietà di un'entità.</span><span class="sxs-lookup"><span data-stu-id="a2698-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="a2698-149">Inoltre, questo comportamento non è sempre possibile; Quando si esegue il mapping di stored procedure a un tipo di entità, tutte le proprietà di un'entità vengono aggiornate quando vengono apportate modifiche all'entità nel database.</span><span class="sxs-lookup"><span data-stu-id="a2698-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="a2698-150">È possibile lasciare che la modifica di Jane sovrascriva la modifica di John.</span><span class="sxs-lookup"><span data-stu-id="a2698-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="a2698-151">Quando Jane fa clic su **Aggiorna**, l'importo del **Budget** torna a $1.000.000,00.</span><span class="sxs-lookup"><span data-stu-id="a2698-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="a2698-152">Questo scenario è detto *Priorità client* o *Last in Wins* (Priorità ultimo accesso).</span><span class="sxs-lookup"><span data-stu-id="a2698-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="a2698-153">I valori del client hanno la precedenza sugli elementi presenti nell'archivio dati.</span><span class="sxs-lookup"><span data-stu-id="a2698-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="a2698-154">È possibile impedire che la modifica di Jane venga aggiornata nel database.</span><span class="sxs-lookup"><span data-stu-id="a2698-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="a2698-155">In genere, viene visualizzato un messaggio di errore, viene visualizzato lo stato corrente dei dati e viene consentita la reimmissione delle modifiche nel caso in cui si desideri comunque crearli.</span><span class="sxs-lookup"><span data-stu-id="a2698-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="a2698-156">È possibile automatizzare ulteriormente il processo salvando l'input e concedendo la possibilità di riapplicarlo senza dover immetterlo di nuovo.</span><span class="sxs-lookup"><span data-stu-id="a2698-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="a2698-157">Questo scenario è detto *Store Wins* (Priorità archivio).</span><span class="sxs-lookup"><span data-stu-id="a2698-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="a2698-158">I valori dell'archivio dati hanno la precedenza sui valori inoltrati dal client.</span><span class="sxs-lookup"><span data-stu-id="a2698-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="a2698-159">Rilevamento dei conflitti di concorrenza</span><span class="sxs-lookup"><span data-stu-id="a2698-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="a2698-160">Nella Entity Framework è possibile risolvere i conflitti gestendo `OptimisticConcurrencyException` eccezioni generate dal Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="a2698-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="a2698-161">Per determinare quando generare queste eccezioni, Entity Framework deve essere in grado di rilevare i conflitti.</span><span class="sxs-lookup"><span data-stu-id="a2698-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="a2698-162">Pertanto è necessario configurare il database e il modello di dati in modo appropriato.</span><span class="sxs-lookup"><span data-stu-id="a2698-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="a2698-163">Di seguito sono elencate alcune opzioni per abilitare il rilevamento dei conflitti:</span><span class="sxs-lookup"><span data-stu-id="a2698-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="a2698-164">Nel database includere una colonna della tabella che può essere utilizzata per determinare quando una riga è stata modificata.</span><span class="sxs-lookup"><span data-stu-id="a2698-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="a2698-165">È quindi possibile configurare il Entity Framework per includere tale colonna nella clausola `Where` dei comandi SQL `Update` o `Delete`.</span><span class="sxs-lookup"><span data-stu-id="a2698-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="a2698-166">Questo è lo scopo della colonna `Timestamp` nella tabella `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="a2698-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="a2698-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="a2698-168">Il tipo di dati della colonna `Timestamp` viene anche chiamato `Timestamp`.</span><span class="sxs-lookup"><span data-stu-id="a2698-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="a2698-169">Tuttavia, la colonna non contiene effettivamente un valore di data o ora.</span><span class="sxs-lookup"><span data-stu-id="a2698-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="a2698-170">Il valore è invece un numero sequenziale che viene incrementato ogni volta che la riga viene aggiornata.</span><span class="sxs-lookup"><span data-stu-id="a2698-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="a2698-171">In un `Update` o in un comando `Delete` la clausola `Where` include il valore `Timestamp` originale.</span><span class="sxs-lookup"><span data-stu-id="a2698-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="a2698-172">Se la riga da aggiornare è stata modificata da un altro utente, il valore in `Timestamp` è diverso dal valore originale, quindi la clausola `Where` non restituisce alcuna riga da aggiornare.</span><span class="sxs-lookup"><span data-stu-id="a2698-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="a2698-173">Quando il Entity Framework rileva che nessuna riga è stata aggiornata dal comando `Update` o `Delete` corrente, ovvero quando il numero di righe interessate è pari a zero, lo interpreta come un conflitto di concorrenza.</span><span class="sxs-lookup"><span data-stu-id="a2698-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="a2698-174">Configurare la Entity Framework per includere i valori originali di ogni colonna nella tabella nella clausola `Where` dei comandi `Update` e `Delete`.</span><span class="sxs-lookup"><span data-stu-id="a2698-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="a2698-175">Come nella prima opzione, se qualsiasi elemento nella riga è stato modificato dopo la prima lettura della riga, la clausola `Where` non restituirà una riga da aggiornare, che l'Entity Framework interpreta come un conflitto di concorrenza.</span><span class="sxs-lookup"><span data-stu-id="a2698-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="a2698-176">Questo metodo è efficace come l'uso di un campo di `Timestamp`, ma può risultare inefficiente.</span><span class="sxs-lookup"><span data-stu-id="a2698-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="a2698-177">Per le tabelle di database che contengono molte colonne, è possibile che si verifichino clausole di `Where` molto grandi e in un'applicazione Web può essere necessario mantenere grandi quantità di stato.</span><span class="sxs-lookup"><span data-stu-id="a2698-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="a2698-178">La gestione di grandi quantità di stato può influire sulle prestazioni dell'applicazione perché richiede risorse del server, ad esempio lo stato della sessione, oppure deve essere incluso nella pagina Web stessa, ad esempio lo stato di visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="a2698-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="a2698-179">In questa esercitazione verrà aggiunta la gestione degli errori per i conflitti di concorrenza ottimistica per un'entità che non dispone di una proprietà di rilevamento (l'entità `Department`) e per un'entità che dispone di una proprietà di rilevamento (l'entità `OfficeAssignment`).</span><span class="sxs-lookup"><span data-stu-id="a2698-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="a2698-180">Gestione della concorrenza ottimistica senza una proprietà di rilevamento</span><span class="sxs-lookup"><span data-stu-id="a2698-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="a2698-181">Per implementare la concorrenza ottimistica per l'entità `Department`, che non ha una proprietà di rilevamento (`Timestamp`), si completeranno le attività seguenti:</span><span class="sxs-lookup"><span data-stu-id="a2698-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="a2698-182">Modificare il modello di dati per abilitare il rilevamento della concorrenza per le entità `Department`.</span><span class="sxs-lookup"><span data-stu-id="a2698-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="a2698-183">Nella classe `SchoolRepository` gestire le eccezioni di concorrenza nel metodo `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="a2698-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="a2698-184">Nella pagina *Departments. aspx* gestire le eccezioni di concorrenza visualizzando un messaggio all'utente per avvisare che le modifiche apportate non sono riuscite.</span><span class="sxs-lookup"><span data-stu-id="a2698-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="a2698-185">L'utente può quindi visualizzare i valori correnti e ripetere le modifiche se sono ancora necessari.</span><span class="sxs-lookup"><span data-stu-id="a2698-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="a2698-186">Abilitazione del rilevamento della concorrenza nel modello di dati</span><span class="sxs-lookup"><span data-stu-id="a2698-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="a2698-187">In Visual Studio aprire l'applicazione Web Contoso University con cui si stava lavorando nell'esercitazione precedente di questa serie.</span><span class="sxs-lookup"><span data-stu-id="a2698-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="a2698-188">Aprire *SchoolModel. edmx*e in Progettazione modelli di dati fare clic con il pulsante destro del mouse sulla proprietà `Name` nell'entità `Department`, quindi scegliere **Proprietà**.</span><span class="sxs-lookup"><span data-stu-id="a2698-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="a2698-189">Nella finestra **Proprietà** modificare la proprietà `ConcurrencyMode` in `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="a2698-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="a2698-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="a2698-191">Eseguire la stessa operazione per le altre proprietà scalari non primarie chiave (`Budget`, `StartDate`e `Administrator`). Non è possibile eseguire questa operazione per le proprietà di navigazione. In questo modo viene specificato che ogni volta che il Entity Framework genera un comando SQL `Update` o `Delete` per aggiornare l'entità `Department` nel database, è necessario includere nella clausola `Where` le colonne con valori originali.</span><span class="sxs-lookup"><span data-stu-id="a2698-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="a2698-192">Se non viene trovata alcuna riga durante l'esecuzione del comando `Update` o `Delete`, il Entity Framework genererà un'eccezione di concorrenza ottimistica.</span><span class="sxs-lookup"><span data-stu-id="a2698-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="a2698-193">Salvare e chiudere il modello di dati.</span><span class="sxs-lookup"><span data-stu-id="a2698-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="a2698-194">Gestione delle eccezioni di concorrenza nel DAL</span><span class="sxs-lookup"><span data-stu-id="a2698-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="a2698-195">Aprire *SchoolRepository.cs* e aggiungere l'istruzione `using` seguente per lo spazio dei nomi `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="a2698-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="a2698-196">Aggiungere il nuovo metodo di `SaveChanges` seguente che gestisce le eccezioni di concorrenza ottimistica:</span><span class="sxs-lookup"><span data-stu-id="a2698-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="a2698-197">Se si verifica un errore di concorrenza quando viene chiamato questo metodo, i valori delle proprietà dell'entità in memoria vengono sostituiti con i valori attualmente presenti nel database.</span><span class="sxs-lookup"><span data-stu-id="a2698-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="a2698-198">L'eccezione di concorrenza viene nuovamente generata in modo che la pagina Web possa gestirla.</span><span class="sxs-lookup"><span data-stu-id="a2698-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="a2698-199">Nei metodi `DeleteDepartment` e `UpdateDepartment` sostituire la chiamata esistente a `context.SaveChanges()` con una chiamata a `SaveChanges()` per richiamare il nuovo metodo.</span><span class="sxs-lookup"><span data-stu-id="a2698-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="a2698-200">Gestione delle eccezioni di concorrenza nel livello di presentazione</span><span class="sxs-lookup"><span data-stu-id="a2698-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="a2698-201">Aprire *repartitions. aspx* e aggiungere un attributo `OnDeleted="DepartmentsObjectDataSource_Deleted"` al controllo `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="a2698-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="a2698-202">Il tag di apertura per il controllo sarà simile all'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="a2698-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="a2698-203">Nel controllo `DepartmentsGridView` specificare tutte le colonne della tabella nell'attributo `DataKeyNames`, come illustrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="a2698-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="a2698-204">Si noti che in questo modo vengono creati campi di stato di visualizzazione molto grandi, motivo per cui l'utilizzo di un campo di rilevamento è in genere il modo migliore per tenere traccia dei conflitti di concorrenza.</span><span class="sxs-lookup"><span data-stu-id="a2698-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="a2698-205">Aprire *Departments.aspx.cs* e aggiungere l'istruzione `using` seguente per lo spazio dei nomi `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="a2698-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="a2698-206">Aggiungere il nuovo metodo seguente, che si chiamerà dal `Updated` del controllo origine dati e `Deleted` gestori eventi per la gestione delle eccezioni di concorrenza:</span><span class="sxs-lookup"><span data-stu-id="a2698-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="a2698-207">Questo codice controlla il tipo di eccezione e, se si tratta di un'eccezione di concorrenza, il codice crea dinamicamente un controllo `CustomValidator` che a sua volta Visualizza un messaggio nel controllo `ValidationSummary`.</span><span class="sxs-lookup"><span data-stu-id="a2698-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="a2698-208">Chiamare il nuovo metodo dal gestore eventi `Updated` aggiunto in precedenza.</span><span class="sxs-lookup"><span data-stu-id="a2698-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="a2698-209">Inoltre, creare un nuovo gestore dell'evento `Deleted` che chiama lo stesso metodo (ma non esegue altre operazioni):</span><span class="sxs-lookup"><span data-stu-id="a2698-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="a2698-210">Verifica della concorrenza ottimistica nella pagina Departments</span><span class="sxs-lookup"><span data-stu-id="a2698-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="a2698-211">Eseguire la pagina *repartitions. aspx* .</span><span class="sxs-lookup"><span data-stu-id="a2698-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="a2698-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="a2698-213">Fare clic su **modifica** in una riga e modificare il valore nella colonna **budget** .</span><span class="sxs-lookup"><span data-stu-id="a2698-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="a2698-214">Tenere presente che è possibile modificare solo i record creati per questa esercitazione, perché i record esistenti del database di `School` contengono alcuni dati non validi.</span><span class="sxs-lookup"><span data-stu-id="a2698-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="a2698-215">Il record per il reparto economico è sicuro da sperimentare.</span><span class="sxs-lookup"><span data-stu-id="a2698-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="a2698-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="a2698-217">Aprire una nuova finestra del browser ed eseguire di nuovo la pagina, copiando l'URL dalla prima casella dell'indirizzo della finestra del browser alla seconda finestra del browser.</span><span class="sxs-lookup"><span data-stu-id="a2698-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="a2698-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="a2698-219">Fare clic su **modifica** nella stessa riga modificata in precedenza e modificare il valore di **budget** in un valore diverso.</span><span class="sxs-lookup"><span data-stu-id="a2698-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="a2698-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="a2698-221">Nella seconda finestra del browser fare clic su **Aggiorna**.</span><span class="sxs-lookup"><span data-stu-id="a2698-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="a2698-222">L'importo del **budget** è stato modificato correttamente in questo nuovo valore.</span><span class="sxs-lookup"><span data-stu-id="a2698-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="a2698-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="a2698-224">Nella prima finestra del browser fare clic su **Aggiorna**.</span><span class="sxs-lookup"><span data-stu-id="a2698-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="a2698-225">L'aggiornamento non riesce.</span><span class="sxs-lookup"><span data-stu-id="a2698-225">The update fails.</span></span> <span data-ttu-id="a2698-226">L'importo del **budget** viene visualizzato nuovamente usando il valore impostato nella seconda finestra del browser e viene visualizzato un messaggio di errore.</span><span class="sxs-lookup"><span data-stu-id="a2698-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="a2698-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="a2698-228">Gestione della concorrenza ottimistica tramite una proprietà di rilevamento</span><span class="sxs-lookup"><span data-stu-id="a2698-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="a2698-229">Per gestire la concorrenza ottimistica per un'entità che dispone di una proprietà di rilevamento, si completeranno le attività seguenti:</span><span class="sxs-lookup"><span data-stu-id="a2698-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="a2698-230">Aggiungere stored procedure al modello di dati per gestire le entità `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="a2698-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="a2698-231">(Le proprietà di rilevamento e le stored procedure non devono essere utilizzate insieme; sono raggruppate qui per illustrazione).</span><span class="sxs-lookup"><span data-stu-id="a2698-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="a2698-232">Aggiungere metodi CRUD a DAL e a BLL per `OfficeAssignment` entità, incluso il codice per gestire le eccezioni di concorrenza ottimistica nel DAL.</span><span class="sxs-lookup"><span data-stu-id="a2698-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="a2698-233">Creare una pagina Web Office-assegnazioni.</span><span class="sxs-lookup"><span data-stu-id="a2698-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="a2698-234">Testare la concorrenza ottimistica nella nuova pagina Web.</span><span class="sxs-lookup"><span data-stu-id="a2698-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="a2698-235">Aggiunta di stored procedure OfficeAssignment al modello di dati</span><span class="sxs-lookup"><span data-stu-id="a2698-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="a2698-236">Aprire il file *SchoolModel. edmx* in Progettazione modelli, fare clic con il pulsante destro del mouse sull'area di progettazione e scegliere **Aggiorna modello da database**.</span><span class="sxs-lookup"><span data-stu-id="a2698-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="a2698-237">Nella scheda **Aggiungi** della finestra di dialogo **Seleziona oggetti di database** espandere **stored procedure** e selezionare le tre stored procedure `OfficeAssignment` (vedere la schermata seguente), quindi fare clic su **fine**.</span><span class="sxs-lookup"><span data-stu-id="a2698-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="a2698-238">Queste stored procedure erano già presenti nel database quando è stato scaricato o creato mediante uno script.</span><span class="sxs-lookup"><span data-stu-id="a2698-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="a2698-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="a2698-240">Fare clic con il pulsante destro del mouse sull'entità `OfficeAssignment` e selezionare **Mapping stored procedure**.</span><span class="sxs-lookup"><span data-stu-id="a2698-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="a2698-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="a2698-242">Impostare le funzioni di **inserimento**, **aggiornamento**ed **eliminazione** per utilizzare le stored procedure corrispondenti.</span><span class="sxs-lookup"><span data-stu-id="a2698-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="a2698-243">Per il parametro `OrigTimestamp` della funzione `Update`, impostare la **Proprietà** su `Timestamp` e selezionare l'opzione **Usa valore originale** .</span><span class="sxs-lookup"><span data-stu-id="a2698-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="a2698-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="a2698-245">Quando il Entity Framework chiama il stored procedure di `UpdateOfficeAssignment`, passerà il valore originale della colonna `Timestamp` nel parametro `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="a2698-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="a2698-246">Il stored procedure utilizza questo parametro nella relativa clausola `Where`:</span><span class="sxs-lookup"><span data-stu-id="a2698-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="a2698-247">Il stored procedure seleziona anche il nuovo valore della colonna `Timestamp` dopo l'aggiornamento, in modo che il Entity Framework possa garantire la sincronizzazione dell'entità `OfficeAssignment` in memoria con la riga di database corrispondente.</span><span class="sxs-lookup"><span data-stu-id="a2698-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="a2698-248">Si noti che il stored procedure per l'eliminazione di un'assegnazione di ufficio non ha un parametro di `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="a2698-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="a2698-249">Per questo motivo, il Entity Framework non è in grado di verificare se un'entità non è stata modificata prima di eliminarla.</span><span class="sxs-lookup"><span data-stu-id="a2698-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="a2698-250">Salvare e chiudere il modello di dati.</span><span class="sxs-lookup"><span data-stu-id="a2698-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="a2698-251">Aggiunta di metodi OfficeAssignment al DAL</span><span class="sxs-lookup"><span data-stu-id="a2698-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="a2698-252">Aprire *ISchoolRepository.cs* e aggiungere i seguenti metodi CRUD per il set di entità `OfficeAssignment`:</span><span class="sxs-lookup"><span data-stu-id="a2698-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="a2698-253">Aggiungere i nuovi metodi seguenti a *SchoolRepository.cs*.</span><span class="sxs-lookup"><span data-stu-id="a2698-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="a2698-254">Nel metodo `UpdateOfficeAssignment` si chiama il metodo `SaveChanges` locale invece di `context.SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="a2698-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="a2698-255">Nel progetto di test aprire *MockSchoolRepository.cs* e aggiungere i seguenti metodi di raccolta `OfficeAssignment` e CRUD.</span><span class="sxs-lookup"><span data-stu-id="a2698-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="a2698-256">Il repository fittizio deve implementare l'interfaccia del repository o la soluzione non verrà compilata.</span><span class="sxs-lookup"><span data-stu-id="a2698-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="a2698-257">Aggiunta di metodi OfficeAssignment al BLL</span><span class="sxs-lookup"><span data-stu-id="a2698-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="a2698-258">Nel progetto principale aprire *SchoolBL.cs* e aggiungere i metodi CRUD seguenti per il set di entità `OfficeAssignment`:</span><span class="sxs-lookup"><span data-stu-id="a2698-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="a2698-259">Creazione di una pagina Web OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="a2698-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="a2698-260">Creare una nuova pagina Web che usa la pagina master *site. master* e denominarla *OfficeAssignments. aspx*.</span><span class="sxs-lookup"><span data-stu-id="a2698-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="a2698-261">Aggiungere il markup seguente al controllo `Content` denominato `Content2`:</span><span class="sxs-lookup"><span data-stu-id="a2698-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="a2698-262">Si noti che nell'attributo `DataKeyNames` il markup specifica la proprietà `Timestamp` e la chiave del record (`InstructorID`).</span><span class="sxs-lookup"><span data-stu-id="a2698-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="a2698-263">Se si specificano proprietà nell'attributo `DataKeyNames`, il controllo lo salva nello stato del controllo (simile allo stato di visualizzazione), in modo che i valori originali siano disponibili durante l'elaborazione del postback.</span><span class="sxs-lookup"><span data-stu-id="a2698-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="a2698-264">Se il valore `Timestamp` non è stato salvato, il Entity Framework non lo avrebbe per la clausola `Where` del comando SQL `Update`.</span><span class="sxs-lookup"><span data-stu-id="a2698-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="a2698-265">Di conseguenza, non viene trovato alcun elemento da aggiornare.</span><span class="sxs-lookup"><span data-stu-id="a2698-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="a2698-266">Di conseguenza, il Entity Framework genererebbe un'eccezione di concorrenza ottimistica ogni volta che viene aggiornata un'entità `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="a2698-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="a2698-267">Aprire *OfficeAssignments.aspx.cs* e aggiungere l'istruzione `using` seguente per il livello di accesso ai dati:</span><span class="sxs-lookup"><span data-stu-id="a2698-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="a2698-268">Aggiungere il seguente metodo di `Page_Init`, che Abilita Dynamic Data funzionalità.</span><span class="sxs-lookup"><span data-stu-id="a2698-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="a2698-269">Aggiungere anche il gestore seguente per l'evento `Updated` del controllo `ObjectDataSource` per verificare la presenza di errori di concorrenza:</span><span class="sxs-lookup"><span data-stu-id="a2698-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="a2698-270">Test della concorrenza ottimistica nella pagina OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="a2698-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="a2698-271">Eseguire la pagina *OfficeAssignments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="a2698-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="a2698-272">[![image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="a2698-273">Fare clic su **modifica** in una riga e modificare il valore nella colonna **percorso** .</span><span class="sxs-lookup"><span data-stu-id="a2698-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="a2698-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="a2698-275">Aprire una nuova finestra del browser ed eseguire di nuovo la pagina, copiando l'URL dalla prima finestra del browser alla seconda finestra del browser.</span><span class="sxs-lookup"><span data-stu-id="a2698-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="a2698-276">[![image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="a2698-277">Fare clic su **modifica** nella stessa riga modificata in precedenza e modificare il valore del **percorso** in un valore diverso.</span><span class="sxs-lookup"><span data-stu-id="a2698-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="a2698-278">[![IMAGE12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="a2698-279">Nella seconda finestra del browser fare clic su **Aggiorna**.</span><span class="sxs-lookup"><span data-stu-id="a2698-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="a2698-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="a2698-281">Passare alla prima finestra del browser e fare clic su **Aggiorna**.</span><span class="sxs-lookup"><span data-stu-id="a2698-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="a2698-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="a2698-283">Viene visualizzato un messaggio di errore e il valore **location** è stato aggiornato per visualizzare il valore in cui è stato modificato nella seconda finestra del browser.</span><span class="sxs-lookup"><span data-stu-id="a2698-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="a2698-284">Gestione della concorrenza con il controllo EntityDataSource</span><span class="sxs-lookup"><span data-stu-id="a2698-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="a2698-285">Il controllo `EntityDataSource` include la logica incorporata che riconosce le impostazioni di concorrenza nel modello di dati e gestisce di conseguenza le operazioni di aggiornamento ed eliminazione.</span><span class="sxs-lookup"><span data-stu-id="a2698-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="a2698-286">Tuttavia, come per tutte le eccezioni, è necessario gestire `OptimisticConcurrencyException` le eccezioni per fornire un messaggio di errore descrittivo.</span><span class="sxs-lookup"><span data-stu-id="a2698-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="a2698-287">Si configurerà quindi la pagina *courses. aspx* (che usa un controllo `EntityDataSource`) per consentire le operazioni di aggiornamento ed eliminazione e per visualizzare un messaggio di errore se si verifica un conflitto di concorrenza.</span><span class="sxs-lookup"><span data-stu-id="a2698-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="a2698-288">L'entità `Course` non dispone di una colonna di rilevamento della concorrenza, quindi si userà lo stesso metodo che è stato fatto con l'entità `Department`: tenere traccia dei valori di tutte le proprietà non chiave.</span><span class="sxs-lookup"><span data-stu-id="a2698-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="a2698-289">Aprire il file *SchoolModel. edmx* .</span><span class="sxs-lookup"><span data-stu-id="a2698-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="a2698-290">Per le proprietà non chiave dell'entità `Course` (`Title`, `Credits`e `DepartmentID`), impostare la proprietà **modalità concorrenza** su `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="a2698-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="a2698-291">Quindi salvare e chiudere il modello di dati.</span><span class="sxs-lookup"><span data-stu-id="a2698-291">Then save and close the data model.</span></span>

<span data-ttu-id="a2698-292">Aprire la pagina *courses. aspx* e apportare le modifiche seguenti:</span><span class="sxs-lookup"><span data-stu-id="a2698-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="a2698-293">Nel controllo `CoursesEntityDataSource` aggiungere gli attributi `EnableUpdate="true"` e `EnableDelete="true"`.</span><span class="sxs-lookup"><span data-stu-id="a2698-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="a2698-294">Il tag di apertura per il controllo è ora simile all'esempio seguente:</span><span class="sxs-lookup"><span data-stu-id="a2698-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="a2698-295">Nel controllo `CoursesGridView` modificare il valore dell'attributo `DataKeyNames` in `"CourseID,Title,Credits,DepartmentID"`.</span><span class="sxs-lookup"><span data-stu-id="a2698-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="a2698-296">Aggiungere quindi un elemento `CommandField` all'elemento `Columns` che mostra i pulsanti **modifica** ed **Elimina** (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span><span class="sxs-lookup"><span data-stu-id="a2698-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="a2698-297">Il controllo `GridView` ora è simile all'esempio seguente:</span><span class="sxs-lookup"><span data-stu-id="a2698-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="a2698-298">Eseguire la pagina e creare una situazione di conflitto come in precedenza nella pagina departments (reparti).</span><span class="sxs-lookup"><span data-stu-id="a2698-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="a2698-299">Eseguire la pagina in due finestre del browser, fare clic su **modifica** nella stessa riga in ogni finestra e apportare una modifica diversa in ciascuna di esse.</span><span class="sxs-lookup"><span data-stu-id="a2698-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="a2698-300">Fare clic su **Aggiorna** in una finestra, quindi fare clic su **Aggiorna** nell'altra finestra.</span><span class="sxs-lookup"><span data-stu-id="a2698-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="a2698-301">Quando si fa clic su **Aggiorna** la seconda volta, viene visualizzata la pagina di errore risultante da un'eccezione di concorrenza non gestita.</span><span class="sxs-lookup"><span data-stu-id="a2698-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="a2698-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="a2698-303">Questo errore viene gestito in modo molto simile a come è stato gestito per il controllo `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="a2698-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="a2698-304">Aprire la pagina *courses. aspx* e nel controllo `CoursesEntityDataSource` specificare i gestori per gli eventi `Deleted` e `Updated`.</span><span class="sxs-lookup"><span data-stu-id="a2698-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="a2698-305">Il tag di apertura del controllo è ora simile all'esempio seguente:</span><span class="sxs-lookup"><span data-stu-id="a2698-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="a2698-306">Prima del controllo `CoursesGridView` aggiungere il controllo `ValidationSummary` seguente:</span><span class="sxs-lookup"><span data-stu-id="a2698-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="a2698-307">In *courses.aspx.cs*aggiungere un'istruzione `using` per lo spazio dei nomi `System.Data`, aggiungere un metodo che controlla le eccezioni di concorrenza e aggiungere gestori per i gestori di `Updated` e `Deleted` del controllo `EntityDataSource`.</span><span class="sxs-lookup"><span data-stu-id="a2698-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="a2698-308">Il codice sarà simile al seguente:</span><span class="sxs-lookup"><span data-stu-id="a2698-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="a2698-309">L'unica differenza tra questo codice e le operazioni effettuate per il controllo `ObjectDataSource` è che in questo caso l'eccezione di concorrenza si trova nella proprietà `Exception` dell'oggetto arguments dell'evento anziché nella proprietà `InnerException` di tale eccezione.</span><span class="sxs-lookup"><span data-stu-id="a2698-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="a2698-310">Eseguire la pagina e creare nuovamente un conflitto di concorrenza.</span><span class="sxs-lookup"><span data-stu-id="a2698-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="a2698-311">Questa volta viene visualizzato un messaggio di errore:</span><span class="sxs-lookup"><span data-stu-id="a2698-311">This time you see an error message:</span></span>

<span data-ttu-id="a2698-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="a2698-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="a2698-313">Questo argomento completa l'introduzione alla gestione dei conflitti di concorrenza.</span><span class="sxs-lookup"><span data-stu-id="a2698-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="a2698-314">L'esercitazione successiva fornirà indicazioni su come migliorare le prestazioni in un'applicazione Web che usa la Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="a2698-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="a2698-315">[Precedente](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [Successivo](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="a2698-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
